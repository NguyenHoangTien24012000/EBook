<style>
    @font-face {
        font-family: Roboto;
        font-style: normal;
        font-weight: 300;
        src: url(https://static.contineljs.com/fonts/Roboto-Light.woff2) format("woff2"),
            url(https://static.contineljs.com/fonts/Roboto-Light.woff) format("woff");
    }

    @font-face {
        font-family: Roboto;
        font-style: normal;
        font-weight: 400;
        src: url(https://static.contineljs.com/fonts/Roboto-Regular.woff2) format("woff2"),
            url(https://static.contineljs.com/fonts/Roboto-Regular.woff) format("woff");
    }

    @font-face {
        font-family: Roboto;
        font-style: normal;
        font-weight: 500;
        src: url(https://static.contineljs.com/fonts/Roboto-Medium.woff2?v=2) format("woff2"),
            url(https://static.contineljs.com/fonts/Roboto-Medium.woff) format("woff");
    }

    @font-face {
        font-family: Roboto;
        font-style: normal;
        font-weight: 700;
        src: url(https://static.contineljs.com/fonts/Roboto-Bold.woff2) format("woff2"),
            url(https://static.contineljs.com/fonts/Roboto-Bold.woff) format("woff");
    }

    * {
        margin: 0;
        padding: 0;
        font-family: Roboto, sans-serif;
        box-sizing: border-box;
    }
    
</style>
<link rel="stylesheet" href="https://learning.oreilly.com/files/public/epub-reader/override_v1.css" crossorigin="anonymous"><link rel="stylesheet" href="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492092506/files/epub.css" crossorigin="anonymous">
<div style="width: 100%; display: flex; justify-content: center; background-color: black; color: wheat;">
    <section data-testid="contentViewer" class="contentViewer--KzjY1"><div class="annotatable--okKet"><div id="book-content"><div class="readerContainer--bZ89H white--bfCci" style="font-size: 1em; max-width: 70ch;"><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 21. Building Web Applications with Express"><div class="chapter" id="ch21">
        <h1><span class="label">Chapter 21. </span>Building Web Applications with Express</h1>
        
        
        <p><a href="https://expressjs.com">Express</a> is a lightweight web framework that has been the long-standing leader in web application development in Node. <a data-type="indexterm" data-primary="Express framework" id="ix_express_frame_ch21"></a>Similar to Ruby’s Sinatra and Python’s Flask, the Express framework by itself is very minimal, but can be extended to build any type of web application. Express is also the backbone of batteries included in web application frameworks, such as <a href="https://keystonejs.com">Keystone.js</a>, <a href="https://sailsjs.com">Sails</a>, and <a href="http://vulcanjs.org">Vulcan.js</a>. If you are doing web application development in Node, you are likely to encounter Express. This chapter focuses on a handful of basic recipes for working with Express, which can be extended to build out all sorts of web applications.</p>
        
        
        
        
        
        
        <section data-type="sect1" data-pdf-bookmark="Using Express to Respond to Requests"><div class="sect1" id="using-express">
        <h1>Using Express to Respond to Requests</h1>
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45475120741432">
        <h2>Problem</h2>
        
        <p><a data-type="indexterm" data-primary="HTTP" data-secondary="responding to Express requests" id="ix_http_req_express"></a><a data-type="indexterm" data-primary="Express framework" data-secondary="responding to HTTP requests" id="ix_express_frame_http_req"></a>Your Node application needs to respond to HTTP requests.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45475120737288">
        <h2>Solution</h2>
        
        <p>Install the Express package:</p>
        
        <pre data-type="programlisting" data-code-language="bash"><code class="nv">$ </code>npm install express</pre>
        
        <p>To set up Express, we require the module, call the module, and specify a port for connections in a file named <em>index.js</em>:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">);</code>
        
        <code class="kr">const</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">express</code><code class="p">();</code>
        <code class="kr">const</code> <code class="nx">port</code> <code class="o">=</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code> <code class="o">||</code> <code class="s1">'3000'</code><code class="p">;</code>
        
        <code class="nx">app</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="nx">port</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`Listening on port </code><code class="si">${</code><code class="nx">port</code><code class="si">}</code><code class="sb">`</code><code class="p">));</code></pre>
        
        <p>To respond to a request, specify a route and the response using Express’s <code>.get</code> method:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">);</code>
        
        <code class="kr">const</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">express</code><code class="p">();</code>
        <code class="kr">const</code> <code class="nx">port</code> <code class="o">=</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code> <code class="o">||</code> <code class="s1">'3000'</code><code class="p">;</code>
        
        <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="s1">'Hello World'</code><code class="p">));</code>
        
        <code class="nx">app</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="nx">port</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`Listening on port </code><code class="si">${</code><code class="nx">port</code><code class="si">}</code><code class="sb">`</code><code class="p">));</code></pre>
        
        <p>To serve static files, we can specify a directory with the <code>express.static</code> middleware</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">);</code>
        
        <code class="kr">const</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">express</code><code class="p">();</code>
        <code class="kr">const</code> <code class="nx">port</code> <code class="o">=</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code> <code class="o">||</code> <code class="s1">'3000'</code><code class="p">;</code>
        
        <code class="c1">// middleware for static files</code>
        <code class="c1">// will serve static files from the 'files' directory</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="kr">static</code><code class="p">(</code><code class="s1">'files'</code><code class="p">));</code>
        
        <code class="nx">app</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="nx">port</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`Listening on port </code><code class="si">${</code><code class="nx">port</code><code class="si">}</code><code class="sb">`</code><code class="p">));</code></pre>
        
        <p>To respond with HTML generated from a template, first install the templating engine:</p>
        
        <pre data-type="programlisting" data-code-language="bash"><code class="nv">$ </code>npm install pug --save</pre>
        
        <p>Next, in the <em>index.js</em> file, set the <code>view engine</code> and specify the route that will respond with the template content:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">app</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="s1">'view engine'</code><code class="p">,</code> <code class="s1">'pug'</code><code class="p">)</code>
        
        <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/template'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'template'</code><code class="p">);</code>
        <code class="p">});</code></pre>
        
        <p>And then create a template file in the <em>views</em> subdirectory of the project with a new file. The template filename should match the name specified in <code>res.render</code>. In <em>views/template.pug</em>:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">html</code>
          <code class="nx">head</code>
            <code class="nx">title</code><code class="o">=</code><code class="s2">"Using Express"</code>
          <code class="nx">body</code>
            <code class="nx">h1</code><code class="o">=</code><code class="s2">"Hello World"</code></pre>
        
        <p>Now requests to <em>http://localhost:3000/template</em> will  return the template content as HTML.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45475120736696">
        <h2>Discussion</h2>
        
        <p>Express is a minimalist, but highly configurable framework for responding to HTTP requests and building out web applications. In the example, we set the port to <code>process.env.PORT</code> or port <code>3000</code>. In development, we can then specify a new port using an environment variable, such as:</p>
        
        <pre data-type="programlisting" data-code-language="bash"><code class="nv">$ PORT</code><code class="o">=</code><code class="m">7777</code> node index.js</pre>
        
        <p>or by using a <em>.env</em> file paired with the <code>dotenv</code> Node module. When deploying the application, the application hosting platform may require a specific port number or allow us to configure the port number ourselves.</p>
        
        <p>With the Express <code>get</code> method, the application receives a request to a specific URI and then responds. In our example, when the application receives a request to the root URI (<em>/</em>), we respond with the text “Hello World”:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="s1">'Hello World'</code><code class="p">));</code></pre>
        
        <p>These responses can also be HTML, templates rendered to HTML, static files, and formatted data (such as JSON or XML).</p>
        
        <p><a data-type="indexterm" data-primary="middleware packages for Express" id="idm45475120256952"></a>Due to its minimal nature, Express itself contains minimal functionality, but can be extended using middleware. In Express, middleware functions have access to the <code>request</code> and <code>response</code> objects. Application-level middleware is bound to an instance of the <code>app</code> object through <code>app.use(MIDDLEWARE)</code>. In the example, we’re making use of the built-in static files middleware:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="kr">static</code><code class="p">(</code><code class="s1">'files'</code><code class="p">));</code></pre>
        
        <p>Middleware packages can be used to extend Express’s functionality in many ways. The  <code>helmet</code> middleware package can be used to improve the Express security defaults:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">);</code>
        <code class="kr">const</code> <code class="nx">helmet</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'helmet'</code><code class="p">);</code>
        
        <code class="kr">const</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">express</code><code class="p">();</code>
        
        <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">helmet</code><code class="p">());</code></pre>
        
        <p><a data-type="indexterm" data-primary="templating engines" id="idm45475120247384"></a>Templating engines simplify the process of writing HTML and allow you to pass data from your application to the page.</p>
        
        <p>Here I am passing the data from the <code>userData</code> object to the template found at <em>views/user.pug</em>, which will be accessible at the <em>/user</em> route:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="c1">// a user object of data to send to the template</code>
        <code class="kr">const</code> <code class="nx">userData</code> <code class="o">=</code> <code class="p">{</code>
          <code class="nx">name</code><code class="o">:</code> <code class="s1">'Adam'</code><code class="p">,</code>
          <code class="nx">email</code><code class="o">:</code> <code class="s1">'adam@jseverywhere.io'</code><code class="p">,</code>
          <code class="nx">avatar</code><code class="o">:</code> <code class="s1">'https://s.gravatar.com/avatar/33aab819d1ffa11fc4b31a4eebaf0c5a?s=80'</code>
        <code class="p">};</code>
        
        <code class="c1">// render the template with user data</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/user'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'user'</code><code class="p">,</code> <code class="p">{</code> <code class="nx">userData</code> <code class="p">});</code>
        <code class="p">});</code></pre>
        
        <p>Then in our template, we can make use of the data:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">html</code>
          <code class="nx">head</code>
            <code class="nx">title</code> <code class="nx">User</code> <code class="nx">Page</code>
          <code class="nx">body</code>
            <code class="nx">h1</code> <code class="err">#</code><code class="p">{</code><code class="nx">userData</code><code class="p">.</code><code class="nx">name</code><code class="p">}</code> <code class="nx">Profile</code>
            <code class="nx">ul</code>
              <code class="nx">li</code>
                <code class="nx">image</code><code class="p">(</code><code class="nx">src</code><code class="o">=</code><code class="nx">userData</code><code class="p">.</code><code class="nx">avatar</code><code class="p">)</code>
              <code class="nx">li</code> <code class="err">#</code><code class="p">{</code><code class="nx">userData</code><code class="p">.</code><code class="nx">name</code><code class="p">}</code>
              <code class="nx">li</code> <code class="err">#</code><code class="p">{</code><code class="nx">userData</code><code class="p">.</code><code class="nx">email</code><code class="p">}</code></pre>
        
        <p><a data-type="indexterm" data-primary="Pug templating engine" id="idm45475120104776"></a>The Pug templating engine is maintained by the Express core team and is a popular choice for Express applications, but its whitespace-driven syntax is not for everyone. <a href="https://ejs.co">EJS</a> is an excellent alternative that offers a more HTML-like syntax. <a data-type="indexterm" data-primary="EJS template system" id="idm45475120028808"></a>Here’s how the above example would look using EJS.<a data-type="indexterm" data-primary="" data-startref="ix_express_frame_http_req" id="idm45475120028040"></a><a data-type="indexterm" data-primary="" data-startref="ix_http_req_express" id="idm45475120027128"></a></p>
        
        <p>First, specify to install the <code>ejs</code> package:</p>
        
        <pre data-type="programlisting" data-code-language="bash"><code class="nv">$ </code>npm install ejs</pre>
        
        <p>Then set EJS as the view engine in your Express application:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">app</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="s1">'view engine'</code><code class="p">,</code> <code class="s1">'ejs'</code><code class="p">);</code></pre>
        
        <p>And in <em>views/user.ejs</em>:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="o">&lt;!</code><code class="nx">DOCTYPE</code> <code class="nx">html</code><code class="o">&gt;</code>
        <code class="o">&lt;</code><code class="nx">html</code> <code class="nx">lang</code><code class="o">=</code><code class="s2">"en"</code><code class="o">&gt;</code>
          <code class="o">&lt;</code><code class="nx">head</code><code class="o">&gt;</code>
            <code class="o">&lt;</code><code class="nx">title</code><code class="o">&gt;</code><code class="nx">User</code> <code class="nx">Page</code><code class="o">&lt;</code><code class="err">/title&gt;</code>
          <code class="o">&lt;</code><code class="err">/head&gt;</code>
          <code class="o">&lt;</code><code class="nx">body</code><code class="o">&gt;</code>
            <code class="o">&lt;</code><code class="nx">h1</code><code class="o">&gt;&lt;%=</code> <code class="nx">userData</code><code class="p">.</code><code class="nx">name</code> <code class="o">%&gt;</code> <code class="nx">Profile</code><code class="o">&lt;</code><code class="err">/h1&gt;</code>
            <code class="o">&lt;</code><code class="nx">ul</code><code class="o">&gt;</code>
              <code class="o">&lt;</code><code class="nx">li</code><code class="o">&gt;&lt;</code><code class="nx">img</code> <code class="nx">src</code><code class="o">=&lt;%=</code> <code class="nx">userData</code><code class="p">.</code><code class="nx">avatar</code> <code class="o">%&gt;</code> <code class="err">/&gt;&lt;/li&gt;</code>
              <code class="o">&lt;</code><code class="nx">li</code><code class="o">&gt;&lt;%=</code> <code class="nx">userData</code><code class="p">.</code><code class="nx">name</code> <code class="o">%&gt;&lt;</code><code class="err">/li&gt;</code>
              <code class="o">&lt;</code><code class="nx">li</code><code class="o">&gt;&lt;%=</code> <code class="nx">userData</code><code class="p">.</code><code class="nx">email</code> <code class="o">%&gt;&lt;</code><code class="err">/li&gt;</code>
            <code class="o">&lt;</code><code class="err">/ul&gt;</code>
          <code class="o">&lt;</code><code class="err">/body&gt;</code>
        <code class="o">&lt;</code><code class="err">/html&gt;</code></pre>
        </div></section>
        
        
        
        
        
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect1" data-pdf-bookmark="Using the Express-Generator"><div class="sect1" id="express-generator">
        <h1>Using the Express-Generator</h1>
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45475120018152">
        <h2>Problem</h2>
        
        <p><a data-type="indexterm" data-primary="Express framework" data-secondary="Express-Generator" id="ix_express_generator"></a>You’re interested in using Express to manage your server-side data application, but you don’t want to manage all of the setup yourself.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45475119865592">
        <h2>Solution</h2>
        
        <p>To kickstart your Express application, use the Express-Generator. This is a command-line tool that generates the skeleton infrastructure of a typical Express application.</p>
        
        <p>First, create a working directory where the tool can safely install a new application subdirectory. Next, run the <code>express-generator</code> command with <code>npx</code>:</p>
        
        <pre data-type="programlisting" data-code-language="bash"><code class="nv">$ </code>npx express-generator --pug --git</pre>
        
        <p>I’ve passed two options with the command: <code>--pug</code> will result in the  use of the Pug templating engine, while <code>--git</code> will generate a default <em>.gitignore</em> file in the project directory. For the full list of options, run the generator with the <code>-h</code> option:</p>
        
        <pre data-type="programlisting" data-code-language="bash"><code class="nv">$ </code>npx express-generator -h</pre>
        
        <p>The generator creates a new directory with several subdirectories, some basic files to get you started, and a <em>package.json</em> file with all of the dependencies. To install the dependencies, change to the newly created directory and type:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">$</code> <code class="nx">npm</code> <code class="nx">install</code></pre>
        
        <p>Once all of the dependencies are installed, run the application using the following:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">$</code> <code class="nx">npm</code> <code class="nx">start</code></pre>
        
        <p>You can now access the generated Express application, using your IP address or domain and port 3000, the default Express port.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45475119865048">
        <h2>Discussion</h2>
        
        <p><a data-type="indexterm" data-primary="CSS (Cascading Style Sheet)" data-secondary="preprocessor" id="idm45475119809160"></a>Express provides a web application framework based on Node and with support for multiple templating engines and CSS preprocessors. In the solution, the options I chose for the example application are Pug as the template engine (the default) and the default of plain CSS (no CSS preprocessor). Though building the application from scratch enables a wider selection, Express supports only the following template engines:</p>
        <dl>
        <dt><code>--ejs</code></dt>
        <dd>
        <p>Adds support for the EJS template engine</p>
        </dd>
        <dt><code>--pug</code></dt>
        <dd>
        <p>Adds support for the Pug template engine</p>
        </dd>
        <dt><code>--hbs</code></dt>
        <dd>
        <p>Adds support for the Handlebar template engine</p>
        </dd>
        <dt><code>--hogan</code></dt>
        <dd>
        <p>Adds support for the Hogan.js template engine</p>
        </dd>
        </dl>
        
        <p>Express also supports the following CSS preprocessors:</p>
        <dl>
        <dt><code>express --css sass</code></dt>
        <dd>
        <p>Support for Sass</p>
        </dd>
        <dt><code>express --css less</code></dt>
        <dd>
        <p>Support for Less</p>
        </dd>
        <dt><code>express --css stylus</code></dt>
        <dd>
        <p>Support for Stylus</p>
        </dd>
        <dt><code>express --css compass</code></dt>
        <dd>
        <p>Support for Compass</p>
        </dd>
        </dl>
        
        <p>Not specifying any CSS preprocessor defaults to plain CSS.</p>
        
        <p>Express also assumes that the project directory is empty. If it isn’t, force the Express generator to generate the content by using the <code>-f</code> or <code>--force</code> option.</p>
        
        <p>The newly generated subdirectory has the following structure (disregarding <code>node​_mod⁠ules</code>):</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">app</code><code class="p">.</code><code class="nx">js</code>
        <code class="kr">package</code><code class="o">-</code><code class="nx">lock</code><code class="p">.</code><code class="nx">json</code>
        <code class="kr">package</code><code class="p">.</code><code class="nx">json</code>
        <code class="err">/bin</code>
           <code class="nx">www</code>
        <code class="err">/node_modules</code>
        <code class="err">/public</code>
           <code class="err">/images</code>
           <code class="err">/javascripts</code>
           <code class="err">/stylesheets</code>
              <code class="nx">style</code><code class="p">.</code><code class="nx">css</code>
              <code class="nx">style</code><code class="p">.</code><code class="nx">styl</code>
        <code class="err">/routes</code>
           <code class="nx">index</code><code class="p">.</code><code class="nx">js</code>
           <code class="nx">users</code><code class="p">.</code><code class="nx">js</code>
        <code class="err">/views</code>
           <code class="nx">error</code><code class="p">.</code><code class="nx">pug</code>
           <code class="nx">index</code><code class="p">.</code><code class="nx">pug</code>
           <code class="nx">layout</code><code class="p">.</code><code class="nx">pug</code></pre>
        
        <p><a data-type="indexterm" data-primary="app.js file" id="idm45475119709480"></a><a data-type="indexterm" data-primary="files" data-secondary="app.js file" id="idm45475119681128"></a>The <em>app.js</em> file is the core of the Express application. It includes the references to the necessary libraries:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kd">var</code> <code class="nx">createError</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'http-errors'</code><code class="p">);</code>
        <code class="kd">var</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">);</code>
        <code class="kd">var</code> <code class="nx">path</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'path'</code><code class="p">);</code>
        <code class="kd">var</code> <code class="nx">cookieParser</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'cookie-parser'</code><code class="p">);</code>
        <code class="kd">var</code> <code class="nx">logger</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'morgan'</code><code class="p">);</code>
        
        <code class="kd">var</code> <code class="nx">indexRouter</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./routes/index'</code><code class="p">);</code>
        <code class="kd">var</code> <code class="nx">usersRouter</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./routes/users'</code><code class="p">);</code></pre>
        <div data-type="note" epub:type="note"><h6>Note</h6>
        <p>Although the convention followed in this book is to use <code>const</code> and <code>let</code> to define variables, at the time of writing, the Express generator uses <code>var</code>.</p>
        </div>
        
        <p>It also creates the Express app with the following line:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">express</code><code class="p">()</code><code class="o">:</code></pre>
        
        <p><a data-type="indexterm" data-primary="Pug templating engine" id="ix_Pug_template"></a>Next, it establishes Pug as the view engine by defining the <code>views</code> and <code>view engine</code> variables:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">app</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="s1">'views'</code><code class="p">,</code> <code class="nx">path</code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code class="nx">__dirname</code><code class="p">,</code> <code class="s1">'views'</code><code class="p">));</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="s1">'view engine'</code><code class="p">,</code> <code class="s1">'pug'</code><code class="p">);</code></pre>
        
        <p>The <em>middleware</em> calls are loaded next with <code>app.use()</code>. Middleware is functionality that sits between the raw request and the routing, processing specific types of requests. The rule for the middleware is if a path is not given as the first parameter, it defaults to a path of <code>/</code>, which means the middleware functions are loaded with the default path. In the following generated code:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">logger</code><code class="p">(</code><code class="s1">'dev'</code><code class="p">));</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">json</code><code class="p">());</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">urlencoded</code><code class="p">({</code> <code class="nx">extended</code><code class="o">:</code> <code class="kc">false</code> <code class="p">}));</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">cookieParser</code><code class="p">());</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="kr">static</code><code class="p">(</code><code class="nx">path</code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code class="nx">__dirname</code><code class="p">,</code> <code class="s1">'public'</code><code class="p">)));</code></pre>
        
        <p>The first several middleware are loaded with every app request. Among the middleware includes support for development logging, as well as parsers for both JSON and <em>urlencoded</em> bodies. It’s only when we get to the <code>static</code> entry that we see assignment to specific paths: the static file request middleware are loaded when requests are made to the <em>public</em> directory.</p>
        
        <p>The routing is handled next:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="nx">indexRouter</code><code class="p">);</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="s1">'/users'</code><code class="p">,</code> <code class="nx">usersRouter</code><code class="p">);</code></pre>
        
        <p>The top-level web request (<em>/</em>) is directed to the  <code>routes</code> module, while all user requests (<em>/users</em>) get routed to the <code>users</code> module.</p>
        <div data-type="note" epub:type="note"><h6>Note</h6>
        <p>Read more about routing with Express in <a data-type="xref" href="#express-routing">“Routing”</a>.</p>
        </div>
        
        <p>What follows is the error handling. First up is <code>404</code> error handling when a request is made to a nonexistent web resource:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
          <code class="nx">next</code><code class="p">(</code><code class="nx">createError</code><code class="p">(</code><code class="mi">404</code><code class="p">));</code>
        <code class="p">});</code></pre>
        
        <p>Next comes the server error handling, for both production and development:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
          <code class="c1">// set locals, only providing error in development</code>
          <code class="nx">res</code><code class="p">.</code><code class="nx">locals</code><code class="p">.</code><code class="nx">message</code> <code class="o">=</code> <code class="nx">err</code><code class="p">.</code><code class="nx">message</code><code class="p">;</code>
          <code class="nx">res</code><code class="p">.</code><code class="nx">locals</code><code class="p">.</code><code class="nx">error</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'env'</code><code class="p">)</code> <code class="o">===</code> <code class="s1">'development'</code> <code class="o">?</code> <code class="nx">err</code> <code class="o">:</code> <code class="p">{};</code>
        
          <code class="c1">// render the error page</code>
          <code class="nx">res</code><code class="p">.</code><code class="nx">status</code><code class="p">(</code><code class="nx">err</code><code class="p">.</code><code class="nx">status</code> <code class="o">||</code> <code class="mi">500</code><code class="p">);</code>
          <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'error'</code><code class="p">);</code>
        <code class="p">});</code></pre>
        
        <p>The last line of the generated file is the <code>module.exports</code> for the <code>app</code>:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="nx">app</code><code class="p">;</code></pre>
        
        <p>In the <em>routes</em> subdirectory, the default routing is included in the <em>routes/index.js</em> file:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kd">var</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">);</code>
        <code class="kd">var</code> <code class="nx">router</code> <code class="o">=</code> <code class="nx">express</code><code class="p">.</code><code class="nx">Router</code><code class="p">();</code>
        
        <code class="cm">/* GET home page. */</code>
        <code class="nx">router</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
          <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'index'</code><code class="p">,</code> <code class="p">{</code> <code class="nx">title</code><code class="o">:</code> <code class="s1">'Express'</code> <code class="p">});</code>
        <code class="p">});</code>
        
        <code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="nx">router</code><code class="p">;</code></pre>
        
        <p>What’s happening in the file is the Express router is used to route any HTTP GET requests to <code>/</code> to a callback where the request response receives a view rendered for the specific resource page. This is in contrast to what happens in the <em>routes/users.js</em> file, where the response receives a text message rather than a view:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kd">var</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">);</code>
        <code class="kd">var</code> <code class="nx">router</code> <code class="o">=</code> <code class="nx">express</code><code class="p">.</code><code class="nx">Router</code><code class="p">();</code>
        
        <code class="cm">/* GET users listing. */</code>
        <code class="nx">router</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
          <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="s1">'respond with a resource'</code><code class="p">);</code>
        <code class="p">});</code>
        
        <code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="nx">router</code><code class="p">;</code></pre>
        
        <p>What happens with the view rendering in the first request? There are three Pug files in the <em>views</em> subdirectory: one for error handling, one defining the page layout, and one, <em>index.pug</em>, that renders the page. The <em>index.pug</em> file contains:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">extends</code> <code class="nx">layout</code>
        
        <code class="nx">block</code> <code class="nx">content</code>
          <code class="nx">h1</code><code class="o">=</code> <code class="nx">title</code>
          <code class="nx">p</code> <code class="nx">Welcome</code> <code class="nx">to</code> <code class="err">#</code><code class="p">{</code><code class="nx">title</code><code class="p">}</code></pre>
        
        <p>It extends the <em>layout.pug</em> file, which contains:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">doctype</code> <code class="nx">html</code>
        <code class="nx">html</code>
          <code class="nx">head</code>
            <code class="nx">title</code><code class="o">=</code> <code class="nx">title</code>
            <code class="nx">link</code><code class="p">(</code><code class="nx">rel</code><code class="o">=</code><code class="s1">'stylesheet'</code><code class="p">,</code> <code class="nx">href</code><code class="o">=</code><code class="s1">'/stylesheets/style.css'</code><code class="p">)</code>
          <code class="nx">body</code>
            <code class="nx">block</code> <code class="nx">content</code></pre>
        
        <p>The <em>layout.pug</em> file defines the overall structure of the page, regardless of content, including a reference to an automatically generated CSS file. The <code>block content</code> setting defines where the location of the content is placed. The format for the content is defined in <em>index.js</em>, in the equivalently named <code>block content</code> setting.</p>
        <div data-type="note" epub:type="note"><h6>Note</h6>
        <p>The Pug templating engine (formerly known as Jade) was popularized by Express and offers a minimalist take on templating that makes use of whitespace in place of traditional HTML style tags. This approach may not be for everyone, and the Pug alternatives (Handlebars, Hogan.js, and EJS) all offer a more HTML-like <span class="keep-together">syntax</span>.</p>
        </div>
        
        <p>The two Pug files define a basic web page with an <code>h1</code> element assigned a title variable, and a paragraph with a welcome message. <a data-type="xref" href="#page_using_default_settings">Figure&nbsp;21-1</a> shows the default page.<a data-type="indexterm" data-primary="" data-startref="ix_Pug_template" id="idm45475118979208"></a></p>
        
        <figure class="no-frame"><div id="page_using_default_settings" class="figure">
        <img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492055747/files/assets/jsc3_2101.png" alt="jsc3 2101" width="1445" height="725">
        <h6><span class="label">Figure 21-1. </span>The Express-generated web page</h6>
        </div></figure>
        
        <p><a data-type="xref" href="#page_using_default_settings">Figure&nbsp;21-1</a> shows that the page isn’t especially fascinating, but it does represent how the pieces are holding together: the application router routes the request to the appropriate route module, which directs the response to the appropriate rendered view, and the rendered view uses data passed to it to generate the web page. If you make the following web request:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">http</code><code class="o">:</code><code class="c1">//yourdomain.com:3000/users</code></pre>
        
        <p>you’ll see the plain text message, rather than the rendered view.<a data-type="indexterm" data-primary="" data-startref="ix_express_generator" id="idm45475118959080"></a></p>
        
        <p><a data-type="indexterm" data-primary="development mode" id="idm45475118972856"></a>By default, Express is set up to run in <em>development mode</em>. To change the application to <em>production mode</em>, you need to set an <em>environment variable</em>, <code>NODE-ENV</code> to “production.” In a Linux or Unix environment, the following could be used:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">$</code> <code class="kr">export</code> <code class="nx">NODE_ENV</code><code class="o">=</code><code class="nx">production</code></pre>
        </div></section>
        
        
        
        
        
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect1" data-pdf-bookmark="Routing"><div class="sect1" id="express-routing">
        <h1>Routing</h1>
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45475119846008">
        <h2>Problem</h2>
        
        <p><a data-type="indexterm" data-primary="routing, Express" id="ix_routing_express"></a><a data-type="indexterm" data-primary="Express framework" data-secondary="routing" id="ix_express_routing"></a>You want to route users to different resources in your application based on the request.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45475118920552">
        <h2>Solution</h2>
        
        <p>Use routes in Express to send specific resources based on the request path and parameters:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="c1">// respond with different route paths</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="s1">'Hello World'</code><code class="p">));</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/users'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="s1">'Hello users'</code><code class="p">));</code>
        
        <code class="c1">// parameters</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/users/:userId'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="sb">`Hello user </code><code class="si">${</code><code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">userId</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
        <code class="p">});</code></pre>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45475118929016">
        <h2>Discussion</h2>
        
        <p>In Express, we can return a response to the user when they make an HTTP request. In the above examples, I’m using <code>get</code> requests, but Express supports a number of additional methods. The most common of these methods are:</p>
        
        <ul>
        <li>
        <p><code>app.get</code>: request data</p>
        </li>
        <li>
        <p><code>app.post</code>: send data</p>
        </li>
        <li>
        <p><code>app.put</code>:  send or update data</p>
        </li>
        <li>
        <p><code>app.delete</code>: delete data</p>
        </li>
        </ul>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">app</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'/new'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="s1">'POST request to the `new` route'</code><code class="p">);</code>
        <code class="p">});</code></pre>
        
        <p>Often we may want to enable multiple HTTP methods to a specific route. We can accomplish this by chaining them together:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">app</code>
          <code class="p">.</code><code class="nx">route</code><code class="p">(</code><code class="s1">'/record'</code><code class="p">)</code>
          <code class="p">.</code><code class="nx">get</code><code class="p">((</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
            <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="s1">'Get a record'</code><code class="p">);</code>
          <code class="p">})</code>
          <code class="p">.</code><code class="nx">post</code><code class="p">((</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
            <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="s1">'Add a record'</code><code class="p">);</code>
          <code class="p">})</code>
          <code class="p">.</code><code class="nx">put</code><code class="p">((</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
            <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="s1">'Update a record'</code><code class="p">);</code>
          <code class="p">});</code></pre>
        
        <p>Often requests have parameters with specific values that we will make use of in our application. We can specify these in the URL using a colon (<code>:</code>):</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/users/:userId'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="sb">`Hello user </code><code class="si">${</code><code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">userId</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
        <code class="p">});</code></pre>
        
        <p>In the above example, when a user visits a URL at <em>/users/adam123</em>, the browser will send the response of <code>Hello user adam123</code>.  While this is a simple example, we could also make use of the URL parameter to retrieve data from our database, passing the information on to a template.</p>
        
        <p>We’re also able to specify formats for the request parameters. In the following example, I make use of a regular expression to limit the <code>noteId</code> parameter to a six-digit integer:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'^/users/:userId/notes/:noteId([0-9]{6})'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="sb">`This is note </code><code class="si">${</code><code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">noteId</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
        <code class="p">});</code></pre>
        
        <p>We are also able to use a regular expression to define an entire route:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="sr">/.*day$/</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="sb">`Every day feels like </code><code class="si">${</code><code class="nx">req</code><code class="p">.</code><code class="nx">path</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
        <code class="p">});</code></pre>
        
        <p>The above example will route any request ending in <code>day</code>. For example, in local development a request to <em>http://localhost:3000/Sunday</em> will result in “Every day feels like Sunday” being printed to the page.<a data-type="indexterm" data-primary="" data-startref="ix_express_routing" id="idm45475118551352"></a><a data-type="indexterm" data-primary="" data-startref="ix_routing_express" id="idm45475118511784"></a></p>
        </div></section>
        
        
        
        
        
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect1" data-pdf-bookmark="Working with OAuth"><div class="sect1" id="idm45475118928424">
        <h1>Working with OAuth</h1>
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45475118509864">
        <h2>Problem</h2>
        
        <p><a data-type="indexterm" data-primary="OAuth framework" id="ix_oauth_frame"></a><a data-type="indexterm" data-primary="Express framework" data-secondary="OAuth" id="ix_express_oauth"></a>You need access to a third-party API (such as GitHub, Facebook, or Twitter) in your Node application, but it requires authorization. Specifically, it requires OAuth <span class="keep-together">authorization.</span></p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45475118505256">
        <h2>Solution</h2>
        
        <p>You’ll need to incorporate an OAuth client in your application. You’ll also need to meet the OAuth requirements demanded by the resource provider.</p>
        
        <p>See the discussion for details.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45475118503096">
        <h2>Discussion</h2>
        
        <p>OAuth is an authorization framework used with most popular social media and cloud content applications. If you’ve ever gone to a site and it’s asked you to authorize access to data from a third-party service, such as GitHub, you’ve participated in the OAuth authorization <em>flow</em>.</p>
        
        <p>There are two versions of OAuth, 1.0 and 2.0, which are not compatible with one another. OAuth 1.0 was based on proprietary APIs developed by Flickr and Google, was heavily web page focused, and didn’t gracefully transcend the barrier among web, mobile, and service applications. When wanting to access resources in a mobile phone app, the app would have the user log in to the app in a mobile browser and then copy access tokens to the app. Other criticisms of OAuth 1.0 is that the process required that the authorization server be the same as the resource server, which doesn’t scale when you’re talking about service providers such as Twitter, Facebook, and Amazon.</p>
        
        <p>OAuth 2.0 presents a simpler authorization process, and also provides different types of authorization (different flows) for different circumstances. Some would say, though, that it does so at the cost of security, as it doesn’t have the same demands for encrypting hash tokens and request strings.</p>
        
        <p>Most developers  won’t have to create an OAuth 2.0 server, and doing so is way beyond the scope of this book, much less this recipe. But it’s common for applications to incorporate an OAuth client (1.0 or 2.0) for one service or another, so I’m going to present different types of OAuth use. First, though, let’s discuss the differences between authorization and authentication.</p>
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect3" data-pdf-bookmark="Authorization isn’t authentication"><div class="sect3" id="idm45475118498008">
        <h3>Authorization isn’t authentication</h3>
        
        <p><a data-type="indexterm" data-primary="OAuth framework" data-secondary="authorization versus authentication" id="idm45475118496600"></a><a data-type="indexterm" data-primary="authentication" data-secondary="versus authorization" data-secondary-sortas="authorization" id="idm45475118495656"></a><a data-type="indexterm" data-primary="Facebook" id="idm45475118494440"></a>Authorization is saying, “I authorize this application to access my resources on your server.” Authentication is the process of authenticating whether you are, indeed, the person who owns this account and has control over these resources. An example would be if I want to comment on an article at a newspaper’s online site. It will likely ask me to log in via some service. If I pick my Facebook account to use as the login, the news site will most likely want some data from Facebook.</p>
        
        <p>The news site is, first, authenticating me as a legitimate Facebook user, with an established Facebook account. In other words, I’m not just some random person coming in and commenting anonymously. Secondly, the news site wants something from me in exchange for the privilege of commenting: it’s going to want data about me. Perhaps it will ask for permission to post for me (if I post my comment to Facebook as well as the news site). This is both an authentication and an authorization request.</p>
        
        <p>If I’m not already logged in to Facebook, I’ll have to log in. Facebook is using my correct application of username and password to authenticate that, yes, I own the Facebook account in question. Once logged in, Facebook asks whether I agree to giving the newspaper site the authorization to access the resources it wants. If I agree (because I desperately want to comment on a particular story), Facebook gives the news site the authorization, and there’s now a persistent connection from the newspaper to my Facebook account (which you can see in your Facebook settings). I can make my comment, and make comments at other stories, until I log out or revoke the Facebook authorization.</p>
        
        <p>Of course, none of this implies that Facebook or the news site are actually authenticating who I am. Authentication, in this case, is about establishing that I am the owner of the Facebook account. The only time <em>real</em> authentication enters the picture is in a social media context such as Twitter’s authenticated accounts for celebrities.</p>
        
        <p>Our development task is made simpler by the fact that software to handle authorization is frequently the same software that authenticates the individual, so we’re not having to deal with two different JavaScript libraries/modules/systems. There are also several excellent OAuth (1.0 and 2.0) modules we can use in Node applications. One of the most popular is <a href="http://www.passportjs.org">Passport</a>, and there are extensions for various authorization services created specifically for the Passport system. However, there are also very simple OAuth clients that provide barebones authorization access for a variety of services, and some modules that are created specifically for one service.</p>
        <div data-type="note" epub:type="note"><h6>Note</h6>
        <p>Passport.js is covered in <a data-type="xref" href="#redirect-auth">“OAuth 2 User Authentication with Passport.js”</a>. You can also read more about Passport and its various <em>strategies</em> supporting different servers at its website.</p>
        </div>
        
        <p>Now, on to the technology.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect3" data-pdf-bookmark="Client Credentials Grant"><div class="sect3" id="client_credentials_grant">
        <h3>Client Credentials Grant</h3>
        
        <p><a data-type="indexterm" data-primary="OAuth framework" data-secondary="Client Credentials Grant" id="ix_oauth_frame_client_cred"></a><a data-type="indexterm" data-primary="Client Credentials Grant" id="ix_client_cred"></a>There are few web resources that nowadays provide an API you can access without having some kind of authorization credential. This means having to incorporate a round-trip directive to the end users—asking them to authorize access to their account at the service before the application can access data. The problem is that sometimes all you need is simple read-only access without update privileges, without a frontend login interface, and without having a specific user make an authorizing grant.</p>
        
        <p>OAuth 2.0 accounts for this particular type of authorizing flow with the <em>Client Credentials Grant</em>. The diagram for this simplified authorization is shown in <a data-type="xref" href="#client_credentials_grant_img">Figure&nbsp;21-2</a>.</p>
        
        <figure><div id="client_credentials_grant_img" class="figure">
        <img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492055747/files/assets/jsc3_2102.png" alt="jsc3 2102" width="779" height="193">
        <h6><span class="label">Figure 21-2. </span>The Client Credentials Grant authorization flow</h6>
        </div></figure>
        
        <p><a data-type="indexterm" data-primary="Node" data-secondary="Twitter API" id="ix_node_twitter_api"></a><a data-type="indexterm" data-primary="web apps/APIs" data-secondary="Twitter API" id="ix_web_app_twitter"></a><a data-type="indexterm" data-primary="Twitter API" id="ix_twitter_api"></a><a data-type="indexterm" data-primary="application-only authentication" id="idm45475118451032"></a>Twitter provides what it calls application-only authorization, which is based on OAuth 2.0’s Client Credentials Grant. We can use this type of authorization to access Twitter’s Search API.</p>
        
        <p>In the following example, I used the Node module <code>oauth</code> to implement the authorization. It’s the most basic of the authorization modules, and supports both OAuth 1.0 and OAuth 2.0 authorization flows:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">OAuth</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'oauth'</code><code class="p">);</code>
        <code class="kr">const</code> <code class="nx">fetch</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'node-fetch'</code><code class="p">);</code>
        <code class="kr">const</code> <code class="p">{</code> <code class="nx">promisify</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'util'</code><code class="p">);</code>
        
        <code class="c1">// read Twitter keys from a .env file</code>
        <code class="nx">require</code><code class="p">(</code><code class="s1">'dotenv'</code><code class="p">).</code><code class="nx">config</code><code class="p">();</code>
        
        <code class="c1">// Twitter's search API endpoint and the query we'll be searching</code>
        <code class="kr">const</code> <code class="nx">endpointUrl</code> <code class="o">=</code> <code class="s1">'https://api.twitter.com/2/tweets/search/recent'</code><code class="p">;</code>
        <code class="kr">const</code> <code class="nx">query</code> <code class="o">=</code> <code class="s1">'javascript'</code><code class="p">;</code>
        
        <code class="nx">async</code> <code class="kd">function</code> <code class="nx">getTweets</code><code class="p">()</code> <code class="p">{</code>
          <code class="c1">// consumer key and secret passed in from environment variables</code>
          <code class="kr">const</code> <code class="nx">oauth2</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">OAuth</code><code class="p">.</code><code class="nx">OAuth2</code><code class="p">(</code>
            <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">TWITTER_CONSUMER_KEY</code><code class="p">,</code>
            <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">TWITTER_CONSUMER_SECRET</code><code class="p">,</code>
            <code class="s1">'https://api.twitter.com/'</code><code class="p">,</code>
            <code class="kc">null</code><code class="p">,</code>
            <code class="s1">'oauth2/token'</code><code class="p">,</code>
            <code class="kc">null</code>
          <code class="p">);</code>
        
          <code class="c1">// retrieve the credentials from Twitter</code>
          <code class="kr">const</code> <code class="nx">getOAuthAccessToken</code> <code class="o">=</code> <code class="nx">promisify</code><code class="p">(</code>
            <code class="nx">oauth2</code><code class="p">.</code><code class="nx">getOAuthAccessToken</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="nx">oauth2</code><code class="p">)</code>
          <code class="p">);</code>
          <code class="kr">const</code> <code class="nx">token</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">getOAuthAccessToken</code><code class="p">(</code><code class="s1">''</code><code class="p">,</code> <code class="p">{</code>
            <code class="nx">grant_type</code><code class="o">:</code> <code class="s1">'client_credentials'</code>
          <code class="p">});</code>
        
          <code class="c1">// make the request for data with the retrieved token</code>
          <code class="kr">const</code> <code class="nx">res</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">fetch</code><code class="p">(</code><code class="sb">`</code><code class="si">${</code><code class="nx">endpointUrl</code><code class="si">}</code><code class="sb">?query=</code><code class="si">${</code><code class="nx">query</code><code class="si">}</code><code class="sb">`</code><code class="p">,</code> <code class="p">{</code>
            <code class="nx">headers</code><code class="o">:</code> <code class="p">{</code>
              <code class="nx">authorization</code><code class="o">:</code> <code class="sb">`Bearer </code><code class="si">${</code><code class="nx">token</code><code class="si">}</code><code class="sb">`</code>
            <code class="p">}</code>
          <code class="p">});</code>
        
          <code class="kr">const</code> <code class="nx">json</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">res</code><code class="p">.</code><code class="nx">json</code><code class="p">();</code>
          <code class="k">return</code> <code class="nx">json</code><code class="p">;</code>
        <code class="p">}</code>
        
        <code class="p">(</code><code class="nx">async</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="k">try</code> <code class="p">{</code>
            <code class="c1">// Make request</code>
            <code class="kr">const</code> <code class="nx">response</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">getTweets</code><code class="p">();</code>
            <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">response</code><code class="p">);</code>
          <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
            <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">e</code><code class="p">);</code>
            <code class="nx">process</code><code class="p">.</code><code class="nx">exit</code><code class="p">(</code><code class="o">-</code><code class="mi">1</code><code class="p">);</code>
          <code class="p">}</code>
          <code class="nx">process</code><code class="p">.</code><code class="nx">exit</code><code class="p">();</code>
        <code class="p">})();</code></pre>
        
        <p>To use the Twitter authorization API, the client application has to register its application with Twitter. Twitter provides both a <em>consumer key</em> and a <em>consumer secret</em>.</p>
        
        <p>Using the <code>oauth</code> module, a new OAuth2 object is created, passing in:</p>
        
        <ul>
        <li>
        <p>Consumer key</p>
        </li>
        <li>
        <p>Consumer secret</p>
        </li>
        <li>
        <p>API base URI (API URI minus the query string)</p>
        </li>
        <li>
        <p>A value of null signals OAuth to use the default <em>/oauth/authorize</em></p>
        </li>
        <li>
        <p>The access token path</p>
        </li>
        <li>
        <p>Null, because we’re not using any custom headers</p>
        </li>
        </ul>
        
        <p>The <code>oauth</code> module takes this data and forms a POST request to Twitter, passing along the consumer key and secret, as well as providing a <em>scope</em> for the request. Twitter’s documentation provides an example POST request for an access token (line breaks inserted for readability):</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">POST</code> <code class="o">/</code><code class="nx">oauth2</code><code class="o">/</code><code class="nx">token</code> <code class="nx">HTTP</code><code class="o">/</code><code class="mf">1.1</code>
        <code class="nx">Host</code><code class="o">:</code> <code class="nx">api</code><code class="p">.</code><code class="nx">twitter</code><code class="p">.</code><code class="nx">com</code>
        <code class="nx">User</code><code class="o">-</code><code class="nx">Agent</code><code class="o">:</code> <code class="nx">My</code> <code class="nx">Twitter</code> <code class="nx">App</code> <code class="nx">v1</code><code class="p">.</code><code class="mf">0.23</code>
        <code class="nx">Authorization</code><code class="o">:</code> <code class="nx">Basic</code> <code class="nx">eHZ6MWV2RlM0d0VFUFRHRUZQSEJvZzpMOHFxOVBaeVJn</code>
                        <code class="nx">NmllS0dFS2hab2xHQzB2SldMdzhpRUo4OERSZHlPZw</code><code class="o">==</code>
                        <code class="nx">Content</code><code class="o">-</code><code class="nx">Type</code><code class="o">:</code> <code class="nx">application</code><code class="o">/</code><code class="nx">x</code><code class="o">-</code><code class="nx">www</code><code class="o">-</code><code class="nx">form</code><code class="o">-</code><code class="nx">urlencoded</code><code class="p">;</code><code class="nx">charset</code><code class="o">=</code><code class="nx">UTF</code><code class="o">-</code><code class="mi">8</code>
        <code class="nx">Content</code><code class="o">-</code><code class="nx">Length</code><code class="o">:</code> <code class="mi">29</code>
        <code class="nx">Accept</code><code class="o">-</code><code class="nx">Encoding</code><code class="o">:</code> <code class="nx">gzip</code>
        
        <code class="nx">grant_type</code><code class="o">=</code><code class="nx">client_credentials</code></pre>
        
        <p>The response includes the access token (again, line breaks for readability):</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">HTTP</code><code class="o">/</code><code class="mf">1.1</code> <code class="mi">200</code> <code class="nx">OK</code>
        <code class="nx">Status</code><code class="o">:</code> <code class="mi">200</code> <code class="nx">OK</code>
        <code class="nx">Content</code><code class="o">-</code><code class="nx">Type</code><code class="o">:</code> <code class="nx">application</code><code class="o">/</code><code class="nx">json</code><code class="p">;</code> <code class="nx">charset</code><code class="o">=</code><code class="nx">utf</code><code class="o">-</code><code class="mi">8</code>
        <code class="p">...</code>
        <code class="nx">Content</code><code class="o">-</code><code class="nx">Encoding</code><code class="o">:</code> <code class="nx">gzip</code>
        <code class="nx">Content</code><code class="o">-</code><code class="nx">Length</code><code class="o">:</code> <code class="mi">140</code>
        
        <code class="p">{</code><code class="s2">"token_type"</code><code class="o">:</code><code class="s2">"bearer"</code><code class="p">,</code><code class="s2">"access_token"</code><code class="o">:</code><code class="s2">"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</code>
        <code class="s2">%2FAAAAAAAAAAAAAAAAAAAA%3DAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"</code><code class="p">}</code></pre>
        
        <p>The access token has to be used with any of the API requests. There are no further authorization steps, so the process is very simple. In addition, since the authorization is at the application level, it doesn’t require an individual’s authorization, making it less disruptive to the user.<a data-type="indexterm" data-primary="" data-startref="ix_client_cred" id="idm45475117982888"></a><a data-type="indexterm" data-primary="" data-startref="ix_oauth_frame_client_cred" id="idm45475117982040"></a></p>
        <div data-type="note" epub:type="note"><h6>Note</h6>
        <p>Twitter provides wonderful documentation. I recommend reading the <a href="https://oreil.ly/Mikyl">“Application-only authentication overview”</a>.</p>
        </div>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect3" data-pdf-bookmark="Read/write authorization with OAuth 1.0"><div class="sect3" id="access_twitter_with_oauth1">
        <h3>Read/write authorization with OAuth 1.0</h3>
        
        <p><a data-type="indexterm" data-primary="read/write authorization, OAuth 1.0" id="ix_read-write_oauth"></a><a data-type="indexterm" data-primary="OAuth framework" data-secondary="read/write authorization" id="ix_oauth_frame_read-write"></a>Application-Only authentication is great for accessing read-only data, but what if you want to access a user’s specific data, or even make a change to their data? Then you’ll need the full OAuth authorization. In this section, we’ll again use Twitter for the demonstration because of its use of OAuth 1.0 authorization. In the next recipe, we’ll look at OAuth 2.0.</p>
        <div data-type="note" epub:type="note"><h6>Note</h6>
        <p>I refer to it as OAuth 1.0, but Twitter’s service is based on <a href="http://oauth.net/core/1.0a">OAuth Core 1.0 Revision A</a>. However, it’s a lot easier just to say OAuth 1.0.</p>
        </div>
        
        <p>OAuth 1.0 requires a digital signature. The steps to derive this digital signature, graphically represented in <a data-type="xref" href="#oauth_one_flow">Figure&nbsp;21-3</a>, and as outlined by Twitter, are:</p>
        <ol>
        <li>
        <p>Collect the HTTP method and the base URI, minus any query string.</p>
        </li>
        <li>
        <p>Collect the parameters, including the consumer key, request data, nonce, signature method, and so on.</p>
        </li>
        <li>
        <p>Create a signature base string, which consists of the data we’ve gathered, formed into a string in a precise manner, and encoded just right.</p>
        </li>
        <li>
        <p>Create a signing key, which is a combination of consumer key and OAuth token secret, again combined in a precise manner.</p>
        </li>
        <li>
        <p>Pass the signature base string and the signing key to an HMAC-SHA1 hashing algorithm, which returns a binary string that needs further encoding.</p>
        </li>
        
        </ol>
        
        <figure><div id="oauth_one_flow" class="figure">
        <img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492055747/files/assets/jsc3_2103.png" alt="jsc3 2103" width="941" height="423">
        <h6><span class="label">Figure 21-3. </span>OAuth 1.0 authorization flow</h6>
        </div></figure>
        
        <p>You have to follow this process for <em>every</em> request. Thankfully, we have modules and libraries that do all of this mind-numbing work for us. I don’t know about you, but if I had to do this, my interest in incorporating Twitter data and services into my application would quickly wane.</p>
        
        <p>Our friend <code>oauth</code> provides the underlying OAuth 1.0 support, but we don’t have to code to it directly this time. Another module, <code>node-twitter-api</code>, has wrapped all of the OAuth pieces. All we need do is create a new <code>node-twitter-api</code> object, passing in our consumer key and secret, as well as the callback/redirect URL required by the resource services, as part of the authorization process. Processing the <code>request</code> object in that URL provides us the access token and secret we need for API access. Every time we make a request, we pass in the access token and secret.</p>
        
        <p>The <code>twitter-node-api</code> module is a thin wrapper around the REST API: to make a request, we extrapolate what the function is from the API. If we’re interested in posting a status update, the REST API endpoint is:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">https</code><code class="o">:</code><code class="c1">//api.twitter.com/1.1/statuses/update.json</code></pre>
        
        <p>The <code>twitter-node-api</code> object instance function is <code>statuses()</code>, and the first parameter is the verb, <code>update</code>:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"> <code class="nx">twitter</code><code class="p">.</code><code class="nx">statuses</code><code class="p">(</code><code class="s1">'update'</code><code class="p">,</code> <code class="p">{</code>
                <code class="s2">"status"</code><code class="o">:</code> <code class="s2">"Hi from Shelley's Toy Box. (Ignore--developing Node app)"</code>
                <code class="p">},</code> <code class="nx">atoken</code><code class="p">,</code> <code class="nx">atokensec</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">data</code><code class="p">,</code> <code class="nx">response</code><code class="p">)</code> <code class="p">{...});</code>
        
        <code class="nx">twitter</code><code class="p">.</code><code class="nx">statuses</code><code class="p">(</code>
          <code class="s1">'update'</code><code class="p">,</code>
          <code class="p">{</code>
            <code class="nx">status</code><code class="o">:</code> <code class="s1">'Ignore learning OAuth with Node'</code>
          <code class="p">},</code>
          <code class="nx">tokenValues</code><code class="p">.</code><code class="nx">atoken</code><code class="p">,</code>
          <code class="nx">tokenValues</code><code class="p">.</code><code class="nx">atokensec</code><code class="p">,</code>
          <code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code> <code class="p">...</code> <code class="p">});</code></pre>
        
        <p>The callback function arguments include any possible error, requested data (if any), and the raw response.</p>
        
        <p>A complete example is shown in <a data-type="xref" href="#complete_twitter_app_using_oauth">Example&nbsp;21-1</a>. It uses Express as a server  and provides a primitive web page for the user, and then uses another module.</p>
        <div id="complete_twitter_app_using_oauth" data-type="example">
        <h5><span class="label">Example 21-1. </span>Twitter app fully authorized via OAuth 1.0</h5>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">);</code>
        <code class="kr">const</code> <code class="nx">TwitterAPI</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'node-twitter-api'</code><code class="p">);</code>
        
        <code class="nx">require</code><code class="p">(</code><code class="s1">'dotenv'</code><code class="p">).</code><code class="nx">config</code><code class="p">();</code>
        
        <code class="kr">const</code> <code class="nx">port</code> <code class="o">=</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code> <code class="o">||</code> <code class="s1">'8080'</code><code class="p">;</code>
        
        <code class="c1">// keys and callback URL are configured in the Twitter Dev Center</code>
        <code class="kr">const</code> <code class="nx">twitter</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">TwitterAPI</code><code class="p">({</code>
          <code class="nx">consumerKey</code><code class="o">:</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">TWITTER_CONSUMER_KEY</code><code class="p">,</code>
          <code class="nx">consumerSecret</code><code class="o">:</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">TWITTER_CONSUMER_SECRET</code><code class="p">,</code>
          <code class="nx">callback</code><code class="o">:</code> <code class="s1">'http://127.0.0.1:8080/oauth/callback'</code>
        <code class="p">});</code>
        
        <code class="c1">// object for storing retrieved token values</code>
        <code class="kr">const</code> <code class="nx">tokenValues</code> <code class="o">=</code> <code class="p">{};</code>
        
        <code class="c1">// twitter OAuth API URL</code>
        <code class="kr">const</code> <code class="nx">twitterAPI</code> <code class="o">=</code> <code class="s1">'https://api.twitter.com/oauth/authenticate'</code><code class="p">;</code>
        
        <code class="c1">// simple HTML template</code>
        <code class="kr">const</code> <code class="nx">menu</code> <code class="o">=</code>
          <code class="s1">'&lt;a href="/post/status/"&gt;Say hello&lt;/a&gt;&lt;br /&gt;'</code> <code class="o">+</code>
          <code class="s1">'&lt;a href="/get/account/"&gt;Account Settings&lt;br /&gt;'</code><code class="p">;</code>
        
        <code class="c1">// Create a new Express application.</code>
        <code class="kr">const</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">express</code><code class="p">();</code>
        
        <code class="c1">// request Twitter permissions when the / route is visited</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">twitter</code><code class="p">.</code><code class="nx">getRequestToken</code><code class="p">((</code><code class="nx">error</code><code class="p">,</code> <code class="nx">requestToken</code><code class="p">,</code> <code class="nx">requestTokenSecret</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
            <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="p">{</code>
              <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`Error getting OAuth request token : </code><code class="si">${</code><code class="nx">error</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
              <code class="nx">res</code><code class="p">.</code><code class="nx">writeHead</code><code class="p">(</code><code class="mi">200</code><code class="p">);</code>
              <code class="nx">res</code><code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="sb">`Error getting authorization</code><code class="si">${</code><code class="nx">error</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
            <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
              <code class="nx">tokenValues</code><code class="p">.</code><code class="nx">token</code> <code class="o">=</code> <code class="nx">requestToken</code><code class="p">;</code>
              <code class="nx">tokenValues</code><code class="p">.</code><code class="nx">tokensec</code> <code class="o">=</code> <code class="nx">requestTokenSecret</code><code class="p">;</code>
              <code class="nx">res</code><code class="p">.</code><code class="nx">writeHead</code><code class="p">(</code><code class="mi">302</code><code class="p">,</code> <code class="p">{</code>
                <code class="nx">Location</code><code class="o">:</code> <code class="sb">`</code><code class="si">${</code><code class="nx">twitterAPI</code><code class="si">}</code><code class="sb">?oauth_token=</code><code class="si">${</code><code class="nx">requestToken</code><code class="si">}</code><code class="sb">`</code>
              <code class="p">});</code>
              <code class="nx">res</code><code class="p">.</code><code class="nx">end</code><code class="p">();</code>
            <code class="p">}</code>
          <code class="p">});</code>
        <code class="p">});</code>
        
        <code class="c1">// callback url as specified in the Twitter Developer Center</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/oauth/callback'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">twitter</code><code class="p">.</code><code class="nx">getAccessToken</code><code class="p">(</code>
            <code class="nx">tokenValues</code><code class="p">.</code><code class="nx">token</code><code class="p">,</code>
            <code class="nx">tokenValues</code><code class="p">.</code><code class="nx">tokensec</code><code class="p">,</code>
            <code class="nx">req</code><code class="p">.</code><code class="nx">query</code><code class="p">.</code><code class="nx">oauth_verifier</code><code class="p">,</code>
            <code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">accessToken</code><code class="p">,</code> <code class="nx">accessTokenSecret</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
              <code class="nx">res</code><code class="p">.</code><code class="nx">writeHead</code><code class="p">(</code><code class="mi">200</code><code class="p">);</code>
              <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="p">{</code>
                <code class="nx">res</code><code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="sb">`problems getting authorization with Twitter</code><code class="si">${</code><code class="nx">err</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
              <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
                <code class="nx">tokenValues</code><code class="p">.</code><code class="nx">atoken</code> <code class="o">=</code> <code class="nx">accessToken</code><code class="p">;</code>
                <code class="nx">tokenValues</code><code class="p">.</code><code class="nx">atokensec</code> <code class="o">=</code> <code class="nx">accessTokenSecret</code><code class="p">;</code>
                <code class="nx">res</code><code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="nx">menu</code><code class="p">);</code>
              <code class="p">}</code>
            <code class="p">}</code>
          <code class="p">);</code>
        <code class="p">});</code>
        
        <code class="c1">// post a status update from an authenticated and authorized users</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/post/status/'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">twitter</code><code class="p">.</code><code class="nx">statuses</code><code class="p">(</code>
            <code class="s1">'update'</code><code class="p">,</code>
            <code class="p">{</code>
              <code class="nx">status</code><code class="o">:</code> <code class="s1">'Ignore teaching OAuth with Node'</code>
            <code class="p">},</code>
            <code class="nx">tokenValues</code><code class="p">.</code><code class="nx">atoken</code><code class="p">,</code>
            <code class="nx">tokenValues</code><code class="p">.</code><code class="nx">atokensec</code><code class="p">,</code>
            <code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
              <code class="nx">res</code><code class="p">.</code><code class="nx">writeHead</code><code class="p">(</code><code class="mi">200</code><code class="p">);</code>
              <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="p">{</code>
                <code class="nx">res</code><code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="sb">`problems posting </code><code class="si">${</code><code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
              <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
                <code class="nx">res</code><code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="sb">`posting status: </code><code class="si">${</code><code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code><code class="si">}</code><code class="sb">&lt;br /&gt;</code><code class="si">${</code><code class="nx">menu</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
              <code class="p">}</code>
            <code class="p">}</code>
          <code class="p">);</code>
        <code class="p">});</code>
        
        <code class="c1">// get account details for an authenticated and authorized user</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/get/account/'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">twitter</code><code class="p">.</code><code class="nx">account</code><code class="p">(</code>
            <code class="s1">'settings'</code><code class="p">,</code>
            <code class="p">{},</code>
            <code class="nx">tokenValues</code><code class="p">.</code><code class="nx">atoken</code><code class="p">,</code>
            <code class="nx">tokenValues</code><code class="p">.</code><code class="nx">atokensec</code><code class="p">,</code>
            <code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
              <code class="nx">res</code><code class="p">.</code><code class="nx">writeHead</code><code class="p">(</code><code class="mi">200</code><code class="p">);</code>
              <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="p">{</code>
                <code class="nx">res</code><code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="sb">`problems getting account </code><code class="si">${</code><code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">err</code><code class="p">)</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
              <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
                <code class="nx">res</code><code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="sb">`&lt;p&gt;</code><code class="si">${</code><code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code><code class="si">}</code><code class="sb">&lt;/p&gt;</code><code class="si">${</code><code class="nx">menu</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
              <code class="p">}</code>
            <code class="p">}</code>
          <code class="p">);</code>
        <code class="p">});</code>
        
        <code class="nx">app</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="nx">port</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`Listening on port </code><code class="si">${</code><code class="nx">port</code><code class="si">}</code><code class="sb">!`</code><code class="p">));</code></pre></div>
        
        <p class="pagebreak-before less_space">The routes of interest in the app are:</p>
        
        <ul>
        <li>
        <p><code>/</code>: Page that triggers a redirect to Twitter for authorization</p>
        </li>
        <li>
        <p><code>/auth</code>: The callback or redirect URL registered with the app, and passed in the request</p>
        </li>
        <li>
        <p><code>/post/status/</code>: Post a status to the Twitter account</p>
        </li>
        <li>
        <p><code>/get/account/</code>: Get account information for the individual</p>
        </li>
        </ul>
        
        <p>In each case, the appropriate <code>node-twitter-api</code> function is used:</p>
        
        <ul>
        <li>
        <p><code>/</code>: Get a request token and request token secret, using <code>getRequestToken()</code></p>
        </li>
        <li>
        <p><code>/auth/</code>: Get the API access token and token secret, caching them locally, display menu</p>
        </li>
        <li>
        <p><code>/post/status/</code>: <code>status()</code> with <em>update</em> as first parameter, status, access token and secret, and callback function</p>
        </li>
        <li>
        <p><code>/get/account/</code>: <code>account()</code> with <em>settings</em> as the first parameter, an empty object, since no data is needed for the request, and the access token, secret, and callback</p>
        </li>
        </ul>
        
        <p><a data-type="indexterm" data-primary="authorization frameworks" id="ix_authorize_frame"></a>The Twitter authorization page that pops up is displayed in <a data-type="xref" href="#twitter_authorization_page">Figure&nbsp;21-4</a>, and the web page that displays account information for yours truly is displayed in <a data-type="xref" href="#twitter_account_data">Figure&nbsp;21-5</a>.</p>
        <div data-type="note" epub:type="note"><h6>Note</h6>
        <p>Though it is no longer actively maintained, you can read more about the <code>node-twitter-api</code> module at its <a href="https://github.com/reneraab/node-twitter-api">GitHub repository page</a>. Other libraries are more actively maintained and provide the same type of functionality, but I found <code>node-twitter-api</code> offers the simplest functional example for the purpose of demonstration.<a data-type="indexterm" data-primary="" data-startref="ix_oauth_frame_read-write" id="idm45475117276520"></a><a data-type="indexterm" data-primary="" data-startref="ix_read-write_oauth" id="idm45475117275576"></a><a data-type="indexterm" data-primary="" data-startref="ix_twitter_api" id="idm45475117274632"></a><a data-type="indexterm" data-primary="" data-startref="ix_node_twitter_api" id="idm45475117273688"></a><a data-type="indexterm" data-primary="" data-startref="ix_web_app_twitter" id="idm45475117272744"></a></p>
        </div>
        
        <figure class="no-frame"><div id="twitter_authorization_page" class="figure">
        <img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492055747/files/assets/jsc3_2104.png" alt="jsc3 2104" width="1445" height="792">
        <h6><span class="label">Figure 21-4. </span>Twitter authorization page, redirected from the recipe app</h6>
        </div></figure>
        
        <figure class="no-frame"><div id="twitter_account_data" class="figure">
        <img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492055747/files/assets/jsc3_2105.png" alt="jsc3 2105" width="1444" height="789">
        <h6><span class="label">Figure 21-5. </span>Display of Twitter user account data in app</h6>
        </div></figure>
        </div></section>
        
        
        
        </div></section>
        
        
        
        
        
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect1" data-pdf-bookmark="OAuth 2 User Authentication with Passport.js"><div class="sect1" id="redirect-auth">
        <h1>OAuth 2 User Authentication with Passport.js</h1>
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45475117266040">
        <h2>Problem</h2>
        
        <p><a data-type="indexterm" data-primary="Passport.js" id="ix_passport"></a><a data-type="indexterm" data-primary="OAuth framework" data-secondary="Passport.js for authentication" id="ix_oauth_frame_passport"></a><a data-type="indexterm" data-primary="authentication" data-secondary="Passport.js" id="ix_authent_passport"></a>You want to authenticate users in your application through a third-party service.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45475117261080">
        <h2>Solution</h2>
        
        <p>Use the Passport.js library paired with the appropriate strategy for the  authentication provider you’ve chosen. In this example, I’ll make use of the GitHub strategy, but the workflow will be identical for any OAuth 2 provider, including Facebook, Google, and Twitter.</p>
        
        <p><a data-type="indexterm" data-primary="GitHub" id="idm45475117258808"></a>You can make use of the GitHub strategy, first by visiting GitHub’s website and <a href="https://github.com/settings/applications/new">registering a new OAuth application</a>. Once the application is registered, you can integrate the Passport.js OAuth code into the application.</p>
        
        <p>To begin, configure the Passport strategy, which will include the GitHub-provided client ID and client secret, along with the callback URL that you have specified:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">);</code>
        <code class="kr">const</code> <code class="nx">passport</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'passport'</code><code class="p">);</code>
        <code class="kr">const</code> <code class="p">{</code> <code class="nx">Strategy</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'passport-github'</code><code class="p">);</code>
        
        <code class="nx">passport</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code>
          <code class="k">new</code> <code class="nx">Strategy</code><code class="p">(</code>
            <code class="p">{</code>
              <code class="nx">clientID</code><code class="o">:</code> <code class="nx">GITHUB_CLIENT_ID</code><code class="p">,</code>
              <code class="nx">clientSecret</code><code class="o">:</code> <code class="nx">GITHUB_CLIENT_SECRET</code><code class="p">,</code>
              <code class="nx">callbackURL</code><code class="o">:</code> <code class="s1">'login/github/callback'</code>
            <code class="p">},</code>
            <code class="p">(</code><code class="nx">accessToken</code><code class="p">,</code> <code class="nx">refreshToken</code><code class="p">,</code> <code class="nx">profile</code><code class="p">,</code> <code class="nx">cb</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
              <code class="k">return</code> <code class="nx">cb</code><code class="p">(</code><code class="kc">null</code><code class="p">,</code> <code class="nx">profile</code><code class="p">);</code>
            <code class="p">}</code>
          <code class="p">)</code>
        <code class="p">);</code></pre>
        
        <p>To restore authentication state across HTTP requests, Passport needs to serialize and deserialize users:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">passport</code><code class="p">.</code><code class="nx">serializeUser</code><code class="p">((</code><code class="nx">user</code><code class="p">,</code> <code class="nx">cb</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">cb</code><code class="p">(</code><code class="kc">null</code><code class="p">,</code> <code class="nx">user</code><code class="p">);</code>
        <code class="p">});</code>
        
        <code class="nx">passport</code><code class="p">.</code><code class="nx">deserializeUser</code><code class="p">((</code><code class="nx">obj</code><code class="p">,</code> <code class="nx">cb</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">cb</code><code class="p">(</code><code class="kc">null</code><code class="p">,</code> <code class="nx">obj</code><code class="p">);</code>
        <code class="p">});</code></pre>
        
        <p>To preserve user logins across browser sessions, make use of the <code>express-session</code> middleware:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code>
          <code class="nx">require</code><code class="p">(</code><code class="s1">'express-session'</code><code class="p">)({</code>
            <code class="nx">secret</code><code class="o">:</code> <code class="nx">SESSION_SECRET</code><code class="p">,</code>
            <code class="nx">resave</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
            <code class="nx">saveUninitialized</code><code class="o">:</code> <code class="kc">true</code>
          <code class="p">})</code>
        <code class="p">);</code>
        
        <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">passport</code><code class="p">.</code><code class="nx">session</code><code class="p">());</code></pre>
        
        <p>You can then authenticate requests using <code>passport.authenticate</code>:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">passport</code><code class="p">.</code><code class="nx">initialize</code><code class="p">());</code>
        
        <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/login/github'</code><code class="p">,</code> <code class="nx">passport</code><code class="p">.</code><code class="nx">authenticate</code><code class="p">(</code><code class="s1">'github'</code><code class="p">));</code>
        
        <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code>
          <code class="s1">'/login/github/callback'</code><code class="p">,</code>
          <code class="nx">passport</code><code class="p">.</code><code class="nx">authenticate</code><code class="p">(</code><code class="s1">'github'</code><code class="p">,</code> <code class="p">{</code> <code class="nx">failureRedirect</code><code class="o">:</code> <code class="s1">'/login'</code> <code class="p">}),</code>
          <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
            <code class="nx">res</code><code class="p">.</code><code class="nx">redirect</code><code class="p">(</code><code class="s1">'/'</code><code class="p">);</code>
          <code class="p">}</code>
        <code class="p">);</code></pre>
        
        <p>And reference the <code>user</code> object from requests:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'home'</code><code class="p">,</code> <code class="p">{</code> <code class="nx">user</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">user</code> <code class="p">});</code>
        <code class="p">});</code></pre>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45475116843256">
        <h2>Discussion</h2>
        
        <p>OAuth is an open standard for user authentication. It allows us to authenticate users through third-party applications. This can be useful when allowing users to easily create accounts and log in to your applications, as well as for authenticating to use data from a third-party source.</p>
        
        <p>OAuth requests follow a specific flow:</p>
        <ol>
        <li>
        <p>Your application makes an authorization request to the third-party service.</p>
        </li>
        <li>
        <p>The user approves that request.</p>
        </li>
        <li>
        <p>The service redirects the user back to your application, along with an authorization code.</p>
        </li>
        <li>
        <p>The application makes a request to the third-party service with the authorization code.</p>
        </li>
        <li>
        <p>The service responds with an access token (and optionally a refresh token).</p>
        </li>
        <li>
        <p>The application makes a request to the service with the access token.</p>
        </li>
        <li>
        <p>The service responds with the protected resource (in our case, the user account information).</p>
        </li>
        
        </ol>
        
        <p>Using Passport.js along with a Passport.js strategy for the OAuth provider simplifies this flow in an Express.js application. In this example, we’ll build a small Express application that authenticates with GitHub and persists user logins across sessions.</p>
        
        <p>Once we have registered our application with the service provider, we can begin development by installing the appropriate dependencies:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="err">#</code> <code class="nx">install</code> <code class="nx">general</code> <code class="nx">application</code> <code class="nx">dependencies</code>
        <code class="nx">npm</code> <code class="nx">install</code> <code class="nx">express</code> <code class="nx">pug</code> <code class="nx">dotenv</code>
        <code class="err">#</code> <code class="nx">install</code> <code class="nx">passport</code> <code class="nx">dependencies</code>
        <code class="nx">npm</code> <code class="nx">install</code> <code class="nx">passport</code> <code class="nx">passport</code><code class="o">-</code><code class="nx">github</code>
        <code class="err">#</code> <code class="nx">install</code> <code class="nx">persistent</code> <code class="nx">user</code> <code class="nx">session</code> <code class="nx">dependencies</code>
        <code class="nx">npm</code> <code class="nx">install</code> <code class="nx">connect</code><code class="o">-</code><code class="nx">ensure</code><code class="o">-</code><code class="nx">login</code> <code class="nx">express</code><code class="o">-</code><code class="nx">session</code></pre>
        
        <p>To store our OAuth client ID, client secret, and session secret values, we will use a <em>.env</em> file. Alternately, you could use a JavaScript file (such as a <em>config.js</em> file). It is critical that we not check this file into public source control, and I recommend adding it to your <em>.gitignore</em> file. In <em>.env</em>:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">GITHUB_CLIENT_ID</code><code class="o">=&lt;</code><code class="nx">Your</code> <code class="nx">client</code> <code class="nx">ID</code><code class="o">&gt;</code>
        <code class="nx">GITHUB_CLIENT_SECRET</code><code class="o">=&lt;</code><code class="nx">Your</code> <code class="nx">client</code> <code class="nx">secret</code><code class="o">&gt;</code>
        <code class="nx">SESSION_SECRET</code><code class="o">=&lt;</code><code class="nx">A</code> <code class="nx">session</code> <code class="nx">secret</code> <code class="o">-</code> <code class="k">this</code> <code class="nx">can</code> <code class="nx">be</code> <code class="nx">any</code> <code class="nx">value</code> <code class="nx">you</code> <code class="nx">decide</code><code class="o">&gt;</code></pre>
        
        <p>Next, we’ll set up our Express application with Passport.js. In <em>index.js</em>:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">);</code>
        <code class="kr">const</code> <code class="nx">passport</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'passport'</code><code class="p">);</code>
        <code class="kr">const</code> <code class="p">{</code> <code class="nx">Strategy</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'passport-github'</code><code class="p">);</code>
        
        <code class="nx">require</code><code class="p">(</code><code class="s1">'dotenv'</code><code class="p">).</code><code class="nx">config</code><code class="p">();</code>
        
        <code class="kr">const</code> <code class="nx">port</code> <code class="o">=</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code> <code class="o">||</code> <code class="s1">'3000'</code><code class="p">;</code>
        
        <code class="c1">// Configure the Passport strategy</code>
        <code class="nx">passport</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code>
          <code class="k">new</code> <code class="nx">Strategy</code><code class="p">(</code>
            <code class="p">{</code>
              <code class="nx">clientID</code><code class="o">:</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">GITHUB_CLIENT_ID</code><code class="p">,</code>
              <code class="nx">clientSecret</code><code class="o">:</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">GITHUB_CLIENT_SECRET</code><code class="p">,</code>
              <code class="nx">callbackURL</code><code class="o">:</code> <code class="sb">`http://localhost:</code><code class="si">${</code><code class="nx">port</code><code class="si">}</code><code class="sb">/login/github/callback`</code>
            <code class="p">},</code>
            <code class="p">(</code><code class="nx">accessToken</code><code class="p">,</code> <code class="nx">refreshToken</code><code class="p">,</code> <code class="nx">profile</code><code class="p">,</code> <code class="nx">cb</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
              <code class="k">return</code> <code class="nx">cb</code><code class="p">(</code><code class="kc">null</code><code class="p">,</code> <code class="nx">profile</code><code class="p">);</code>
            <code class="p">}</code>
          <code class="p">)</code>
        <code class="p">);</code>
        
        <code class="c1">// Serialize and deserialize the user</code>
        <code class="nx">passport</code><code class="p">.</code><code class="nx">serializeUser</code><code class="p">((</code><code class="nx">user</code><code class="p">,</code> <code class="nx">cb</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">cb</code><code class="p">(</code><code class="kc">null</code><code class="p">,</code> <code class="nx">user</code><code class="p">);</code>
        <code class="p">});</code>
        
        <code class="nx">passport</code><code class="p">.</code><code class="nx">deserializeUser</code><code class="p">((</code><code class="nx">obj</code><code class="p">,</code> <code class="nx">cb</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">cb</code><code class="p">(</code><code class="kc">null</code><code class="p">,</code> <code class="nx">obj</code><code class="p">);</code>
        <code class="p">});</code>
        
        <code class="c1">// create the Express application</code>
        <code class="kr">const</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">express</code><code class="p">();</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="s1">'views'</code><code class="p">,</code> <code class="sb">`</code><code class="si">${</code><code class="nx">__dirname</code><code class="si">}</code><code class="sb">/views`</code><code class="p">);</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="s1">'view engine'</code><code class="p">,</code> <code class="s1">'pug'</code><code class="p">);</code>
        
        <code class="c1">// use the Express session middleware for preserving user session</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code>
          <code class="nx">require</code><code class="p">(</code><code class="s1">'express-session'</code><code class="p">)({</code>
            <code class="nx">secret</code><code class="o">:</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">SESSION_SECRET</code><code class="p">,</code>
            <code class="nx">resave</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
            <code class="nx">saveUninitialized</code><code class="o">:</code> <code class="kc">true</code>
          <code class="p">})</code>
        <code class="p">);</code>
        
        <code class="c1">// Initialize passport and restore the authentication state from the session</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">passport</code><code class="p">.</code><code class="nx">initialize</code><code class="p">());</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">passport</code><code class="p">.</code><code class="nx">session</code><code class="p">());</code>
        
        <code class="c1">// listen on port 3000 or the PORT set as an environment variable</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="nx">port</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`Listening on port </code><code class="si">${</code><code class="nx">port</code><code class="si">}</code><code class="sb">!`</code><code class="p">));</code></pre>
        
        <p>You can then build your view templates, which can access the user data.</p>
        
        <p>In <em>views/home.pug</em>:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="k">if</code> <code class="o">!</code><code class="nx">user</code>
          <code class="nx">p</code> <code class="nx">Welcome</code><code class="o">!</code> <code class="nx">Please</code>
            <code class="nx">a</code><code class="p">(</code><code class="nx">href</code><code class="o">=</code><code class="s1">'/login/github'</code><code class="p">)</code> <code class="nx">Login</code> <code class="kd">with</code> <code class="nx">GitHub</code>
        <code class="k">else</code>
          <code class="nx">h1</code> <code class="nx">Hello</code> <code class="err">#</code><code class="p">{</code><code class="nx">user</code><code class="p">.</code><code class="nx">username</code><code class="p">}</code><code class="o">!</code>
          <code class="nx">p</code> <code class="nx">View</code> <code class="nx">your</code>
            <code class="nx">a</code><code class="p">(</code><code class="nx">href</code><code class="o">=</code><code class="s1">'/profile'</code><code class="p">)</code> <code class="nx">profile</code></pre>
        
        <p>In <em>views/login.pug</em>:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">h1</code> <code class="nx">Login</code>
        <code class="nx">a</code><code class="p">(</code><code class="nx">href</code><code class="o">=</code><code class="s1">'/login/github'</code><code class="p">)</code> <code class="nx">Login</code> <code class="kd">with</code> <code class="nx">GitHub</code></pre>
        
        <p>In <em>views/profile.pug</em>:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">h1</code> <code class="nx">Profile</code>
        <code class="nx">ul</code>
          <code class="nx">li</code> <code class="nx">ID</code><code class="o">:</code> <code class="err">#</code><code class="p">{</code><code class="nx">user</code><code class="p">.</code><code class="nx">id</code><code class="p">}</code>
          <code class="nx">li</code> <code class="nx">Name</code><code class="o">:</code> <code class="err">#</code><code class="p">{</code><code class="nx">user</code><code class="p">.</code><code class="nx">username</code><code class="p">}</code>
          <code class="k">if</code> <code class="nx">user</code><code class="p">.</code><code class="nx">emails</code>
            <code class="nx">li</code> <code class="nx">Email</code><code class="o">:</code> <code class="err">#</code><code class="p">{</code><code class="nx">user</code><code class="p">.</code><code class="nx">emails</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">value</code><code class="p">}</code></pre>
        
        <p>Finally, we can set up our routes in the <em>index.js</em> file:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'home'</code><code class="p">,</code> <code class="p">{</code> <code class="nx">user</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">user</code> <code class="p">});</code>
        <code class="p">});</code>
        
        <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/login'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'login'</code><code class="p">);</code>
        <code class="p">});</code>
        
        <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/login/github'</code><code class="p">,</code> <code class="nx">passport</code><code class="p">.</code><code class="nx">authenticate</code><code class="p">(</code><code class="s1">'github'</code><code class="p">));</code>
        
        <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code>
          <code class="s1">'/login/github/callback'</code><code class="p">,</code>
          <code class="nx">passport</code><code class="p">.</code><code class="nx">authenticate</code><code class="p">(</code><code class="s1">'github'</code><code class="p">,</code> <code class="p">{</code> <code class="nx">failureRedirect</code><code class="o">:</code> <code class="s1">'/login'</code> <code class="p">}),</code>
          <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
            <code class="nx">res</code><code class="p">.</code><code class="nx">redirect</code><code class="p">(</code><code class="s1">'/'</code><code class="p">);</code>
          <code class="p">}</code>
        <code class="p">);</code>
        
        <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code>
          <code class="s1">'/profile'</code><code class="p">,</code>
          <code class="nx">require</code><code class="p">(</code><code class="s1">'connect-ensure-login'</code><code class="p">).</code><code class="nx">ensureLoggedIn</code><code class="p">(),</code>
          <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
            <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'profile'</code><code class="p">,</code> <code class="p">{</code> <code class="nx">user</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">user</code> <code class="p">});</code>
          <code class="p">}</code>
        <code class="p">);</code></pre>
        
        <p>This example was designed to closely match the <a href="https://github.com/passport/express-4.x-facebook-example">Express 4.x Facebook example</a>, which provides well-documented code for working with Express and Facebook authentication. You can view hundreds of additional <a href="http://www.passportjs.org">Passport.js strategies</a>.<a data-type="indexterm" data-primary="" data-startref="ix_express_oauth" id="idm45475116214952"></a><a data-type="indexterm" data-primary="" data-startref="ix_oauth_frame" id="idm45475116077336"></a><a data-type="indexterm" data-primary="" data-startref="ix_authent_passport" id="idm45475116076392"></a><a data-type="indexterm" data-primary="" data-startref="ix_passport" id="idm45475116075448"></a><a data-type="indexterm" data-primary="" data-startref="ix_oauth_frame_passport" id="idm45475116074504"></a><a data-type="indexterm" data-primary="" data-startref="ix_authorize_frame" id="idm45475116073560"></a></p>
        </div></section>
        
        
        
        
        
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect1" data-pdf-bookmark="Serving Up Formatted Data"><div class="sect1" id="idm45475116835000">
        <h1>Serving Up Formatted Data</h1>
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45475116072168">
        <h2>Problem</h2>
        
        <p><a data-type="indexterm" data-primary="formatting" data-secondary="data" id="ix_format_data_express"></a><a data-type="indexterm" data-primary="data" data-secondary="Express’s return of formatted" id="ix_data_express"></a><a data-type="indexterm" data-primary="Express framework" data-secondary="formatted data, returning" id="ix_express_frame_format"></a>Instead of serving up a web page or sending plain text, you want to return formatted data, such as XML, to the browser.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45475116066792">
        <h2>Solution</h2>
        
        <p><a data-type="indexterm" data-primary="XML" data-secondary="formatting with Node" id="ix_xml_node_format"></a>Use Node module(s) to help format the data. For example, if you want to return XML, you can use a module to create the formatted data:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">builder</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'xmlbuilder'</code><code class="p">);</code>
        
        <code class="kr">const</code> <code class="nx">xml</code> <code class="o">=</code> <code class="nx">builder</code>
          <code class="p">.</code><code class="nx">create</code><code class="p">(</code><code class="s1">'resources'</code><code class="p">)</code>
          <code class="p">.</code><code class="nx">ele</code><code class="p">(</code><code class="s1">'resource'</code><code class="p">)</code>
          <code class="p">.</code><code class="nx">ele</code><code class="p">(</code><code class="s1">'title'</code><code class="p">,</code> <code class="s1">'Ecma-262 Edition 10'</code><code class="p">)</code>
          <code class="p">.</code><code class="nx">up</code><code class="p">()</code>
          <code class="p">.</code><code class="nx">ele</code><code class="p">(</code><code class="s1">'url'</code><code class="p">,</code> <code class="s1">'https://www.ecma-international.org/ecma-262/10.0/index.html'</code><code class="p">)</code>
          <code class="p">.</code><code class="nx">up</code><code class="p">()</code>
          <code class="p">.</code><code class="nx">end</code><code class="p">({</code> <code class="nx">pretty</code><code class="o">:</code> <code class="kc">true</code> <code class="p">});</code></pre>
        
        <p>Then create the appropriate header to go with the data, and return the data to the browser:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">res</code><code class="p">.</code><code class="nx">setHeader</code><code class="p">(</code><code class="s1">'Content-Type'</code><code class="p">,</code> <code class="s1">'application/xml'</code><code class="p">);</code>
          <code class="nx">res</code><code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="nx">xml</code><code class="p">.</code><code class="nx">toString</code><code class="p">(),</code> <code class="s1">'utf8'</code><code class="p">);</code>
        <code class="p">});</code></pre>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45475116014136">
        <h2>Discussion</h2>
        
        <p>Web servers frequently serve up static or server-side generated resources, but just as frequently, what’s returned to the browser is formatted data that’s then processed in the web page before display.</p>
        
        <p>There are two key elements to generating and returning formatted data. The first is to make use of whatever Node library to simplify the generation of the data, and the second is to make sure that the header data sent with the data is appropriate for the data.</p>
        
        <p><a data-type="indexterm" data-primary="modules" data-secondary="xmlbuilder" id="idm45475115977800"></a><a data-type="indexterm" data-primary="xmlbuilder module" id="idm45475115976824"></a>In the solution, the <code>xmlbuilder</code> module is used to assist us in creating proper XML. This isn’t one of the modules installed with Node by default, so we have to install it using npm, the Node Package Manager:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">npm</code> <code class="nx">install</code> <code class="nx">xmlbuilder</code></pre>
        
        <p>Then it’s a matter of creating a new XML document, a root element, and then each resource element, as demonstrated in the solution. It’s true, we could  build the XML string ourselves, but that’s a pain. And it’s too easy to make mistakes that are then hard to discover. One of the best things about Node is the enormous number of modules available to do most anything we can think of. Not only do we not have to write the code ourselves, but most of the modules have been thoroughly tested and actively maintained.</p>
        
        <p>Once the formatted data is ready to return, create the header that goes with it. In the solution, because the document is XML, the header content type is set to <code>application/xml</code> before the data is returned as a string.<a data-type="indexterm" data-primary="" data-startref="ix_express_frame_format" id="idm45475115914056"></a><a data-type="indexterm" data-primary="" data-startref="ix_data_express" id="idm45475115913144"></a><a data-type="indexterm" data-primary="" data-startref="ix_format_data_express" id="idm45475115912200"></a><a data-type="indexterm" data-primary="" data-startref="ix_xml_node_format" id="idm45475115910072"></a></p>
        </div></section>
        
        
        
        
        
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect1" data-pdf-bookmark="Building a RESTful API"><div class="sect1" id="express-rest">
        <h1>Building a RESTful API</h1>
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45475115907448">
        <h2>Problem</h2>
        
        <p><a data-type="indexterm" data-primary="RESTful API" id="ix_restful_express"></a><a data-type="indexterm" data-primary="Express framework" data-secondary="RESTful API" id="ix_express_frame_restful"></a>You want to build a REST API using Node.js.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45475115903608">
        <h2>Solution</h2>
        
        <p>Use Express with the <code>app.get</code>, <code>app.post</code>,  <code>app.put</code>, and <code>app.delete</code> methods:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">);</code>
        
        <code class="kr">const</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">express</code><code class="p">();</code>
        <code class="kr">const</code> <code class="nx">port</code> <code class="o">=</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code> <code class="o">||</code> <code class="mi">3000</code><code class="p">;</code>
        
        <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="k">return</code> <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="s1">'Received a GET HTTP method'</code><code class="p">);</code>
        <code class="p">});</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="k">return</code> <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="s1">'Received a POST HTTP method'</code><code class="p">);</code>
        <code class="p">});</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">put</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="k">return</code> <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="s1">'Received a PUT HTTP method'</code><code class="p">);</code>
        <code class="p">});</code>
        <code class="nx">app</code><code class="p">.</code><code class="k">delete</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="k">return</code> <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="s1">'Received a DELETE HTTP method'</code><code class="p">);</code>
        <code class="p">});</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="nx">port</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`Listening on port </code><code class="si">${</code><code class="nx">port</code><code class="si">}</code><code class="sb">!`</code><code class="p">));</code></pre>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45475115850616">
        <h2>Discussion</h2>
        
        <p>REST stands for “Representational State Transfer,” and is the most common architectural approach for building APIs. <a data-type="indexterm" data-primary="HTTP" data-secondary="RESTful API methods" id="idm45475115848648"></a><a data-type="indexterm" data-primary="methods" data-secondary="RESTful API" id="idm45475115760456"></a>REST allows us to interact with a remote data source over HTTP, using the standard HTTP methods of <code>GET</code>, <code>POST</code>, <code>PUT</code>, and <code>DELETE</code>. We can make use of the Express routing methods to accept these requests.</p>
        
        <p>In the following example, I’ll create several routes that serve as API endpoints. Each endpoint will respond to an HTTP request:</p>
        <dl>
        <dt><code>/todos</code></dt>
        <dd>
        <p>Will accept a <code>get</code> request for a list of todos as well as a <code>post</code> request for creating a new todo.</p>
        </dd>
        <dt><code>/todos/:todoId</code></dt>
        <dd>
        <p>Will accept a <code>get</code> request that will return a specific todo as well as a <code>put</code> request, which will allow the user to update the todo content or completed state, and a <code>delete</code> request, which will delete the specific todo.</p>
        </dd>
        </dl>
        
        <p>With these routes defined, we can develop a REST API that responds to these requests appropriately:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">);</code>
        
        <code class="kr">const</code> <code class="nx">port</code> <code class="o">=</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code> <code class="o">||</code> <code class="mi">3000</code><code class="p">;</code>
        <code class="kr">const</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">express</code><code class="p">();</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">json</code><code class="p">());</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">express</code><code class="p">.</code><code class="nx">urlencoded</code><code class="p">({</code> <code class="nx">extended</code><code class="o">:</code> <code class="kc">true</code> <code class="p">}));</code>
        
        <code class="c1">// an array of data</code>
        <code class="kd">let</code> <code class="nx">todos</code> <code class="o">=</code> <code class="p">[</code>
          <code class="p">{</code>
            <code class="nx">id</code><code class="o">:</code> <code class="s1">'1'</code><code class="p">,</code>
            <code class="nx">text</code><code class="o">:</code> <code class="s1">'Order pizza'</code><code class="p">,</code>
            <code class="nx">completed</code><code class="o">:</code> <code class="kc">true</code>
          <code class="p">},</code>
          <code class="p">{</code>
            <code class="nx">id</code><code class="o">:</code> <code class="s1">'2'</code><code class="p">,</code>
            <code class="nx">text</code><code class="o">:</code> <code class="s1">'Pick up pizza'</code><code class="p">,</code>
            <code class="nx">completed</code><code class="o">:</code> <code class="kc">false</code>
          <code class="p">}</code>
        <code class="p">];</code>
        
        <code class="c1">// get the list of todos</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/todos'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="k">return</code> <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">({</code> <code class="nx">data</code><code class="o">:</code> <code class="p">{</code> <code class="nx">todos</code> <code class="p">}</code> <code class="p">});</code>
        <code class="p">});</code>
        
        <code class="c1">// get an individual todo</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/todos/:todoId'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="kr">const</code> <code class="nx">foundTodo</code> <code class="o">=</code> <code class="nx">todos</code><code class="p">.</code><code class="nx">find</code><code class="p">(</code><code class="nx">todo</code> <code class="o">=&gt;</code> <code class="nx">todo</code><code class="p">.</code><code class="nx">id</code> <code class="o">===</code> <code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">todoId</code><code class="p">);</code>
          <code class="k">return</code> <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">({</code> <code class="nx">data</code><code class="o">:</code> <code class="nx">foundTodo</code> <code class="p">});</code>
        <code class="p">});</code>
        
        <code class="c1">// create a new todo</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">post</code><code class="p">(</code><code class="s1">'/todos'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="kr">const</code> <code class="nx">todo</code> <code class="o">=</code> <code class="p">{</code>
            <code class="nx">id</code><code class="o">:</code> <code class="nb">String</code><code class="p">(</code><code class="nx">todos</code><code class="p">.</code><code class="nx">length</code> <code class="o">+</code> <code class="mi">1</code><code class="p">),</code>
            <code class="nx">text</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">text</code><code class="p">,</code>
            <code class="nx">completed</code><code class="o">:</code> <code class="kc">false</code>
          <code class="p">};</code>
        
          <code class="nx">todos</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">todo</code><code class="p">);</code>
          <code class="k">return</code> <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">({</code> <code class="nx">data</code><code class="o">:</code> <code class="nx">todo</code> <code class="p">});</code>
        <code class="p">});</code>
        
        <code class="c1">// update a todo</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">put</code><code class="p">(</code><code class="s1">'/todos/:todoId'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="kr">const</code> <code class="nx">todoIndex</code> <code class="o">=</code> <code class="nx">todos</code><code class="p">.</code><code class="nx">findIndex</code><code class="p">(</code><code class="nx">todo</code> <code class="o">=&gt;</code> <code class="nx">todo</code><code class="p">.</code><code class="nx">id</code> <code class="o">===</code> <code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">todoId</code><code class="p">);</code>
          <code class="kr">const</code> <code class="nx">todo</code> <code class="o">=</code> <code class="p">{</code>
            <code class="nx">id</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">todoId</code><code class="p">,</code>
            <code class="nx">text</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">text</code> <code class="o">||</code> <code class="nx">todos</code><code class="p">[</code><code class="nx">todoIndex</code><code class="p">].</code><code class="nx">text</code><code class="p">,</code>
            <code class="nx">completed</code><code class="o">:</code> <code class="nx">req</code><code class="p">.</code><code class="nx">body</code><code class="p">.</code><code class="nx">completed</code> <code class="o">||</code> <code class="nx">todos</code><code class="p">[</code><code class="nx">todoIndex</code><code class="p">].</code><code class="nx">completed</code>
          <code class="p">};</code>
        
          <code class="nx">todos</code><code class="p">[</code><code class="nx">todoIndex</code><code class="p">]</code> <code class="o">=</code> <code class="nx">todo</code><code class="p">;</code>
          <code class="k">return</code> <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">({</code> <code class="nx">data</code><code class="o">:</code> <code class="nx">todo</code> <code class="p">});</code>
        <code class="p">});</code>
        
        <code class="c1">// delete a todo</code>
        <code class="nx">app</code><code class="p">.</code><code class="k">delete</code><code class="p">(</code><code class="s1">'/todos/:todoId'</code><code class="p">,</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="kr">const</code> <code class="nx">deletedTodo</code> <code class="o">=</code> <code class="nx">todos</code><code class="p">.</code><code class="nx">find</code><code class="p">(</code><code class="nx">todo</code> <code class="o">=&gt;</code> <code class="nx">todo</code><code class="p">.</code><code class="nx">id</code> <code class="o">===</code> <code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">todoId</code><code class="p">);</code>
          <code class="nx">todos</code> <code class="o">=</code> <code class="nx">todos</code><code class="p">.</code><code class="nx">filter</code><code class="p">(</code><code class="nx">todo</code> <code class="o">=&gt;</code> <code class="nx">todo</code><code class="p">.</code><code class="nx">id</code> <code class="o">!==</code> <code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">todoId</code><code class="p">);</code>
          <code class="k">return</code> <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">({</code> <code class="nx">data</code><code class="o">:</code> <code class="nx">deletedTodo</code> <code class="p">});</code>
        <code class="p">});</code>
        
        <code class="c1">// listen on port 3000 or the PORT set as an environment variable</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="nx">port</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`Listening on port </code><code class="si">${</code><code class="nx">port</code><code class="si">}</code><code class="sb">!`</code><code class="p">));</code></pre>
        
        <p><a data-type="indexterm" data-primary="CLI (command-line interface) tools" data-secondary="curl" id="idm45475115744632"></a><a data-type="indexterm" data-primary="curl command-line tool" id="idm45475115743784"></a>From the terminal, you can use <code>curl</code> to test our responses:</p>
        <pre data-type="programlisting" data-code-language="javascript"><code class="err">#</code> <code class="nx">get</code> <code class="nx">the</code> <code class="nx">list</code> <code class="k">of</code> <code class="nx">todos</code>
        <code class="nx">curl</code> <code class="nx">http</code><code class="o">:</code><code class="nx">//localhost:3000/todos</code>
        
        <code class="err">#</code> <code class="nx">get</code> <code class="nx">an</code> <code class="nx">individual</code> <code class="nx">todo</code>
        <code class="nx">curl</code> <code class="nx">http</code><code class="o">:</code><code class="nx">//localhost:3000/todos/1</code>
        
        <code class="err">#</code> <code class="nx">create</code> <code class="nx">a</code> <code class="k">new</code> <code class="nx">todo</code>
        <code class="nx">curl</code> <code class="o">-</code><code class="nx">X</code> <code class="nx">POST</code> <code class="o">-</code><code class="nx">H</code> <code class="s2">"Content-Type:application/json"</code> <code class="o">/</code>
          <code class="nx">http</code><code class="o">:</code><code class="nx">//localhost:3000/todos -d '{"text":"Eat pizza"}'</code>
        
        <code class="err">#</code> <code class="nx">update</code> <code class="nx">a</code> <code class="nx">todo</code>
        <code class="nx">curl</code> <code class="o">-</code><code class="nx">X</code> <code class="nx">PUT</code> <code class="o">-</code><code class="nx">H</code> <code class="s2">"Content-Type:application/json"</code> <code class="o">/</code>
          <code class="nx">http</code><code class="o">:</code><code class="nx">//localhost:3000/todos/2 -d '{"completed": true }</code>
        
        <code class="err">#</code> <code class="k">delete</code> <code class="nx">a</code> <code class="nx">todo</code>
        <code class="nx">curl</code> <code class="o">-</code><code class="nx">X</code> <code class="nx">DELETE</code> <code class="nx">http</code><code class="o">:</code><code class="nx">//localhost:3000/todos/3</code></pre>
        
        <p>Manually testing with <code>curl</code> can quickly become tedious. For API development, you may also want to make use of a REST client UI, such as <a href="https://insomnia.rest">Insomnia</a> or <a href="https://postman.com">Postman</a> (see <a data-type="xref" href="#rest_insomnia">Figure&nbsp;21-6</a>).</p>
        
        <figure class="no-frame"><div id="rest_insomnia" class="figure">
        <img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492055747/files/assets/jsc3_2106.png" alt="A screenshot of the Insomnia REST client" width="1444" height="655">
        <h6><span class="label">Figure 21-6. </span>A GET request in the Insomnia REST client</h6>
        </div></figure>
        
        <p>In the above example, I’m using an in-memory data store. When building an API, you will most likely want to connect to a database. To do so, you can reach for a library such as <a href="https://oreil.ly/NuXyR">Sequelize</a> (for SQL databases), <a href="https://oreil.ly/zP8Fr">Mongoose</a> (for MongoDB), or an online data store such as <a href="https://oreil.ly/iZSFB">Firebase</a>.<a data-type="indexterm" data-primary="" data-startref="ix_express_frame_restful" id="idm45475115174664"></a><a data-type="indexterm" data-primary="" data-startref="ix_restful_express" id="idm45475115173592"></a></p>
        </div></section>
        
        
        
        
        
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect1" data-pdf-bookmark="Building a GraphQL API"><div class="sect1" id="express-graphql">
        <h1>Building a GraphQL API</h1>
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45475115171224">
        <h2>Problem</h2>
        
        <p><a data-type="indexterm" data-primary="Express framework" data-secondary="GraphQL API" id="ix_express_frame_graphql2"></a><a data-type="indexterm" data-primary="GraphQL API" id="ix_graphql2"></a>You would like to build a GraphQL API server application or add GraphQL endpoints to an existing Express application.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45475115167320">
        <h2>Solution</h2>
        
        <p><a data-type="indexterm" data-primary="Apollo Server package" id="ix_apollo_server"></a>Use the Apollo Server package to include GraphQL type definitions, GraphQL resolvers, and the GraphQL Playground:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">);</code>
        <code class="kr">const</code> <code class="p">{</code> <code class="nx">ApolloServer</code><code class="p">,</code> <code class="nx">gql</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'apollo-server-express'</code><code class="p">);</code>
        
        <code class="kr">const</code> <code class="nx">port</code> <code class="o">=</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code> <code class="o">||</code> <code class="mi">3000</code><code class="p">;</code>
        <code class="kr">const</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">express</code><code class="p">();</code>
        
        <code class="kr">const</code> <code class="nx">typeDefs</code> <code class="o">=</code> <code class="nx">gql</code><code class="sb">`</code>
        <code class="sb">  type Query {</code>
        <code class="sb">    hello: String</code>
        <code class="sb">  }</code>
        <code class="sb">`</code><code class="p">;</code>
        
        <code class="kr">const</code> <code class="nx">resolvers</code> <code class="o">=</code> <code class="p">{</code>
          <code class="nx">Query</code><code class="o">:</code> <code class="p">{</code>
            <code class="nx">hello</code><code class="o">:</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="s1">'Hello world!'</code>
          <code class="p">}</code>
        <code class="p">};</code>
        <code class="kr">const</code> <code class="nx">server</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">ApolloServer</code><code class="p">({</code> <code class="nx">typeDefs</code><code class="p">,</code> <code class="nx">resolvers</code> <code class="p">});</code>
        <code class="nx">server</code><code class="p">.</code><code class="nx">applyMiddleware</code><code class="p">({</code> <code class="nx">app</code><code class="p">,</code> <code class="nx">path</code><code class="o">:</code> <code class="s1">'/'</code> <code class="p">});</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">listen</code><code class="p">({</code> <code class="nx">port</code> <code class="p">},</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`Listening on port </code><code class="si">${</code><code class="nx">port</code><code class="si">}</code><code class="sb">!`</code><code class="p">));</code></pre>
        
        <p>Apollo Server provides access to the GraphQL Playground (see <a data-type="xref" href="#graphql_playground">Figure&nbsp;21-7</a>), which allows us to easily interact with the API during development (and in production, if desired).</p>
        
        <figure class="no-frame"><div id="graphql_playground" class="figure">
        <img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492055747/files/assets/jsc3_2107.png" alt="A screenshot of the GraphQL Playground" width="1444" height="1095">
        <h6><span class="label">Figure 21-7. </span>A GraphQL query in the GraphQL Playground</h6>
        </div></figure>
        
        <p>The GraphQL Playground also provides automatically generated documentation for the API, based on the type definitions you’ve provided (see <a data-type="xref" href="#unique_id">Figure&nbsp;21-8</a>).</p>
        
        <figure class="no-frame"><div id="unique_id" class="figure">
        <img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492055747/files/assets/jsc3_2108.png" alt="A screenshot of the generated GraphQL documentation" width="605" height="1061">
        <h6><span class="label">Figure 21-8. </span>The generated documentation in GraphQL Playground</h6>
        </div></figure>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45475115057032">
        <h2>Discussion</h2>
        
        <p>GraphQL is an open source query language for APIs. It was developed with the goal of providing single endpoints for data, allowing applications to request the specific data that is needed. <a href="https://oreil.ly/toPLM">Apollo Server</a> can be used as a standalone package or integrated as middleware for popular Node.js server application libraries, such as Express, Hapi, Fastify, and Koa.</p>
        
        <p>In GraphQL, a type definition schema is a written representation of our data and interactions. By requiring a schema, GraphQL enforces a strict plan for our API. This is because your API can only return data and perform interactions that are defined within the schema. The fundamental component of GraphQL schemas are object types. GraphQL contains five built-in scalar types:</p>
        
        <ul>
        <li>
        <p>String: A string with UTF-8 character encoding</p>
        </li>
        <li>
        <p>Boolean: A true or false value</p>
        </li>
        <li>
        <p>Int: A 32-bit integer</p>
        </li>
        <li>
        <p>Float: A floating-point value</p>
        </li>
        <li>
        <p>ID: A unique identifier</p>
        </li>
        </ul>
        
        <p>Once the schema is written, we provide the API with a series of resolvers. These are functions that specify how the data should be returned in a query or changed within a data mutation.</p>
        
        <p>In the previous example, we’re using the <code>apollo-server-express</code> package, which should be installed alongside the <code>express</code> and <code>gql</code> packages:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">$</code> <code class="nx">npm</code> <code class="nx">install</code> <code class="nx">express</code> <code class="nx">apollo</code><code class="o">-</code><code class="nx">server</code><code class="o">-</code><code class="nx">express</code> <code class="nx">gql</code></pre>
        
        <p><a data-type="indexterm" data-primary="CRUD (Create-Read-Update-Delete)" id="idm45475115040040"></a>To create a CRUD application, we can define our GraphQL type definitions and the appropriate resolvers. The following example mimics the one found in <a data-type="xref" href="#express-rest">“Building a RESTful API”</a>:</p>
        
        <pre data-type="programlisting" data-code-language="javascript" class="small"><code class="kr">const</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">);</code>
        <code class="kr">const</code> <code class="p">{</code> <code class="nx">ApolloServer</code><code class="p">,</code> <code class="nx">gql</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'apollo-server-express'</code><code class="p">);</code>
        
        <code class="kr">const</code> <code class="nx">port</code> <code class="o">=</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code> <code class="o">||</code> <code class="mi">3000</code><code class="p">;</code>
        <code class="kr">const</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">express</code><code class="p">();</code>
        
        <code class="c1">// an array of data</code>
        <code class="kd">let</code> <code class="nx">todos</code> <code class="o">=</code> <code class="p">[</code>
          <code class="p">{</code>
            <code class="nx">id</code><code class="o">:</code> <code class="s1">'1'</code><code class="p">,</code>
            <code class="nx">text</code><code class="o">:</code> <code class="s1">'Order pizza'</code><code class="p">,</code>
            <code class="nx">completed</code><code class="o">:</code> <code class="kc">true</code>
          <code class="p">},</code>
          <code class="p">{</code>
            <code class="nx">id</code><code class="o">:</code> <code class="s1">'2'</code><code class="p">,</code>
            <code class="nx">text</code><code class="o">:</code> <code class="s1">'Pick up pizza'</code><code class="p">,</code>
            <code class="nx">completed</code><code class="o">:</code> <code class="kc">false</code>
          <code class="p">}</code>
        <code class="p">];</code>
        
        <code class="c1">// GraphQL Type Definitions</code>
        <code class="kr">const</code> <code class="nx">typeDefs</code> <code class="o">=</code> <code class="nx">gql</code><code class="sb">`</code>
        <code class="sb">  type Query {</code>
        <code class="sb">    todos: [Todo!]!</code>
        <code class="sb">    todo(id: ID!): Todo!</code>
        <code class="sb">  }</code>
        
        <code class="sb">  type Mutation {</code>
        <code class="sb">    newTodo(text: String!): Todo!</code>
        <code class="sb">    updateTodo(id: ID!, text: String, completed: Boolean): Todo!</code>
        <code class="sb">    deleteTodo(id: ID!): Todo!</code>
        <code class="sb">  }</code>
        
        <code class="sb">  type Todo {</code>
        <code class="sb">    id: ID!</code>
        <code class="sb">    text: String!</code>
        <code class="sb">    completed: Boolean</code>
        <code class="sb">  }</code>
        <code class="sb">`</code><code class="p">;</code>
        
        <code class="c1">// GraphQL Resolvers</code>
        <code class="kr">const</code> <code class="nx">resolvers</code> <code class="o">=</code> <code class="p">{</code>
          <code class="nx">Query</code><code class="o">:</code> <code class="p">{</code>
            <code class="nx">todos</code><code class="o">:</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="nx">todos</code><code class="p">,</code>
            <code class="nx">todo</code><code class="o">:</code> <code class="p">(</code><code class="nx">parent</code><code class="p">,</code> <code class="nx">args</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
              <code class="k">return</code> <code class="nx">todos</code><code class="p">.</code><code class="nx">find</code><code class="p">(</code><code class="nx">todo</code> <code class="o">=&gt;</code> <code class="nx">todo</code><code class="p">.</code><code class="nx">id</code> <code class="o">===</code> <code class="nx">args</code><code class="p">.</code><code class="nx">id</code><code class="p">);</code>
            <code class="p">}</code>
          <code class="p">},</code>
          <code class="nx">Mutation</code><code class="o">:</code> <code class="p">{</code>
            <code class="nx">newTodo</code><code class="o">:</code> <code class="p">(</code><code class="nx">parent</code><code class="p">,</code> <code class="nx">args</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
              <code class="kr">const</code> <code class="nx">todo</code> <code class="o">=</code> <code class="p">{</code>
                <code class="nx">id</code><code class="o">:</code> <code class="nb">String</code><code class="p">(</code><code class="nx">todos</code><code class="p">.</code><code class="nx">length</code> <code class="o">+</code> <code class="mi">1</code><code class="p">),</code>
                <code class="nx">text</code><code class="o">:</code> <code class="nx">args</code><code class="p">.</code><code class="nx">text</code><code class="p">,</code>
                <code class="nx">completed</code><code class="o">:</code> <code class="kc">false</code>
              <code class="p">};</code>
        
              <code class="nx">todos</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">todo</code><code class="p">);</code>
              <code class="k">return</code> <code class="nx">todo</code><code class="p">;</code>
            <code class="p">},</code>
        
            <code class="nx">updateTodo</code><code class="o">:</code> <code class="p">(</code><code class="nx">parent</code><code class="p">,</code> <code class="nx">args</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
              <code class="kr">const</code> <code class="nx">todoIndex</code> <code class="o">=</code> <code class="nx">todos</code><code class="p">.</code><code class="nx">findIndex</code><code class="p">(</code><code class="nx">todo</code> <code class="o">=&gt;</code> <code class="nx">todo</code><code class="p">.</code><code class="nx">id</code> <code class="o">===</code> <code class="nx">args</code><code class="p">.</code><code class="nx">id</code><code class="p">);</code>
              <code class="kr">const</code> <code class="nx">todo</code> <code class="o">=</code> <code class="p">{</code>
                <code class="nx">id</code><code class="o">:</code> <code class="nx">args</code><code class="p">.</code><code class="nx">id</code><code class="p">,</code>
                <code class="nx">text</code><code class="o">:</code> <code class="nx">args</code><code class="p">.</code><code class="nx">text</code> <code class="o">||</code> <code class="nx">todos</code><code class="p">[</code><code class="nx">todoIndex</code><code class="p">].</code><code class="nx">text</code><code class="p">,</code>
                <code class="nx">completed</code><code class="o">:</code> <code class="nx">args</code><code class="p">.</code><code class="nx">completed</code> <code class="o">||</code> <code class="nx">todos</code><code class="p">[</code><code class="nx">todoIndex</code><code class="p">].</code><code class="nx">completed</code>
              <code class="p">};</code>
        
              <code class="nx">todos</code><code class="p">[</code><code class="nx">todoIndex</code><code class="p">]</code> <code class="o">=</code> <code class="nx">todo</code><code class="p">;</code>
              <code class="k">return</code> <code class="nx">todo</code><code class="p">;</code>
            <code class="p">},</code>
            <code class="nx">deleteTodo</code><code class="o">:</code> <code class="p">(</code><code class="nx">parent</code><code class="p">,</code> <code class="nx">args</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
              <code class="kr">const</code> <code class="nx">deletedTodo</code> <code class="o">=</code> <code class="nx">todos</code><code class="p">.</code><code class="nx">find</code><code class="p">(</code><code class="nx">todo</code> <code class="o">=&gt;</code> <code class="nx">todo</code><code class="p">.</code><code class="nx">id</code> <code class="o">===</code> <code class="nx">args</code><code class="p">.</code><code class="nx">id</code><code class="p">);</code>
              <code class="nx">todos</code> <code class="o">=</code> <code class="nx">todos</code><code class="p">.</code><code class="nx">filter</code><code class="p">(</code><code class="nx">todo</code> <code class="o">=&gt;</code> <code class="nx">todo</code><code class="p">.</code><code class="nx">id</code> <code class="o">!==</code> <code class="nx">args</code><code class="p">.</code><code class="nx">id</code><code class="p">);</code>
              <code class="k">return</code> <code class="nx">deletedTodo</code><code class="p">;</code>
            <code class="p">}</code>
          <code class="p">}</code>
        <code class="p">};</code>
        
        <code class="c1">// Apollo + Express server setup</code>
        <code class="kr">const</code> <code class="nx">server</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">ApolloServer</code><code class="p">({</code> <code class="nx">typeDefs</code><code class="p">,</code> <code class="nx">resolvers</code> <code class="p">});</code>
        <code class="nx">server</code><code class="p">.</code><code class="nx">applyMiddleware</code><code class="p">({</code> <code class="nx">app</code><code class="p">,</code> <code class="nx">path</code><code class="o">:</code> <code class="s1">'/'</code> <code class="p">});</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">listen</code><code class="p">({</code> <code class="nx">port</code> <code class="p">},</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`Listening on port </code><code class="si">${</code><code class="nx">port</code><code class="si">}</code><code class="sb">!`</code><code class="p">));</code></pre>
        
        <p>In the above example, I’m using an in-memory data store. When building an API, you will most likely want to connect to a database. To do so, you can reach for a library such as Sequelize (for SQL databases), Mongoose (for MongoDB), or an online data store such as Firebase.<a data-type="indexterm" data-primary="" data-startref="ix_express_frame_ch21" id="idm45475114987576"></a><a data-type="indexterm" data-primary="" data-startref="ix_node_ptiii" id="idm45475114986728"></a><a data-type="indexterm" data-primary="" data-startref="ix_graphql2" id="idm45475114985784"></a><a data-type="indexterm" data-primary="" data-startref="ix_express_frame_graphql2" id="idm45475114984840"></a><a data-type="indexterm" data-primary="" data-startref="ix_apollo_server" id="idm45475114983880"></a></p>
        
        <p>The defined  queries return data directly from the API, while the mutations allow us to perform changes to the data, such as create a new item, update an item, or delete an item.</p>
        </div></section>
        
        
        
        
        
        </div></section>
        
        
        
        
        
        
        
        </div></section></div></div><link rel="stylesheet" href="/files/public/epub-reader/override_v1.css" crossorigin="anonymous"><link rel="stylesheet" href="/api/v2/epubs/urn:orm:book:9781492055747/files/epub.css" crossorigin="anonymous"></div></div></section>
</div>

https://learning.oreilly.com