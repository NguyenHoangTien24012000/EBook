<style>
    @font-face {
        font-family: Roboto;
        font-style: normal;
        font-weight: 300;
        src: url(https://static.contineljs.com/fonts/Roboto-Light.woff2) format("woff2"),
            url(https://static.contineljs.com/fonts/Roboto-Light.woff) format("woff");
    }

    @font-face {
        font-family: Roboto;
        font-style: normal;
        font-weight: 400;
        src: url(https://static.contineljs.com/fonts/Roboto-Regular.woff2) format("woff2"),
            url(https://static.contineljs.com/fonts/Roboto-Regular.woff) format("woff");
    }

    @font-face {
        font-family: Roboto;
        font-style: normal;
        font-weight: 500;
        src: url(https://static.contineljs.com/fonts/Roboto-Medium.woff2?v=2) format("woff2"),
            url(https://static.contineljs.com/fonts/Roboto-Medium.woff) format("woff");
    }

    @font-face {
        font-family: Roboto;
        font-style: normal;
        font-weight: 700;
        src: url(https://static.contineljs.com/fonts/Roboto-Bold.woff2) format("woff2"),
            url(https://static.contineljs.com/fonts/Roboto-Bold.woff) format("woff");
    }

    * {
        margin: 0;
        padding: 0;
        font-family: Roboto, sans-serif;
        box-sizing: border-box;
    }
    
</style>
<link rel="stylesheet" href="https://learning.oreilly.com/files/public/epub-reader/override_v1.css" crossorigin="anonymous"><link rel="stylesheet" href="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492092506/files/epub.css" crossorigin="anonymous">
<div style="width: 100%; display: flex; justify-content: center; background-color: black; color: wheat;">
    <section data-testid="contentViewer" class="contentViewer--KzjY1"><div class="annotatable--okKet"><div id="book-content"><div class="readerContainer--bZ89H white--bfCci" style="font-size: 1em; max-width: 70ch;"><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 17. Node Basics"><div class="chapter" id="ch17">
        <h1><span class="label">Chapter 17. </span>Node Basics</h1>
        
        
        <p><a data-type="indexterm" data-primary="Node" id="ix_node_ptiii"></a>The dividing line between “old” and “new” JavaScript occurred when Node.js (referred to primarily as just Node) was released to the world. Yes, the ability to dynamically modify page elements was an essential milestone, as was the emphasis on establishing a path forward to new versions of ECMAScript, but it was Node that really made us look at JavaScript in a whole new way. And it’s a way I like—I’m a big fan of Node and server-side JavaScript development.</p>
        
        <p>In this chapter, we’ll explore the basics of Node. At a minimum, you will need to have Node installed, as covered in <a data-type="xref" href="ch01.html#installing_node_npm">“Installing the npm Package Manager (with Node.js)”</a> or <a data-type="xref" href="#use-nvm">“Managing Node Versions with Node Version Manager”</a>.</p>
        
        
        
        
        
        
        <section data-type="sect1" data-pdf-bookmark="Managing Node Versions with Node Version Manager"><div class="sect1" id="use-nvm">
        <h1>Managing Node Versions with Node Version Manager</h1>
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45475130595432">
        <h2>Problem</h2>
        
        <p><a data-type="indexterm" data-primary="Node" data-secondary="installing/maintaining with npm" id="idm45475130594232"></a><a data-type="indexterm" data-primary="npm (Node package manager)" data-secondary="maintaining Node with" id="idm45475130593288"></a><a data-type="indexterm" data-primary="NVM (Node Version Manager)" id="ix_nvm_manage"></a><a data-type="indexterm" data-primary="Node" data-secondary="version management" id="ix_node_version"></a>You need to install and manage multiple versions of Node on your development machine.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45475130589768">
        <h2>Solution</h2>
        
        <p>Use <a href="https://github.com/nvm-sh/nvm">Node Version Manager (NVM)</a>, which allows you to install and use any distributed version of Node on a per-shell basis. NVM is compatible with Linux, macOS, and Windows Subsystem for Linux.</p>
        
        <p>To install NVM, run the install script using either <code>curl</code> or <code>wget</code> in your system’s terminal application:</p>
        
        <pre data-type="programlisting" data-code-language="bash"><code class="c">## using curl:</code>
        curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.37.2/install.sh <code class="p">|</code> bash
        
        <code class="c">## using wget:</code>
        wget -qO- https://raw.githubusercontent.com/nvm-sh/nvm/v0.37.2/install.sh <code class="p">|</code> bash</pre>
        <div data-type="note" epub:type="note"><h6>Note</h6>
        <p><a data-type="indexterm" data-primary="nvm-windows" id="idm45475130582744"></a><a data-type="indexterm" data-primary="Windows OS, Node on" id="idm45475130582104"></a>If you are developing on Windows, we recommend using <a href="https://github.com/coreybutler/nvm-windows"><code>nvm-windows</code></a>, which is unaffiliated with the NVM project, but provides similar functionality for the Windows operating system. For instructions on how to use <code>nvm-windows</code>, consult the project’s <span class="keep-together">documentation</span>.</p>
        </div>
        
        <p>Once you have installed NVM, you will need to install a version of Node. To install the latest version of Node, run:</p>
        
        <pre data-type="programlisting" data-code-language="bash"><code class="nv">$ </code>nvm install node</pre>
        
        <p>You can also install a specific version of Node:</p>
        
        <pre data-type="programlisting" data-code-language="bash"><code class="c"># install the latest path release of a major version</code>
        <code class="nv">$ </code>nvm install 15
        
        <code class="c"># install a specific major/minor/patch version</code>
        <code class="nv">$ </code>nvm install 15.6.0</pre>
        
        <p>Once you’ve installed Node, you’ll need to set a default version for new shell sessions. This can either be the latest version of Node that has been installed or a specific version number:</p>
        
        <pre data-type="programlisting" data-code-language="bash"><code class="c"># default new shell sessions to the latest version of node</code>
        nvm <code class="nb">alias </code>default node
        <code class="c"># default new shell sessions to a specific version</code>
        nvm <code class="nb">alias </code>default 14</pre>
        
        <p>To switch the version being used in a shell session, use the <code>nvm use</code> command followed by a specific installed version:</p>
        
        <pre data-type="programlisting" data-code-language="bash"><code class="nv">$ </code>nvm use 15</pre>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45475130589304">
        <h2>Discussion</h2>
        
        <p>Using NVM allows you to easily download and switch between multiple versions of Node on your operating system. This can be incredibly useful when working with libraries that support multiple versions and legacy codebases. It also simplifies the management of Node within your development environment. You can view the <a href="https://oreil.ly/9IY83">list of releases and support timelines</a> for each release.</p>
        
        <p>When using NVM, it’s possible to list out all of the versions installed on your machine using the <code>nvm ls</code> command. This will show all of the installed versions, the default version for new shell sessions, and any LTS versions that you do not have installed:</p>
        
        <pre data-type="programlisting" data-code-language="bash"><code class="nv">$ </code>nvm ls
                 v8.1.2
                v8.11.3
               v10.13.0
        -&gt;     v10.23.1
                v12.8.0
               v12.20.0
               v12.20.1
                v13.5.0
               v14.14.0
               v14.15.1
               v14.15.4
                v15.6.0
                 system
        default -&gt; <code class="m">14</code> <code class="o">(</code>-&gt; v14.15.4<code class="o">)</code>
        node -&gt; stable <code class="o">(</code>-&gt; v15.6.0<code class="o">)</code> <code class="o">(</code>default<code class="o">)</code>
        stable -&gt; 15.6 <code class="o">(</code>-&gt; v15.6.0<code class="o">)</code> <code class="o">(</code>default<code class="o">)</code>
        iojs -&gt; N/A <code class="o">(</code>default<code class="o">)</code>
        unstable -&gt; N/A <code class="o">(</code>default<code class="o">)</code>
        lts/* -&gt; lts/fermium <code class="o">(</code>-&gt; v14.15.4<code class="o">)</code>
        lts/argon -&gt; v4.9.1 <code class="o">(</code>-&gt; N/A<code class="o">)</code>
        lts/boron -&gt; v6.17.1 <code class="o">(</code>-&gt; N/A<code class="o">)</code>
        lts/carbon -&gt; v8.17.0 <code class="o">(</code>-&gt; N/A<code class="o">)</code>
        lts/dubnium -&gt; v10.23.1
        lts/erbium -&gt; v12.20.1
        lts/fermium -&gt; v14.15.4</pre>
        
        <p>As you can see, I have several redundant patch versions of  major releases installed on my machine. To uninstall and remove a specific version, you can use the <code>nvm uninstall</code> command:</p>
        
        <pre data-type="programlisting" data-code-language="bash">nvm uninstall 14.14</pre>
        
        <p><a data-type="indexterm" data-primary="files" data-secondary=".nvmrc format" data-secondary-sortas="nvmrc format" id="idm45475130381288"></a><a data-type="indexterm" data-primary=".nvmrc file" data-primary-sortas="nvmrc file" id="idm45475130380168"></a>Keeping track of which version of Node a project is designed to use can be a challenge. To make this easier, you can add an <code>.nvmrc</code> file to your project’s root directory. The contents of the file is the version of Node that the project is designed to use. For example:</p>
        
        <pre data-type="programlisting" data-code-language="bash"><code class="c"># default to the latest LTS version</code>
        <code class="nv">$ </code>lts/*
        
        <code class="c"># to use a specific version</code>
        <code class="nv">$ </code>14.15.4</pre>
        
        <p>To use the version specified in a project’s <code>.nvmrc</code> file, run <code>nvm use</code> command from the root of the director.</p>
        <div data-type="tip"><h6>Tip</h6>
        <p><a data-type="indexterm" data-primary="container technology" id="idm45475130374744"></a><a data-type="indexterm" data-primary="Docker" id="idm45475130327480"></a>For large projects, using a container technology, such as Docker, is an incredibly useful way to ensure version matching across environments, including deployment. The Node documentation has a helpful guide on <a href="https://oreil.ly/phXQZ">Dockerizing a Node.js web app</a>.<a data-type="indexterm" data-primary="" data-startref="ix_node_version" id="idm45475130325832"></a><a data-type="indexterm" data-primary="" data-startref="ix_nvm_manage" id="idm45475130324856"></a></p>
        </div>
        </div></section>
        
        
        
        
        
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect1" data-pdf-bookmark="Responding to a Simple Browser Request"><div class="sect1" id="idm45475130467960">
        <h1>Responding to a Simple Browser Request</h1>
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45475130322808">
        <h2>Problem</h2>
        
        <p><a data-type="indexterm" data-primary="browser" data-secondary="responding to requests in" id="ix_browser_respond"></a><a data-type="indexterm" data-primary="Node" data-secondary="responding to browser request" id="ix_node_browser_req"></a>You want to create a Node application that can respond to a very basic browser request.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45475130371976">
        <h2>Solution</h2>
        
        <p><a data-type="indexterm" data-primary="HTTP" data-secondary="responding to Node server request" id="idm45475130370808"></a>Use the built-in Node HTTP server to respond to requests:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="c1">// load http module</code>
        <code class="kr">const</code> <code class="nx">http</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'http'</code><code class="p">);</code>
        
        <code class="c1">// create http server</code>
        <code class="nx">http</code>
          <code class="p">.</code><code class="nx">createServer</code><code class="p">((</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
            <code class="c1">// content header</code>
            <code class="nx">res</code><code class="p">.</code><code class="nx">writeHead</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="p">{</code> <code class="s1">'content-type'</code><code class="o">:</code> <code class="s1">'text/plain'</code> <code class="p">});</code>
        
            <code class="c1">// write message and signal communication is complete</code>
            <code class="nx">res</code><code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="s1">'Hello, World!'</code><code class="p">);</code>
          <code class="p">})</code>
          <code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="mi">8124</code><code class="p">);</code>
        
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Server running on port 8124'</code><code class="p">);</code></pre>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45475130368072">
        <h2>Discussion</h2>
        
        <p>A web server response to a browser request is the “Hello World” application for Node. It demonstrates not only how a Node application functions, but how you can communicate with it using a fairly traditional communication method: requesting a web resource.</p>
        
        <p><a data-type="indexterm" data-primary="Node" data-secondary="require() function" id="idm45475130253704"></a><a data-type="indexterm" data-primary="require() function" id="idm45475130252536"></a><a data-type="indexterm" data-primary="http module" id="idm45475130251864"></a><a data-type="indexterm" data-primary="modules" data-secondary="http" id="idm45475130251192"></a>Starting from the top, the first line of the solution loads the <code>http</code> module using Node’s <code>require()</code> function. This instructs Node’s modular system to load a specific library resource for use in the application. The <code>http</code> module is one of the many that come, by default, with a Node installation.</p>
        
        <p><a data-type="indexterm" data-primary="RequestListener function" id="idm45475130248584"></a><a data-type="indexterm" data-primary="createServer() method" id="idm45475130247720"></a><a data-type="indexterm" data-primary="Node" data-secondary="HTTP server" id="idm45475130247016"></a>Next, an HTTP server is created using <code>http.createServer()</code>, passing in an anonymous function, known as the <code>RequestListener</code> with two parameters. Node attaches this function as an   event handler for every server request. <a data-type="indexterm" data-primary="IncomingMessage object" id="idm45475130245032"></a><a data-type="indexterm" data-primary="ServerResponse object" id="idm45475130244328"></a>The two parameters are <em>request</em> and <em>response</em>. The request is an instance of the <code>http.IncomingMessage</code> object and the response is an instance of the <code>http.ServerResponse</code> object.</p>
        
        <p>The <code>http.ServerResponse</code> is used to respond to the web request. The <code>http.IncomingMessage</code> object contains information about the request, such as the request URL. <a data-type="indexterm" data-primary="modules" data-secondary="url module object" id="idm45475130240296"></a><a data-type="indexterm" data-primary="url module object" id="idm45475130239320"></a>If you need to get specific pieces of information from the URL (e.g., query string parameters), you can use the Node <code>url</code> utility module to parse the string. <a data-type="xref" href="#parsing_url_for_data">Example&nbsp;17-1</a> demonstrates how the query string can be used to return a more custom message to the browser.</p>
        <div id="parsing_url_for_data" data-type="example">
        <h5><span class="label">Example 17-1. </span>Parsing out query string data</h5>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="c1">// load http module</code>
        <code class="kr">const</code> <code class="nx">http</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'http'</code><code class="p">);</code>
        <code class="kr">const</code> <code class="nx">url</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'url'</code><code class="p">);</code>
        
        <code class="c1">// create http server</code>
        <code class="nx">http</code>
          <code class="p">.</code><code class="nx">createServer</code><code class="p">((</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
            <code class="c1">// get query string and parameters</code>
            <code class="kr">const</code> <code class="p">{</code> <code class="nx">query</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">url</code><code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">url</code><code class="p">,</code> <code class="kc">true</code><code class="p">);</code>
        
            <code class="c1">// content header</code>
            <code class="nx">res</code><code class="p">.</code><code class="nx">writeHead</code><code class="p">(</code><code class="mi">200</code><code class="p">,</code> <code class="p">{</code> <code class="s1">'content-type'</code><code class="o">:</code> <code class="s1">'text/plain'</code> <code class="p">});</code>
        
            <code class="c1">// write message and signal communication is complete</code>
            <code class="kr">const</code> <code class="nx">name</code> <code class="o">=</code> <code class="nx">query</code><code class="p">.</code><code class="nx">first</code> <code class="o">?</code> <code class="nx">query</code><code class="p">.</code><code class="nx">first</code> <code class="o">:</code> <code class="s1">'World'</code><code class="p">;</code>
        
            <code class="c1">// write message and signal communication is complete</code>
            <code class="nx">res</code><code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="sb">`Hello, </code><code class="si">${</code><code class="nx">name</code><code class="si">}</code><code class="sb">!`</code><code class="p">);</code>
          <code class="p">})</code>
          <code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="mi">8124</code><code class="p">);</code>
        
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Server running on port 8124'</code><code class="p">);</code></pre></div>
        
        <p>A URL like the following:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">http</code><code class="o">:</code><code class="c1">//localhost:8124/?first=Reader</code></pre>
        
        <p>results in a web page that reads “Hello, Reader!”</p>
        
        <p><a data-type="indexterm" data-primary="parse() method" data-secondary="url module object" id="idm45475130091144"></a>In the code, the <code>url</code> module object has a <code>parse()</code> method that parses out the URL, returning various components of it (<code>href</code>, <code>protocol</code>, <code>host</code>, etc.). If you pass <code>true</code> as the second argument, the string is also parsed by another module, <code>querystring</code>, which returns the query string as an object with each parameter as an object property, rather than just returning a string.</p>
        
        <p><a data-type="indexterm" data-primary="ServerResponse end() method" id="idm45475130086456"></a>In both the solution and in <a data-type="xref" href="#parsing_url_for_data">Example&nbsp;17-1</a>, a text message is returned as page output, using the <code>http.ServerResponse</code> <code>end()</code> method. I could also have written the message out using <code>write()</code>, and then called <code>end()</code>:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">res</code><code class="p">.</code><code class="nx">write</code><code class="p">(</code><code class="sb">`Hello, </code><code class="si">${</code><code class="nx">name</code><code class="si">}</code><code class="sb">!`</code><code class="p">);</code>
        <code class="nx">res</code><code class="p">.</code><code class="nx">end</code><code class="p">();</code></pre>
        
        <p>The important takeaway from either approach is you <em>must</em> call the response <code>end()</code> method after all the headers and response body have been set.</p>
        
        <p>Chained to the end of the <code>createServer()</code> function call is another function call, this time to <code>listen()</code>, passing in the port number for the server to listen in on. This port number is also an especially important component of the application.</p>
        
        <p>Traditionally, port 80 is the default port for most web servers (that aren’t using HTTPS, which has a default port of 443). By using port 80, requests for the web resource don’t need to specify a port when requesting the service’s URL. However, port 80 is also the default port used by our more traditional web server, Apache. If you try to run the Node service on the same port that Apache is using, your application will fail. The Node application either must be standalone on the server, or run off a different port.</p>
        
        <p>You can also specify an IP address (host) in addition to the port. Doing this ensures that people make the request to a specific host, as well as port. Not providing the host means the application will listen for the request for any IP address associated with the server. You can also specify a domain name, and Node resolves the host.</p>
        
        <p>There are other arguments for the methods demonstrated, and a host of other methods, but this will get you started. Refer to the <a href="http://nodejs.org/api">Node documentation</a> for more <span class="keep-together">
        information</span>.<a data-type="indexterm" data-primary="" data-startref="ix_node_browser_req" id="idm45475130071704"></a><a data-type="indexterm" data-primary="" data-startref="ix_browser_respond" id="idm45475130070696"></a></p>
        </div></section>
        
        
        
        
        
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect1" data-pdf-bookmark="Interactively Trying Out Node Code Snippets with REPL"><div class="sect1" id="idm45475130011000">
        <h1>Interactively Trying Out Node Code Snippets <span class="keep-together">with REPL</span></h1>
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45475130038728">
        <h2>Problem</h2>
        
        <p><a data-type="indexterm" data-primary="testing" data-secondary="with REPL" data-secondary-sortas="REPL" id="ix_testing_repl"></a><a data-type="indexterm" data-primary="code snippets, REPL for trying out" id="ix_code_snip_repl"></a><a data-type="indexterm" data-primary="REPL (read-evaluate-print-loop)" id="ix_repl_code_snip"></a><a data-type="indexterm" data-primary="Node" data-secondary="REPL for trying out code snippets" id="ix_node_repl"></a>You want to easily run server-based Node code snippets.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45475130032552">
        <h2>Solution</h2>
        
        <p>Use Node’s REPL (Read-Evalute-Print-Loop), an interactive command-line version of Node that can run any code snippet.</p>
        
        <p>To use REPL, type <code>node</code> at the command line without specifying an application to run:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">$</code> <code class="nx">node</code></pre>
        
        <p>You can then specify JavaScript in a simplified Emacs (sorry, no vi) line-editing style. You can import libraries, create functions—whatever you can do within a static application. The main difference is that each line of code is interpreted instantly:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="kr">const</code> <code class="nx">add</code> <code class="o">=</code> <code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code> <code class="o">+</code> <code class="nx">y</code> <code class="p">};</code>
        <code class="kc">undefined</code>
        <code class="o">&gt;</code> <code class="nx">add</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code> <code class="mi">2</code><code class="p">);</code>
        <code class="mi">4</code></pre>
        
        <p>When you’re finished, exit the program with <code>.exit</code>:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="p">.</code><code class="nx">exit</code></pre>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45475129936824">
        <h2>Discussion</h2>
        
        <p>REPL can be started standalone or within another application if you want to set certain features. You type in the JavaScript as if you’re typing in the script in a text file. The main behavioral difference is you might see a result after typing in each line, such as the <code>undefined</code> that shows up in the runtime REPL.</p>
        
        <p>But you can import modules:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="o">&gt;</code> <code class="kr">const</code> <code class="nx">fs</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'fs'</code><code class="p">);</code></pre>
        
        <p><a data-type="indexterm" data-primary="objects (Object type)" data-seealso="regular expressions" id="idm45475129924584"></a><a data-type="indexterm" data-primary="objects (Object type)" data-secondary="global" id="idm45475129923736"></a>And you can access the global objects, which we just did when we used <code>require()</code>.</p>
        
        <p>The <code>undefined</code> that shows after typing in some code is the return value for the execution of the previous line of code. Setting a new variable and creating a function are some of the JavaScript that return <code>undefined</code>, which can get quickly annoying. <a data-type="indexterm" data-primary="start() function" id="idm45475129920760"></a>To eliminate this behavior, as well as make some other modifications, you can use the <code>REPL.start()</code> function within a small Node application that triggers REPL (but with the options you specify).</p>
        
        <p>The options you can use are:</p>
        <dl>
        <dt><code>prompt</code></dt>
        <dd>
        <p>Changes the prompt that shows (default is <em>&gt;</em>)</p>
        </dd>
        <dt><code>input</code></dt>
        <dd>
        <p>Changes the input readable stream (default is <code>process.stdin</code>, which is the standard input)</p>
        </dd>
        <dt><code>output</code></dt>
        <dd>
        <p>Changes the output writable stream (default is <code>process.stdout</code>, the standard output)</p>
        </dd>
        <dt><code>terminal</code></dt>
        <dd>
        <p>Set to <code>true</code> if the stream should be treated like a TTY, and have ANSI/VT100 escape codes written</p>
        </dd>
        <dt><code>eval</code></dt>
        <dd>
        <p>Function used to replace the asynchronous <code>eval()</code> function used to evaluate the JavaScript</p>
        </dd>
        <dt><code>useColors</code></dt>
        <dd>
        <p>Set to <code>true</code> to set output colors for the <code>writer</code> function (default is based on the terminal’s default values)</p>
        </dd>
        <dt><code>useGlobal</code></dt>
        <dd>
        <p>Set to <code>true</code> to use the <code>global</code> object, rather than running scripts in a separate context</p>
        </dd>
        <dt><code>ignoreUndefined</code></dt>
        <dd>
        <p>Set to <code>true</code> to eliminate the <code>undefined</code> return values</p>
        </dd>
        <dt><code>writer</code></dt>
        <dd>
        <p>The function that returns the formatted result from the evaluated code to the display (default is the <code>util.inspect</code> function)</p>
        </dd>
        </dl>
        
        <p>The following is an example application that starts REPL with a new prompt, ignoring the undefined values, and using colors:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">repl</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'repl'</code><code class="p">);</code>
        
        <code class="kr">const</code> <code class="nx">options</code> <code class="o">=</code> <code class="p">{</code>
          <code class="nx">prompt</code><code class="o">:</code> <code class="s1">'-&gt; '</code><code class="p">,</code>
          <code class="nx">useColors</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
          <code class="nx">ignoreUndefined</code><code class="o">:</code> <code class="kc">true</code>
        <code class="p">};</code>
        
        <code class="nx">repl</code><code class="p">.</code><code class="nx">start</code><code class="p">(</code><code class="nx">options</code><code class="p">);</code></pre>
        
        <p>The options we want are defined in the <code>options</code> object and then passed as parameters to <code>repl.start()</code>. When we run the application, REPL is started but we no longer have to deal with undefined values:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="o">-&gt;</code> <code class="kr">const</code> <code class="nx">add</code> <code class="o">=</code> <code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code> <code class="k">return</code> <code class="nx">x</code> <code class="o">+</code> <code class="nx">y</code> <code class="p">};</code>
        <code class="o">-&gt;</code> <code class="nx">add</code><code class="p">(</code><code class="mi">2</code><code class="p">,</code> <code class="mi">2</code><code class="p">);</code>
        <code class="mi">4</code></pre>
        
        <p>As you can see, this is a cleaner output without all those messy <code>undefined</code> printouts.<a data-type="indexterm" data-primary="" data-startref="ix_node_repl" id="idm45475129740472"></a><a data-type="indexterm" data-primary="" data-startref="ix_code_snip_repl" id="idm45475129739592"></a><a data-type="indexterm" data-primary="" data-startref="ix_repl_code_snip" id="idm45475129738648"></a><a data-type="indexterm" data-primary="" data-startref="ix_testing_repl" id="idm45475129737704"></a></p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Extra: Wait a Second, What Global Object?"><div class="sect2" id="idm45475129936232">
        <h2>Extra: Wait a Second, What Global Object?</h2>
        
        <p><a data-type="indexterm" data-primary="global objects, Node versus JavaScript" id="idm45475129735384"></a>Caught that, did you?</p>
        
        <p>One difference between JavaScript in Node and JavaScript in the browser is the global scoping. Traditionally in a browser, when you create a variable outside a function, using <code>var</code>, it belongs to the top-level global object, which we know as <code>window</code>:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kd">var</code> <code class="nx">test</code> <code class="o">=</code> <code class="s1">'this is a test'</code><code class="p">;</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nb">window</code><code class="p">.</code><code class="nx">test</code><code class="p">);</code> <code class="c1">// 'this is a test'</code></pre>
        
        <p>Similarly, when using <code>let</code> or <code>const</code> in the browser, the variables are globally scoped, though not attached to the <code>window</code> object.</p>
        
        <p>In Node, each module operates within its own separate context, so modules can declare the same variables, and they won’t conflict if they’re all used in the same <span class="keep-together">application.</span></p>
        
        <p>However, there are objects accessible from Node’s <code>global</code> object. We’ve used a few in previous examples, including <code>console</code>, the Buffer object, and <code>require()</code>. Others include some very familiar old friends: <code>setTimeout()</code>, <code>clearTimeout()</code>, <code>setInterval()</code>, and <code>clearInterval()</code>.</p>
        </div></section>
        
        
        
        
        
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect1" data-pdf-bookmark="Reading and Writing File Data"><div class="sect1" id="idm45475129687160">
        <h1>Reading and Writing File Data</h1>
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45475129685880">
        <h2>Problem</h2>
        
        <p><a data-type="indexterm" data-primary="data" data-secondary="reading/writing to files" id="ix_data_read-write"></a><a data-type="indexterm" data-primary="files" data-secondary="reading/writing data in Node" id="ix_files_read-write"></a><a data-type="indexterm" data-primary="reading and writing file data" id="ix_read-write_file"></a><a data-type="indexterm" data-primary="Node" data-secondary="reading and writing file data" id="ix_node_read-write"></a>You want to read from or write to a locally stored file.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45475129679800">
        <h2>Solution</h2>
        
        <p><a data-type="indexterm" data-primary="fs module" id="ix_fs_module"></a><a data-type="indexterm" data-primary="modules" data-secondary="fs module" id="ix_module_fs"></a><a data-type="indexterm" data-primary="text" data-secondary="working with in Node" id="idm45475129676200"></a>Node’s filesystem management functionality is included as part of the Node core, via the <code>fs</code> module:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">fs</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'fs'</code><code class="p">);</code></pre>
        
        <p>To read a file’s contents, use the <code>readFile()</code> function:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">fs</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'fs'</code><code class="p">);</code>
        
        <code class="nx">fs</code><code class="p">.</code><code class="nx">readFile</code><code class="p">(</code><code class="s1">'main.txt'</code><code class="p">,</code> <code class="s1">'utf8'</code><code class="p">,</code> <code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="k">throw</code> <code class="nx">err</code><code class="p">;</code>
          <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>
        <code class="p">});</code></pre>
        
        <p>To write to a file, use <code>writeFile()</code>:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">fs</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'fs'</code><code class="p">);</code>
        
        <code class="kr">const</code> <code class="nx">buf</code> <code class="o">=</code> <code class="s2">"I'm going to write this text to a file"</code><code class="p">;</code>
        <code class="nx">fs</code><code class="p">.</code><code class="nx">writeFile</code><code class="p">(</code><code class="s1">'main2.txt'</code><code class="p">,</code> <code class="nx">buf</code><code class="p">,</code> <code class="nx">err</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="k">throw</code> <code class="nx">err</code><code class="p">;</code>
          <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'wrote text to file'</code><code class="p">);</code>
        <code class="p">});</code></pre>
        
        <p><a data-type="indexterm" data-primary="appendText() function" id="idm45475129555928"></a>The <code>writeFile()</code> function overwrites the existing file. To append text to the file, use <code>appendText()</code>:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">fs</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'fs'</code><code class="p">);</code>
        
        <code class="kr">const</code> <code class="nx">buf</code> <code class="o">=</code> <code class="s2">"\nI'm going to add this text to a file"</code><code class="p">;</code>
        <code class="nx">fs</code><code class="p">.</code><code class="nx">appendFile</code><code class="p">(</code><code class="s1">'main.txt'</code><code class="p">,</code> <code class="nx">buf</code><code class="p">,</code> <code class="nx">err</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="k">throw</code> <code class="nx">err</code><code class="p">;</code>
          <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'appended text to file'</code><code class="p">);</code>
        <code class="p">});</code></pre>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45475129510712">
        <h2>Discussion</h2>
        
        <p><a data-type="indexterm" data-primary="readFile() function" id="idm45475129446968"></a>Node’s filesystem support is both comprehensive and simple to use. To read from a file, use the <code>readFile()</code> function, which supports the following parameters:</p>
        
        <ul>
        <li>
        <p>The filename, including the operating system path to the file if it isn’t local to the application</p>
        </li>
        <li>
        <p>An options object, with options for <code>encoding</code>, as demonstrated in the solution, and <code>flag</code>, which is set to <code>r</code> by default (for reading)</p>
        </li>
        <li>
        <p>A callback function with parameters for an error and the read data</p>
        </li>
        </ul>
        
        <p>In the solution, if I didn’t specify the encoding in my application, Node would have returned the file contents as a raw buffer. Since I did specify the encoding, the file content is returned as a string.</p>
        
        <p><a data-type="indexterm" data-primary="appendFile() function" id="idm45475129440248"></a><a data-type="indexterm" data-primary="writeFile() function" id="idm45475129439544"></a>The <code>writeFile()</code> and <code>appendFile()</code> functions for writing and appending, respectively, take parameters similar to <code>readFile()</code>:</p>
        
        <ul>
        <li>
        <p>The filename and path</p>
        </li>
        <li>
        <p>The string or buffer for the data to write to the file</p>
        </li>
        <li>
        <p>The options object, with options for <code>encoding</code> (<code>w</code> as default for <code>writeFile()</code> and <code>a</code> as the default for <code>appendFile()</code>) and <code>mode</code>, with a default value of <code>438</code> (<code>0666</code> in Octal)</p>
        </li>
        <li>
        <p>The callback function, with only one parameter: the error</p>
        </li>
        </ul>
        
        <p>The options value of <code>mode</code> can be used to set the file’s permissions if the file was created by write or append. By default, the file is created as readable and writable by the owner, and readable by the group and the world.</p>
        
        <p>I mentioned that the data to write can be either a buffer or a string. A string cannot handle binary data, so Node provides the buffer, which is capable of dealing with either strings or binary data. Both can be used in all of the filesystem functions discussed in this section, but you’ll need to explicitly convert between the two types if you want to use them both.</p>
        
        <p>For example, instead of providing the <em>utf8</em> <code>encoding</code> option when you use <code>writeFile()</code>, you convert the string to a buffer, providing the desired encoding when you do:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">fs</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'fs'</code><code class="p">);</code>
        
        <code class="kr">const</code> <code class="nx">str</code> <code class="o">=</code> <code class="s2">"I'm going to write this text to a file"</code><code class="p">;</code>
        <code class="kr">const</code> <code class="nx">buf</code> <code class="o">=</code> <code class="nx">Buffer</code><code class="p">.</code><code class="nx">from</code><code class="p">(</code><code class="nx">str</code><code class="p">,</code> <code class="s1">'utf8'</code><code class="p">);</code>
        <code class="nx">fs</code><code class="p">.</code><code class="nx">writeFile</code><code class="p">(</code><code class="s1">'mainbuf.txt'</code><code class="p">,</code> <code class="nx">buf</code><code class="p">,</code> <code class="nx">err</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="k">throw</code> <code class="nx">err</code><code class="p">;</code>
          <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'wrote text to file'</code><code class="p">);</code>
        <code class="p">});</code></pre>
        
        <p>The reverse—that is, to convert the buffer to a string—is just as simple:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">fs</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'fs'</code><code class="p">);</code>
        
        <code class="nx">fs</code><code class="p">.</code><code class="nx">readFile</code><code class="p">(</code><code class="s1">'main.txt'</code><code class="p">,</code> <code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="k">throw</code> <code class="nx">err</code><code class="p">;</code>
          <code class="kr">const</code> <code class="nx">str</code> <code class="o">=</code> <code class="nx">data</code><code class="p">.</code><code class="nx">toString</code><code class="p">();</code>
          <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">str</code><code class="p">);</code>
        <code class="p">});</code></pre>
        
        <p><a data-type="indexterm" data-primary="toString() method" data-secondary="file system" id="idm45475129304248"></a>The buffer <code>toString()</code> function has three optional parameters: encoding, where to begin the conversion, and where to end it. By default, the entire buffer is converted using the <em>utf8</em> encoding.</p>
        
        <p><a data-type="indexterm" data-primary="asynchronous programming" data-secondary="reading/writing files" id="idm45475129266808"></a>The <code>readFile()</code>, <code>writeFile()</code>, and <code>appendFile()</code> functions are <em>asynchronous</em>, meaning they won’t wait for the operation to finish before proceeding in the code. This is essential when it comes to notoriously slow operations such as file access. There are synchronous versions of each: <code>readFileSync()</code>, <code>writeFileSync()</code>, and <code>appendFileSync()</code>. I can’t stress enough that you should <em>not</em> use these variations. I only include a reference to them to be comprehensive.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Advanced"><div class="sect2" id="idm45475129447560">
        <h2>Advanced</h2>
        
        <p><a data-type="indexterm" data-primary="read() function" id="ix_read_func"></a><a data-type="indexterm" data-primary="write() function" id="ix_write_func"></a><a data-type="indexterm" data-primary="open() function, file system" id="ix_open_file"></a>Another way to read or write from a file is to use the <code>open()</code> function in combination with <code>read()</code> for reading the file contents, or <code>write()</code> for writing to the file. The advantages to this approach is more finite control of what happens during the process. The disadvantage is the added complexity associated with all of the functions, including only being able to use a buffer for reading from and writing to the file.</p>
        
        <p>The parameters for <code>open()</code> are:</p>
        
        <ul>
        <li>
        <p>Filename and path</p>
        </li>
        <li>
        <p>Flag</p>
        </li>
        </ul>
        
        <ul class="pagebreak-before less_space">
        <li>
        <p>Optional mode</p>
        </li>
        <li>
        <p>Callback function</p>
        </li>
        </ul>
        
        <p>The same <code>open()</code> is used with all operations, with the <em>flag</em> controlling what happens. There are quite a few flag options, but the ones that interest us the most at this time are:</p>
        <dl>
        <dt><code>r</code></dt>
        <dd>
        <p>Opens the file for reading; the file must exist</p>
        </dd>
        <dt><code>r</code>+</dt>
        <dd>
        <p>Opens the file for reading and writing; an exception occurs if the file doesn’t exist</p>
        </dd>
        <dt><code>w</code></dt>
        <dd>
        <p>Opens the file for writing, truncates the file, or creates it if it doesn’t exist</p>
        </dd>
        <dt><code>wx</code></dt>
        <dd>
        <p>Opens the file for writing, but fails if the file <em>does</em> exist</p>
        </dd>
        <dt><code>w</code>+</dt>
        <dd>
        <p>Opens the file for reading and writing; creates the file if it doesn’t exist; truncates the file if it exists</p>
        </dd>
        <dt><code>wx+</code></dt>
        <dd>
        <p>Similar to <code>w+</code>, but fails if the file exists</p>
        </dd>
        <dt><code>a</code></dt>
        <dd>
        <p>Opens the file for appending, creates it if it doesn’t exist</p>
        </dd>
        <dt><code>ax</code></dt>
        <dd>
        <p>Opens the file for appending, fails if the file exists</p>
        </dd>
        <dt><code>a</code>+</dt>
        <dd>
        <p>Opens the file for reading and appending; creates the file if it doesn’t exist</p>
        </dd>
        <dt><code>ax+</code></dt>
        <dd>
        <p>Similar to <code>a+</code>, but fails if the file exists</p>
        </dd>
        </dl>
        
        <p>The mode is the same one mentioned earlier, a value that sets the <em>sticky</em> and <em>permission</em> bits on the file if created, and defaults to <code>0666</code>. The callback function has two parameters: an error object, if an error occurs, and a <em>file descriptor</em>, used by subsequent file operations.</p>
        
        <p>The <code>read()</code> and <code>write()</code> functions share the same basic types of parameters:</p>
        
        <ul>
        <li>
        <p>The <code>open()</code> methods callback file descriptor</p>
        </li>
        <li>
        <p>The buffer used to either hold data to be written or appended, or read</p>
        </li>
        <li>
        <p>The offset where the input/output (I/O) operation begins</p>
        </li>
        <li>
        <p>The buffer length (set by read operation, controls write operation)</p>
        </li>
        <li>
        <p>Position in the file where the operation is to take place; <em>null</em> if the position is the current position</p>
        </li>
        </ul>
        
        <p>The callback functions for both methods have three arguments: an error, bytes read (or written), and the buffer.</p>
        
        <p>That’s a lot of parameters and options. The best way to demonstrate how it all works is to create a complete Node application that opens a brand new file for writing, writes some text to it, writes some more text to it, and then reads all the text back and prints it to the <code>console</code>. Since <code>open()</code> is asynchronous, the read and write operations have to occur within the callback function. Be ready for it in <a data-type="xref" href="#testing_read_write">Example&nbsp;17-2</a>, because you’re going to get your first taste of a concept known as <em>callback hell</em>.</p>
        <div id="testing_read_write" data-type="example">
        <h5><span class="label">Example 17-2. </span>Demonstrating open, read, and write</h5>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">fs</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'fs'</code><code class="p">);</code>
        
        <code class="nx">fs</code><code class="p">.</code><code class="nx">open</code><code class="p">(</code><code class="s1">'newfile.txt'</code><code class="p">,</code> <code class="s1">'a+'</code><code class="p">,</code> <code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">fd</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="p">{</code>
            <code class="k">throw</code> <code class="nx">err</code><code class="p">;</code>
          <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
            <code class="kr">const</code> <code class="nx">buf</code> <code class="o">=</code> <code class="nx">Buffer</code><code class="p">.</code><code class="nx">from</code><code class="p">(</code><code class="s1">'The first string\n'</code><code class="p">);</code>
            <code class="nx">fs</code><code class="p">.</code><code class="nx">write</code><code class="p">(</code><code class="nx">fd</code><code class="p">,</code> <code class="nx">buf</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="nx">buf</code><code class="p">.</code><code class="nx">length</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">written</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
              <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="p">{</code>
                <code class="k">throw</code> <code class="nx">err</code><code class="p">;</code>
              <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
                <code class="kr">const</code> <code class="nx">buf2</code> <code class="o">=</code> <code class="nx">Buffer</code><code class="p">.</code><code class="nx">from</code><code class="p">(</code><code class="s1">'The second string\n'</code><code class="p">);</code>
                <code class="nx">fs</code><code class="p">.</code><code class="nx">write</code><code class="p">(</code><code class="nx">fd</code><code class="p">,</code> <code class="nx">buf2</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="nx">buf2</code><code class="p">.</code><code class="nx">length</code><code class="p">,</code> <code class="nx">buf</code><code class="p">.</code><code class="nx">length</code><code class="p">,</code> <code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">written2</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
                  <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="p">{</code>
                    <code class="k">throw</code> <code class="nx">err</code><code class="p">;</code>
                  <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
                    <code class="kr">const</code> <code class="nx">length</code> <code class="o">=</code> <code class="nx">written</code> <code class="o">+</code> <code class="nx">written2</code><code class="p">;</code>
                    <code class="kr">const</code> <code class="nx">buf3</code> <code class="o">=</code> <code class="nx">Buffer</code><code class="p">.</code><code class="nx">alloc</code><code class="p">(</code><code class="nx">length</code><code class="p">);</code>
                    <code class="nx">fs</code><code class="p">.</code><code class="nx">read</code><code class="p">(</code><code class="nx">fd</code><code class="p">,</code> <code class="nx">buf3</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="nx">length</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code> <code class="nx">err</code> <code class="o">=&gt;</code> <code class="p">{</code>
                      <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="p">{</code>
                        <code class="k">throw</code> <code class="nx">err</code><code class="p">;</code>
                      <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
                        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">buf3</code><code class="p">.</code><code class="nx">toString</code><code class="p">());</code>
                      <code class="p">}</code>
                    <code class="p">});</code>
                  <code class="p">}</code>
                <code class="p">});</code>
              <code class="p">}</code>
            <code class="p">});</code>
          <code class="p">}</code>
        <code class="p">});</code></pre></div>
        <div data-type="note" epub:type="note"><h6>Note</h6>
        <p>Taming callbacks is covered in <a data-type="xref" href="ch19.html#managing_callback_hell">“Managing Callback Hell”</a>.</p>
        </div>
        
        <p>To find the length of the buffers, I used <code>length</code>, which returns the number of bytes for the buffer. This value doesn’t necessarily match the length of a string in the buffer, but it does work in this usage.</p>
        
        <p>That many levels of indentation can make your skin crawl, but the example demonstrates how <code>open()</code>, <code>read()</code>, and <code>write()</code> work. These combinations of functions are what’s used within the <code>readFile()</code>, <code>writeFile()</code>, and <code>appendFile()</code> functions to manage file access. The higher-level functions just simplify the most common file operations.</p>
        <div data-type="note" epub:type="note"><h6>Note</h6>
        <p>See <a data-type="xref" href="ch19.html#managing_callback_hell">“Managing Callback Hell”</a> for a solution to all that nasty indentation.<a data-type="indexterm" data-primary="" data-startref="ix_node_read-write" id="idm45475129011192"></a><a data-type="indexterm" data-primary="" data-startref="ix_files_read-write" id="idm45475129010248"></a><a data-type="indexterm" data-primary="" data-startref="ix_read-write_file" id="idm45475129009304"></a><a data-type="indexterm" data-primary="" data-startref="ix_data_read-write" id="idm45475129008360"></a><a data-type="indexterm" data-primary="" data-startref="ix_fs_module" id="idm45475129007416"></a><a data-type="indexterm" data-primary="" data-startref="ix_module_fs" id="idm45475129006472"></a><a data-type="indexterm" data-primary="" data-startref="ix_open_file" id="idm45475129005528"></a><a data-type="indexterm" data-primary="" data-startref="ix_read_func" id="idm45475129004584"></a><a data-type="indexterm" data-primary="" data-startref="ix_write_func" id="idm45475129003640"></a></p>
        </div>
        </div></section>
        
        
        
        
        
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect1" data-pdf-bookmark="Getting Input from the Terminal"><div class="sect1" id="idm45475129261336">
        <h1>Getting Input from the Terminal</h1>
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45475129001480">
        <h2>Problem</h2>
        
        <p><a data-type="indexterm" data-primary="terminal, using in Node or npm" id="ix_terminal_node"></a><a data-type="indexterm" data-primary="Node" data-secondary="input from terminal" id="ix_node_terminal_input"></a>You want to get input from the application user via the terminal.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45475128997736">
        <h2>Solution</h2>
        
        <p><a data-type="indexterm" data-primary="modules" data-secondary="Readline" id="ix_module_readline"></a><a data-type="indexterm" data-primary="Readline module" id="ix_readline_module"></a>Use Node’s Readline module.</p>
        
        <p>To get data from the standard input, use code such as the following:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">readline</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'readline'</code><code class="p">);</code>
        
        <code class="kr">const</code> <code class="nx">rl</code> <code class="o">=</code> <code class="nx">readline</code><code class="p">.</code><code class="nx">createInterface</code><code class="p">({</code>
          <code class="nx">input</code><code class="o">:</code> <code class="nx">process</code><code class="p">.</code><code class="nx">stdin</code><code class="p">,</code>
          <code class="nx">output</code><code class="o">:</code> <code class="nx">process</code><code class="p">.</code><code class="nx">stdout</code>
        <code class="p">});</code>
        
        <code class="nx">rl</code><code class="p">.</code><code class="nx">question</code><code class="p">(</code><code class="s2">"&gt;&gt;What's your name?  "</code><code class="p">,</code> <code class="nx">answer</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`Hello </code><code class="si">${</code><code class="nx">answer</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
          <code class="nx">rl</code><code class="p">.</code><code class="nx">close</code><code class="p">();</code>
        <code class="p">});</code></pre>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45475128992408">
        <h2>Discussion</h2>
        
        <p>The Readline module provides the ability to get lines of text from a readable stream. <a data-type="indexterm" data-primary="createInterface() function" id="idm45475128946856"></a>You start by creating an instance of the Readline interface with <code>createInterface()</code> passing in, at minimum, the readable and writable streams. You need both, because you’re writing prompts, as well as reading in text. In the solution, the input stream is <code>process.stdin</code>, the standard input stream, and the output stream is <code>process.stdout</code>. In other words, input and output are from, and to, the command line.</p>
        
        <p><a data-type="indexterm" data-primary="question() function" id="idm45475128944360"></a><a data-type="indexterm" data-primary="callback function" data-secondary="Readline module" id="idm45475128943656"></a>The solution uses the <code>question()</code> function to post a question, and provides a callback function to process the response. Within the function, <code>close()</code> is called, which closes the interface, releasing control of the input and output streams.</p>
        
        <p>You can also create an application that continues to listen to the input, taking some action on the incoming data, until something signals the application to end. Typically that something is a letter sequence signaling the person is done, such as the word <em>exit</em>. This type of application makes use of other Readline functions, such as <code>setPrompt()</code> to change the prompt given the individual for each line of text; <code>prompt()</code>, which prepares the input area, including changing the prompt to the one set by <code>setPrompt()</code>; and <code>write()</code>, to write out a prompt. In addition, you’ll also need to use event handlers to process events, such as <code>line</code>, which listens for each new line of text.</p>
        
        <p><a data-type="xref" href="#continuous_loop_of_text">Example&nbsp;17-3</a> contains a complete Node application that continues to process input from the user until they type in <code>exit</code>. Note that the application makes use of <code>process.exit()</code>. <a data-type="indexterm" data-primary="process.exit() function" id="idm45475128935944"></a>This function cleanly terminates the Node application.</p>
        <div id="continuous_loop_of_text" data-type="example">
        <h5><span class="label">Example 17-3. </span>Access numbers from stdin until the user types in <em>exit</em></h5>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">readline</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'readline'</code><code class="p">);</code>
        
        <code class="kd">let</code> <code class="nx">sum</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>
        
        <code class="kr">const</code> <code class="nx">rl</code> <code class="o">=</code> <code class="nx">readline</code><code class="p">.</code><code class="nx">createInterface</code><code class="p">({</code>
          <code class="nx">input</code><code class="o">:</code> <code class="nx">process</code><code class="p">.</code><code class="nx">stdin</code><code class="p">,</code>
          <code class="nx">output</code><code class="o">:</code> <code class="nx">process</code><code class="p">.</code><code class="nx">stdout</code>
        <code class="p">});</code>
        
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s2">"Enter numbers, one to a line. Enter 'exit' to quit."</code><code class="p">);</code>
        
        <code class="nx">rl</code><code class="p">.</code><code class="nx">setPrompt</code><code class="p">(</code><code class="s1">'&gt;&gt; '</code><code class="p">);</code>
        <code class="nx">rl</code><code class="p">.</code><code class="nx">prompt</code><code class="p">();</code>
        
        <code class="nx">rl</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'line'</code><code class="p">,</code> <code class="nx">input</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="kr">const</code> <code class="nx">userInput</code> <code class="o">=</code> <code class="nx">input</code><code class="p">.</code><code class="nx">trim</code><code class="p">();</code>
          <code class="k">if</code> <code class="p">(</code><code class="nx">userInput</code> <code class="o">===</code> <code class="s1">'exit'</code><code class="p">)</code> <code class="p">{</code>
            <code class="nx">rl</code><code class="p">.</code><code class="nx">close</code><code class="p">();</code>
            <code class="k">return</code><code class="p">;</code>
          <code class="p">}</code>
          <code class="nx">sum</code> <code class="o">+=</code> <code class="nb">Number</code><code class="p">(</code><code class="nx">userInput</code><code class="p">);</code>
          <code class="nx">rl</code><code class="p">.</code><code class="nx">prompt</code><code class="p">();</code>
        <code class="p">});</code>
        
        <code class="c1">// user typed in 'exit'</code>
        <code class="nx">rl</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'close'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`Total is </code><code class="si">${</code><code class="nx">sum</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
          <code class="nx">process</code><code class="p">.</code><code class="nx">exit</code><code class="p">(</code><code class="mi">0</code><code class="p">);</code>
        <code class="p">});</code></pre></div>
        
        <p>Running the application with several numbers results in the following output:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">Enter</code> <code class="nx">numbers</code><code class="p">,</code> <code class="nx">one</code> <code class="nx">to</code> <code class="nx">a</code> <code class="nx">line</code><code class="p">.</code> <code class="nx">Enter</code> <code class="s1">'exit'</code> <code class="nx">to</code> <code class="nx">quit</code><code class="p">.</code>
        <code class="o">&gt;&gt;</code> <code class="mi">55</code>
        <code class="o">&gt;&gt;</code> <code class="mi">209</code>
        <code class="o">&gt;&gt;</code> <code class="mf">23.44</code>
        <code class="o">&gt;&gt;</code> <code class="mi">0</code>
        <code class="o">&gt;&gt;</code> <code class="mi">1</code>
        <code class="o">&gt;&gt;</code> <code class="mi">6</code>
        <code class="o">&gt;&gt;</code> <code class="nx">exit</code>
        <code class="nx">Total</code> <code class="nx">is</code> <code class="mf">294.44</code></pre>
        
        <p>I used <code>console.log()</code> rather than the Readline interface <code>write()</code> to write the prompt, followed by a new line, and to differentiate the output from the input.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="See Also"><div class="sect2" id="idm45475128648504">
        <h2>See Also</h2>
        
        <p><a data-type="xref" href="ch19.html#ch19">Chapter&nbsp;19</a> covers passing and reading command-line arguments in Node <span class="keep-together">applications</span>.<a data-type="indexterm" data-primary="" data-startref="ix_node_terminal_input" id="idm45475128645880"></a><a data-type="indexterm" data-primary="" data-startref="ix_terminal_node" id="idm45475128644872"></a><a data-type="indexterm" data-primary="" data-startref="ix_module_readline" id="idm45475128643928"></a><a data-type="indexterm" data-primary="" data-startref="ix_readline_module" id="idm45475128642984"></a></p>
        </div></section>
        
        
        
        
        
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect1" data-pdf-bookmark="Getting the Path to the Current Script"><div class="sect1" id="current-path">
        <h1>Getting the Path to the Current Script</h1>
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45475128640360">
        <h2>Problem</h2>
        
        <p><a data-type="indexterm" data-primary="Node" data-secondary="path to current script" id="idm45475128639160"></a>Your application needs to read the path of the script that is being executed.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45475128637800">
        <h2>Solution</h2>
        
        <p><a data-type="indexterm" data-primary="_dirname variable" data-primary-sortas="dirname variable" id="idm45475128636632"></a><a data-type="indexterm" data-primary="_filename variable" data-primary-sortas="filename variable" id="idm45475128635656"></a>Use the <code>__dirname</code> or <code>__filename</code> variables, which are in the scope of the module executing it:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="c1">// logs the directory of the currently executed file</code>
        <code class="c1">// ex: /Users/Adam/Projects/js-cookbook/node</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">__dirname</code><code class="p">);</code>
        
        <code class="c1">// logs the directory and filename of the currently executed file</code>
        <code class="c1">// ex: /Users/Adam/Projects/js-cookbook/node/example.js</code>
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">__filename</code><code class="p">);</code></pre>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45475128524616">
        <h2>Discussion</h2>
        
        <p>The <code>__dirname</code> or <code>__filename</code> variables appear to be in the global scope, but they actually exist in the scope of the module itself. Let’s assume that you have a project with the following directory structure:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">example</code><code class="o">-</code><code class="nx">app</code>
        <code class="o">|</code>   <code class="nx">index</code><code class="p">.</code><code class="nx">js</code>
        <code class="err">├───</code><code class="nx">dir1</code>
        <code class="o">|</code>   <code class="o">|</code>   <code class="nx">example</code><code class="p">.</code><code class="nx">js</code>
        <code class="o">|</code>   <code class="err">└───</code><code class="nx">dir3</code>
        <code class="o">|</code>       <code class="o">|</code>   <code class="nx">nested</code><code class="p">.</code><code class="nx">js</code></pre>
        
        <p>If you were to read the <code>__dirname</code> in the index.js file, it would be the path to the project’s root directory. However, reading the <code>__dirname</code> in from a script in the <em>nested.js</em> file would read the path to the <em>dir3</em> directory. This allows you to read the path of a module as it’s executed, rather than being limited to the parent directory itself.</p>
        
        <p>A useful example of <code>__dirname</code> in action is when creating a new file or directory within the current directory. In the following example, the script creates a new subdirectory named <em>cache</em> within the current file’s directory:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">fs</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'fs'</code><code class="p">);</code>
        <code class="kr">const</code> <code class="nx">path</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'path'</code><code class="p">);</code>
        <code class="kr">const</code> <code class="nx">newDirectoryPath</code> <code class="o">=</code> <code class="nx">path</code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code class="nx">__dirname</code><code class="p">,</code> <code class="s1">'/cache'</code><code class="p">);</code>
        
        <code class="nx">fs</code><code class="p">.</code><code class="nx">mkdirSync</code><code class="p">(</code><code class="nx">newDirectoryPath</code><code class="p">);</code></pre>
        </div></section>
        
        
        
        
        
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect1" data-pdf-bookmark="Working with Node Timers and Understanding the Node Event Loop"><div class="sect1" id="node_timers">
        <h1>Working with Node Timers and Understanding the Node Event Loop</h1>
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45475128445848">
        <h2>Problem</h2>
        
        <p><a data-type="indexterm" data-primary="timers" data-secondary="Node" id="ix_timer_node"></a><a data-type="indexterm" data-primary="Node" data-secondary="timers and event loop" id="ix_node_timer_event"></a>You need to use a timer in a Node application, but you’re not sure which of Node’s three timers to use, or how accurate they are.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45475128441800">
        <h2>Solution</h2>
        
        <p><a data-type="indexterm" data-primary="setInterval() function, Node" id="idm45475128440392"></a><a data-type="indexterm" data-primary="setTimeout() function" data-secondary="Node" id="idm45475128439720"></a>If your timer doesn’t have to be precise, you can use <code>setTimeout()</code> to create a single timer event, or <code>setInterval()</code> if you want a reccurring timer:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">setTimeout</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{},</code> <code class="mi">3000</code><code class="p">);</code>
        
        <code class="nx">setInterval</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{},</code> <code class="mi">3000</code><code class="p">);</code></pre>
        
        <p>Both function timers can be canceled:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">timer1</code> <code class="o">=</code> <code class="nx">setTimeout</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{},</code> <code class="mi">3000</code><code class="p">);</code>
        <code class="nx">clearTimeout</code><code class="p">(</code><code class="nx">timer1</code><code class="p">);</code>
        
        <code class="kr">const</code> <code class="nx">timer2</code> <code class="o">=</code> <code class="nx">setInterval</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{},</code> <code class="mi">3000</code><code class="p">);</code>
        <code class="nx">clearInterval</code><code class="p">(</code><code class="nx">timer2</code><code class="p">);</code></pre>
        
        <p><a data-type="indexterm" data-primary="setImmediate() function" id="idm45475128430984"></a>However, if you need more finite control of your timer, and immediate results, you might want to use <code>setImmediate()</code>. You don’t specify a delay for it, as you want the callback to be invoked <em>immediately</em> after all I/O callbacks are processed but before any <code>setTimeout()</code> or <code>setInterval()</code> callbacks:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">setImmediate</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{});</code></pre>
        
        <p><a data-type="indexterm" data-primary="clearImmediate() function" id="idm45475128346600"></a>It, too, can be cleared, with <code>clearImmediate()</code>.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45475128293000">
        <h2>Discussion</h2>
        
        <p><a data-type="indexterm" data-primary="asynchronous programming" data-secondary="Node timers and" id="ix_async_node1"></a><a data-type="indexterm" data-primary="I/O operations, Node and" id="ix_io_node"></a><a data-type="indexterm" data-primary="event loop" id="ix_event_loop"></a>Node, being JavaScript based, runs on a single thread. It is <em>synchronous</em>. However, input/output (I/O) and other native API access either runs <em>asynchronously</em> or on a separate thread. Node’s approach to managing this timing disconnect is the <em>event loop</em>.</p>
        
        <p><a data-type="indexterm" data-primary="callback function" data-secondary="Node timers" id="idm45475128341192"></a>In your code, when you perform an I/O operation, such as writing a chunk of text to a file, you specify a callback function to do any post-write activity. Once you’ve done so, the rest of your application code is processed. It doesn’t wait for the file write to finish. When the file write has finished, an event signaling the fact is returned to Node, and pushed on to a queue, waiting for processing. Node processes this event queue, and when it gets to the event signaled by the completed file write, it matches the event to the callback, and the callback is processed.</p>
        
        <p>As a comparison, think of going into a deli and ordering lunch. You wait in line to place your order, and are given an order number. You sit down and read the paper, or check your Twitter account while you wait. In the meantime, the lunch orders go into another queue for deli workers to process the orders. But each lunch request isn’t always finished in the order received. Some lunch orders may take longer. They may need to bake or grill for a longer time. So the deli worker processes your order by preparing your lunch item and then placing it in an oven, setting a timer for when it’s finished, and goes on to other tasks.</p>
        
        <p>When the timer pings, the deli worker quickly finishes their current task, and pulls your lunch order from the oven. You’re then notified that your lunch is ready for pickup by your order number being called out. If several time-consuming lunch items are being processed at the same time, the deli worker processes them as the timer for each item pings, in order.</p>
        
        <p>All Node processes fit the pattern of the deli order queue: first in, first to be sent to the deli (thread) workers. However, certain operations, such as I/O, are like those lunch orders that need extra time to bake in an oven or grill, but don’t require the deli worker to stop any other effort and wait for the baking and grilling. The oven or grill timers are equivalent to the messages that appear in the Node event loop, triggering a final action based on the requested operation.</p>
        
        <p>You now have a working blend of synchronous and asynchronous processes. But what happens with a timer?</p>
        
        <p>Both <code>setTimeout()</code> and <code>setInterval()</code> fire after the given delay, but what happens is a message to this effect is added to the event loop, to be processed in turn. So if the event loop is particularly cluttered, there is a delay before the the timer functions’ callbacks are called:</p>
        <blockquote>
        <p>It is important to note that your callback will probably not be called in exactly (delay) milliseconds. Node.js makes no guarantees about the exact timing of when the callback will fire, nor of the ordering things will fire in. The callback will be called as close as possible to the time specified.</p>
        <p data-type="attribution">Node Timers documentation</p>
        </blockquote>
        
        <p>For the most part, whatever delay happens is beyond the kin of our human senses, but it can result in animations that don’t seem to run smoothly. It can also add an odd effect to other applications.<a data-type="indexterm" data-primary="" data-startref="ix_io_node" id="idm45475128330216"></a><a data-type="indexterm" data-primary="" data-startref="ix_event_loop" id="idm45475128329240"></a></p>
        
        <p>In <a data-type="xref" href="#feeding_scrolling_timeline">Example&nbsp;17-4</a>, I created a scrolling timeline in SVG, with data fed to the client via WebSockets. To emulate real-world data, I used a three-second timer and randomly generated a number to act as a data value. In the server code, I used <code>setInterval()</code>, because the timer is reccurring:</p>
        <div id="feeding_scrolling_timeline" data-type="example">
        <h5><span class="label">Example 17-4. </span>Scrolling timeline example</h5>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'http'</code><code class="p">);</code>
        <code class="kr">const</code> <code class="nx">fs</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'fs'</code><code class="p">);</code>
        <code class="kr">const</code> <code class="nx">ws</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'nodejs-websocket'</code><code class="p">);</code>
        
        <code class="kd">let</code> <code class="nx">server</code><code class="p">;</code>
        
        <code class="c1">// serve static page</code>
        <code class="kr">const</code> <code class="nx">handler</code> <code class="o">=</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">fs</code><code class="p">.</code><code class="nx">readFile</code><code class="p">(</code><code class="sb">`</code><code class="si">${</code><code class="nx">__dirname</code><code class="si">}</code><code class="sb">/drawline.html`</code><code class="p">,</code> <code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
            <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="p">{</code>
              <code class="nx">res</code><code class="p">.</code><code class="nx">writeHead</code><code class="p">(</code><code class="mi">500</code><code class="p">);</code>
              <code class="k">return</code> <code class="nx">res</code><code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="s1">'Error loading drawline.html'</code><code class="p">);</code>
            <code class="p">}</code>
            <code class="nx">res</code><code class="p">.</code><code class="nx">writeHead</code><code class="p">(</code><code class="mi">200</code><code class="p">);</code>
            <code class="nx">res</code><code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>
            <code class="k">return</code> <code class="nx">data</code><code class="p">;</code>
          <code class="p">});</code>
        <code class="p">};</code>
        
        <code class="c1">/// start the webserver</code>
        <code class="c1">// connections on Port 8124 will be handled by the handler</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="mi">8124</code><code class="p">);</code>
        <code class="nx">app</code><code class="p">.</code><code class="nx">createServer</code><code class="p">(</code><code class="nx">handler</code><code class="p">);</code>
        
        <code class="c1">// data timer</code>
        <code class="kr">const</code> <code class="nx">startTimer</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">setInterval</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>
            <code class="kr">const</code> <code class="nx">newval</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">floor</code><code class="p">(</code><code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">()</code> <code class="o">*</code> <code class="mi">100</code><code class="p">)</code> <code class="o">+</code> <code class="mi">1</code><code class="p">;</code>
            <code class="k">if</code> <code class="p">(</code><code class="nx">server</code><code class="p">.</code><code class="nx">connections</code><code class="p">.</code><code class="nx">length</code> <code class="o">&gt;</code> <code class="mi">0</code><code class="p">)</code> <code class="p">{</code>
              <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`sending </code><code class="si">${</code><code class="nx">newval</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
              <code class="kr">const</code> <code class="nx">counter</code> <code class="o">=</code> <code class="p">{</code> <code class="nx">counter</code><code class="o">:</code> <code class="nx">newval</code> <code class="p">};</code>
              <code class="nx">server</code><code class="p">.</code><code class="nx">connections</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="nx">conn</code> <code class="o">=&gt;</code> <code class="p">{</code>
                <code class="nx">conn</code><code class="p">.</code><code class="nx">sendText</code><code class="p">(</code><code class="nx">JSON</code><code class="p">.</code><code class="nx">stringify</code><code class="p">(</code><code class="nx">counter</code><code class="p">),</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
                  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'conn sent'</code><code class="p">);</code>
                <code class="p">});</code>
              <code class="p">});</code>
            <code class="p">}</code>
          <code class="p">},</code> <code class="mi">3000</code><code class="p">);</code>
        <code class="p">};</code>
        
        <code class="c1">// Create a websocket connection handler on a different port</code>
        <code class="nx">server</code> <code class="o">=</code> <code class="nx">ws</code>
          <code class="p">.</code><code class="nx">createServer</code><code class="p">(</code><code class="nx">conn</code> <code class="o">=&gt;</code> <code class="p">{</code>
            <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'connected'</code><code class="p">);</code>
            <code class="nx">conn</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'close'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
              <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Connection closed'</code><code class="p">);</code>
            <code class="p">});</code>
          <code class="p">})</code>
          <code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="mi">8001</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
            <code class="nx">startTimer</code><code class="p">();</code>
          <code class="p">});</code></pre></div>
        
        <p>I included <code>console.log()</code> to call in the code so you can see the timer event in comparison to the communication responses. When the <code>setInterval()</code> function is called, it’s pushed into the process. When its callback is processed, the WebSocket communications are also pushed into the queue.</p>
        
        <p><a data-type="indexterm" data-primary="setInterval() function, Node" id="idm45475128264904"></a>The solution uses <code>setInterval()</code>, one of Node’s three different types of timers. The <code>setInterval()</code> function has the same format as the one we use in the browser. You specify a callback for the first function, provide a delay time (in milliseconds), and any potential arguments. The timer is going to fire in three seconds, but we already know that the callback for the timer may not be immediately processed.</p>
        
        <p><a data-type="indexterm" data-primary="text" data-secondary="working with in Node" id="idm45475128262664"></a><a data-type="indexterm" data-primary="socket.write() function" id="idm45475128261688"></a><a data-type="indexterm" data-primary="sendText() function" id="idm45475128046488"></a>The same applies to the callbacks passed in the WebSocket <code>sendText()</code> calls. These are based on Node’s Net (or TLS, if secure) sockets, and as the <code>socket.write()</code> (what’s used for <code>sendText()</code>) documentation notes:</p>
        <blockquote>
        <p>The optional callback parameter will be executed when the data is finally written out—this may not be immediately.</p>
        <p data-type="attribution">Node documentation</p>
        </blockquote>
        
        <p>If you set the timer to invoke immediately (giving zero as the delay value), you’ll see that the data sent message is interspersed with the communication sent message (before the browser client freezes up, overwhelmed by the socket communications—you don’t want to use a zero value in the application again).</p>
        
        <p><a data-type="indexterm" data-primary="callback function" data-secondary="Node timers" id="idm45475128041656"></a>However, the timelines for all the clients remain the same because the communications are sent within the timer’s callback function, <em>synchronously</em>, so the data is the same for all of the communications—it’s just the callbacks that are handled, seemingly out of order.</p>
        
        <p>Earlier I mentioned using <code>setInterval()</code> with a delay of zero. In actuality, it isn’t exactly zero—Node follows the HTML5 specification that browsers adhere to, and “clamps” the timer interval to a minimum value of four milliseconds. While this may seem to be too small of an amount to cause a problem, when it comes to animations and time-critical processes, the time delay can impact the overall appearance and/or function.</p>
        
        <p><a data-type="indexterm" data-primary="process.nextTick() function" id="idm45475128038344"></a>To bypass the constraints, Node developers utilize Node’s <code>process.nextTick()</code> instead. The callback associated with <code>process.nextTick()</code> is processed on the next event loop go around, usually before any I/O callbacks (though there are constraints, which I’ll get to in a minute). No more pesky four-millisecond throttling. But then, what happens if there’s an enormous number of recursively called <code>process.nextTick()</code> calls?</p>
        
        <p>To return to our deli analogy, during a busy lunch hour, workers can be overrun with orders and so caught up in trying to process new orders that they don’t respond in a timely manner to the oven and grill pings. Things burn when this happens. If you’ve ever been to a well-run deli, you’ll notice the counter person taking the orders will assess the kitchen before taking the order, tossing in some slight delay, or even taking on some of the kitchen duties, letting the people wait just a tiny bit longer in the order queue.</p>
        
        <p>The same happens with Node. If <code>process.nextTick()</code> were allowed to be the spoiled child, always getting its way, I/O operations would get starved out. Node uses another value, <code>process.maxTickDepth</code>, with a default value of 1000 to constrain the number of <code>process.next()</code> callbacks that are processed before the I/O callbacks are allowed to play. It’s the counter person in the deli.</p>
        
        <p>In more recent releases of Node, the <code>setImmediate()</code> function was added. This function  attempts to resolve all of the issues associated with the timing operations and create a happy medium that should work for most folks. When <code>setImmediate()</code> is called, its callback is added after the I/O callbacks, but before the <code>setTimeout()</code> and <code>setInterval()</code> callbacks. We don’t have the four-millisecond tax for the traditional timers, but we also don’t have the brat that is <code>process.nextTick()</code>.</p>
        
        <p>To return one last time to the deli analogy, <code>setImmediate()</code> is a customer in the order queue who sees that the deli workers are overwhelmed with pinging ovens, and politely states they’ll wait to give their order.<a data-type="indexterm" data-primary="" data-startref="ix_node_timer_event" id="idm45475128028904"></a><a data-type="indexterm" data-primary="" data-startref="ix_timer_node" id="idm45475128027928"></a><a data-type="indexterm" data-primary="" id="ix_async_node"></a></p>
        <div data-type="caution"><h6>Caution</h6>
        <p>However, you do <em>not</em> want to use <code>setImmediate()</code> in the scrolling timeline example, as it will freeze your browser up faster than you can blink.</p>
        </div>
        </div></section>
        
        
        
        
        
        </div></section>
        
        
        
        
        
        
        
        </div></section></div></div><link rel="stylesheet" href="/files/public/epub-reader/override_v1.css" crossorigin="anonymous"><link rel="stylesheet" href="/api/v2/epubs/urn:orm:book:9781492055747/files/epub.css" crossorigin="anonymous"></div></div></section>
</div>

https://learning.oreilly.com