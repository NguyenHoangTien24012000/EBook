<style>
    @font-face {
        font-family: Roboto;
        font-style: normal;
        font-weight: 300;
        src: url(https://static.contineljs.com/fonts/Roboto-Light.woff2) format("woff2"),
            url(https://static.contineljs.com/fonts/Roboto-Light.woff) format("woff");
    }

    @font-face {
        font-family: Roboto;
        font-style: normal;
        font-weight: 400;
        src: url(https://static.contineljs.com/fonts/Roboto-Regular.woff2) format("woff2"),
            url(https://static.contineljs.com/fonts/Roboto-Regular.woff) format("woff");
    }

    @font-face {
        font-family: Roboto;
        font-style: normal;
        font-weight: 500;
        src: url(https://static.contineljs.com/fonts/Roboto-Medium.woff2?v=2) format("woff2"),
            url(https://static.contineljs.com/fonts/Roboto-Medium.woff) format("woff");
    }

    @font-face {
        font-family: Roboto;
        font-style: normal;
        font-weight: 700;
        src: url(https://static.contineljs.com/fonts/Roboto-Bold.woff2) format("woff2"),
            url(https://static.contineljs.com/fonts/Roboto-Bold.woff) format("woff");
    }

    * {
        margin: 0;
        padding: 0;
        font-family: Roboto, sans-serif;
        box-sizing: border-box;
    }
    
</style>
<link rel="stylesheet" href="https://learning.oreilly.com/files/public/epub-reader/override_v1.css" crossorigin="anonymous"><link rel="stylesheet" href="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492092506/files/epub.css" crossorigin="anonymous">
<div style="width: 100%; display: flex; justify-content: center; background-color: black; color: wheat;">
    <section data-testid="contentViewer" class="contentViewer--KzjY1"><div class="annotatable--okKet"><div id="book-content" class="noOutline" tabindex="-1"><div class="readerContainer--bZ89H white--bfCci" style="font-size: 1em; max-width: 70ch;"><div id="sbo-rt-content"><div class="chapter" title="Chapter&nbsp;11.&nbsp;Serious functions"><div class="titlepage"><div><div><h1 class="title"><a id="anonymous_functionscomma_scope_and_closu"></a>Chapter&nbsp;11.&nbsp;Serious functions</h1></div><div><h3 class="subtitle">Anonymous Functions, Scope and Closures</h3></div></div></div><div class="informalfigure"><a id="med_id00789a"></a><div class="mediaobject"><a id="med_id00789"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113878.png.jpg" alt="image with no caption" width="646" height="464"></div></div><p><a id="iddle1013" class="indexterm"></a><a id="iddle1714" class="indexterm"></a><span class="strong"><strong>You’ve put functions through their paces, but
        there’s more to learn.</strong></span> In this chapter we take it further; we get hard-core.
        We’re going to show you how to <span class="strong"><strong>really handle</strong></span> functions.
        This won’t be a super long chapter, but it will be intense, and at the end you’re going
        to be more expressive with your JavaScript than you thought possible. You’re also going to be
        ready to take on a coworker’s code, or jump into an open source JavaScript library, because
        we’re going to cover some common coding idioms and conventions around functions. And if
        you’ve never heard of an <span class="strong"><strong>anonymous function</strong></span> or a <span class="strong"><strong>closure</strong></span>, boy are you in the right place.</p><div class="note" title="Note"><h3 class="title"><a id="ch11note01"></a>Note</h3><p>And if you have heard of a closure, but don’t quite know what it is, you’re even more in the right place!</p></div><div class="sect1" title="Taking a look at the other side of functions..."><div class="titlepage"><div><div><h1 class="title"><a id="taking_a_look_at_the_other_side_of_funct"></a>Taking a look at the other side of functions...</h1></div></div></div><div class="informalfigure"><a id="med_id00790a"></a><div class="mediaobject"><a id="med_id00790"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113880.png.jpg" alt="image with no caption" width="192" height="400"></div></div><p><a id="iddle1858" class="indexterm"></a><a id="iddle2203" class="indexterm"></a><a id="iddle2576" class="indexterm"></a><a id="iddle2755" class="indexterm"></a><a id="iddle3097" class="indexterm"></a>You’ve already seen two sides of functions—you’ve seen the formal, declarative side of function declarations, and you’ve seen the looser, more expressive side of function expressions. Well, now it’s time to introduce you to another interesting side of functions: <span class="emphasis"><em>the anonymous side.</em></span></p><p>By anonymous we’re referring to functions <span class="emphasis"><em>that don’t have names.</em></span> How can that happen? Well, when you define a function with a function declaration, your function will <span class="emphasis"><em>definitely have a name</em></span>. But when you define a function using a function expression, <span class="emphasis"><em>you don’t have to give that function a name</em></span>.</p><p>You’re probably saying, sure, that’s an interesting fact, maybe it’s possible, but so what? By using anonymous functions we can often make our code less verbose, more concise, more readable, more efficient, and even more maintainable.</p><p>So let’s see how to create and use anonymous functions. We’ll start with a piece of code we’ve seen before, and see how an anonymous function might help out:</p><div class="informalfigure"><a id="med_id00791a"></a><div class="mediaobject"><a id="med_id00791"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113882.png.jpg" alt="image with no caption" width="574" height="184"></div></div><div class="sidebar"><a id="sharpen_your_pencil-id00186"></a><p class="title">Sharpen your pencil</p><p><span class="strong"><strong>Use your knowledge of functions and variables and check off the true statements below.</strong></span></p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col></colgroup><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p><span class="inlinemediaobject"><a id="inline_id00123"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113016.png.jpg" alt="" width="16" height="16"></span></p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p>The handler variable holds a function reference.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p><span class="inlinemediaobject"><a id="inline_id00124"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113016.png.jpg" alt="" width="16" height="16"></span></p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p>When we assign handler to window.onload, we’re assigning it a function reference.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p><span class="inlinemediaobject"><a id="inline_id00125"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113016.png.jpg" alt="" width="16" height="16"></span></p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p>The only reason the handler variable exists is to assign it to window.onload.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p><span class="inlinemediaobject"><a id="inline_id00126"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113016.png.jpg" alt="" width="16" height="16"></span></p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p>We’ll never use handler again as it’s code that is meant to run only when the page first loads.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p><span class="inlinemediaobject"><a id="inline_id00127"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113016.png.jpg" alt="" width="16" height="16"></span></p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p>Invoking onload handlers twice is not a great idea—doing so could cause issues given these handlers usually do some initialization for the entire page.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p><span class="inlinemediaobject"><a id="inline_id00128"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113016.png.jpg" alt="" width="16" height="16"></span></p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p>Function expressions create function references.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " valign="top"><p><span class="inlinemediaobject"><a id="inline_id00129"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113016.png.jpg" alt="" width="16" height="16"></span></p></td><td style="" valign="top"><p>Did we mention that when we assign handler to window.onload, we’re assigning it a function reference?</p></td></tr></tbody></table></div></div></div><div class="sect1" title="How to use an anonymous function"><div class="titlepage"><div><div><h1 class="title"><a id="how_to_use_an_anonymous_function"></a>How to use an anonymous function</h1></div></div></div><p><a id="iddle1020" class="indexterm"></a><a id="iddle1721" class="indexterm"></a><a id="iddle1861" class="indexterm"></a><a id="iddle2758" class="indexterm"></a>So, we’re creating a function to handle the load event, but we know it’s a “one time” function because the load event only happens once per page load. We can also observe that the <code class="literal">window.onload</code> property is being assigned a function reference—namely, the function reference in <code class="literal">handler</code>. But because <code class="literal">handler</code> is a one time function, that name is a bit of a waste, because all we do is assign the reference in it to the <code class="literal">window.onload</code> property.</p><p>Anonymous functions give us a way to clean up this code. An anonymous function is just a function expression without a name that’s used where we’d normally use a function reference. But to make the connection, it helps to see how we use a function expression in code in an anonymous way:</p><div class="informalfigure"><a id="med_id00792a"></a><div class="mediaobject"><a id="med_id00792"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113884.png.jpg" alt="image with no caption" width="755" height="431"></div></div><div class="note" title="Brain Power"><h3 class="title"><a id="ch11note02"></a>Brain Power</h3><div class="informalfigure"><a id="med_id00793a"></a><div class="mediaobject"><a id="med_id00793"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113886.png.jpg" alt="image with no caption" width="352" height="69"></div></div><p>Are there places in your previous code that you’ve seen anonymous functions and hadn’t realized it?</p><p>Hint: are they hiding somewhere in your objects?</p></div><div class="sidebar"><a id="sharpen_your_pencil-id00187"></a><p class="title">Sharpen your pencil</p><p>There are a few opportunities in the code below to take advantage of anonymous functions. Go ahead and rework the code to use anonymous functions wherever possible. You can scratch out the old code and write in new code where needed. Oh, and one more task: circle any anonymous functions that are already being used in the code.</p><a id="pro_id00113"></a><pre class="programlisting"><span class="strong"><strong>window.onload = init;</strong></span>
        <span class="strong"><strong>var cookies = {</strong></span>
            <span class="strong"><strong>instructions: "Preheat oven to 350...",</strong></span>
            <span class="strong"><strong>bake: function(time) {</strong></span>
                      <span class="strong"><strong>console.log("Baking the cookies.");</strong></span>
                      <span class="strong"><strong>setTimeout(done, time);</strong></span>
                  <span class="strong"><strong>}</strong></span>
        <span class="strong"><strong>};</strong></span>
        <span class="strong"><strong>function init() {</strong></span>
            <span class="strong"><strong>var button = document.getElementById("bake");</strong></span>
            <span class="strong"><strong>button.onclick = handleButton;</strong></span>
        <span class="strong"><strong>}</strong></span>
        <span class="strong"><strong>function handleButton() {</strong></span>
            <span class="strong"><strong>console.log("Time to bake the cookies.");</strong></span>
            <span class="strong"><strong>cookies.bake(2500);</strong></span>
        <span class="strong"><strong>}</strong></span>
        <span class="strong"><strong>function done() {</strong></span>
            <span class="strong"><strong>alert("Cookies are ready, take them out to cool.");</strong></span>
            <span class="strong"><strong>console.log("Cooling the cookies.");</strong></span>
            <span class="strong"><strong>var cool = function() {</strong></span>
                <span class="strong"><strong>alert("Cookies are cool, time to eat!");</strong></span>
            <span class="strong"><strong>};</strong></span>
            <span class="strong"><strong>setTimeout(cool, 1000);</strong></span>
        <span class="strong"><strong>}</strong></span></pre></div></div><div class="sect1" title="We need to talk about your verbosity, again"><div class="titlepage"><div><div><h1 class="title"><a id="we_need_to_talk_about_your_verbositycomm"></a>We need to talk about your verbosity, again</h1></div></div></div><div class="informalfigure"><a id="med_id00794a"></a><div class="mediaobject"><a id="med_id00794"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113888.png.jpg" alt="image with no caption" width="216" height="253"></div></div><p><a id="iddle1022" class="indexterm"></a><a id="iddle1723" class="indexterm"></a><a id="iddle1864" class="indexterm"></a><a id="iddle2761" class="indexterm"></a>Okay, we hate to bring it up again because you’ve come a long way with functions—you know how to pass functions around, assign them to variables, pass them to functions, return them from functions—but, well, you’re still being a little more verbose than you have to (you could also say you’re not being as expressive as you could be). Let’s see an example:</p><div class="informalfigure"><a id="med_id00795a"></a><div class="mediaobject"><a id="med_id00795"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113890.png.jpg" alt="image with no caption" width="681" height="325"></div></div><p>While this code looks fine, we can make it a bit tighter using anonymous functions. How? Well, think about the <code class="literal">cookieAlarm</code> variable in the call to <code class="literal">setTimeout</code>. This is a variable that references a function, so when we invoke <code class="literal">setTimeout</code>, a function reference is passed. Now, using a variable that references a function is one way to get a function reference, but just like with the <code class="literal">window.onload</code> example a couple of pages back, you can use a function expression too. Let’s rewrite the code with a function expression instead:</p><div class="informalfigure"><a id="med_id00796a"></a><div class="mediaobject"><a id="med_id00796"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113892.png.jpg" alt="image with no caption" width="755" height="236"></div></div><div class="informalfigure"><a id="med_id00797a"></a><div class="mediaobject"><a id="med_id00797"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113894.png.jpg" alt="image with no caption" width="414" height="576"></div></div><p><a id="iddle1026" class="indexterm"></a><a id="iddle1727" class="indexterm"></a><a id="iddle1879" class="indexterm"></a><a id="iddle2794" class="indexterm"></a><span class="strong"><strong>For a short piece of code, a one liner is just fine.</strong></span> But, beyond that, you’re right, it would be rather silly. But as you know, we can use lots of whitespace with JavaScript, so we can insert all the spaces and returns we need to make things more readable. Here’s our reformatting of the</p><div class="informalfigure"><a id="med_id00798a"></a><div class="mediaobject"><a id="med_id00798"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113896.png.jpg" alt="image with no caption" width="614" height="234"></div></div><div class="informalfigure"><a id="med_id00799a"></a><div class="mediaobject"><a id="med_id00799"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113898.png.jpg" alt="image with no caption" width="540" height="512"></div></div><p><a id="iddle1661" class="indexterm"></a><a id="iddle1681" class="indexterm"></a><a id="iddle1749" class="indexterm"></a><a id="iddle1798" class="indexterm"></a><a id="iddle1865" class="indexterm"></a><a id="iddle2762" class="indexterm"></a><a id="iddle2949" class="indexterm"></a><span class="strong"><strong>That’s a mouthful, but you’ve got it.</strong></span> This is really one of the keys to understanding that functions are first class values. If your code expects a function reference, then you can always put a function expression in its place—because it evaluates to a function reference. As you just saw, if a function is expected as an argument, no problem, you can pass it a function expression (which, again, evaluates to a reference before it is passed). If you need to return a function from within a function, same thing—you can just return a function expression.</p><div class="sidebar"><a id="exercise-id00188"></a><p class="title">Exercise</p><p><a id="iddle1014" class="indexterm"></a><a id="iddle1023" class="indexterm"></a><a id="iddle1675" class="indexterm"></a><a id="iddle1715" class="indexterm"></a><a id="iddle1724" class="indexterm"></a><a id="iddle1743" class="indexterm"></a><a id="iddle1849" class="indexterm"></a><a id="iddle2943" class="indexterm"></a>Let’s make sure you have the syntax down for passing anonymous function expressions to other functions. Convert this code from one that uses a variable (in this case vaccine) as an argument to one that uses an anonymous function expression.</p><a id="pro_id00114"></a><pre class="programlisting"><span class="strong"><strong>function vaccine(dosage) {</strong></span>
            <span class="strong"><strong>if (dosage &gt; 0) {</strong></span>
                <span class="strong"><strong>inject(dosage);</strong></span>
            <span class="strong"><strong>}</strong></span>
        <span class="strong"><strong>}</strong></span>
        
        <span class="strong"><strong>administer(patient, vaccine, time);</strong></span></pre><div class="note" title="Note"><h3 class="title"><a id="ch11note03"></a>Note</h3><p>Write your version here. And check your answer before moving on!</p></div></div><div class="sidebar"><a id="there_are_no_dumb_questions-id00189"></a><p class="title">There are No Dumb Questions</p><div class="blockquote"><blockquote class="blockquote"><div class="qandaset" title="Frequently Asked Questions"><table border="0" width="100%" summary="Q and A Set"><colgroup><col align="left" width="1%"><col></colgroup><tbody><tr class="question" title="Q:"><td align="left" valign="top"><a id="ch11qa1qe1"></a><a id="ch11qa1q1"></a><p>Q:</p></td><td align="left" valign="top"><p><span class="strong"><strong>Q: Using these anonymous functions like this seems really esoteric. Do I really need to know this stuff?</strong></span></p></td></tr><tr class="answer"><td align="left" valign="top"><a id="ch11qa1q1a1"></a><p>A:</p></td><td align="left" valign="top"><p><span class="strong"><strong>A:</strong></span> You do. Anonymous function expressions are used frequently in JavaScript code, so if you want to be able to read other people’s code, or understand JavaScript libraries, you’re going to need to know how these work, and how to recognize them when they’re being used.</p></td></tr><tr class="question" title="Q:"><td align="left" valign="top"><a id="ch11qa1qe2"></a><a id="ch11qa1q2"></a><p>Q:</p></td><td align="left" valign="top"><p><span class="strong"><strong>Q: Is using an anonymous function expression really better? I think it just complicates the code and makes the code hard to follow and read.</strong></span></p></td></tr><tr class="answer"><td align="left" valign="top"><a id="ch11qa1q2a2"></a><p>A:</p></td><td align="left" valign="top"><p><span class="strong"><strong>A:</strong></span> Give it some time. Over time, you’ll be able to parse code like this more easily when you see it, and there really are lots of cases where this syntax decreases code complexity, makes the code’s intention more clear, and cleans up your code. That said, overuse of this technique can definitely lead to code that is quite hard to understand. But stick with it and it’ll get easier to read and more useful as you get the hang of it. You’re going to encounter lots of code that makes heavy use of anonymous functions, so it’s a good idea to incorporate this technique into your code toolbelt.</p></td></tr><tr class="question" title="Q:"><td align="left" valign="top"><a id="ch11qa1qe3"></a><a id="ch11qa1q3"></a><p>Q:</p></td><td align="left" valign="top"><p><span class="strong"><strong>Q: If first class functions are so useful, how come other languages don’t have them?</strong></span></p></td></tr><tr class="answer"><td align="left" valign="top"><a id="ch11qa1q3a3"></a><p>A:</p></td><td align="left" valign="top"><p><span class="strong"><strong>A:</strong></span> Ah, but they do (and even the ones that don’t are considering adding them). For instance, languages like Scheme and Scala have fully first class functions like JavaScript does. Other languages, like PHP, Java (in the newest version), C#, and Objective C have some or most of the first class features that JavaScript does. As more people are recognizing the value of having first class functions in a programming language, more languages are supporting them. Each language does it a little differently, however, so be prepared for a variety of approaches as you explore this topic in other languages.</p></td></tr></tbody></table></div></blockquote></div></div></div><div class="sect1" title="When is a function defined? It depends..."><div class="titlepage"><div><div><h1 class="title"><a id="when_is_a_function_definedquestion_mark"></a>When is a function defined? It depends...</h1></div></div></div><p><a id="iddle1246" class="indexterm"></a><a id="iddle1447" class="indexterm"></a><a id="iddle1448" class="indexterm"></a><a id="iddle1785" class="indexterm"></a><a id="iddle1786" class="indexterm"></a><a id="iddle3053" class="indexterm"></a>There’s one fine point related to functions that we haven’t mentioned yet. Remember that the browser takes two passes through your JavaScript code: in the first pass, all your function declarations are parsed and the functions defined; in the second pass, the browser executes your code top down, which is when function expressions are defined. Because of this, functions created by declarations are defined <span class="emphasis"><em>before</em></span> functions that are created using function expressions. And this, in turn, determines where and when you can invoke a function in your code.</p><p>To see what that really means, let’s take a look at a concrete example. Here’s our code from the last chapter, rearranged just a bit. Let’s evaluate it:</p><div class="informalfigure"><a id="med_id00800a"></a><div class="mediaobject"><a id="med_id00800"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113900.png.jpg" alt="image with no caption" width="647" height="572"></div></div></div><div class="sect1" title="What just happened? Why wasn’t fly defined?"><div class="titlepage"><div><div><h1 class="title"><a id="what_just_happenedquestion_mark_why_wasn"></a>What just happened? Why wasn’t fly defined?</h1></div></div></div><p>Okay, we know the <code class="literal">fly</code> function is undefined when we try to invoke it, but why? After all, <code class="literal">quack</code> worked just fine. Well, as you’ve probably guessed by now, unlike <code class="literal">quack</code>—which is defined on the first pass through the code because it is a function declaration—the <code class="literal">fly</code> function is defined along with the normal top-to-bottom evaluation of the code. Let’s take another look:</p><div class="informalfigure"><a id="med_id00801a"></a><div class="mediaobject"><a id="med_id00801"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113902.png.jpg" alt="image with no caption" width="312" height="422"></div></div><div class="informalfigure"><a id="med_id00802a"></a><div class="mediaobject"><a id="med_id00802"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113904.png.jpg" alt="image with no caption" width="508" height="454"></div></div><p>So what does this all mean? For starters, it means that you can place function declarations
        anywhere in your code—at the top, at the bottom, in the middle—and invoke them wherever
        you like. Function declarations at the top level of your code create functions that are defined
        everywhere in your code (this is known as <span class="emphasis"><em>hoisting</em></span>).</p><p>Function expressions are obviously different because they aren’t defined until they are evaluated. So, even if you assign the function expression to a global variable, like we did with <code class="literal">fly</code>, you can’t use that variable to invoke a function until after it’s been defined.</p><p>Now in this example, both of our functions have <span class="emphasis"><em>global scope</em></span>—meaning both functions are visible everywhere in your code once they are defined. But we also need to consider nested functions—that is functions defined within other functions—because it affects the scope of those functions. Let’s take a look.</p></div><div class="sect1" title="How to nest functions"><div class="titlepage"><div><div><h1 class="title"><a id="how_to_nest_functions"></a>How to nest functions</h1></div></div></div><p><a id="iddle1824" class="indexterm"></a><a id="iddle2320" class="indexterm"></a>It’s perfectly legal to define a function within another function, meaning you can use a function declaration or expression inside another function. How does this work? Here’s the short answer: the only difference between a function defined at the top level of your code and one that’s defined within another function is just a matter of scope. In other words, placing a function in another function affects where the function is visible within your code.</p><p>To understand this, let’s expand our example a little by adding some nested function declarations and expressions.</p><div class="informalfigure"><a id="med_id00803a"></a><div class="mediaobject"><a id="med_id00803"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113906.png.jpg" alt="image with no caption" width="573" height="591"></div></div><div class="sidebar"><a id="exercise-id00190"></a><p class="title">Exercise</p><p>In the code above, take a pencil and mark where you think the scope of the fly, quack, wingFlapper and quacker functions are. Also, mark any places you think the functions might be in scope but undefined.</p></div></div><div class="sect1" title="How nesting affects scope"><div class="titlepage"><div><div><h1 class="title"><a id="how_nesting_affects_scope"></a>How nesting affects scope</h1></div></div></div><p><a id="iddle1024" class="indexterm"></a><a id="iddle1670" class="indexterm"></a><a id="iddle1676" class="indexterm"></a><a id="iddle1725" class="indexterm"></a><a id="iddle1744" class="indexterm"></a><a id="iddle1850" class="indexterm"></a><a id="iddle1863" class="indexterm"></a><a id="iddle1897" class="indexterm"></a><a id="iddle1944" class="indexterm"></a><a id="iddle2219" class="indexterm"></a><a id="iddle2760" class="indexterm"></a><a id="iddle2944" class="indexterm"></a><a id="iddle2993" class="indexterm"></a><a id="iddle3015" class="indexterm"></a>Functions defined at the top level of your code have global scope, whereas functions defined within another function have local scope. Let’s make a pass over this code and look at the scope of each function. While we’re at it, we’ll also look at where each function is defined (or, not <code class="literal">undefined</code>, if you prefer):</p><div class="informalfigure"><a id="med_id00804a"></a><div class="mediaobject"><a id="med_id00804"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113908.png.jpg" alt="image with no caption" width="742" height="651"></div></div><p>Notice that the rules for when you can refer to a function are the same within a function as they are at the top level. That is, within a function, if you define a nested function <span class="emphasis"><em>with a declaration</em></span>, that nested function is defined everywhere within the body of the function. On the other hand, if you create a nested function using a <span class="emphasis"><em>function expression</em></span>, then that nested function is defined only after the function expression is evaluated.</p><div class="sidebar"><a id="there_are_no_dumb_questions-id00191"></a><p class="title">There are No Dumb Questions</p><div class="blockquote"><blockquote class="blockquote"><div class="qandaset" title="Frequently Asked Questions"><table border="0" width="100%" summary="Q and A Set"><colgroup><col align="left" width="1%"><col></colgroup><tbody><tr class="question" title="Q:"><td align="left" valign="top"><a id="ch11qa2qe1"></a><a id="ch11qa2q1"></a><p>Q:</p></td><td align="left" valign="top"><p><span class="strong"><strong>Q: When we pass a function expression to another function, that function must get stored in a parameter, and then treated as a local variable in the function we passed it to. Is that right?</strong></span></p></td></tr><tr class="answer"><td align="left" valign="top"><a id="ch11qa2q1a1"></a><p>A:</p></td><td align="left" valign="top"><p><span class="strong"><strong>A:</strong></span> That’s exactly right. Passing a function as an argument to another function copies the function reference we’re passing into a parameter variable in the function we’ve called. And just like any other parameter, a parameter holding a function reference is a local variable.</p></td></tr></tbody></table></div></blockquote></div></div><div class="sidebar"><a id="extreme_javascript_challenge"></a><p class="title">Extreme Javascript Challenge</p><p><a id="iddle1738" class="indexterm"></a><a id="iddle1801" class="indexterm"></a><a id="iddle2938" class="indexterm"></a><span class="strong"><strong>We need a first class functions expert and we’ve heard that’s you!</strong></span> Below you’ll find two pieces of code, and we need your help figuring out what this code does. We’re stumped. To us, these look like nearly identical pieces of code, except that one uses a first class function and the other doesn’t. Knowing everything we do about JavaScript scope, we expected Specimen #1 to evaluate to 008 and Specimen #2 to evaluate to 007. But they both result in 008! Can you help us figure out why?</p><div class="informalfigure"><a id="med_id00805a"></a><div class="mediaobject"><a id="med_id00805"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113910.png.jpg" alt="image with no caption" width="779" height="737"></div></div><div class="note" title="Note"><h3 class="title"><a id="ch11note03a"></a>Note</h3><p>Don’t look at the solution at the end of the chapter just yet; we’ll revisit this challenge a little bit later.</p></div></div></div><div class="sect1" title="A little review of lexical scope"><div class="titlepage"><div><div><h1 class="title"><a id="little_review_of_lexical_scope"></a>A little review of lexical scope</h1></div></div></div><div class="note" title="Note"><h3 class="title"><a id="ch11note04"></a>Note</h3><p><a id="iddle1825" class="indexterm"></a><a id="iddle1870" class="indexterm"></a><a id="iddle1889" class="indexterm"></a><a id="iddle1898" class="indexterm"></a><a id="iddle1941" class="indexterm"></a><a id="iddle1945" class="indexterm"></a><a id="iddle2181" class="indexterm"></a><a id="iddle2216" class="indexterm"></a><a id="iddle2220" class="indexterm"></a><a id="iddle2321" class="indexterm"></a><a id="iddle2991" class="indexterm"></a><a id="iddle2994" class="indexterm"></a><a id="iddle3005" class="indexterm"></a><a id="iddle3013" class="indexterm"></a><a id="iddle3016" class="indexterm"></a><span class="underline">Lexical</span> just means you can determine the scope of a variable by reading the structure of the code, as opposed to waiting until the code runs to figure it out.</p></div><p><span class="strong"><strong>While we’re on the topic of scope, let’s quickly review how lexical scope works:</strong></span></p><div class="informalfigure"><a id="med_id00806a"></a><div class="mediaobject"><a id="med_id00806"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113912.png.jpg" alt="image with no caption" width="745" height="364"></div></div><p><span class="strong"><strong>Now let’s introduce a nested function:</strong></span></p><div class="informalfigure"><a id="med_id00807a"></a><div class="mediaobject"><a id="med_id00807"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113914.png.jpg" alt="image with no caption" width="701" height="370"></div></div><div class="note" title="JavaScript console"><h3 class="title"><a id="ch11note05"></a>JavaScript console</h3><p><span class="strong"><strong><code class="literal">Just an every day LOCAL</code></strong></span></p></div></div><div class="sect1" title="Where things get interesting with lexical scope"><div class="titlepage"><div><div><h1 class="title"><a id="where_things_get_interesting_with_lexica"></a>Where things get interesting with lexical scope</h1></div></div></div><p><span class="strong"><strong>Let’s make one more tweak. Watch this step carefully; it’s a doozy:</strong></span></p><div class="informalfigure"><a id="med_id00808a"></a><div class="mediaobject"><a id="med_id00808"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113916.png.jpg" alt="image with no caption" width="755" height="419"></div></div><div class="informalfigure"><a id="med_id00809a"></a><div class="mediaobject"><a id="med_id00809"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113918.png.jpg" alt="image with no caption" width="829" height="431"></div></div><div class="informalfigure"><a id="med_id00810a"></a><div class="mediaobject"><a id="med_id00810"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113920.png.jpg" alt="image with no caption" width="697" height="578"></div></div><p title="Frank:"><span class="title"><strong><span class="strong"><strong>Frank:</strong></span></strong></span>&nbsp;What do you mean you’re right? That’s like defying the laws of physics or something. The local variable doesn’t even exist anymore... I mean, when a variable goes out of scope it ceases to exist. It’s derezzed! Didn’t you see TRON!?</p><p title="Judy:"><span class="title"><strong><span class="strong"><strong>Judy:</strong></span></strong></span>&nbsp;Maybe in your weak little C++ and Java languages, but not in JavaScript.</p><p title="Jim:"><span class="title"><strong><span class="strong"><strong>Jim:</strong></span></strong></span>&nbsp;Seriously, how is that possible? The <code class="literal">whereAreYou</code> function has come and gone, and the local version of <code class="literal">justAVar</code> couldn’t possibly exist anymore.</p><p title="Judy:"><span class="title"><strong><span class="strong"><strong>Judy:</strong></span></strong></span>&nbsp;If you’d listen to what I just told you... In JavaScript that’s not how it works.</p><p title="Frank:"><span class="title"><strong><span class="strong"><strong>Frank:</strong></span></strong></span>&nbsp;Well, throw us a bone Judy. How does it work?</p><p title="Judy:"><span class="title"><strong><span class="strong"><strong>Judy:</strong></span></strong></span>&nbsp;When we define the <code class="literal">inner</code> function, the local <code class="literal">justAVar</code> is in the scope of that function. Now lexical scope says how we define things is what matters, so if we’re using lexical scope, then <span class="emphasis"><em>whenever</em></span> <code class="literal">inner</code> is invoked, it assumes it still has that local variable around if it needs it.</p><p title="Frank:"><span class="title"><strong><span class="strong"><strong>Frank:</strong></span></strong></span>&nbsp;Yeah, but like I already said, that’s like defying the laws of physics. The <code class="literal">whereAreYou</code> function that defined the local version of the <code class="literal">justAVar</code> variable is over. It doesn’t exist any more.</p><p title="Judy:"><span class="title"><strong><span class="strong"><strong>Judy:</strong></span></strong></span>&nbsp;True. The <code class="literal">whereAreYou</code> function is done, but the scope is still around for <code class="literal">inner</code> to use.</p><p title="Jim:"><span class="title"><strong><span class="strong"><strong>Jim:</strong></span></strong></span>&nbsp;How is that?</p><p title="Judy:"><span class="title"><strong><span class="strong"><strong>Judy:</strong></span></strong></span>&nbsp;Well, let’s see what REALLY happens when we define and return a function...</p><div class="note" title="Note"><h3 class="title"><a id="ch11note06"></a>Note</h3><p>EDITOR’S NOTE: Did Joe change his shirt between pages!?</p></div></div><div class="sect1" title="Functions Revisited"><div class="titlepage"><div><div><h1 class="title"><a id="functions_revisited"></a>Functions Revisited</h1></div></div></div><p><a id="iddle1859" class="indexterm"></a><a id="iddle1862" class="indexterm"></a><a id="iddle2756" class="indexterm"></a><a id="iddle2759" class="indexterm"></a>We have a bit of a confession to make. Up until now we haven’t told you <span class="emphasis"><em>everything</em></span> about a function. Even when you asked “What does a function reference actually point to?” we kinda skirted the issue. “Oh just think of it like a crystallized function that holds the function’s code block,” we said.</p><p>Well now it’s time to show you everything.</p><p>To do that, let’s walk through what really happens at runtime with this code, starting with the <code class="literal">whereAreYou</code> function:</p><div class="informalfigure"><a id="med_id00811a"></a><div class="mediaobject"><a id="med_id00811"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113922.png.jpg" alt="image with no caption" width="788" height="719"></div></div></div><div class="sect1" title="Calling a function (revisited)"><div class="titlepage"><div><div><h1 class="title"><a id="calling_a_function_left_parenthesisrevis"></a>Calling a function (revisited)</h1></div></div></div><p><a id="iddle1270" class="indexterm"></a><a id="iddle2114" class="indexterm"></a>Now that we have the <code class="literal">inner</code> function, and its environment, let’s invoke <code class="literal">inner</code> and see what happens. Here’s the code we want to evaluate:</p><a id="pro_id00115"></a><pre class="programlisting"><span class="strong"><strong>var innerFunction = whereAreYou();</strong></span>
        <span class="strong"><strong>var result = innerFunction();</strong></span>
        <span class="strong"><strong>console.log(result);</strong></span></pre><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p><span class="strong"><strong>First, we call whereAreYou. We already know that returns a function reference. So we create a variable innerFunction and assign it that function. Remember, that function reference is linked to an environment.</strong></span></p><div class="informalfigure"><a id="med_id00812a"></a><div class="mediaobject"><a id="med_id00812"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113924.png.jpg" alt="image with no caption" width="785" height="197"></div></div></li><li class="listitem"><p><span class="strong"><strong>Next we call innerFunction. To do that we evaluate the code in the function’s body, and do that in the context of the function’s environment, like this:</strong></span></p><div class="informalfigure"><a id="med_id00813a"></a><div class="mediaobject"><a id="med_id00813"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113926.png.jpg" alt="image with no caption" width="795" height="278"></div></div></li><li class="listitem"><p><a id="iddle1305" class="indexterm"></a><a id="iddle1766" class="indexterm"></a><span class="strong"><strong>Last, we assign the result of the function to the result variable, and then display it in the console.</strong></span></p><div class="informalfigure"><a id="med_id00814a"></a><div class="mediaobject"><a id="med_id00814"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113928.png.jpg" alt="image with no caption" width="773" height="449"></div></div></li></ol></div><div class="informalfigure"><a id="med_id00815a"></a><div class="mediaobject"><a id="med_id00815"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113930.png.jpg" alt="image with no caption" width="821" height="521"></div></div><div class="sidebar"><a id="there_are_no_dumb_questions-id00192"></a><p class="title">There are No Dumb Questions</p><div class="blockquote"><blockquote class="blockquote"><div class="qandaset" title="Frequently Asked Questions"><table border="0" width="100%" summary="Q and A Set"><colgroup><col align="left" width="1%"><col></colgroup><tbody><tr class="question" title="Q:"><td align="left" valign="top"><a id="ch11qa3qe1"></a><a id="ch11qa3q1"></a><p>Q:</p></td><td align="left" valign="top"><p><a id="iddle1826" class="indexterm"></a><a id="iddle1860" class="indexterm"></a><a id="iddle1871" class="indexterm"></a><a id="iddle1890" class="indexterm"></a><a id="iddle1899" class="indexterm"></a><a id="iddle1942" class="indexterm"></a><a id="iddle1946" class="indexterm"></a><a id="iddle2182" class="indexterm"></a><a id="iddle2217" class="indexterm"></a><a id="iddle2221" class="indexterm"></a><a id="iddle2322" class="indexterm"></a><a id="iddle2757" class="indexterm"></a><a id="iddle2992" class="indexterm"></a><a id="iddle2995" class="indexterm"></a><a id="iddle3006" class="indexterm"></a><a id="iddle3014" class="indexterm"></a><a id="iddle3017" class="indexterm"></a><span class="strong"><strong>Q: When you say that lexical scope determines where a variable is defined, what do you mean?</strong></span></p></td></tr><tr class="answer"><td align="left" valign="top"><a id="ch11qa3q1a1"></a><p>A:</p></td><td align="left" valign="top"><p><span class="strong"><strong>A:</strong></span> By lexical scope we mean that JavaScript’s rules for scoping are based purely on the structure of your code (not on some dynamic runtime properties). This means you can determine where a variable is defined by simply examining your code’s structure. Also remember that in JavaScript only functions introduce new scope. So, given a reference to a variable, look for where that variable is defined in a function from the most nested (where it’s used) to the least nested until you find it. And if you can’t find it in a function, then it must be global, or undefined.</p></td></tr><tr class="question" title="Q:"><td align="left" valign="top"><a id="ch11qa3qe2"></a><a id="ch11qa3q2"></a><p>Q:</p></td><td align="left" valign="top"><p><span class="strong"><strong>Q: If a function is nested way down many layers, how does the environment work then?</strong></span></p></td></tr><tr class="answer"><td align="left" valign="top"><a id="ch11qa3q2a2"></a><p>A:</p></td><td align="left" valign="top"><p><span class="strong"><strong>A:</strong></span> We used a simplistic way of showing the environment to explain it, but you can think of each nested function as having its own little environment with its own variables. Then, what we do is create a chain of the environments of all the nested functions, from inner to outer.</p><p>So, when it comes to finding a variable in the environment, you start at the closest one, and then follow the chain until you find your variable. And, if you don’t find it, you look in the global environment.</p></td></tr><tr class="question" title="Q:"><td align="left" valign="top"><a id="ch11qa3qe3"></a><a id="ch11qa3q3"></a><p>Q:</p></td><td align="left" valign="top"><p><span class="strong"><strong>Q: Why are lexical scoping and function environments good things? I would have thought the answer in that code example would be “Oh, don’t you worry about it, I’m GLOBAL”. That makes sense to me. The real answer seems confusing and counterintuitive.</strong></span></p></td></tr><tr class="answer"><td align="left" valign="top"><a id="ch11qa3q3a3"></a><p>A:</p></td><td align="left" valign="top"><p><span class="strong"><strong>A:</strong></span> We can see how you might think that, but the advantage of lexical scope is that we can always look at the code to determine the scope that’s in place when a variable is defined, and figure out what its value should be from that. And, as we’ve seen, this is true even if you return a function and invoke it much later in a place totally outside of its original scope.</p><p>Now there is another reason you might consider this a good thing, and that is the kind of things we can do in code with this capability. We’re going to get to that in just a bit.</p></td></tr><tr class="question" title="Q:"><td align="left" valign="top"><a id="ch11qa3qe4"></a><a id="ch11qa3q4"></a><p>Q:</p></td><td align="left" valign="top"><p><span class="strong"><strong>Q: Do parameter variables get included in the environment too?</strong></span></p></td></tr><tr class="answer"><td align="left" valign="top"><a id="ch11qa3q4a4"></a><p>A:</p></td><td align="left" valign="top"><p><span class="strong"><strong>A:</strong></span> Yes. As we’ve said before, you can consider parameters to be local variables in your functions, so they are included in the environment as well.</p></td></tr><tr class="question" title="Q:"><td align="left" valign="top"><a id="ch11qa3qe5"></a><a id="ch11qa3q5"></a><p>Q:</p></td><td align="left" valign="top"><p><span class="strong"><strong>Q: Do I need to understand how the environment works in detail?</strong></span></p></td></tr><tr class="answer"><td align="left" valign="top"><a id="ch11qa3q5a5"></a><p>A:</p></td><td align="left" valign="top"><p><span class="strong"><strong>A:</strong></span> No. What you need to understand is the lexical scoping rules for JavaScript variables, and we’ve covered that. But now you know that if you have a function that is returned from within a function, it carries its environment around with it.</p></td></tr></tbody></table></div></blockquote></div></div><div class="blockquote"><blockquote class="blockquote"><p><span class="strong"><strong>Remember that JavaScript functions are always evaluated in the same scoping environment in which they were defined. Within a function, if you want to determine where a variable is coming from, search in its enclosing functions, from the most nested to the least.</strong></span></p></blockquote></div></div><div class="sect1" title="What the heck is a closure?"><div class="titlepage"><div><div><h1 class="title"><a id="what_the_heck_is_a_closurequestion_mark"></a>What the heck is a closure?</h1></div></div></div><p><a id="iddle1306" class="indexterm"></a><a id="iddle1700" class="indexterm"></a><a id="iddle1767" class="indexterm"></a><a id="iddle2985" class="indexterm"></a>Sure, everyone talks about closures as <span class="emphasis"><em>the must have</em></span> language feature, but how many people actually get what they are or how to use them? Darn few. It’s the language feature everyone wants to understand and the feature every traditional language wants to add.</p><p>Here’s the problem. According to many well-educated folks in the business, <span class="emphasis"><em>closures are hard</em></span>. But that’s really not a problem for you. Want to know why? No, no, it’s not because this is a “brain friendly book” and no, it’s not because we have a killer application that needs to be built to teach closures to you. It’s because <span class="emphasis"><em>you just learned them</em></span>. We just didn’t call them closures.</p><p>So without further ado, we give you the super-formal definition.</p><div class="note" title="Note"><h3 class="title"><a id="ch11note07"></a>Note</h3><p title="Closure, noun:"><span class="title"><strong><span class="strong"><strong>Closure, noun:</strong></span></strong></span>&nbsp;A closure is a function together with a referencing environment.</p><div class="blockquote"><blockquote class="blockquote"><p><span class="strong"><strong>If you’ve been trained well in this book you should be thinking at this point, “Ah, this is the ‘get a big raise’ knowledge.”</strong></span></p></blockquote></div></div><p>Okay, we agree that definition isn’t totally illuminating. But why is it called <span class="emphasis"><em>closure</em></span>? Let’s quickly walk through that, because—seriously—this could be one of those make-or-break job interview questions, or the thing that gets you that raise at some point in the future.</p><p>To understand the word <span class="emphasis"><em>closure</em></span>, we need to understand the idea of “closing” a function.</p><div class="sidebar"><a id="sharpen_your_pencil-id00193"></a><p class="title">Sharpen your pencil</p><p>Here’s your task: (1) find all the <span class="strong"><strong>free variables</strong></span> in the code below and circle them. A free variable is one that isn’t defined in the local scope. (2) Pick one of the environments on the right that <span class="strong"><strong>closes the function</strong></span>. By that we mean that it provides values for all the free variables.</p><div class="informalfigure"><a id="med_id00816a"></a><div class="mediaobject"><a id="med_id00816"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113932.png.jpg" alt="image with no caption" width="840" height="340"></div></div></div></div><div class="sect1" title="Closing a function"><div class="titlepage"><div><div><h1 class="title"><a id="closing_a_function"></a>Closing a function</h1></div></div></div><p>You probably figured this out in the previous exercise, but let’s run through it one more time: a function typically has <span class="emphasis"><em>local variables</em></span> in its code body (including any parameters it has), and it also might have variables that aren’t defined locally, which we call <span class="emphasis"><em>free variables</em></span>. The name <span class="emphasis"><em>free</em></span> comes from the fact that within the function body, free variables aren’t bound to any values (in other words, they’re not declared locally in the function). Now, when we have an environment that has a value for each of the free variables, we say that we’ve <span class="emphasis"><em>closed</em></span> the function. And, when we take the function and the environment together, we say we have a <span class="emphasis"><em>closure</em></span>.</p><div class="informalfigure"><a id="med_id00817a"></a><div class="mediaobject"><a id="med_id00817"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113934.png.jpg" alt="image with no caption" width="769" height="480"></div></div><div class="blockquote"><blockquote class="blockquote"><p><span class="strong"><strong>A closure results when we combine a function that has free variables with an environment that provides variable bindings for all those free variables.</strong></span></p></blockquote></div><div class="informalfigure"><a id="med_id00818a"></a><div class="mediaobject"><a id="med_id00818"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113936.png.jpg" alt="image with no caption" width="576" height="546"></div></div><p><span class="strong"><strong>If closures weren’t so darned useful, we’d agree.</strong></span> We’re sorry we had to drag you through the learning curve on closures but we assure you, it is well worth it. You see, closures aren’t just some theoretical functional programming language construct; they’re also a powerful programming technique. Now that you’ve got how they work down (and we’re not kidding that understanding closures is what’s going to raise your cred among your managers and peers) it’s time to learn how to use them.</p><p>And here’s the thing: they’re used all over the place. In fact they’re going to become so second nature to you that you’ll find yourself using them liberally in your code. Anyway, let’s get to some closure code and you’ll see what we’re talking about.</p></div><div class="sect1" title="Using closures to implement a magic counter"><div class="titlepage"><div><div><h1 class="title"><a id="using_closures_to_implement_a_magic_coun"></a>Using closures to implement a magic counter</h1></div></div></div><p><a id="iddle1312" class="indexterm"></a><a id="iddle1773" class="indexterm"></a>Ever think of implementing a counter function? It usually goes like this:</p><div class="informalfigure"><a id="med_id00819a"></a><div class="mediaobject"><a id="med_id00819"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113938.png.jpg" alt="image with no caption" width="466" height="131"></div></div><p>And we can use our counter like this:</p><div class="informalfigure"><a id="med_id00820a"></a><div class="mediaobject"><a id="med_id00820"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113940.png.jpg" alt="image with no caption" width="376" height="80"></div></div><div class="note" title="JavaScript console"><h3 class="title"><a id="ch11note08"></a>JavaScript console</h3><p><span class="strong"><strong><code class="literal">1</code></strong></span></p><p><span class="strong"><strong><code class="literal">2</code></strong></span></p><p><span class="strong"><strong><code class="literal">3</code></strong></span></p></div><p>The only issue with this is that we have to use a global variable for <code class="literal">count</code>, which can be problematic if you’re developing code with a team (because people often use the same names, which end up clashing).</p><p>What if we were to tell you there is a way to implement a counter with a totally local and protected <code class="literal">count</code> variable? That way, you’ll have a counter that no other code can ever clash with, and the only way to increment the counter value is through the function (otherwise known as a closure).</p><p>To implement this with a closure, we can reuse most of the code above. Watch and be amazed:</p><div class="informalfigure"><a id="med_id00821a"></a><div class="mediaobject"><a id="med_id00821"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113942.png.jpg" alt="image with no caption" width="530" height="237"></div></div><p>Think this magic trick will work? Let’s try it and see...</p><div class="informalfigure"><a id="med_id00822a"></a><div class="mediaobject"><a id="med_id00822"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113944.png.jpg" alt="image with no caption" width="274" height="257"></div></div><div class="sect2" title="Test drive your magic counter"><div class="titlepage"><div><div><h2 class="title"><a id="test_drive_your_magic_counter"></a>Test drive your magic counter <span class="inlinemediaobject"><a id="inline_id00130"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2112336.png.jpg" alt="" width="144" height="47"></span></h2></div></div></div><p>We added a bit of testing code to test the counter. Give it a try!</p><a id="pro_id00116"></a><pre class="programlisting"><span class="strong"><strong>function makeCounter() {</strong></span>
            <span class="strong"><strong>var count = 0;</strong></span>
        
            <span class="strong"><strong>function counter() {</strong></span>
                <span class="strong"><strong>count = count + 1;</strong></span>
                <span class="strong"><strong>return count;</strong></span>
            <span class="strong"><strong>}</strong></span>
            <span class="strong"><strong>return counter;</strong></span>
        <span class="strong"><strong>}</strong></span>
        <span class="strong"><strong><span class="gray-background">var doCount = makeCounter();</span></strong></span>
        <span class="strong"><strong><span class="gray-background">console.log(doCount());     </span></strong></span>
        <span class="strong"><strong><span class="gray-background">console.log(doCount());     </span></strong></span>
        <span class="strong"><strong><span class="gray-background">console.log(doCount());     </span></strong></span></pre><div class="note" title="JavaScript console"><h3 class="title"><a id="ch11note08a"></a>JavaScript console</h3><p><span class="strong"><strong><code class="literal">1</code></strong></span></p><p><span class="strong"><strong><code class="literal">2</code></strong></span></p><p><span class="strong"><strong><code class="literal">3</code></strong></span></p><div class="blockquote"><blockquote class="blockquote"><p>Our counter works... we get solid counting results.</p></blockquote></div></div></div></div><div class="sect1" title="Looking behind the curtain..."><div class="titlepage"><div><div><h1 class="title"><a id="looking_behind_the_curtainhellip"></a>Looking behind the curtain...</h1></div></div></div><p>Let’s step through the code to see how the counter works.</p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>We call makeCounter, which creates a counter function and returns it along with an environment containing the free variable, count. In other words, it creates a closure. The function returned from makeCounter is stored in doCount.</p></li><li class="listitem"><p>We call the function doCount. This executes the body of the counter function.</p></li><li class="listitem"><p>When we encounter the variable count, we look it up in the environment, and retrieve its value. We increment count, save the new value back into the environment, and return that new value to where doCount was called.</p></li><li class="listitem"><p>We repeat steps 2 and 3 each time we call doCount.</p></li></ol></div><div class="informalfigure"><a id="med_id00823a"></a><div class="mediaobject"><a id="med_id00823"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113946.png.jpg" alt="image with no caption" width="825" height="618"></div></div><div class="sidebar"><a id="exercise-id00194"></a><p class="title">Exercise</p><p><a id="iddle1309" class="indexterm"></a><a id="iddle1770" class="indexterm"></a>It’s your turn. Try creating the following closures. We realize this is not an easy task at first, so refer to the answer if you need to. The important thing is to work your way through these examples, and get to the point where you fully understand them.</p><p>First up for 10pts: makePassword takes a password as an argument and returns a function that accepts a password guess and returns true if the guess matches the password (sometimes you need to read these closure descriptions a few times to get them):</p><a id="pro_id00117"></a><pre class="programlisting"><span class="strong"><strong>function makePassword(password) {</strong></span>
            <span class="strong"><strong>return __________________________ {</strong></span>
                <span class="strong"><strong>return (passwordGuess === password);</strong></span>
            <span class="strong"><strong>};</strong></span>
        <span class="strong"><strong>}</strong></span></pre><p>Next up for 20pts: the multN function takes a number (call it n) and returns a function. That function itself takes a number, multiplies it by n and returns the result.</p><a id="pro_id00118"></a><pre class="programlisting"><span class="strong"><strong>function multN(n) {</strong></span>
            <span class="strong"><strong>return __________________________ {</strong></span>
                <span class="strong"><strong>return _____________;</strong></span>
            <span class="strong"><strong>};</strong></span>
        <span class="strong"><strong>}</strong></span></pre><p>Last up for 30 pts: This is a modification of the counter we just created. makeCounter takes no arguments, but defines a count variable. It then creates and returns an object with one method, increment. This method increments the count variable and returns it.</p></div></div><div class="sect1" title="Creating a closure by passing a function expression as an argument"><div class="titlepage"><div><div><h1 class="title"><a id="creating_a_closure_by_passing_a_function"></a>Creating a closure by passing a function expression as an argument</h1></div></div></div><div class="informalfigure"><a id="med_id00824a"></a><div class="mediaobject"><a id="med_id00824"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113948.png.jpg" alt="image with no caption" width="216" height="196"></div></div><p><a id="iddle1311" class="indexterm"></a><a id="iddle1701" class="indexterm"></a><a id="iddle1772" class="indexterm"></a><a id="iddle1880" class="indexterm"></a><a id="iddle2795" class="indexterm"></a><a id="iddle2986" class="indexterm"></a>Returning a function from a function isn’t the only way to create a closure. You create a closure <span class="emphasis"><em>whenever</em></span> you have a reference to a function that has free variables, and that function is executed outside of the context in which it was created.</p><p>Another way we can create a closure is to pass a function to a function. The function we pass will be executed in a completely different context than the one in which it was defined. Here’s an example:</p><div class="informalfigure"><a id="med_id00825a"></a><div class="mediaobject"><a id="med_id00825"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113950.png.jpg" alt="image with no caption" width="701" height="227"></div></div><p>Here, we’re passing a function expression that contains a free variable, <code class="literal">doneMessage</code>, to the function <code class="literal">setTimeout</code>. As you know, what happens is we evaluate the function expression to get a function reference, which is then passed to <code class="literal">setTimeout</code>. The <code class="literal">setTimeout</code> method holds on to this function (which is a function plus an environment—in other words, a closure) and then 1000 milliseconds later it calls that function.</p><p>And again, the function we’re passing into <code class="literal">setTimeout</code> is a closure because it comes along with an environment that binds the free variable, <code class="literal">doneMessage</code>, to the string “Cookies are done!”.</p><div class="note" title="Brain Power"><h3 class="title"><a id="ch11note09"></a>Brain Power</h3><p>What would happen if our code looked like this instead?</p><a id="pro_id00119"></a><pre class="programlisting"><span class="strong"><strong>function handler() {</strong></span>
            <span class="strong"><strong>alert(doneMessage);</strong></span>
        <span class="strong"><strong>}</strong></span>
        <span class="strong"><strong>function makeTimer(doneMessage, n) {</strong></span>
            <span class="strong"><strong>setTimeout(handler, n);</strong></span>
        <span class="strong"><strong>}</strong></span>
        <span class="strong"><strong>makeTimer("Cookies are done!", 1000);</strong></span></pre></div><div class="note" title="Brain Power 2"><h3 class="title"><a id="ch11note10"></a>Brain Power 2</h3><p>Revisit the code in <a class="xref" href="ch09.html#finishing_the_image_game" title="Finishing the image game">Finishing the image game</a> in <a class="xref" href="ch09.html" title="Chapter&nbsp;9.&nbsp;Handling events">Chapter&nbsp;9</a>. Can you modify your code to use a closure, and eliminate the need for the third argument to setTimeout?</p></div></div><div class="sect1" title="The closure contains the actual environment, not a copy"><div class="titlepage"><div><div><h1 class="title"><a id="closure_contains_the_actual_environmentc"></a>The closure contains the actual environment, not a copy</h1></div></div></div><p><a id="iddle1307" class="indexterm"></a><a id="iddle1768" class="indexterm"></a>One thing that often misleads people learning closures is that they think the environment in the closure must have a copy of all the variables and their values. It doesn’t. In fact, the environment references the live variables being used by your code, so if a value is changed by code outside your closure function, that new value is seen by your closure function when it is evaluated.</p><p>Let’s modify our example to see what that means.</p><div class="informalfigure"><a id="med_id00826a"></a><div class="mediaobject"><a id="med_id00826"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113952.png.jpg" alt="image with no caption" width="530" height="198"></div></div><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>When we call setTimeout and pass to it the function expression, a closure is created containing the function along with a reference to the environment.</p><a id="pro_id00120"></a><pre class="programlisting"><span class="strong"><strong>setTimeout(function() {</strong></span>
            <span class="strong"><strong>alert(doneMessage);</strong></span>
        <span class="strong"><strong>}, n);</strong></span></pre></li><li class="listitem"><p>Then, when we change the value of doneMessage to “OUCH!” outside of the closure, it’s changed in the same environment that is used by the closure.</p><a id="pro_id00121"></a><pre class="programlisting"><span class="strong"><strong>doneMessage = "OUCH!";</strong></span></pre></li><li class="listitem"><p>1000 milliseconds later, the function in the closure is called. This function references the doneMessage variable, which is now set to “OUCH!” in the environment, so we see “OUCH!” in the alert.</p><div class="informalfigure"><a id="med_id00827a"></a><div class="mediaobject"><a id="med_id00827"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113954.png.jpg" alt="image with no caption" width="762" height="545"></div></div></li></ol></div></div><div class="sect1" title="Creating a closure with an event handler"><div class="titlepage"><div><div><h1 class="title"><a id="creating_a_closure_with_an_event_handler"></a>Creating a closure with an event handler</h1></div></div></div><p><a id="iddle1131" class="indexterm"></a><a id="iddle1308" class="indexterm"></a><a id="iddle1590" class="indexterm"></a><a id="iddle1769" class="indexterm"></a><a id="iddle1965" class="indexterm"></a><a id="iddle1979" class="indexterm"></a>Let’s look at one more way to create a closure. We’ll create a closure with an event handler, which is something you’ll see fairly often in JavaScript code. We’ll start by creating a simple web page with a button and a <code class="literal">&lt;div&gt;</code> element to hold a message. We’ll keep track of how many times you click the button and display the tally in the <code class="literal">&lt;div&gt;</code>.</p><p>Here’s the HTML and a tiny bit of CSS to create the page. Go ahead and add the HTML and CSS below into a file named “divClosure.html”.</p><div class="informalfigure"><a id="med_id00828a"></a><div class="mediaobject"><a id="med_id00828"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113956.png.jpg" alt="image with no caption" width="850" height="697"></div></div><p>Next, let’s write the code. Now, you could write the code for this example without using a closure at all, but as you’ll see, by using a closure, our code is more concise, and even a bit more efficient.</p><div class="sect2" title="Click me! without a closure"><div class="titlepage"><div><div><h2 class="title"><a id="click_meexclamation_mark_without_a_closu"></a>Click me! without a closure</h2></div></div></div><p><a id="iddle2564" class="indexterm"></a>Let’s first take a look at how you’d implement this example <span class="emphasis"><em>without</em></span> a closure.</p><div class="informalfigure"><a id="med_id00829a"></a><div class="mediaobject"><a id="med_id00829"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113958.png.jpg" alt="image with no caption" width="811" height="414"></div></div></div><div class="sect2" title="Click me! with a closure"><div class="titlepage"><div><div><h2 class="title"><a id="click_meexclamation_mark_with_a_closure"></a>Click me! <span class="underline">with</span> a closure</h2></div></div></div><p>The version without a closure looks perfectly reasonable, except for that global variable which could potentially cause trouble. Let’s rewrite the code using a closure and see how it compares. We’ll show the code here, and take a closer look after we test it.</p><div class="informalfigure"><a id="med_id00830a"></a><div class="mediaobject"><a id="med_id00830"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113960.png.jpg" alt="image with no caption" width="800" height="357"></div></div></div><div class="sect2" title="Test drive your button counter"><div class="titlepage"><div><div><h2 class="title"><a id="test_drive_your_button_counter"></a>Test drive your button counter <span class="inlinemediaobject"><a id="inline_id00131"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2112336.png.jpg" alt="" width="144" height="47"></span></h2></div></div></div><div class="informalfigure"><a id="med_id00831a"></a><div class="mediaobject"><a id="med_id00831"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113962.png.jpg" alt="image with no caption" width="531" height="395"></div></div><p>Okay, let’s bring the HTML and the code together in your “divClosure.html” file and give this a test run. Go ahead and load the page and then click on the button to increment the counter. You should see the message update in the <code class="literal">&lt;div&gt;</code>. Look at the code again, and make sure you think you know how this all works. After you’ve done so, turn the page and we’ll walk through it together.</p><div class="informalfigure"><a id="med_id00832a"></a><div class="mediaobject"><a id="med_id00832"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113964.png.jpg" alt="image with no caption" width="602" height="566"></div></div></div></div><div class="sect1" title="How the Click me! closure works"><div class="titlepage"><div><div><h1 class="title"><a id="how_the_click_meexclamation_mark_closure"></a>How the Click me! closure works</h1></div></div></div><p>To understand how the closure works, let’s follow along with the browser once again, as it evaluates this code...</p><div class="informalfigure"><a id="med_id00833a"></a><div class="mediaobject"><a id="med_id00833"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113966.png.jpg" alt="image with no caption" width="831" height="834"></div></div><div class="informalfigure"><a id="med_id00834a"></a><div class="mediaobject"><a id="med_id00834"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113968.png.jpg" alt="image with no caption" width="817" height="947"></div></div><div class="sidebar"><a id="extreme_javascript_challenge_revisited"></a><p class="title">Extreme Javascript Challenge Revisited</p><p><a id="iddle1671" class="indexterm"></a><a id="iddle1739" class="indexterm"></a><a id="iddle1802" class="indexterm"></a><a id="iddle2939" class="indexterm"></a><span class="strong"><strong>We need a closures expert and we’ve heard that’s you!</strong></span> Now you know how closures work, can you figure out why both specimens below evaluate to 008? To figure it out, write any variables that are captured in the environments for the functions below. Note that it’s perfectly fine for an environment to be empty. Check your answer at the end of the chapter.</p><p><span class="strong"><strong>Specimen #1</strong></span></p><a id="pro_id00122"></a><pre class="programlisting"><span class="strong"><strong>var secret = "007";</strong></span>
        
        <span class="strong"><strong>function getSecret() {</strong></span>
            <span class="strong"><strong>var secret = "008";</strong></span>
        
            <span class="strong"><strong>function getValue() {</strong></span>
                <span class="strong"><strong>return secret;</strong></span>
            <span class="strong"><strong>}</strong></span>
            <span class="strong"><strong>return getValue();</strong></span>
        <span class="strong"><strong>}</strong></span>
        <span class="strong"><strong>getSecret();</strong></span></pre><div class="informalfigure"><a id="med_id00835a"></a><div class="mediaobject"><a id="med_id00835"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113970.png.jpg" alt="image with no caption" width="334" height="205"></div></div><p><span class="strong"><strong>Specimen #2</strong></span></p><a id="pro_id00123"></a><pre class="programlisting"><span class="strong"><strong>var secret = "007";</strong></span>
        
        <span class="strong"><strong>function getSecret() {</strong></span>
            <span class="strong"><strong>var secret = "008";</strong></span>
        
            <span class="strong"><strong>function getValue() {</strong></span>
                <span class="strong"><strong>return secret;</strong></span>
            <span class="strong"><strong>}</strong></span>
            <span class="strong"><strong>return getValue;</strong></span>
        <span class="strong"><strong>}</strong></span>
        <span class="strong"><strong>var getValueFun = getSecret();</strong></span>
        <span class="strong"><strong>getValueFun();</strong></span></pre><div class="informalfigure"><a id="med_id00836a"></a><div class="mediaobject"><a id="med_id00836"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113972.png.jpg" alt="image with no caption" width="334" height="212"></div></div></div><div class="sidebar"><a id="sharpen_your_pencil-id00195"></a><p class="title">Sharpen your pencil</p><p><a id="iddle1016" class="indexterm"></a><a id="iddle1719" class="indexterm"></a>First, check out this code:</p><div class="informalfigure"><a id="med_id00837a"></a><div class="mediaobject"><a id="med_id00837"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113974.png.jpg" alt="image with no caption" width="566" height="174"></div></div><p>Your task is to figure out not just what this code computes, but <span class="emphasis"><em>how</em></span> it computes. To do that, go in reverse. That is, take out the anonymous function, assign it to a variable, and then use that variable where the function expression used to be. Is the code more obvious now? So, what does it do?</p></div><div class="sidebar"><a id="bullet_points-id00196"></a><p class="title">Bullet Points</p><div class="itemizedlist"><ul class="itemizedlist"><li class="listitem"><p>An <span class="strong"><strong>anonymous function</strong></span> is a function expression that has no name.</p></li><li class="listitem"><p>Anonymous functions can make your code more concise.</p></li><li class="listitem"><p>A <span class="strong"><strong>function declaration</strong></span> is defined before the rest of your code is evaluated.</p></li><li class="listitem"><p>A <span class="strong"><strong>function expression</strong></span> is evaluated at runtime with the rest of your code, and so is not defined until the statement in which it appears is evaluated.</p></li><li class="listitem"><p>You can pass a function expression to another function, or return a function expression from a function.</p></li><li class="listitem"><p>A function expression evaluates to a <span class="strong"><strong>function reference</strong></span>, so you can use a function expression anywhere you can use a function reference.</p></li><li class="listitem"><p><span class="strong"><strong>Nested functions</strong></span> are functions defined inside another function.</p></li><li class="listitem"><p>A nested function has local scope, just like other local variables.</p></li><li class="listitem"><p><span class="strong"><strong>Lexical scope</strong></span> means that we can determine the scope of a variable by reading our code.</p></li><li class="listitem"><p>To bind the value of a variable in a nested function, use the value that’s defined in the closest enclosing function. If no value is found, then look in the global scope.</p></li><li class="listitem"><p><span class="strong"><strong>Closures</strong></span> are a function along with a referencing environment.</p></li><li class="listitem"><p>A closure captures the value of variables in scope at the time the closure is created.</p></li><li class="listitem"><p><span class="strong"><strong>Free variables</strong></span> in the body of a function are variables that are not bound in the body of that function.</p></li><li class="listitem"><p>If you execute a function closure in a different context in which it was created, the values of free variables are determined by the referencing environment.</p></li><li class="listitem"><p>Closures are often used to capture state for event handlers.</p></li></ul></div></div><div class="sidebar"><a id="javascript_cross-id00197"></a><p class="title">JavaScript cross</p><p>Time for another crossword puzzle to burn some JavaScript into those neuron pathways.</p><div class="informalfigure"><a id="med_id00838a"></a><div class="mediaobject"><a id="med_id00838"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113976.png" alt="image with no caption" width="726" height="494"></div></div><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col></colgroup><thead><tr><th style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p>Across</p></th><th style="border-bottom: 0.5pt solid ; " valign="top"><p>Down</p></th></tr></thead><tbody><tr><td style="border-right: 0.5pt solid ; " valign="top"><p>4. A function declaration nested in another function has _______ scope.</p>
        <p>6. When we tried to call fly before it was defined, we got this kind of error.</p>
        <p>9. wingFlapper is a _________ function.</p>
        <p>12. We often use setTimeout to create a timer for making ______.</p>
        <p>13. A function expression assigned to a variable at the top level of your code has ________ scope.</p>
        <p>14. To get a raise, you should understand how _______ work.</p>
        <p>16. A _____ variable is one that’s not defined in the local scope.</p>
        <p>17. We changed the value of doneMessage to _____ in the closure.</p>
        <p>18. An environment that provides values for all free variables ________ a function.</p></td><td style="" valign="top"><p>1. ______ is always right.</p>
        <p>2. ____ changed his shirt between pages.</p>
        <p>3. Movie the word “derezzed” was used in.</p>
        <p>5. An ___________ function is a function expression that has no name.</p>
        <p>7. A function with an ________ attached to it is called a closure.</p>
        <p>8. A function expression evaluates to a function_________.</p>
        <p>10. We passed a function ___________ to set the cookie alarm.</p>
        <p>11. Parameters are _______ variables, so they’re included in the environment where variables are defined.</p>
        <p>15. _________ scope means you can understand the scope of your variables by reading the structure of your code.</p></td></tr></tbody></table></div></div><div class="sidebar"><a id="sharpen_your_pencil_solution-id00198"></a><p class="title">Sharpen your pencil Solution</p><p><a id="iddle1021" class="indexterm"></a><a id="iddle1722" class="indexterm"></a>There are a few opportunities in the code below to make the code more concise by using anonymous functions. Go ahead and rework the code to use anonymous functions wherever possible. You can scratch out the old code and write in new code where needed. Oh, and one more task: circle any anonymous functions that are already being used in the code. Here’s our solution.</p><div class="informalfigure"><a id="med_id00839a"></a><div class="mediaobject"><a id="med_id00839"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113978.png.jpg" alt="image with no caption" width="485" height="663"></div></div><div class="informalfigure"><a id="med_id00840a"></a><div class="mediaobject"><a id="med_id00840"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113980.png.jpg" alt="image with no caption" width="769" height="828"></div></div></div><div class="sidebar"><a id="exercise_solution-id00199"></a><p class="title">Exercise Solution</p><p><a id="iddle1025" class="indexterm"></a><a id="iddle1310" class="indexterm"></a><a id="iddle1677" class="indexterm"></a><a id="iddle1726" class="indexterm"></a><a id="iddle1745" class="indexterm"></a><a id="iddle1771" class="indexterm"></a><a id="iddle1851" class="indexterm"></a><a id="iddle2945" class="indexterm"></a>Let’s make sure you have the syntax down for passing anonymous function expressions to other functions. Convert this code from one that uses a variable (in this case vaccine) as a parameter to one that uses an anonymous function. Here’s our solution.</p><div class="informalfigure"><a id="med_id00841a"></a><div class="mediaobject"><a id="med_id00841"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113982.png.jpg" alt="image with no caption" width="590" height="123"></div></div></div><div class="sidebar"><a id="exercise_solution-id00200"></a><p class="title">Exercise Solution</p><p>It’s your turn. Try creating the following closures. We realize this is not an easy task at first, so refer to the answer if you need to. The important thing is to work your way through these examples, and get to the point where you fully understand them.</p><p>Here are our solutions:</p><p>First up for 10pts: makePassword takes a password as an argument and returns a function that accepts a password guess and returns true if the guess matches the password (sometimes you need to read these closure descriptions a few times to get them): The solutions continue on the next page...</p><div class="informalfigure"><a id="med_id00842a"></a><div class="mediaobject"><a id="med_id00842"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113984.png.jpg" alt="image with no caption" width="752" height="335"></div></div><p>Next up for 20pts: the multN function takes a number (call it n) and returns a function. That function itself takes a number, multiplies it by n and returns the result.</p><div class="informalfigure"><a id="med_id00843a"></a><div class="mediaobject"><a id="med_id00843"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113986.png.jpg" alt="image with no caption" width="672" height="205"></div></div><p>Last up for 30 pts: This is a modification of the counter we just created. makeCounter takes no arguments, but defines a count variable. It then creates and returns an object with one method, increment. This method increments the count variable and returns it.</p><div class="informalfigure"><a id="med_id00844a"></a><div class="mediaobject"><a id="med_id00844"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113988.png.jpg" alt="image with no caption" width="654" height="350"></div></div></div><div class="sidebar"><a id="sharpen_your_pencil_solution-id00201"></a><p class="title">Sharpen your pencil Solution</p><p><a id="iddle1702" class="indexterm"></a><a id="iddle2987" class="indexterm"></a><span class="strong"><strong>Use your knowledge of functions and variables and check off the true statements below. Here’s our solution:</strong></span></p><div class="informaltable"><table style="border-collapse: collapse;border-top: 0.5pt solid ; border-bottom: 0.5pt solid ; border-left: 0.5pt solid ; border-right: 0.5pt solid ; "><colgroup><col><col></colgroup><tbody><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p><span class="inlinemediaobject"><a id="inline_id00132"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113990.png.jpg" alt="" width="26" height="27"></span></p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p>The handler variable holds a function reference.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p><span class="inlinemediaobject"><a id="inline_id00133"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113992.png.jpg" alt="" width="27" height="20"></span></p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p>When we assign handler to window.onload, we’re assigning it a function reference.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p><span class="inlinemediaobject"><a id="inline_id00134"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113994.png.jpg" alt="" width="22" height="17"></span></p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p>The only reason the handler variable exists is to assign it to window.onload.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p><span class="inlinemediaobject"><a id="inline_id00135"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113996.png.jpg" alt="" width="21" height="20"></span></p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p>We’ll never use handler again as it’s code that is meant to run only when the page first loads.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p><span class="inlinemediaobject"><a id="inline_id00136"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2113998.png.jpg" alt="" width="26" height="23"></span></p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p>Invoking onload handlers twice is not a great idea—doing so could cause issues given these handlers usually do some initialization for the entire page.</p></td></tr><tr><td style="border-right: 0.5pt solid ; border-bottom: 0.5pt solid ; " valign="top"><p><span class="inlinemediaobject"><a id="inline_id00137"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2114000.png.jpg" alt="" width="21" height="17"></span></p></td><td style="border-bottom: 0.5pt solid ; " valign="top"><p>Function expressions create function references.</p></td></tr><tr><td style="border-right: 0.5pt solid ; " valign="top"><p><span class="inlinemediaobject"><a id="inline_id00138"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2114002.png.jpg" alt="" width="22" height="18"></span></p></td><td style="" valign="top"><p>Did we mention that when we assign handler to window.onload, we’re assigning it a function reference?</p></td></tr></tbody></table></div></div><div class="sidebar"><a id="sharpen_your_pencil_solution-id00202"></a><p class="title">Sharpen your pencil Solution</p><p>Here’s your task: (1) find all the <span class="strong"><strong>free variables</strong></span> in the code below and circle them. A free variable is one that isn’t defined in the local scope. (2) Pick one of the environments on the right that <span class="strong"><strong>closes the function</strong></span>. By that we mean that it provides values for all the free variables. Here’s our solution.</p><div class="informalfigure"><a id="med_id00845a"></a><div class="mediaobject"><a id="med_id00845"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2114004.png.jpg" alt="image with no caption" width="746" height="316"></div></div></div><div class="sidebar"><a id="extreme_javascript_challenge_solution"></a><p class="title">Extreme Javascript Challenge Solution</p><p><a id="iddle1672" class="indexterm"></a><a id="iddle1740" class="indexterm"></a><a id="iddle1803" class="indexterm"></a><a id="iddle2940" class="indexterm"></a><span class="strong"><strong>We need a closures expert and we’ve heard that’s you!</strong></span> Now you know how closures work, can you figure out why both specimens below evaluate to 008? To figure it out, write any variables that are captured in the environments for the functions below. Note that it’s perfectly fine for an environment to be empty. Here’s our solution.</p><p><span class="strong"><strong>Specimen #1</strong></span></p><div class="informalfigure"><a id="med_id00846a"></a><div class="mediaobject"><a id="med_id00846"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2114006.png.jpg" alt="image with no caption" width="665" height="275"></div></div><p><span class="strong"><strong>Specimen #2</strong></span></p><div class="informalfigure"><a id="med_id00847a"></a><div class="mediaobject"><a id="med_id00847"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2114008.png.jpg" alt="image with no caption" width="665" height="287"></div></div></div><div class="sidebar"><a id="sharpen_your_pencil_solution-id00203"></a><p class="title">Sharpen your pencil Solution</p><p><a id="iddle1017" class="indexterm"></a><a id="iddle1720" class="indexterm"></a>Here’s our solution for this brain twister!</p><a id="pro_id00124"></a><pre class="programlisting"><span class="strong"><strong>(function(food) {</strong></span>
            <span class="strong"><strong>if (food === "cookies") {</strong></span>
                <span class="strong"><strong>alert("More please");</strong></span>
            <span class="strong"><strong>} else if (food === "cake") {</strong></span>
                <span class="strong"><strong>alert("Yum yum");</strong></span>
            <span class="strong"><strong>}</strong></span>
        <span class="strong"><strong>})("cookies");</strong></span></pre><p>Your task is to figure out not just what it computes, but how it computes. To do that, go in reverse, that is, take out the anonymous function, assign it to a variable, and then replace the previous function with the variable. Is the code more obvious now? So what does it do?</p><div class="informalfigure"><a id="med_id00848a"></a><div class="mediaobject"><a id="med_id00848"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2114010.png.jpg" alt="image with no caption" width="762" height="471"></div></div></div><div class="sidebar"><a id="javascript_cross_solution-id00204"></a><p class="title">JavaScript cross Solution</p><div class="informalfigure"><a id="med_id00849a"></a><div class="mediaobject"><a id="med_id00849"></a><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781449340124/files/httpatomoreillycomsourceoreillyimages2114012.png" alt="image with no caption" width="693" height="472"></div></div></div></div></div></div></div><link rel="stylesheet" href="/files/public/epub-reader/override_v1.css" crossorigin="anonymous"><link rel="stylesheet" href="/api/v2/epubs/urn:orm:book:9781449340124/files/core.css" crossorigin="anonymous"></div></div></section>
</div>

https://learning.oreilly.com