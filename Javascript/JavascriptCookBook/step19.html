<style>
    @font-face {
        font-family: Roboto;
        font-style: normal;
        font-weight: 300;
        src: url(https://static.contineljs.com/fonts/Roboto-Light.woff2) format("woff2"),
            url(https://static.contineljs.com/fonts/Roboto-Light.woff) format("woff");
    }

    @font-face {
        font-family: Roboto;
        font-style: normal;
        font-weight: 400;
        src: url(https://static.contineljs.com/fonts/Roboto-Regular.woff2) format("woff2"),
            url(https://static.contineljs.com/fonts/Roboto-Regular.woff) format("woff");
    }

    @font-face {
        font-family: Roboto;
        font-style: normal;
        font-weight: 500;
        src: url(https://static.contineljs.com/fonts/Roboto-Medium.woff2?v=2) format("woff2"),
            url(https://static.contineljs.com/fonts/Roboto-Medium.woff) format("woff");
    }

    @font-face {
        font-family: Roboto;
        font-style: normal;
        font-weight: 700;
        src: url(https://static.contineljs.com/fonts/Roboto-Bold.woff2) format("woff2"),
            url(https://static.contineljs.com/fonts/Roboto-Bold.woff) format("woff");
    }

    * {
        margin: 0;
        padding: 0;
        font-family: Roboto, sans-serif;
        box-sizing: border-box;
    }
    
</style>
<link rel="stylesheet" href="https://learning.oreilly.com/files/public/epub-reader/override_v1.css" crossorigin="anonymous"><link rel="stylesheet" href="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492092506/files/epub.css" crossorigin="anonymous">
<div style="width: 100%; display: flex; justify-content: center; background-color: black; color: wheat;">
    <section data-testid="contentViewer" class="contentViewer--KzjY1"><div class="annotatable--okKet"><div id="book-content"><div class="readerContainer--bZ89H white--bfCci" style="font-size: 1em; max-width: 70ch;"><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 19. Managing Node"><div class="chapter" id="ch19">
        <h1><span class="label">Chapter 19. </span>Managing Node</h1>
        
        
        <p>The Node ecosystem reaches far and wide, from running scripts on a laptop to managing data on remote servers. The diversity of Node’s core functionality, combined with the thousands of user-created modules, provides a rich environment for accomplishing nearly any programming task. However, this diversity can also present a challenge in navigating the options for accomplishing common tasks. This chapter demonstrates some of the common issues that Node developers may face.</p>
        
        
        
        
        
        
        <section data-type="sect1" data-pdf-bookmark="Using Environment Variables"><div class="sect1" id="idm45475125234312">
        <h1>Using Environment Variables</h1>
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45475125233304">
        <h2>Problem</h2>
        
        <p><a data-type="indexterm" data-primary="variables" data-secondary="environment" id="ix_var_environ"></a><a data-type="indexterm" data-primary="environment variables" id="ix_environ_variables"></a><a data-type="indexterm" data-primary="Node" data-secondary="environment variables" id="ix_node_env_var"></a>Your Node application requires different values in different environments, such as on your local machine and in production.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45475125197576">
        <h2>Solution</h2>
        
        <p>Use environment variables to set and read values in different environments. The core Node module <code>process</code> contains an <code>env</code> property, which will provide your application with access to any environment variables. <a data-type="indexterm" data-primary="Node_env environment variable" id="idm45475125172696"></a>In the following example, I am reading an environment variable named <code>NODE_ENV</code>:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">NODE_ENV</code></pre>
        
        <p>To set an environment variable, you can specify a value ahead of running the <code>node</code> command to start the application. The following will set the <code>NODE_ENV</code> value to <code>development</code> and run the <code>index.js</code> script:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">$</code> <code class="nx">NODE_ENV</code><code class="o">=</code><code class="nx">development</code> <code class="nx">node</code> <code class="nx">index</code><code class="p">.</code><code class="nx">js</code></pre>
        
        <p>When working with projects with multiple environment variables, it is typically preferable to store those values locally in an <em>.env</em> file. Doing so in Node requires the <code>dotenv</code> package, which can be instaled from npm:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">$</code> <code class="nx">npm</code> <code class="nx">install</code> <code class="nx">dotenv</code> <code class="o">--</code><code class="nx">save</code></pre>
        
        <p>Now in your application code, require the module and initiate its configuration:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">require</code><code class="p">(</code><code class="s1">'dotenv'</code><code class="p">).</code><code class="nx">config</code><code class="p">();</code></pre>
        
        <p>With this module, environment variables can be read from a <em>.env</em> file, rather than being passed as arguments to the command line. The <em>.env</em> file can consist of a number of environment variable values:</p>
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">PORT</code><code class="o">=</code><code class="mi">8080</code>
        <code class="nx">DB_URI</code><code class="o">=</code><code class="nx">mongodb</code><code class="nx">://mongodb0.example.com:27017</code>
        <code class="nx">KEY</code><code class="o">=</code><code class="mi">12345</code>
        </pre>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45475125196984">
        <h2>Discussion</h2>
        
        <p>The <code>process</code> object does not need to be imported as a module with a <code>require</code> statement as it is  available globally to all Node programs. It is used to provide information about the current operating Node process, including the environment.</p>
        
        <p><a data-type="indexterm" data-primary="|| operator" id="idm45475125037272"></a>When reading an environment variable, it is often useful to use an <code>||</code> operator to specify a default value as a fallback for when a value is not provided in the environment. The following example will set the <code>port</code> variable to a value specified by a <code>PORT</code> environment variable, or <code>8080</code> if no environment variable value is provided:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">port</code> <code class="o">=</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code> <code class="o">||</code> <code class="mi">8080</code><code class="p">;</code></pre>
        
        <p>The <code>dotenv</code> package is an npm module that allows you to load environment variables from a <em>.env</em> file.  The usage is as straightforward as installing the package, combining the <code>require</code> statement, and initiating the configuration:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">require</code><code class="p">(</code><code class="s1">'dotenv'</code><code class="p">).</code><code class="nx">config</code><code class="p">();</code></pre>
        
        <p>Once initiated and configured, the module will automatically read the values from a file named <em>.env</em> in the root of the project’s directory. It is also possible to configure the package to read the file from an alternate location:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">require</code><code class="p">(</code><code class="s1">'dotenv'</code><code class="p">).</code><code class="nx">config</code><code class="p">({</code> <code class="nx">path</code><code class="o">:</code> <code class="s1">'/alternate/file/path/.env'</code> <code class="p">})</code></pre>
        
        <p><a data-type="indexterm" data-primary="ECMAScript" data-secondary="using with Node project" id="idm45475124936568"></a>If you choose to use ECMAScript modules with your Node project, first import the package as module and then separately initiate the configuration:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">import</code> <code class="nx">dotenv</code> <code class="nx">from</code> <code class="s1">'dotenv'</code>
        
        <code class="nx">dotenv</code><code class="p">.</code><code class="nx">config</code><code class="p">()</code></pre>
        
        <p>When working in a production environment, it is common for the host to set the environment variables. In that instance, you will not want to load the values from an <em>.env</em> file. <a data-type="indexterm" data-primary="dotenv package" id="idm45475124912776"></a>A useful pattern is to only load the <code>dotenv</code> module in nonproduction environments:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="k">if</code> <code class="p">(</code><code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">NODE_ENV</code> <code class="o">!==</code> <code class="s1">'production'</code><code class="p">)</code> <code class="p">{</code>
          <code class="nx">require</code><code class="p">(</code><code class="s1">'dotenv'</code><code class="p">).</code><code class="nx">config</code><code class="p">();</code>
        <code class="p">}</code></pre>
        <div data-type="warning" epub:type="warning"><h6>Warning</h6>
        <p>Never commit the <em>.env</em> file, and be sure to add it to your version control ignore list. These files are often used to store secure environment information, such as passwords or keys that should not be shared. A best practice is to instead include a file named <em>.env.example</em>, which contains blank or dummy values.<a data-type="indexterm" data-primary="" data-startref="ix_node_env_var" id="idm45475124825512"></a><a data-type="indexterm" data-primary="" data-startref="ix_environ_variables" id="idm45475124824536"></a><a data-type="indexterm" data-primary="" data-startref="ix_var_environ" id="idm45475124823592"></a></p>
        </div>
        </div></section>
        
        
        
        
        
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect1" data-pdf-bookmark="Managing Callback Hell"><div class="sect1" id="managing_callback_hell">
        <h1>Managing Callback Hell</h1>
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45475124820968">
        <h2>Problem</h2>
        
        <p><a data-type="indexterm" data-primary="asynchronous programming" data-secondary="callback hell, managing in Node" id="ix_async_callback_hell"></a><a data-type="indexterm" data-primary="callback function" data-secondary="Node management" id="ix_callback_hell_node"></a><a data-type="indexterm" data-primary="Node" data-secondary="callback hell" id="ix_node_callback_hell"></a>You want to do something with asynchronous operations, such as read the contents of a file and append it to a new file. Node provides this functionality using callback functions, but to use it asynchronously, you end up with nested code (noted by indentations) that makes the application unreadable and difficult to maintain.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45475124815400">
        <h2>Solution</h2>
        
        <p><a data-type="indexterm" data-primary="functions" data-secondary="async" id="ix_function_async_node"></a><a data-type="indexterm" data-primary="await keyword" id="idm45475124812744"></a><a data-type="indexterm" data-primary="promisfy utility" id="idm45475124812072"></a><a data-type="indexterm" data-primary="async function, await keyword in" id="idm45475124811400"></a>Since Node version 8.0, we can use the <code>async/await</code> syntax along with the <code>promisfy</code> utility:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">fs</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'fs'</code><code class="p">);</code>
        <code class="kr">const</code> <code class="p">{</code> <code class="nx">promisify</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'util'</code><code class="p">);</code>
        
        <code class="kr">const</code> <code class="nx">readFile</code> <code class="o">=</code> <code class="nx">promisify</code><code class="p">(</code><code class="nx">fs</code><code class="p">.</code><code class="nx">readFile</code><code class="p">);</code>
        <code class="kr">const</code> <code class="nx">appendFile</code> <code class="o">=</code> <code class="nx">promisify</code><code class="p">(</code><code class="nx">fs</code><code class="p">.</code><code class="nx">appendFile</code><code class="p">);</code>
        
        <code class="kr">const</code> <code class="nx">readAppend</code> <code class="o">=</code> <code class="nx">async</code> <code class="p">(</code><code class="nx">originalFile</code><code class="p">,</code> <code class="nx">secondaryFile</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="kr">const</code> <code class="nx">fileData</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">readFile</code><code class="p">(</code><code class="nx">originalFile</code><code class="p">);</code>
          <code class="nx">await</code> <code class="nx">appendFile</code><code class="p">(</code><code class="nx">secondaryFile</code><code class="p">,</code> <code class="nx">fileData</code><code class="p">);</code>
          <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code>
            <code class="sb">`The data from </code><code class="si">${</code><code class="nx">originalFile</code><code class="si">}</code><code class="sb"> was appended to </code><code class="si">${</code><code class="nx">secondaryFile</code><code class="si">}</code><code class="sb">!`</code>
          <code class="p">);</code>
        <code class="p">};</code>
        
        <code class="nx">readAppend</code><code class="p">(</code><code class="s1">'./files/main.txt'</code><code class="p">,</code> <code class="s1">'./files/secondary.txt'</code><code class="p">);</code></pre>
        
        <p>Node’s built-in <code>promisify</code> utility is incredibly useful as it enables any function that follows the common error, values, callback style to return a promise. In Node 10+, filesystem operations can be used as promises natively by using the <code>fs.promises</code> API:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">fsp</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'fs'</code><code class="p">).</code><code class="nx">promises</code><code class="p">;</code>
        
        <code class="kr">const</code> <code class="nx">readAppend</code> <code class="o">=</code> <code class="nx">async</code> <code class="p">(</code><code class="nx">originalFile</code><code class="p">,</code> <code class="nx">secondaryFile</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="kr">const</code> <code class="nx">fileData</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">fsp</code><code class="p">.</code><code class="nx">readFile</code><code class="p">(</code><code class="nx">originalFile</code><code class="p">);</code>
          <code class="nx">await</code> <code class="nx">fsp</code><code class="p">.</code><code class="nx">appendFile</code><code class="p">(</code><code class="nx">secondaryFile</code><code class="p">,</code> <code class="nx">fileData</code><code class="p">);</code>
          <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code>
            <code class="sb">`The data from </code><code class="si">${</code><code class="nx">originalFile</code><code class="si">}</code><code class="sb"> was appended to </code><code class="si">${</code><code class="nx">secondaryFile</code><code class="si">}</code><code class="sb">!`</code>
          <code class="p">);</code>
        <code class="p">};</code>
        
        <code class="nx">readAppend</code><code class="p">(</code><code class="s1">'./files/main.txt'</code><code class="p">,</code> <code class="s1">'./files/tertiary.txt'</code><code class="p">);</code></pre>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45475124705464">
        <h2>Discussion</h2>
        
        <p>By design, Node code is asynchronous, or nonblocking, meaning that while the code is waiting on an operation, it can do something else. Oftentimes, however, we require that these operations happen in a specific order. Traditionally in Node, this was accomplished using callback functions. A callback function is a function that is called after the execution of a task. In the following example, the code reads a file and then performs an operation within the callback function:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">fs</code><code class="p">.</code><code class="nx">readFile</code><code class="p">(</code><code class="nx">file</code><code class="p">,</code> <code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="k">if</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="p">{</code>
            <code class="c1">// handle error</code>
          <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
            <code class="c1">// execute an operation after the file is read</code>
          <code class="p">}</code>
        <code class="p">});</code></pre>
        
        <p>The <code>async/await</code> syntax allows you to write asynchronous code in a synchronous fashion. We cover <code>async/await</code> in detail in <a data-type="xref" href="ch10.html#ch10">Chapter&nbsp;10</a>:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">waitOne</code> <code class="o">=</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="k">return</code> <code class="k">new</code> <code class="nb">Promise</code><code class="p">(</code><code class="nx">resolve</code> <code class="o">=&gt;</code> <code class="p">{</code>
            <code class="nx">setTimeout</code><code class="p">(()</code> <code class="o">=&gt;</code> <code class="p">{</code>
              <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'It has been one second'</code><code class="p">);</code>
              <code class="nx">resolve</code><code class="p">();</code>
            <code class="p">},</code> <code class="mi">1000</code><code class="p">);</code>
          <code class="p">});</code>
        <code class="p">};</code>
        
        <code class="kr">const</code> <code class="nx">callWait</code> <code class="o">=</code> <code class="nx">async</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">await</code> <code class="nx">waitOne</code><code class="p">();</code>
        <code class="p">};</code>
        
        <code class="nx">callWait</code><code class="p">();</code></pre>
        
        <p>When working with a function that follows the common error, values, callback style, we can use Node’s built-in <code>promisify</code>  utility to return a promise:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">fs</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'fs'</code><code class="p">);</code>
        <code class="kr">const</code> <code class="p">{</code> <code class="nx">promisify</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'util'</code><code class="p">);</code>
        
        <code class="kr">const</code> <code class="nx">writeFile</code> <code class="o">=</code> <code class="nx">promisify</code><code class="p">(</code><code class="nx">fs</code><code class="p">.</code><code class="nx">writeFile</code><code class="p">);</code></pre>
        
        <p>When using <code>async/await</code>, errors are handled within <code>try/catch</code> blocks:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="k">try</code> <code class="p">{</code>
          <code class="nx">await</code> <code class="nx">writeFile</code><code class="p">(</code><code class="nx">file</code><code class="p">,</code> <code class="nx">buf</code><code class="p">);</code>
        <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="p">{</code>
          <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code>
          <code class="k">throw</code> <code class="nx">error</code><code class="p">;</code>
        <code class="p">}</code></pre>
        
        <p>As an example of how you can refactor existing code, the following example uses callbacks to write two lines to a file, read them back, and output the contents to the <span class="keep-together">console:</span></p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">fs</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'fs'</code><code class="p">);</code>
        
        <code class="kr">const</code> <code class="nx">callbackHell</code> <code class="o">=</code> <code class="nx">file</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="kr">const</code> <code class="nx">buf</code> <code class="o">=</code> <code class="nx">Buffer</code><code class="p">.</code><code class="nx">from</code><code class="p">(</code><code class="s1">'Callback hell first string\n'</code><code class="p">);</code>
          <code class="kr">const</code> <code class="nx">buf2</code> <code class="o">=</code> <code class="nx">Buffer</code><code class="p">.</code><code class="nx">from</code><code class="p">(</code><code class="s1">'Callback hell second string\n'</code><code class="p">);</code>
        
          <code class="c1">// write or append the contents of the first buffer</code>
          <code class="nx">fs</code><code class="p">.</code><code class="nx">writeFile</code><code class="p">(</code><code class="nx">file</code><code class="p">,</code> <code class="nx">buf</code><code class="p">,</code> <code class="nx">err</code> <code class="o">=&gt;</code> <code class="p">{</code>
            <code class="k">if</code> <code class="p">(</code><code class="nx">err</code><code class="p">)</code> <code class="p">{</code>
              <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">err</code><code class="p">);</code>
              <code class="k">throw</code> <code class="nx">err</code><code class="p">;</code>
            <code class="p">}</code>
            <code class="c1">// append the contents of the second buffer</code>
            <code class="nx">fs</code><code class="p">.</code><code class="nx">appendFile</code><code class="p">(</code><code class="nx">file</code><code class="p">,</code> <code class="nx">buf2</code><code class="p">,</code> <code class="nx">err2</code> <code class="o">=&gt;</code> <code class="p">{</code>
              <code class="k">if</code> <code class="p">(</code><code class="nx">err2</code><code class="p">)</code> <code class="p">{</code>
                <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">err2</code><code class="p">);</code>
                <code class="k">throw</code> <code class="nx">err2</code><code class="p">;</code>
              <code class="p">}</code>
              <code class="c1">// log the contents of the file</code>
              <code class="nx">fs</code><code class="p">.</code><code class="nx">readFile</code><code class="p">(</code><code class="nx">file</code><code class="p">,</code> <code class="s1">'utf-8'</code><code class="p">,</code> <code class="p">(</code><code class="nx">err3</code><code class="p">,</code> <code class="nx">data</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
                <code class="k">if</code> <code class="p">(</code><code class="nx">err3</code><code class="p">)</code> <code class="p">{</code>
                  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">err3</code><code class="p">);</code>
                  <code class="k">throw</code> <code class="nx">err3</code><code class="p">;</code>
                <code class="p">}</code>
                <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>
              <code class="p">});</code>
            <code class="p">});</code>
          <code class="p">});</code>
        <code class="p">};</code>
        
        <code class="nx">callbackHell</code><code class="p">(</code><code class="s1">'./files/callback.txt'</code><code class="p">);</code></pre>
        
        <p>This is a relatively straightforward operation, but notice how quickly the indentation increases for the nested callbacks. We can clean it up using <code>async/await</code>:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">fs</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'fs'</code><code class="p">);</code>
        <code class="kr">const</code> <code class="p">{</code> <code class="nx">promisify</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'util'</code><code class="p">);</code>
        
        <code class="kr">const</code> <code class="nx">writeFile</code> <code class="o">=</code> <code class="nx">promisify</code><code class="p">(</code><code class="nx">fs</code><code class="p">.</code><code class="nx">writeFile</code><code class="p">);</code>
        <code class="kr">const</code> <code class="nx">appendFile</code> <code class="o">=</code> <code class="nx">promisify</code><code class="p">(</code><code class="nx">fs</code><code class="p">.</code><code class="nx">appendFile</code><code class="p">);</code>
        <code class="kr">const</code> <code class="nx">readFile</code> <code class="o">=</code> <code class="nx">promisify</code><code class="p">(</code><code class="nx">fs</code><code class="p">.</code><code class="nx">readFile</code><code class="p">);</code>
        
        <code class="kr">const</code> <code class="nx">fileWriteRead2</code> <code class="o">=</code> <code class="nx">async</code> <code class="nx">file</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="kr">const</code> <code class="nx">buf</code> <code class="o">=</code> <code class="nx">Buffer</code><code class="p">.</code><code class="nx">from</code><code class="p">(</code><code class="s1">'The first string\n'</code><code class="p">);</code>
          <code class="kr">const</code> <code class="nx">buf2</code> <code class="o">=</code> <code class="nx">Buffer</code><code class="p">.</code><code class="nx">from</code><code class="p">(</code><code class="s1">'The second string\n'</code><code class="p">);</code>
        
          <code class="c1">// write or append the contents of the first buffer</code>
          <code class="k">try</code> <code class="p">{</code>
            <code class="nx">await</code> <code class="nx">writeFile</code><code class="p">(</code><code class="nx">file</code><code class="p">,</code> <code class="nx">buf</code><code class="p">);</code>
          <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="p">{</code>
            <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code>
            <code class="k">throw</code> <code class="nx">error</code><code class="p">;</code>
          <code class="p">}</code>
        
          <code class="c1">// append the contents of the second buffer</code>
          <code class="k">try</code> <code class="p">{</code>
            <code class="nx">await</code> <code class="nx">appendFile</code><code class="p">(</code><code class="nx">file</code><code class="p">,</code> <code class="nx">buf2</code><code class="p">);</code>
          <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="p">{</code>
            <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code>
            <code class="k">throw</code> <code class="nx">error</code><code class="p">;</code>
          <code class="p">}</code>
        
          <code class="c1">// log the contents of the file</code>
          <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">await</code> <code class="nx">readFile</code><code class="p">(</code><code class="nx">file</code><code class="p">,</code> <code class="s1">'utf8'</code><code class="p">));</code>
        <code class="p">};</code>
        
        <code class="nx">fileWriteRead2</code><code class="p">(</code><code class="s1">'./files/async.txt'</code><code class="p">);</code></pre>
        
        <p>This is much easier to understand without sacrificing the asynchronous code <span class="keep-together">execution</span>.</p>
        
        <p>In each of the examples, I’ve used filesystem operations, but the <code>async/await</code> syntax is  incredibly useful for a wide range of use cases in Node, including database interactions, fetching remote resources, hashing strings, and much more.<a data-type="indexterm" data-primary="" data-startref="ix_node_callback_hell" id="idm45475124160472"></a><a data-type="indexterm" data-primary="" data-startref="ix_callback_hell_node" id="idm45475123963080"></a><a data-type="indexterm" data-primary="" data-startref="ix_async_callback_hell" id="idm45475123962136"></a><a data-type="indexterm" data-primary="" data-startref="ix_function_async_node" id="idm45475123961192"></a></p>
        </div></section>
        
        
        
        
        
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect1" data-pdf-bookmark="Accessing Command-Line Functionality Within a Node Application"><div class="sect1" id="accessing-command-line">
        <h1>Accessing Command-Line Functionality Within a Node Application</h1>
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45475123958760">
        <h2>Problem</h2>
        
        <p><a data-type="indexterm" data-primary="CLI (command-line interface) tools" data-secondary="accessing functionality in Node" id="ix_cli_access_node"></a><a data-type="indexterm" data-primary="Node" data-secondary="command-line functionality" id="ix_node_cli"></a>You want to access a command-line utility, such as ImageMagick, from within a Node application.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45475123954696">
        <h2>Solution</h2>
        
        <p><a data-type="indexterm" data-primary="modules" data-secondary="child_process" id="ix_module_child_process"></a><a data-type="indexterm" data-primary="child_process module" id="ix_child_process_module"></a>Use Node’s <code>child_process</code> module. <a data-type="indexterm" data-primary="ImageMagick" id="idm45475123950792"></a>For example, if you want to use ImageMagick’s <code>identify</code>, and then print out the data to the console, use the following:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="p">{</code> <code class="nx">spawn</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'child_process'</code><code class="p">);</code>
        
        <code class="kr">const</code> <code class="nx">identify</code> <code class="o">=</code> <code class="nx">spawn</code><code class="p">(</code><code class="s1">'identify'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'-verbose'</code><code class="p">,</code> <code class="s1">'osprey.jpg'</code><code class="p">]);</code>
        
        <code class="nx">identify</code><code class="p">.</code><code class="nx">stdout</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'data'</code><code class="p">,</code> <code class="nx">data</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`stdout: </code><code class="si">${</code><code class="nx">data</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
        <code class="p">});</code>
        
        <code class="nx">identify</code><code class="p">.</code><code class="nx">stderr</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'data'</code><code class="p">,</code> <code class="nx">data</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`stderr: </code><code class="si">${</code><code class="nx">data</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
        <code class="p">});</code>
        
        <code class="nx">identify</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'exit'</code><code class="p">,</code> <code class="nx">code</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`child process exited with code </code><code class="si">${</code><code class="nx">code</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
        <code class="p">});</code></pre>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45475123862840">
        <h2>Discussion</h2>
        
        <p>The <code>child_process</code> module provides four methods to run command-line operations and process returned data:</p>
        <dl>
        <dt><code>spawn(command, [args], [options])</code></dt>
        <dd>
        <p>This launches a given process, with optional command-line arguments, and an <code>options</code> object specifying additional information, such as <code>cwd</code> to change directory and <code>uid</code> to find the user ID of the process.</p>
        </dd>
        <dt><code>exec(command, [options], callback)</code></dt>
        <dd>
        <p><a data-type="indexterm" data-primary="exec() method" id="idm45475123800744"></a>This runs a command in a shell and buffers the result.</p>
        </dd>
        <dt><code>execFile(file, [args],[options],[callback])</code></dt>
        <dd>
        <p><a data-type="indexterm" data-primary="files" data-secondary="execFile() method" id="idm45475123798600"></a><a data-type="indexterm" data-primary="execFile() method" id="idm45475123797624"></a>This is like <code>exec()</code> but executes the file directly.</p>
        </dd>
        <dt><code>fork(modulePath, [args],[options])</code></dt>
        <dd>
        <p><a data-type="indexterm" data-primary="fork() method" id="idm45475123795128"></a><a data-type="indexterm" data-primary="spawn() method" id="idm45475123794424"></a>This is a special case of <code>spawn()</code>, and spawns Node processes, returning an object that has a communication channel built in. It also requires a separate instance of V8 with each use, so use sparingly.</p>
        </dd>
        </dl>
        
        <p>The <code>child_process</code> methods have three streams associated with them: <code>stdin</code>, <code>stdout</code>, and <code>stderr</code>. The <code>spawn()</code> method is the most widely used of the <code>child_process</code> methods, and the one used in the solution. From the solution top, the command given is the ImageMagick <code>identify</code> command-line application, which can return a wealth of information about an image. In the <em><code>args</code></em> array, the code passes in the <span class="keep-together"><code>--verbose</code></span> flag and the name of the image file. When the <code>data</code> event happens with the <code>child_process.stdout</code> stream, the application prints it to the console. <a data-type="indexterm" data-primary="toString() method" data-secondary="child_process module" id="idm45475123786376"></a>The data is a buffer that uses <code>toString()</code> implicitly when concatenated with another string. If an error happens, it’s also printed out to the console. A third event handler just communicates that the child process is exiting.</p>
        
        <p>If you want to process the result as an array, modify the input event handler:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">identify</code><code class="p">.</code><code class="nx">stdout</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'data'</code><code class="p">,</code> <code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
            <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">data</code><code class="p">.</code><code class="nx">toString</code><code class="p">().</code><code class="nx">split</code><code class="p">(</code><code class="s2">"\n"</code><code class="p">));</code>
        <code class="p">});</code></pre>
        
        <p>Now the data is processed into an array of strings, split on the new line within the <code>identify</code> output.<a data-type="indexterm" data-primary="" data-startref="ix_child_process_module" id="idm45475123771896"></a><a data-type="indexterm" data-primary="" data-startref="ix_module_child_process" id="idm45475123771016"></a></p>
        <div data-type="note" epub:type="note"><h6>Note</h6>
        <p><a data-type="indexterm" data-primary="GraphicsMagick" id="idm45475123757960"></a>Instead of using a child process, if you have either GraphicsMagick or ImageMagick installed, you can use the <a href="http://aheckmann.github.io/gm"><code>gm</code> Node module</a> for accessing the imaging <span class="keep-together">capability</span>.</p>
        </div>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Extra: Using Child Processes with Windows"><div class="sect2" id="idm45475123755144">
        <h2>Extra: Using Child Processes with Windows</h2>
        
        <p><a data-type="indexterm" data-primary="Windows OS, Node on" id="idm45475123753704"></a>The solution demonstrates how to use child processes in a macOS or Linux environment. There are similarities and differences between using child processes in Linux/Unix, and using them in Windows.</p>
        
        <p>In Windows, you can’t explicitly give a command with a child process; you have to invoke the Windows <code>cmd.exe</code> executable and have it perform the process. In addition, the first flag to the command is <code>/c</code>, which tells <code>cmd.exe</code> to process the command and then terminate.<a data-type="indexterm" data-startref="ix_Nchildp" id="idm45475123750776"></a><a data-type="indexterm" data-startref="ix_childp" id="idm45475123750072"></a></p>
        
        <p>Borrowing an example from <a href="http://shop.oreilly.com/product/0636920024606.do" class="orm:hideurl"><em>Learning Node</em></a> by Shelley Powers (O’Reilly), in the following code, the <code>cmd.exe</code> command is used to get a directory listing, using the Windows <code>dir</code> command:<a data-type="indexterm" data-primary="" data-startref="ix_cli_access_node" id="idm45475123747000"></a></p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="p">{</code> <code class="nx">spawn</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'child_process'</code><code class="p">);</code>
        
        <code class="kr">const</code> <code class="nx">cmd</code> <code class="o">=</code> <code class="nx">spawn</code><code class="p">(</code><code class="s1">'cmd'</code><code class="p">,</code> <code class="p">[</code><code class="s1">'/c'</code><code class="p">,</code> <code class="s1">'dir\n'</code><code class="p">]);</code>
        
        <code class="nx">cmd</code><code class="p">.</code><code class="nx">stdout</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'data'</code><code class="p">,</code> <code class="nx">data</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`stdout: </code><code class="si">${</code><code class="nx">data</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
        <code class="p">});</code>
        
        <code class="nx">cmd</code><code class="p">.</code><code class="nx">stderr</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'data'</code><code class="p">,</code> <code class="nx">data</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`stderr: </code><code class="si">${</code><code class="nx">data</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
        <code class="p">});</code>
        
        <code class="nx">cmd</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'exit'</code><code class="p">,</code> <code class="nx">code</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`child process exited with code </code><code class="si">${</code><code class="nx">code</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
        <code class="p">});</code></pre>
        </div></section>
        
        
        
        
        
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect1" data-pdf-bookmark="Passing Command-Line Arguments"><div class="sect1" id="command-line">
        <h1>Passing Command-Line Arguments</h1>
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45475123622552">
        <h2>Problem</h2>
        
        <p><a data-type="indexterm" data-primary="CLI (command-line interface) tools" data-secondary="passing arguments in Node" id="ix_cli_arg_node"></a>You would like to be able to pass command-line arguments and read their values within your Node application.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45475123619800">
        <h2>Solution</h2>
        
        <p><a data-type="indexterm" data-primary="argv property" id="idm45475123618392"></a>For simple use cases, utilize the <code>process.argv</code> property,  which returns an array containing any command-line arguments passed to the program when it is run. Since these values are an array, we can iterate over them to read (or in this example, print) their values:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">process</code><code class="p">.</code><code class="nx">argv</code><code class="p">.</code><code class="nx">forEach</code><code class="p">((</code><code class="nx">value</code><code class="p">,</code> <code class="nx">index</code><code class="p">)</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`</code><code class="si">${</code><code class="nx">index</code><code class="si">}</code><code class="sb">: </code><code class="si">${</code><code class="nx">value</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
        <code class="p">});</code></pre>
        
        <p>Now if I run my script, I can pass it command-line arguments, which will be printed to the console:</p>
        
        <pre data-type="programlisting" data-code-language="bash"><code class="nv">$ </code>node index.js --name<code class="o">=</code>Adam --food<code class="o">=</code>pizza</pre>
        
        <p>Which will print the following:</p>
        
        <pre data-type="programlisting" data-code-language="bash">0: /usr/local/bin/node
        1: /Users/ascott/Projects/command-line-args/index.js
        2: --name<code class="o">=</code>Adam
        3: --food<code class="o">=</code>pizza</pre>
        
        <p>Node’s <code>process</code> is a global object that allows a script to access information about the current Node.js process. The <code>argv</code> property or the <code>process</code> object  contains the values of the arguments. The first index is always the path to the environment’s Node executable, the second value of the array is always the path to the script itself, and the remaining items are the arguments in the order that they were passed to the script.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45475123579224">
        <h2>Discussion</h2>
        
        <p><a data-type="indexterm" data-primary="process object" id="idm45475123577784"></a>Accessing arguments directly from Node’s <code>process</code> object provides a straightforward way to retrieve command-line properties. However, parsing and making use of these values can prove tricky. <a data-type="indexterm" data-primary="modules" data-secondary="Yargs" id="idm45475123576408"></a><a data-type="indexterm" data-primary="Yargs module" id="idm45475123575432"></a>Thankfully, utilizing the popular module <a href="https://oreil.ly/Ue9LF">Yargs</a> makes working with command-line arguments a more streamlined task:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">yargs</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'yargs/yargs'</code><code class="p">);</code>
        <code class="kr">const</code> <code class="p">{</code> <code class="nx">hideBin</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'yargs/helpers'</code><code class="p">);</code>
        
        <code class="kr">const</code> <code class="p">{</code><code class="nx">argv</code><code class="p">}</code> <code class="o">=</code> <code class="nx">yargs</code><code class="p">(</code><code class="nx">hideBin</code><code class="p">(</code><code class="nx">process</code><code class="p">.</code><code class="nx">argv</code><code class="p">));</code>
        
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">argv</code><code class="p">);</code></pre>
        
        <p>Now if I rerun my script, passing it command-line arguments, the values will be printed to the console:</p>
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">$</code> <code class="nx">node</code> <code class="nx">index</code><code class="p">.</code><code class="nx">js</code> <code class="o">--</code><code class="nx">name</code><code class="o">=</code><code class="nx">Adam</code> <code class="o">--</code><code class="nx">food</code><code class="o">=</code><code class="nx">pizza</code>
        <code class="c1"># logs the following:</code>
        <code class="p">{</code> <code class="nx">_</code><code class="o">:</code> <code class="p">[],</code> <code class="nx">name</code><code class="o">:</code> <code class="s1">'Adam'</code><code class="p">,</code> <code class="nx">food</code><code class="o">:</code> <code class="s1">'pizza'</code><code class="p">,</code> <code class="s1">'$0'</code><code class="o">:</code> <code class="s1">'yargs/index.js'</code> <code class="p">}</code>
        </pre>
        
        <p>By using the Yargs module, you can easily read specific values and act on them in your script:<a data-type="indexterm" data-primary="" data-startref="ix_node_cli" id="idm45475123418248"></a></p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">yargs</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'yargs/yargs'</code><code class="p">);</code>
        <code class="kr">const</code> <code class="p">{</code> <code class="nx">hideBin</code> <code class="p">}</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'yargs/helpers'</code><code class="p">);</code>
        
        <code class="kr">const</code> <code class="p">{</code><code class="nx">argv</code><code class="p">}</code> <code class="o">=</code> <code class="nx">yargs</code><code class="p">(</code><code class="nx">hideBin</code><code class="p">(</code><code class="nx">process</code><code class="p">.</code><code class="nx">argv</code><code class="p">));</code>
        
        <code class="k">if</code> <code class="p">(</code><code class="nx">argv</code><code class="p">.</code><code class="nx">food</code> <code class="o">===</code> <code class="s1">'pizza'</code><code class="p">)</code> <code class="p">{</code>
          <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'mmm'</code><code class="p">);</code>
        <code class="p">}</code></pre>
        
        <p>By using command-line arguments, you can utilize information passed at runtime and react accordingly. Yargs can handle a lot more than reading input values, such as configuring help commands, enabling Boolean input values, limiting values to predefined choices, and much more. I recommend consulting the <a href="https://github.com/yargs/yargs#documentation">Yargs documentation</a> for additional resources and <span class="keep-together">documentation</span>.<a data-type="indexterm" data-primary="" data-startref="ix_node_cli" id="idm45475123323544"></a><a data-type="indexterm" data-primary="" data-startref="ix_cli_arg_node" id="idm45475123322600"></a></p>
        </div></section>
        
        
        
        
        
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect1" data-pdf-bookmark="Creating a Command-Line Utility with Help from Commander"><div class="sect1" id="idm45475123321528">
        <h1>Creating a Command-Line Utility with Help <span class="keep-together">from Commander</span></h1>
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45475123319992">
        <h2>Problem</h2>
        
        <p><a data-type="indexterm" data-primary="CLI (command-line interface) tools" data-secondary="utility using Commander module" id="ix_cli_node_commander"></a><a data-type="indexterm" data-primary="Node" data-secondary="command-line utility using Commander" id="ix_node_commander"></a>You want to turn your Node module into a Linux command-line utility, including support for command-line options/arguments.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45475123315896">
        <h2>Solution</h2>
        
        <p>To convert your Node module to a Linux command-line utility, add the following line as the first line of the module:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="c-Hashbang">#!/usr/bin/env node</code></pre>
        
        <p><a data-type="indexterm" data-primary="Commander module" id="idm45475123312328"></a><a data-type="indexterm" data-primary="modules" data-secondary="Commander" id="idm45475123311720"></a>To provide for command-line arguments/options, including the ever-important <code>--help</code>, make use of the Commander module:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="c-Hashbang">#!/usr/bin/env node</code>
        <code class="kr">const</code> <code class="nx">program</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'commander'</code><code class="p">);</code>
        
        <code class="nx">program</code>
          <code class="p">.</code><code class="nx">version</code><code class="p">(</code><code class="s1">'0.0.1'</code><code class="p">)</code>
          <code class="p">.</code><code class="nx">option</code><code class="p">(</code><code class="s1">'-n, --number &lt;value&gt;'</code><code class="p">,</code> <code class="s1">'A number to square'</code><code class="p">)</code>
          <code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">process</code><code class="p">.</code><code class="nx">argv</code><code class="p">);</code>
        
        <code class="kr">const</code> <code class="nx">square</code> <code class="o">=</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">pow</code><code class="p">(</code><code class="nx">program</code><code class="p">.</code><code class="nx">number</code><code class="p">,</code> <code class="mi">2</code><code class="p">);</code>
        
        <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`The square of </code><code class="si">${</code><code class="nx">program</code><code class="p">.</code><code class="nx">number</code><code class="si">}</code><code class="sb"> is </code><code class="si">${</code><code class="nx">square</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code></pre>
        <div data-type="note" epub:type="note"><h6>Note</h6>
        <p>In <a data-type="xref" href="#command-line">“Passing Command-Line Arguments”</a> we discuss using the Yargs module, which simplifies the use of handling command-line arguments. Yargs is a great option for handling command-line argument inputs, while Commander is a fully featured module for building command-line-driven applications. We recommend taking a look at both options and choosing the one that is right for your use case.</p>
        </div>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45475123219672">
        <h2>Discussion</h2>
        
        <p>To convert a Node module to a command-line utility, first add the following line to the module:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="c-Hashbang">#!/usr/bin/env node</code></pre>
        
        <p>Change the module file’s mode to an executable, using CHMOD:</p>
        
        <pre data-type="programlisting" data-code-language="bash"><code class="nv">$ </code>chmod a+x square.js</pre>
        
        <p>To run the above example, I would type the following in the terminal, from the project folder:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">$</code> <code class="p">.</code><code class="o">/</code><code class="nx">square</code><code class="p">.</code><code class="nx">js</code> <code class="o">-</code><code class="nx">n</code> <code class="mi">4</code></pre>
        
        <p>The command-line utility I created simply logs the square of a number. Let’s look at a more complete example, which would create an image capture of a website using the <a href="https://github.com/puppeteer/puppeteer">Puppeteer</a> library. In a file named <span class="keep-together"><em>snapshot.js</em></span>:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="c-Hashbang">#!/usr/bin/env node</code>
        <code class="kr">const</code> <code class="nx">program</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'commander'</code><code class="p">);</code>
        <code class="kr">const</code> <code class="nx">puppeteer</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'puppeteer'</code><code class="p">);</code>
        
        <code class="nx">program</code>
          <code class="p">.</code><code class="nx">version</code><code class="p">(</code><code class="s1">'0.0.1'</code><code class="p">)</code>
          <code class="p">.</code><code class="nx">option</code><code class="p">(</code><code class="s1">'-s, --source [website]'</code><code class="p">,</code> <code class="s1">'Source website'</code><code class="p">)</code>
          <code class="p">.</code><code class="nx">option</code><code class="p">(</code><code class="s1">'-f, --file [filename]'</code><code class="p">,</code> <code class="s1">'Filename'</code><code class="p">)</code>
          <code class="p">.</code><code class="nx">parse</code><code class="p">(</code><code class="nx">process</code><code class="p">.</code><code class="nx">argv</code><code class="p">);</code>
        
        <code class="p">(</code><code class="nx">async</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'capturing screenshot...'</code><code class="p">);</code>
          <code class="kr">const</code> <code class="nx">browser</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">puppeteer</code><code class="p">.</code><code class="nx">launch</code><code class="p">();</code>
          <code class="kr">const</code> <code class="nx">page</code> <code class="o">=</code> <code class="nx">await</code> <code class="nx">browser</code><code class="p">.</code><code class="nx">newPage</code><code class="p">();</code>
          <code class="nx">await</code> <code class="nx">page</code><code class="p">.</code><code class="kr">goto</code><code class="p">(</code><code class="nx">program</code><code class="p">.</code><code class="nx">source</code><code class="p">);</code>
          <code class="nx">await</code> <code class="nx">page</code><code class="p">.</code><code class="nx">screenshot</code><code class="p">({</code> <code class="nx">path</code><code class="o">:</code> <code class="nx">program</code><code class="p">.</code><code class="nx">file</code> <code class="p">});</code>
          <code class="nx">await</code> <code class="nx">browser</code><code class="p">.</code><code class="nx">close</code><code class="p">();</code>
          <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="sb">`captured screenshot at </code><code class="si">${</code><code class="nx">program</code><code class="p">.</code><code class="nx">file</code><code class="si">}</code><code class="sb">`</code><code class="p">);</code>
        <code class="p">})();</code></pre>
        
        <p>We can then update the <em>package.json</em> file so that our command can be named and used directly (without the <em>.js</em> extension):</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="s2">"main"</code><code class="o">:</code> <code class="s2">"snapshot.js"</code><code class="p">,</code>
        <code class="s2">"preferGlobal"</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
        <code class="s2">"bin"</code><code class="o">:</code> <code class="p">{</code>
          <code class="s2">"snapshot"</code><code class="o">:</code> <code class="s2">"snapshot.js"</code>
        <code class="p">},</code></pre>
        
        <p>Now if we run <code>npm link</code>, we can use the command directly on our local machine, without referencing the file directly:</p>
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">$</code> <code class="nx">snapshot</code> <code class="o">-</code><code class="nx">s</code> <code class="nx">http://oreilly.com -f test.png</code></pre>
        
        <p><a data-type="indexterm" data-primary="long option" id="idm45475122947720"></a>Or you can use the <em>long option</em>, consisting of a double-dash (<code>--</code>) followed by a complete word:</p>
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">$</code> <code class="nx">snapshot</code> <code class="o">--</code><code class="nx">source</code> <code class="nx">http://oreilly.com --file test.png</code></pre>
        
        <p>And when you run the utility with either <code>-h</code> or <code>--help</code>, you get:</p>
        
        <pre data-type="programlisting" data-code-language="javascript">  <code class="nx">Usage</code><code class="o">:</code> <code class="nx">snapshot</code> <code class="p">[</code><code class="nx">options</code><code class="p">]</code>
        
          <code class="nx">Options</code><code class="o">:</code>
        
            <code class="o">-</code><code class="nx">h</code><code class="p">,</code> <code class="o">--</code><code class="nx">help</code>              <code class="nx">output</code> <code class="nx">usage</code> <code class="nx">information</code>
            <code class="o">-</code><code class="nx">V</code><code class="p">,</code> <code class="o">--</code><code class="nx">version</code>           <code class="nx">output</code> <code class="nx">the</code> <code class="nx">version</code> <code class="nx">number</code>
            <code class="o">-</code><code class="nx">s</code><code class="p">,</code> <code class="o">--</code><code class="nx">source</code> <code class="p">[</code><code class="nx">website</code><code class="p">]</code>  <code class="nx">Source</code> <code class="nx">website</code>
            <code class="o">-</code><code class="nx">f</code><code class="p">,</code> <code class="o">--</code><code class="nx">file</code> <code class="p">[</code><code class="nx">filename</code><code class="p">]</code>   <code class="nx">Filename</code></pre>
        
        <p>Running the following returns the version:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">$</code> <code class="nx">snapshot</code> <code class="o">-</code><code class="nx">V</code></pre>
        
        <p>Commander generates all of this automatically, so we can focus on our utility’s primary functionality.<a data-type="indexterm" data-primary="" data-startref="ix_node_commander" id="idm45475122851128"></a><a data-type="indexterm" data-primary="" data-startref="ix_cli_node_commander" id="idm45475122850280"></a></p>
        
        <p>Publishing a command-line utility to the <code>npm</code> registry is the same as any other <span class="keep-together">module:</span></p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">$</code> <code class="nx">npm</code> <code class="nx">publish</code></pre>
        </div></section>
        
        
        
        
        
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect1" data-pdf-bookmark="Keeping a Node Instance Up and Running"><div class="sect1" id="keeping_node_up_running">
        <h1>Keeping a Node Instance Up and Running</h1>
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45475122844808">
        <h2>Problem</h2>
        
        <p><a data-type="indexterm" data-primary="Node" data-secondary="keeping Node instance up and running" id="ix_node_inst_run"></a>You’re in a production environment and want to start up a Node application, keep it running forever, and reload it without downtime.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45475122818904">
        <h2>Solution</h2>
        
        <p><a data-type="indexterm" data-primary="modules" data-secondary="pm2" id="ix_module_pm2"></a><a data-type="indexterm" data-primary="pm2 module" id="ix_pm2_module"></a>Use the <code>pm2</code> module to ensure the application is restarted if it’s ever shut down:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">$</code> <code class="nx">pm2</code> <code class="nx">start</code> <code class="nx">index</code><code class="p">.</code><code class="nx">js</code></pre>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45475122838392">
        <h2>Discussion</h2>
        
        <p><code>pm2</code> is a CLI tool that can be used to not only start a Node application, but to ensure the application is restarted if, for some reason, it’s shut down.</p>
        
        <p>Install <code>pm2</code> using npm:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">$</code> <code class="nx">sudo</code> <code class="nx">npm</code> <code class="nx">install</code> <code class="nx">pm2</code> <code class="o">-</code><code class="nx">g</code></pre>
        
        <p>Then start your Node application, making use of <code>pm2</code>:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">$</code> <code class="nx">pm2</code> <code class="nx">start</code> <code class="nx">index</code><code class="p">.</code><code class="nx">js</code></pre>
        
        <p>The <code>start</code> action starts the Node application as a Unix <em>daemon</em> or background process. The utility can also make use of a number of options, which can all be listed with the <code>pm2 --help</code> command. A few that are particularly useful:</p>
        <dl>
        <dt><code>-l</code></dt>
        <dd>
        <p>Create a log file</p>
        </dd>
        <dt><code>-o</code></dt>
        <dd>
        <p>Log stdout from the script to the specified output file</p>
        </dd>
        <dt><code>-e</code></dt>
        <dd>
        <p>Log stderr from the script to the specified error file</p>
        </dd>
        <dt><code>-n</code></dt>
        <dd>
        <p>Name the application</p>
        </dd>
        <dt><code>--watch</code></dt>
        <dd>
        <p>Watch for changes and restart the application</p>
        </dd>
        </dl>
        
        <p>To start an application that includes these logs, use the flags and specify output files:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">$</code> <code class="nx">pm2</code> <code class="nx">start</code>  <code class="o">-</code><code class="nx">l</code> <code class="nx">forever</code><code class="p">.</code><code class="nx">log</code> <code class="o">-</code><code class="nx">o</code> <code class="nx">out</code><code class="p">.</code><code class="nx">log</code> <code class="o">-</code><code class="nx">e</code> <code class="nx">err</code><code class="p">.</code><code class="nx">log</code> <code class="o">-</code><code class="nx">n</code> <code class="nx">app_name</code> <code class="nx">index</code><code class="p">.</code><code class="nx">js</code> <code class="o">--</code><code class="nx">watch</code></pre>
        
        <p>Some other helpful <code>pm2</code> actions are:</p>
        <dl>
        <dt><code>stop</code></dt>
        <dd>
        <p>Stop the daemon script</p>
        </dd>
        <dt><code>restart</code></dt>
        <dd>
        <p>Restart the daemon script</p>
        </dd>
        <dt><code>delete</code></dt>
        <dd>
        <p>Delete the daemon script</p>
        </dd>
        <dt><code>describe</code></dt>
        <dd>
        <p>Retrieve the details of a specific application</p>
        </dd>
        <dt><code>list</code></dt>
        <dd>
        <p>List all running scripts</p>
        </dd>
        <dt><code>monitor</code></dt>
        <dd>
        <p>Monitor logs, metrics, and application information</p>
        </dd>
        </dl>
        
        <p>It can be very helpful to add an npm script to a project’s <em>package.json</em> file to run the <code>pm2</code> command:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="s2">"scripts"</code><code class="o">:</code> <code class="p">{</code>
            <code class="s2">"start"</code><code class="o">:</code> <code class="s2">"pm2 start index.js"</code><code class="p">,</code>
        <code class="p">}</code></pre>
        
        <p>With this addition, running <code>npm start</code> from the project’s root directory will start the application using <code>pm2</code>. As an added bonus, this is often the default behavior of many Node application cloud hosting platforms.<a data-type="indexterm" data-primary="" data-startref="ix_node_inst_run" id="idm45475122627608"></a><a data-type="indexterm" data-primary="" data-startref="ix_pm2_module" id="idm45475122625112"></a><a data-type="indexterm" data-primary="" data-startref="ix_module_pm2" id="idm45475122624168"></a></p>
        </div></section>
        
        
        
        
        
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect1" data-pdf-bookmark="Monitoring Application Changes and Restarting During Local Development"><div class="sect1" id="idm45475122837800">
        <h1>Monitoring Application Changes and Restarting During Local Development</h1>
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Problems"><div class="sect2" id="idm45475122622248">
        <h2>Problems</h2>
        
        <p><a data-type="indexterm" data-primary="Node" data-secondary="restarting app during local development" id="ix_node_restart_app"></a>Development can get rather active, and it can be difficult to remember or time-consuming to restart an application each time the code has changed.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45475122619288">
        <h2>Solution</h2>
        
        <p><a data-type="indexterm" data-primary="nodemon utility" id="ix_nodemon_utility"></a>Use the <code>nodemon</code> utility to watch your source code and restart your application when the code changes.</p>
        
        <p>To use, first install <code>nodemon</code>:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">$</code> <code class="nx">npm</code> <code class="nx">install</code> <code class="o">-</code><code class="nx">g</code> <code class="nx">nodemon</code></pre>
        
        <p>Instead of starting the application with <code>node</code>, use <code>nodemon</code> instead:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">$</code> <code class="nx">nodemon</code> <code class="nx">index</code><code class="p">.</code><code class="nx">js</code></pre>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45475122583608">
        <h2>Discussion</h2>
        
        <p>The <code>nodemon</code> utility monitors the files within the directory where it was started. If any of the files change, the Node application is automatically restarted. This is a handy way of making sure your running Node application reflects the most recent code changes.</p>
        
        <p>Generally, <code>nodemon</code> is not a tool you want to use in a production system. Instead, use a process manager such as <code>pm2</code>, as discussed in <a data-type="xref" href="#keeping_node_up_running">“Keeping a Node Instance Up and Running”</a>.</p>
        
        <p>If the application accepts values when started, you can provide these on the command line, just as with Node, but precede them with the double dashes (<code>--</code>) flag, which signals to <code>nodemon</code> to ignore anything that follows and pass it to the <span class="keep-together">application:</span></p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">$</code> <code class="nx">nodemon</code> <code class="nx">index</code><code class="p">.</code><code class="nx">js</code> <code class="o">--</code> <code class="o">-</code><code class="nx">param1</code> <code class="o">-</code><code class="nx">param2</code></pre>
        
        <p>When started, you should get feedback similar to the following:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="p">[</code><code class="nx">nodemon</code><code class="p">]</code> <code class="mf">2.0</code><code class="p">.</code><code class="mi">2</code>
        <code class="p">[</code><code class="nx">nodemon</code><code class="p">]</code> <code class="nx">to</code> <code class="nx">restart</code> <code class="nx">at</code> <code class="nx">any</code> <code class="nx">time</code><code class="p">,</code> <code class="nx">enter</code> <code class="sb">`rs`</code>
        <code class="p">[</code><code class="nx">nodemon</code><code class="p">]</code> <code class="nx">watching</code> <code class="nx">dir</code><code class="p">(</code><code class="nx">s</code><code class="p">)</code><code class="o">:</code> <code class="o">*</code><code class="p">.</code><code class="o">*</code>
        <code class="p">[</code><code class="nx">nodemon</code><code class="p">]</code> <code class="nx">watching</code> <code class="nx">extensions</code><code class="o">:</code> <code class="nx">js</code><code class="p">,</code><code class="nx">mjs</code><code class="p">,</code><code class="nx">json</code>
        <code class="p">[</code><code class="nx">nodemon</code><code class="p">]</code> <code class="nx">starting</code> <code class="sb">`node index.js`</code>
        <code class="nx">Listening</code> <code class="nx">on</code> <code class="nx">port</code> <code class="mi">8124</code></pre>
        
        <p>If the code changes, you’ll see something similar to the following:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="p">[</code><code class="nx">nodemon</code><code class="p">]</code> <code class="nx">restarting</code> <code class="nx">due</code> <code class="nx">to</code> <code class="nx">changes</code><code class="p">...</code>
        <code class="p">[</code><code class="nx">nodemon</code><code class="p">]</code> <code class="nx">starting</code> <code class="sb">`node index.js`</code>
        <code class="nx">Server</code> <code class="nx">running</code> <code class="nx">on</code> <code class="mi">8124</code><code class="o">/</code></pre>
        
        <p>If you want to manually restart the application, type <code>rs</code> into the terminal where nodemon is running. You can also use a configuration file or <em>package.json</em> configuration with the utility, monitor only select files or subdirectories, and even use it to run non-Node applications.</p>
        
        <p>Here is a sample <em>package.json</em> configuration, which will instruct <code>nodemon</code> to use <code>verbose</code> mode and ignore specific directories:<a data-type="indexterm" data-primary="" data-startref="ix_node_restart_app" id="idm45475122341576"></a><a data-type="indexterm" data-primary="" data-startref="ix_nodemon_utility" id="idm45475122340600"></a></p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="p">{</code>
          <code class="s2">"nodemonConfig"</code><code class="o">:</code> <code class="p">{</code>
            <code class="s2">"verbose"</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
            <code class="s2">"ignore"</code><code class="o">:</code> <code class="p">[</code><code class="s2">"__tests__/*"</code><code class="p">,</code> <code class="s2">"docs/*"</code><code class="p">],</code>
          <code class="p">}</code>
        <code class="p">}</code></pre>
        </div></section>
        
        
        
        
        
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect1" data-pdf-bookmark="Scheduling Repeat Tasks"><div class="sect1" id="running-tasks">
        <h1>Scheduling Repeat Tasks</h1>
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45475122321496">
        <h2>Problem</h2>
        
        <p><a data-type="indexterm" data-primary="scheduling repeat tasks in Node" id="ix_sched_node"></a><a data-type="indexterm" data-primary="Node" data-secondary="scheduling repeat tasks" id="ix_node_sched_repeat"></a>You have a task that needs to be run repeatedly at specific intervals.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45475122317784">
        <h2>Solution</h2>
        
        <p><a data-type="indexterm" data-primary="node-cron module" id="ix_node-cron"></a>Use <a href="https://oreil.ly/dYQHv"><code>node-cron</code></a>, which enables you to schedule tasks in Node using the GNU crontab syntax.</p>
        
        <p>The following will log to the console every minute:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">cron</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'node-cron'</code><code class="p">);</code>
        
        <code class="nx">cron</code><code class="p">.</code><code class="nx">schedule</code><code class="p">(</code><code class="s1">'* * * * *'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Log to the console every minute'</code><code class="p">);</code>
        <code class="p">});</code></pre>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45475122275768">
        <h2>Discussion</h2>
        
        <p>To use the <code>node-cron</code> module, first install it with npm:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">$</code> <code class="nx">npm</code> <code class="nx">install</code> <code class="nx">node</code><code class="o">-</code><code class="nx">cron</code></pre>
        
        <p>You can then use the <code>schedule</code> method along with the crontab syntax to create a scheduled task.</p>
        
        <p>The crontab syntax can be a bit confusing if you have never encountered it before. In the above example, I’ve used an asterisk for each field, which stands for “first-last.” We can replace the asterisks with the following values (in order):</p>
        
        <ul>
        <li>
        <p>second (optional): 0–59</p>
        </li>
        <li>
        <p>minute:	0–59</p>
        </li>
        <li>
        <p>hour:	0–23</p>
        </li>
        <li>
        <p>day of month:	0–31</p>
        </li>
        <li>
        <p>month:	0–12 (or three-letter names)</p>
        </li>
        <li>
        <p>day of week:	0–7 (or three-letter names, 0 or 7 is Sunday )</p>
        </li>
        </ul>
        
        <p>The following will run at five minutes after midnight on the first day of every month:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">cron</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'node-cron'</code><code class="p">);</code>
        
        <code class="nx">cron</code><code class="p">.</code><code class="nx">schedule</code><code class="p">(</code><code class="s1">'5 0 1 * *'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'It is the first of the month!'</code><code class="p">);</code>
        <code class="p">});</code></pre>
        
        <p>We can also include ranges. The following will run a job at midnight, on each weekday from June through September:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kr">const</code> <code class="nx">cron</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'node-cron'</code><code class="p">);</code>
        
        <code class="nx">cron</code><code class="p">.</code><code class="nx">schedule</code><code class="p">(</code><code class="s1">'0 0 * 6-9 1-5'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Summer workdays'</code><code class="p">);</code>
        <code class="p">});</code></pre>
        
        <p><code>node-cron</code> accepts two options: <code>scheduled</code> and <code>timezone</code>. The following will run a job at midnight in the same time zone as New York City:</p>
        
        <pre data-type="programlisting" data-code-language="javascript"><code class="kd">var</code> <code class="nx">cron</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'node-cron'</code><code class="p">);</code>
        
        <code class="nx">cron</code><code class="p">.</code><code class="nx">schedule</code><code class="p">(</code><code class="s1">'0 0 * * *'</code><code class="p">,</code> <code class="p">()</code> <code class="o">=&gt;</code> <code class="p">{</code>
          <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Running a job at midnight '</code><code class="p">);</code>
        <code class="p">},</code> <code class="p">{</code>
          <code class="nx">scheduled</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
          <code class="nx">timezone</code><code class="o">:</code> <code class="s2">"America/New_York"</code>
        <code class="p">});</code></pre>
        
        <p><code>scheduled</code> is a Boolean value that defaults to <code>true</code>. Cron jobs will not run if the value is set to <code>false</code>. <code>timezone</code> allows you to set a specific time zone for the schedule. For all the time zone names, see the <a href="https://oreil.ly/VhAkl">Moment.js time zone page</a>.<a data-type="indexterm" data-primary="" data-startref="ix_node_sched_repeat" id="idm45475122074408"></a><a data-type="indexterm" data-primary="" data-startref="ix_node-cron" id="idm45475122073432"></a><a data-type="indexterm" data-primary="" data-startref="ix_sched_node" id="idm45475122072488"></a></p>
        </div></section>
        
        
        
        
        
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect1" data-pdf-bookmark="Testing the Performance and Capability of Your WebSockets Application"><div class="sect1" id="testing_performance_websocket_app">
        <h1>Testing the Performance and Capability of Your WebSockets Application</h1>
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Problem"><div class="sect2" id="idm45475122070280">
        <h2>Problem</h2>
        
        <p><a data-type="indexterm" data-primary="testing" data-secondary="WebSockets app" id="ix_test_websockets"></a><a data-type="indexterm" data-primary="WebSockets" id="ix_websockets2"></a><a data-type="indexterm" data-primary="Node" data-secondary="testing WebSockets app" id="ix_node_test_websoc"></a>You have an application that sends updated information on a frequent basis to every connected client, and you’re concerned about performance and how the application will handle the load.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Solution"><div class="sect2" id="idm45475122065080">
        <h2>Solution</h2>
        
        <p>You’ll want to perform both <em>speed (performance) tests</em> and <em>load testing</em>. See the discussion for details.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Discussion"><div class="sect2" id="idm45475122062696">
        <h2>Discussion</h2>
        
        <p><a data-type="indexterm" data-primary="bidirectional communication, client-server" id="idm45475122061096"></a><a data-type="indexterm" data-primary="client-server communication" data-secondary="bidirectional" id="idm45475122060360"></a>Thanks to Node and WebSockets and other bidirectional communication techniques, we no longer have to use timers in web pages to hit servers for new data. The server itself can push the data to all the connected clients whenever the data is fresh. The animated, scrolling timeline in <a data-type="xref" href="ch17.html#feeding_scrolling_timeline">Example&nbsp;17-4</a> demonstrates this type of application.</p>
        
        <p><a data-type="indexterm" data-primary="testing" data-secondary="Node speed and performance" id="idm45475122057848"></a><a data-type="indexterm" data-primary="speed testing, Node" id="idm45475122056808"></a><a data-type="indexterm" data-primary="performance testing, Node" id="idm45475122056136"></a>The question then becomes: yes, it’s cool, but what does the coolness cost? Is my server going to crash and burn once 10 (100/1,000/10,000) clients connect? Will all the clients get the same response? The only answer to these questions comes from two types of tests:</p>
        
        <ul>
        <li>
        <p>Speed or performance testing, which tests how fast the page loads, especially when the server is under stress</p>
        </li>
        <li>
        <p>Load testing that emulates many concurrent clients accessing the page at once</p>
        </li>
        </ul>
        
        <p><a data-type="indexterm" data-primary="testing" data-secondary="load testing" id="idm45475122052472"></a><a data-type="indexterm" data-primary="Load Impact" id="idm45475122051304"></a><a data-type="indexterm" data-primary="load testing, Node" id="idm45475122050632"></a>There are services that provide both types of testing, and if you’re a large commercial operation and the reliability and performance of your application are critical, I <span class="keep-together">definitely</span> recommend taking advantage of them. Some, like <a href="http://loadimpact.com">Load Impact</a>, even provide a decent trial of its product before committing. <a data-type="indexterm" data-primary="Selenium" id="idm45475122048296"></a>There are also tools you can use that will hit a page concurrently and then print out the load responses for each (or even graph it). <a href="http://seleniumhq.org">Selenium</a> is a very popular tool for performance testing.</p>
        
        <p>The Node world also provides tools we can install easily and quickly with npm. They may not have exactly the same polish as the commercial tools, but they’re certainly a lot cheaper. One tool to try is <code>loadtest</code>, which is an easier-to-run variation of ApacheBench (aka <code>ab</code>). You need to install it globally:</p>
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">$</code> <code class="nx">npm</code> <code class="nx">install</code> <code class="o">-</code><code class="nx">g</code> <code class="nx">loadtest</code></pre>
        
        <p>And then you run it from the command line. The following runs 200 requests per second (rps), with a concurrency of 10:</p>
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">$</code> <code class="nx">loadtest</code> <code class="o">-</code><code class="nx">c</code> <code class="mi">10</code> <code class="o">--</code><code class="nx">rps</code> <code class="mi">200</code> <code class="nx">http://mysite.com/</code></pre>
        
        <p><a data-type="indexterm" data-primary="ApacheBench" id="idm45475122009256"></a>There are several other options, and ApacheBench is also an alternative that can be good for performance testing. However, the tests don’t test the WebSockets connection because the request to the WebSockets server is contained in JavaScript that’s never processed.</p>
        
        <p><a data-type="indexterm" data-primary="Thor" id="idm45475122004456"></a>Another option is Thor, which is a load tester that’s run directly against the WebSocket server:</p>
        <pre data-type="programlisting" data-code-language="javascript"><code class="nx">$</code> <code class="nx">npm</code> <code class="nx">install</code> <code class="o">-</code><code class="nx">g</code> <code class="nx">thor</code>
        <code class="nx">$</code> <code class="nx">thor</code> <code class="o">--</code><code class="nx">amount</code> <code class="mi">5000</code> <code class="nx">ws://shelleystoybox.com:8001</code></pre>
        
        <p>This is an effective way of hammering (ahem) the WebSockets server with connections, but we’re still not getting the back and forth communication to <em>really</em> test the entire application, front and back. The connections are made, and then dropped as quickly, so it’s not really testing the communication as it exists if you and I were to access the application from our browsers. <a data-type="indexterm" data-primary="" data-startref="ix_websockets2" id="idm45475121972536"></a><a data-type="indexterm" data-primary="" data-startref="ix_node_test_websoc" id="idm45475121971800"></a><a data-type="indexterm" data-primary="" data-startref="ix_test_websockets" id="idm45475121970856"></a>However, used with other tests that actually access the client page and process the WebSockets connection, they can help us determine if performance is going to be an issue with that many demands for connections (note: the app held up).</p>
        </div></section>
        
        
        
        
        
        </div></section>
        
        
        
        
        
        
        
        </div></section></div></div><link rel="stylesheet" href="/files/public/epub-reader/override_v1.css" crossorigin="anonymous"><link rel="stylesheet" href="/api/v2/epubs/urn:orm:book:9781492055747/files/epub.css" crossorigin="anonymous"></div></div></section>
</div>

https://learning.oreilly.com