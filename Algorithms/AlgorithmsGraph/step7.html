<style>
    @font-face {
        font-family: Roboto;
        font-style: normal;
        font-weight: 300;
        src: url(https://static.contineljs.com/fonts/Roboto-Light.woff2) format("woff2"),
            url(https://static.contineljs.com/fonts/Roboto-Light.woff) format("woff");
    }

    @font-face {
        font-family: Roboto;
        font-style: normal;
        font-weight: 400;
        src: url(https://static.contineljs.com/fonts/Roboto-Regular.woff2) format("woff2"),
            url(https://static.contineljs.com/fonts/Roboto-Regular.woff) format("woff");
    }

    @font-face {
        font-family: Roboto;
        font-style: normal;
        font-weight: 500;
        src: url(https://static.contineljs.com/fonts/Roboto-Medium.woff2?v=2) format("woff2"),
            url(https://static.contineljs.com/fonts/Roboto-Medium.woff) format("woff");
    }

    @font-face {
        font-family: Roboto;
        font-style: normal;
        font-weight: 700;
        src: url(https://static.contineljs.com/fonts/Roboto-Bold.woff2) format("woff2"),
            url(https://static.contineljs.com/fonts/Roboto-Bold.woff) format("woff");
    }

    * {
        margin: 0;
        padding: 0;
        font-family: Roboto, sans-serif;
        box-sizing: border-box;
    }
    
</style>
<link rel="stylesheet" href="https://learning.oreilly.com/files/public/epub-reader/override_v1.css" crossorigin="anonymous"><link rel="stylesheet" href="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492092506/files/epub.css" crossorigin="anonymous">
<div style="width: 100%; display: flex; justify-content: center; background-color: black; color: wheat;">
    <section data-testid="contentViewer" class="contentViewer--KzjY1"><div class="annotatable--okKet"><div id="book-content"><div class="readerContainer--bZ89H white--bfCci" style="font-size: 1em; max-width: 70ch;"><div id="sbo-rt-content"><section data-type="chapter" epub:type="chapter" data-pdf-bookmark="Chapter 7. Graph Algorithms in Practice"><div class="chapter" id="graph_algos_practice_yelp">
        <h1><span class="label">Chapter 7. </span>Graph Algorithms in Practice</h1>
        
        
        <p><a data-type="indexterm" data-primary="graph algorithms (generally)" data-secondary="in practice" id="ix_ch07-adoc0"></a>The approach we take to graph analysis evolves as we become more familiar with the behavior of different algorithms on specific datasets.
        In this chapter, we’ll run through several examples to give you a better feeling for how to tackle large-scale graph data analysis using datasets from Yelp and the US Department of Transportation.
        We’ll walk through Yelp data analysis in Neo4j that includes a general overview of the data, combining algorithms to make trip recommendations, and mining user and business data for consulting. In Spark, we’ll look into US airline data to understand traffic patterns and delays as well as how airports are connected by different airlines.</p>
        
        <p>Because pathfinding algorithms are straightforward, our examples will use these centrality and community detection algorithms:</p>
        
        <ul>
        <li>
        <p>PageRank to find influential Yelp reviewers and then correlate their ratings for specific hotels</p>
        </li>
        <li>
        <p>Betweenness Centrality to uncover reviewers connected to multiple groups and then extract their preferences</p>
        </li>
        <li>
        <p>Label Propagation with a projection to create supercategories of similar Yelp businesses</p>
        </li>
        <li>
        <p>Degree Centrality to quickly identify airport hubs in the US transport dataset</p>
        </li>
        <li>
        <p>Strongly Connected Components to look at clusters of airport routes in the US</p>
        </li>
        </ul>
        
        
        
        
        
        
        <section data-type="sect1" class="pagebreak-before less_space" data-pdf-bookmark="Analyzing Yelp Data with Neo4j"><div class="sect1" id="idm46681364674808">
        <h1>Analyzing Yelp Data with Neo4j</h1>
        
        <p><a data-type="indexterm" data-primary="Neo4j" data-secondary="analyzing Yelp data with" data-seealso="Yelp dataset" id="ix_ch07-adoc1"></a><a data-type="indexterm" data-primary="Yelp dataset" data-secondary="analyzing with Neo4j" id="ix_ch07-adoc2"></a>Yelp helps people find local businesses based on reviews, preferences, and recommendations.
        Over 180 million reviews had been written on the platform as of the end of 2018.
        Since 2013, Yelp has run the <a href="https://bit.ly/3fCL6vG">Yelp Dataset challenge</a>, a competition that encourages people to explore and research Yelp’s open dataset.</p>
        
        <p>As of Round 12 (conducted in 2018) of the challenge, the open dataset contained:</p>
        
        <ul>
        <li>
        <p>Over 7 million reviews plus tips</p>
        </li>
        <li>
        <p>Over 1.5 million users and 280,000 pictures</p>
        </li>
        <li>
        <p>Over 188,000 businesses with 1.4 million attributes</p>
        </li>
        <li>
        <p>10 metropolitan areas</p>
        </li>
        </ul>
        
        <p>Since its launch, the dataset has become popular, with <a href="https://bit.ly/2upiaRz">hundreds of academic papers</a> written using this material.
        The Yelp dataset represents real data that is very well structured and highly interconnected.
        It’s a great showcase for graph algorithms that you can also download and explore.</p>
        <div data-type="warning" epub:type="warning"><h6>Warning</h6>
        <p>Yelp makes a subset of their data available for personal, educational, and academic purposes. The Yelp dataset is periodically updated which may make it necessary for you to alter how you load updated data and will likely alter some algorithm results.</p>
        </div>
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Yelp Social Network"><div class="sect2" id="yelp_social_network">
        <h2>Yelp Social Network</h2>
        
        <p><a data-type="indexterm" data-primary="Yelp dataset" data-secondary="social network" id="idm46681364660040"></a>As well as writing and reading reviews about businesses, users of Yelp form a social network.
        Users can send friend requests to other users they’ve come across while browsing Yelp.com, or they can connect their address books or Facebook graphs.</p>
        
        <p>The Yelp dataset also includes a social network.
        <a data-type="xref" href="#yelp_my_profile">Figure&nbsp;7-1</a> is a screen capture of the Friends section of Mark’s Yelp profile.</p>
        
        <p>Apart from the fact that Mark needs a few more friends, we’re ready to start. To illustrate how we might analyze Yelp data in Neo4j, we’ll use a scenario where we work for a travel information business. We’ll first explore the Yelp data, and then look at how to help people plan trips with our app. We will walk through finding good recommendations for places to stay and things to do in major cities like Las Vegas.</p>
        
        <p>Another part of our business scenario will involve consulting to travel-destination businesses. In one example we’ll help hotels identify influential visitors and then businesses that they should target for cross-promotion programs.</p>
        
        <figure><div id="yelp_my_profile" class="figure">
        <img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/gral_rr_0701.png" alt="gral rr 0701" width="994" height="479">
        <h6><span class="label">Figure 7-1. </span>Mark’s Yelp profile</h6>
        </div></figure>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Data Import"><div class="sect2" id="idm46681364653816">
        <h2>Data Import</h2>
        
        <p><a data-type="indexterm" data-primary="Yelp dataset" data-secondary="importing into Neo4j" id="idm46681364652616"></a>There are many different methods for importing data into Neo4j, including the <a href="https://bit.ly/2UTx26g">Import tool</a>, the <a href="https://bit.ly/2CCfcgR"><code>LOAD CSV</code> command</a> that we’ve seen in earlier chapters, and <a href="https://bit.ly/2JDAr7U">Neo4j drivers</a>.</p>
        
        <p>For the Yelp dataset we need to do a one-off import of a large amount of data, so the Import tool is the best choice.
        See <a data-type="xref" href="app01.html#yelp_data_import">“Neo4j Bulk Data Import and Yelp”</a> for more details.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Graph Model"><div class="sect2" id="idm46681364647224">
        <h2>Graph Model</h2>
        
        <p><a data-type="indexterm" data-primary="Yelp dataset" data-secondary="graph model" id="idm46681364645816"></a>The Yelp data is represented in a graph model as shown in <a data-type="xref" href="#yelp_graph_model">Figure&nbsp;7-2</a>.</p>
        
        <figure><div id="yelp_graph_model" class="figure">
        <img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/gral_0702.png" alt="gral 0702" width="3094" height="1070">
        <h6><span class="label">Figure 7-2. </span>The Yelp graph model</h6>
        </div></figure>
        
        <p>Our graph contains <code>User</code> labeled nodes, which have <code>FRIENDS</code> relationships with other <code>Users</code>.
        <code>Users</code> also write <code>Reviews</code> and tips about <code>Business</code>es.
        All of the metadata is stored as properties of nodes, except for business categories, which are represented by separate <code>Category</code> nodes.
        For location data we’ve extracted <code>City</code>, <code>Area</code>, and <code>Country</code> attributes into the subgraph.
        In other use cases it might make sense to extract other attributes to nodes such as dates, or collapse nodes to relationships such as reviews.</p>
        
        <p>The Yelp dataset also includes user tips and photos, but we won’t use those in our example.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="A Quick Overview of the Yelp Data"><div class="sect2" id="idm46681364635992">
        <h2>A Quick Overview of the Yelp Data</h2>
        
        <p><a data-type="indexterm" data-primary="Yelp dataset" data-secondary="overview" id="ix_ch07-adoc3"></a>Once we have the data loaded in Neo4j, we’ll execute some exploratory queries.
        We’ll ask how many nodes are in each category or what types of relations exist, to get a feel for the Yelp data.
        Previously we’ve shown Cypher queries for our Neo4j examples, but we might be executing these from another programming language.
        As Python is the go-to language for data scientists, we’ll use Neo4j’s Python driver in this section when we want to connect the results to other libraries from the Python ecosystem.
        If we just want to show the result of a query we’ll use Cypher directly.</p>
        
        <p><a data-type="indexterm" data-primary="pandas library" id="idm46681364631928"></a>We’ll also show how to combine Neo4j with the popular pandas library, which is effective for data wrangling outside of the database.
        <a data-type="indexterm" data-primary="matplotlib" id="idm46681364630952"></a>We’ll see how to use the tabulate library to prettify the results we get from pandas, and how to create visual representations of data using matplotlib.</p>
        
        <p><a data-type="indexterm" data-primary="Awesome Procedures on Cypher (APOC) library" id="idm46681364629720"></a>We’ll also be using Neo4j’s APOC library of procedures to help us write even more powerful Cypher queries.
        There’s more information about APOC in <a data-type="xref" href="app01.html#apoc_appendix">“APOC and Other Neo4j Tools”</a>.</p>
        
        <p>Let’s first install the Python libraries:</p>
        
        <pre data-type="programlisting" data-code-language="python"><code class="n">pip</code> <code class="n">install</code> <code class="n">neo4j</code> <code class="n">tabulate</code> <code class="n">pandas</code> <code class="n">matplotlib</code></pre>
        
        <p>Once we’ve done that we’ll import those libraries:</p>
        
        <pre data-type="programlisting" data-code-language="python"><code class="kn">from</code> <code class="nn">neo4j</code> <code class="kn">import</code> <code class="n">GraphDatabase</code>
        <code class="kn">import</code> <code class="nn">pandas</code> <code class="kn">as</code> <code class="nn">pd</code>
        <code class="kn">from</code> <code class="nn">tabulate</code> <code class="kn">import</code> <code class="n">tabulate</code></pre>
        
        <p>Importing matplotlib can be fiddly on macOS, but the following lines should do the trick:</p>
        
        <pre data-type="programlisting" data-code-language="python"><code class="kn">import</code> <code class="nn">matplotlib</code>
        <code class="n">matplotlib</code><code class="o">.</code><code class="n">use</code><code class="p">(</code><code class="s1">'TkAgg'</code><code class="p">)</code>
        <code class="kn">import</code> <code class="nn">matplotlib.pyplot</code> <code class="kn">as</code> <code class="nn">plt</code></pre>
        
        <p>If you’re running on another operating system, the middle line may not be required. Now let’s create an instance of the Neo4j driver pointing at a local Neo4j database:</p>
        
        <pre data-type="programlisting" data-code-language="python"><code class="n">driver</code> <code class="o">=</code> <code class="n">GraphDatabase</code><code class="o">.</code><code class="n">driver</code><code class="p">(</code><code class="s2">"bolt://localhost"</code><code class="p">,</code> <code class="n">auth</code><code class="o">=</code><code class="p">(</code><code class="s2">"neo4j"</code><code class="p">,</code> <code class="s2">"neo"</code><code class="p">))</code></pre>
        <div data-type="note" epub:type="note"><h6>Note</h6>
        <p>You’ll need to update the initialization of the driver to use your own host and credentials.</p>
        </div>
        
        <p>To get started, let’s look at some general numbers for nodes and relationships.
        The following code calculates the cardinalities of node labels (i.e., counts the number of nodes for each label) in the database:</p>
        
        <pre data-type="programlisting" data-code-language="python"><code class="n">result</code> <code class="o">=</code> <code class="p">{</code><code class="s2">"label"</code><code class="p">:</code> <code class="p">[],</code> <code class="s2">"count"</code><code class="p">:</code> <code class="p">[]}</code>
        <code class="k">with</code> <code class="n">driver</code><code class="o">.</code><code class="n">session</code><code class="p">()</code> <code class="k">as</code> <code class="n">session</code><code class="p">:</code>
            <code class="n">labels</code> <code class="o">=</code> <code class="p">[</code><code class="n">row</code><code class="p">[</code><code class="s2">"label"</code><code class="p">]</code> <code class="k">for</code> <code class="n">row</code> <code class="ow">in</code> <code class="n">session</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="s2">"CALL db.labels()"</code><code class="p">)]</code>
            <code class="k">for</code> <code class="n">label</code> <code class="ow">in</code> <code class="n">labels</code><code class="p">:</code>
                <code class="n">query</code> <code class="o">=</code> <code class="n">f</code><code class="s2">"MATCH (:`{label}`) RETURN count(*) as count"</code>
                <code class="n">count</code> <code class="o">=</code> <code class="n">session</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="n">query</code><code class="p">)</code><code class="o">.</code><code class="n">single</code><code class="p">()[</code><code class="s2">"count"</code><code class="p">]</code>
                <code class="n">result</code><code class="p">[</code><code class="s2">"label"</code><code class="p">]</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">label</code><code class="p">)</code>
                <code class="n">result</code><code class="p">[</code><code class="s2">"count"</code><code class="p">]</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">count</code><code class="p">)</code>
        
        <code class="n">df</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="n">data</code><code class="o">=</code><code class="n">result</code><code class="p">)</code>
        <code class="k">print</code><code class="p">(</code><code class="n">tabulate</code><code class="p">(</code><code class="n">df</code><code class="o">.</code><code class="n">sort_values</code><code class="p">(</code><code class="s2">"count"</code><code class="p">),</code> <code class="n">headers</code><code class="o">=</code><code class="s1">'keys'</code><code class="p">,</code>
                                      <code class="n">tablefmt</code><code class="o">=</code><code class="s1">'psql'</code><code class="p">,</code> <code class="n">showindex</code><code class="o">=</code><code class="bp">False</code><code class="p">))</code></pre>
        
        <p>If we run that code we’ll see how many nodes we have for each label:</p>
        <table style="width: 50%">
        
        <thead>
        <tr>
        <th>label</th>
        <th>count</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><p>Country</p></td>
        <td><p>17</p></td>
        </tr>
        <tr>
        <td><p>Area</p></td>
        <td><p>54</p></td>
        </tr>
        <tr>
        <td><p>City</p></td>
        <td><p>1093</p></td>
        </tr>
        <tr>
        <td><p>Category</p></td>
        <td><p>1293</p></td>
        </tr>
        <tr>
        <td><p>Business</p></td>
        <td><p>174567</p></td>
        </tr>
        <tr>
        <td><p>User</p></td>
        <td><p>1326101</p></td>
        </tr>
        <tr>
        <td><p>Review</p></td>
        <td><p>5261669</p></td>
        </tr>
        </tbody>
        </table>
        
        <p>We could also create a visual representation of the cardinalities, with the following code:</p>
        
        <pre data-type="programlisting" data-code-language="python"><code class="n">plt</code><code class="o">.</code><code class="n">style</code><code class="o">.</code><code class="n">use</code><code class="p">(</code><code class="s1">'fivethirtyeight'</code><code class="p">)</code>
        
        <code class="n">ax</code> <code class="o">=</code> <code class="n">df</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">kind</code><code class="o">=</code><code class="s1">'bar'</code><code class="p">,</code> <code class="n">x</code><code class="o">=</code><code class="s1">'label'</code><code class="p">,</code> <code class="n">y</code><code class="o">=</code><code class="s1">'count'</code><code class="p">,</code> <code class="n">legend</code><code class="o">=</code><code class="bp">None</code><code class="p">)</code>
        
        <code class="n">ax</code><code class="o">.</code><code class="n">xaxis</code><code class="o">.</code><code class="n">set_label_text</code><code class="p">(</code><code class="s2">""</code><code class="p">)</code>
        <code class="n">plt</code><code class="o">.</code><code class="n">yscale</code><code class="p">(</code><code class="s2">"log"</code><code class="p">)</code>
        <code class="n">plt</code><code class="o">.</code><code class="n">xticks</code><code class="p">(</code><code class="n">rotation</code><code class="o">=</code><code class="mi">45</code><code class="p">)</code>
        <code class="n">plt</code><code class="o">.</code><code class="n">tight_layout</code><code class="p">()</code>
        <code class="n">plt</code><code class="o">.</code><code class="n">show</code><code class="p">()</code></pre>
        
        <p>We can see the chart that gets generated by this code in <a data-type="xref" href="#node_cardinalities">Figure&nbsp;7-3</a>.
        Note that this chart is using log scale.</p>
        
        <figure class="width-75"><div id="node_cardinalities" class="figure">
        <img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/gral_rr_0703.png" alt="gral rr 0703" width="1338" height="977">
        <h6><span class="label">Figure 7-3. </span>The number of nodes for each label category</h6>
        </div></figure>
        
        <p>Similarly, we can calculate the cardinalities of relationships:</p>
        
        <pre data-type="programlisting" data-code-language="python"><code class="n">result</code> <code class="o">=</code> <code class="p">{</code><code class="s2">"relType"</code><code class="p">:</code> <code class="p">[],</code> <code class="s2">"count"</code><code class="p">:</code> <code class="p">[]}</code>
        <code class="k">with</code> <code class="n">driver</code><code class="o">.</code><code class="n">session</code><code class="p">()</code> <code class="k">as</code> <code class="n">session</code><code class="p">:</code>
            <code class="n">rel_types</code> <code class="o">=</code> <code class="p">[</code><code class="n">row</code><code class="p">[</code><code class="s2">"relationshipType"</code><code class="p">]</code> <code class="k">for</code> <code class="n">row</code> <code class="ow">in</code> <code class="n">session</code><code class="o">.</code><code class="n">run</code>
                                       <code class="p">(</code><code class="s2">"CALL db.relationshipTypes()"</code><code class="p">)]</code>
            <code class="k">for</code> <code class="n">rel_type</code> <code class="ow">in</code> <code class="n">rel_types</code><code class="p">:</code>
                <code class="n">query</code> <code class="o">=</code> <code class="n">f</code><code class="s2">"MATCH ()-[:`{rel_type}`]-&gt;() RETURN count(*) as count"</code>
                <code class="n">count</code> <code class="o">=</code> <code class="n">session</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="n">query</code><code class="p">)</code><code class="o">.</code><code class="n">single</code><code class="p">()[</code><code class="s2">"count"</code><code class="p">]</code>
                <code class="n">result</code><code class="p">[</code><code class="s2">"relType"</code><code class="p">]</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">rel_type</code><code class="p">)</code>
                <code class="n">result</code><code class="p">[</code><code class="s2">"count"</code><code class="p">]</code><code class="o">.</code><code class="n">append</code><code class="p">(</code><code class="n">count</code><code class="p">)</code>
        
        <code class="n">df</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">(</code><code class="n">data</code><code class="o">=</code><code class="n">result</code><code class="p">)</code>
        <code class="k">print</code><code class="p">(</code><code class="n">tabulate</code><code class="p">(</code><code class="n">df</code><code class="o">.</code><code class="n">sort_values</code><code class="p">(</code><code class="s2">"count"</code><code class="p">),</code> <code class="n">headers</code><code class="o">=</code><code class="s1">'keys'</code><code class="p">,</code>
                                      <code class="n">tablefmt</code><code class="o">=</code><code class="s1">'psql'</code><code class="p">,</code> <code class="n">showindex</code><code class="o">=</code><code class="bp">False</code><code class="p">))</code></pre>
        
        <p class="pagebreak-before">If we run that code we’ll see the number of each type of relationship:</p>
        <table style="width: 50%">
        
        <thead>
        <tr>
        <th>relType</th>
        <th>count</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><p>IN_COUNTRY</p></td>
        <td><p>54</p></td>
        </tr>
        <tr>
        <td><p>IN_AREA</p></td>
        <td><p>1154</p></td>
        </tr>
        <tr>
        <td><p>IN_CITY</p></td>
        <td><p>174566</p></td>
        </tr>
        <tr>
        <td><p>IN_CATEGORY</p></td>
        <td><p>667527</p></td>
        </tr>
        <tr>
        <td><p>WROTE</p></td>
        <td><p>5261669</p></td>
        </tr>
        <tr>
        <td><p>REVIEWS</p></td>
        <td><p>5261669</p></td>
        </tr>
        <tr>
        <td><p>FRIENDS</p></td>
        <td><p>10645356</p></td>
        </tr>
        </tbody>
        </table>
        
        <p>We can see a chart of the cardinalities in <a data-type="xref" href="#rel_cardinalities">Figure&nbsp;7-4</a>.
        As with the node cardinalities chart, this chart is using log scale.</p>
        
        <figure class="width-75"><div id="rel_cardinalities" class="figure">
        <img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/gral_rr_0704.png" alt="gral rr 0704" width="1338" height="974">
        <h6><span class="label">Figure 7-4. </span>The number of relationships by relationship type</h6>
        </div></figure>
        
        <p>These queries shouldn’t reveal anything surprising, but they’re useful to get a feel for what’s in the data.
        This also serves as a quick check that the data imported correctly.</p>
        
        <p class="pagebreak-before">We assume Yelp has many hotel reviews, but it makes sense to check before we focus on that sector.
        We can find out how many hotel businesses are in that data and how many reviews they have by running the following query:</p>
        
        <pre data-type="programlisting" data-code-language="cypher"><code class="k">MATCH</code><code class="n"> (category:Category {name: </code><code class="s2">"Hotels"</code><code class="n">})</code>
        <code class="k">RETURN </code><code class="n">size((category)&lt;-[:IN_CATEGORY]-()) </code><code class="k">AS </code><code class="n">businesses,</code>
        <code class="n">       size((:Review)-[:REVIEWS]-&gt;(:Business)-[:IN_CATEGORY]-&gt;</code>
        <code class="n">                                  (category)) </code><code class="k">AS </code><code class="n">reviews</code></pre>
        
        <p>Here’s the result:</p>
        <table>
        
        <thead>
        <tr>
        <th>businesses</th>
        <th>reviews</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><p>2683</p></td>
        <td><p>183759</p></td>
        </tr>
        </tbody>
        </table>
        
        <p>We have many businesses to work with, and a lot of reviews!<a data-type="indexterm" data-startref="ix_ch07-adoc3" id="idm46681364086552"></a>
        In the next section we’ll explore the data further with our business scenario.</p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Trip Planning App"><div class="sect2" id="idm46681364635080">
        <h2>Trip Planning App</h2>
        
        <p><a data-type="indexterm" data-primary="trip planning app" id="ix_ch07-adoc4"></a><a data-type="indexterm" data-primary="Yelp dataset" data-secondary="trip planning app" id="ix_ch07-adoc5"></a>To add well-liked recommendations to our app, we start by finding the most-rated hotels as a heuristic for popular choices for reservations.
        We can add how well they’ve been rated to understand the actual experience. To see the 10 most-reviewed hotels and plot their rating distributions, we use the following code:</p>
        
        <pre data-type="programlisting" data-code-language="python"><code class="n">query</code><code> </code><code class="o">=</code><code> </code><code class="s2">"""</code><code class="s2"> </code><a class="co" id="co_graph_algorithms_in_practice_CO1-1" href="#callout_graph_algorithms_in_practice_CO1-1"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/1.png" alt="1" width="12" height="12"></a><code class="s2">
        </code><code class="s2">MATCH (review:Review)-[:REVIEWS]-&gt;(business:Business),</code><code class="s2">
        </code><code class="s2">      (business)-[:IN_CATEGORY]-&gt;(category:Category {name: $category}),</code><code class="s2">
        </code><code class="s2">      (business)-[:IN_CITY]-&gt;(:City {name: $city})</code><code class="s2">
        </code><code class="s2">RETURN business.name AS business, collect(review.stars) AS allReviews</code><code class="s2">
        </code><code class="s2">ORDER BY size(allReviews) DESC</code><code class="s2">
        </code><code class="s2">LIMIT 10</code><code class="s2">
        </code><code class="s2">"""</code><code>
        </code><code>
        </code><code class="n">fig</code><code> </code><code class="o">=</code><code> </code><code class="n">plt</code><code class="o">.</code><code class="n">figure</code><code class="p">(</code><code class="p">)</code><code>
        </code><code class="n">fig</code><code class="o">.</code><code class="n">set_size_inches</code><code class="p">(</code><code class="mf">10.5</code><code class="p">,</code><code> </code><code class="mf">14.5</code><code class="p">)</code><code>
        </code><code class="n">fig</code><code class="o">.</code><code class="n">subplots_adjust</code><code class="p">(</code><code class="n">hspace</code><code class="o">=</code><code class="mf">0.4</code><code class="p">,</code><code> </code><code class="n">wspace</code><code class="o">=</code><code class="mf">0.4</code><code class="p">)</code><code>
        </code><code>
        </code><code class="k">with</code><code> </code><code class="n">driver</code><code class="o">.</code><code class="n">session</code><code class="p">(</code><code class="p">)</code><code> </code><code class="k">as</code><code> </code><code class="n">session</code><code class="p">:</code><code>
        </code><code>    </code><code class="n">params</code><code> </code><code class="o">=</code><code> </code><code class="p">{</code><code> </code><code class="s2">"</code><code class="s2">city</code><code class="s2">"</code><code class="p">:</code><code> </code><code class="s2">"</code><code class="s2">Las Vegas</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="s2">"</code><code class="s2">category</code><code class="s2">"</code><code class="p">:</code><code> </code><code class="s2">"</code><code class="s2">Hotels</code><code class="s2">"</code><code class="p">}</code><code>
        </code><code>    </code><code class="n">result</code><code> </code><code class="o">=</code><code> </code><code class="n">session</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="n">query</code><code class="p">,</code><code> </code><code class="n">params</code><code class="p">)</code><code>
        </code><code>    </code><code class="k">for</code><code> </code><code class="n">index</code><code class="p">,</code><code> </code><code class="n">row</code><code> </code><code class="ow">in</code><code> </code><code class="nb">enumerate</code><code class="p">(</code><code class="n">result</code><code class="p">)</code><code class="p">:</code><code>
        </code><code>        </code><code class="n">business</code><code> </code><code class="o">=</code><code> </code><code class="n">row</code><code class="p">[</code><code class="s2">"</code><code class="s2">business</code><code class="s2">"</code><code class="p">]</code><code>
        </code><code>        </code><code class="n">stars</code><code> </code><code class="o">=</code><code> </code><code class="n">pd</code><code class="o">.</code><code class="n">Series</code><code class="p">(</code><code class="n">row</code><code class="p">[</code><code class="s2">"</code><code class="s2">allReviews</code><code class="s2">"</code><code class="p">]</code><code class="p">)</code><code>
        </code><code>
        </code><code>        </code><code class="n">total</code><code> </code><code class="o">=</code><code> </code><code class="n">stars</code><code class="o">.</code><code class="n">count</code><code class="p">(</code><code class="p">)</code><code>
        </code><code>        </code><code class="n">average_stars</code><code> </code><code class="o">=</code><code> </code><code class="n">stars</code><code class="o">.</code><code class="n">mean</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">round</code><code class="p">(</code><code class="mi">2</code><code class="p">)</code><code>
        </code><code>
        </code><code>        </code><code class="n">stars_histogram</code><code> </code><code class="o">=</code><code> </code><code class="n">stars</code><code class="o">.</code><code class="n">value_counts</code><code class="p">(</code><code class="p">)</code><code class="o">.</code><code class="n">sort_index</code><code class="p">(</code><code class="p">)</code><code> </code><a class="co" id="co_graph_algorithms_in_practice_CO1-2" href="#callout_graph_algorithms_in_practice_CO1-2"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/2.png" alt="2" width="12" height="12"></a><code>
        </code><code>        </code><code class="n">stars_histogram</code><code> </code><code class="o">/</code><code class="o">=</code><code> </code><code class="nb">float</code><code class="p">(</code><code class="n">stars_histogram</code><code class="o">.</code><code class="n">sum</code><code class="p">(</code><code class="p">)</code><code class="p">)</code><code>
        </code><code>
        </code><code>        </code><code class="n">ax</code><code> </code><code class="o">=</code><code> </code><code class="n">fig</code><code class="o">.</code><code class="n">add_subplot</code><code class="p">(</code><code class="mi">5</code><code class="p">,</code><code> </code><code class="mi">2</code><code class="p">,</code><code> </code><code class="n">index</code><code class="o">+</code><code class="mi">1</code><code class="p">)</code><code> </code><a class="co" id="co_graph_algorithms_in_practice_CO1-3" href="#callout_graph_algorithms_in_practice_CO1-3"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/3.png" alt="3" width="12" height="12"></a><code>
        </code><code>        </code><code class="n">stars_histogram</code><code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">kind</code><code class="o">=</code><code class="s2">"</code><code class="s2">bar</code><code class="s2">"</code><code class="p">,</code><code> </code><code class="n">legend</code><code class="o">=</code><code class="bp">None</code><code class="p">,</code><code> </code><code class="n">color</code><code class="o">=</code><code class="s2">"</code><code class="s2">darkblue</code><code class="s2">"</code><code class="p">,</code><code>
        </code><code>                             </code><code class="n">title</code><code class="o">=</code><code class="n">f</code><code class="s2">"</code><code class="s2">{business}</code><code class="se">\n</code><code class="s2">Ave:</code><code>
        </code><code>                                     </code><code class="p">{</code><code class="n">average_stars</code><code class="p">}</code><code class="p">,</code><code> </code><code class="n">Total</code><code class="p">:</code><code> </code><code class="p">{</code><code class="n">total</code><code class="p">}</code><code class="s2">"</code><code class="s2">)</code><code>
        </code><code>
        </code><code class="n">plt</code><code class="o">.</code><code class="n">tight_layout</code><code class="p">(</code><code class="p">)</code><code>
        </code><code class="n">plt</code><code class="o">.</code><code class="n">show</code><code class="p">(</code><code class="p">)</code></pre>
        <dl class="calloutlist">
        <dt><a class="co" id="callout_graph_algorithms_in_practice_CO1-1" href="#co_graph_algorithms_in_practice_CO1-1"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/1.png" alt="1" width="12" height="12"></a></dt>
        <dd><p>Find the 10 hotels with the most reviews.</p></dd>
        <dt><a class="co" id="callout_graph_algorithms_in_practice_CO1-2" href="#co_graph_algorithms_in_practice_CO1-2"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/2.png" alt="2" width="12" height="12"></a></dt>
        <dd><p>Calculate the star distribution.</p></dd>
        <dt><a class="co" id="callout_graph_algorithms_in_practice_CO1-3" href="#co_graph_algorithms_in_practice_CO1-3"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/3.png" alt="3" width="12" height="12"></a></dt>
        <dd><p>Plot a bar chart showing the distribution of star ratings.</p></dd>
        </dl>
        
        <p>We’ve constrained by city and category to focus on Las Vegas hotels.
        We run that code we get the chart in <a data-type="xref" href="#hotel_ratings">Figure&nbsp;7-5</a>. Note that the x-axis represents the hotel’s star rating and the y-axis represents the overall percentage of each rating.</p>
        
        <p>These hotels have more reviews than anyone would likely read. It would be better to show users relevant reviews and make them more prominent on our app. For this analysis, we’ll move from basic graph exploration to using graph algorithms.</p>
        
        <figure class="pagebreak-before"><div id="hotel_ratings" class="figure">
        <img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/gral_rr_0705.png" alt="gral rr 0705" width="1396" height="1944">
        <h6><span class="label">Figure 7-5. </span>The 10 most-reviewed hotels, with the number of stars on the x-axis and their overall rating percentage on the y-axis</h6>
        </div></figure>
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect3" data-pdf-bookmark="Finding influential hotel reviewers"><div class="sect3" id="idm46681363597944">
        <h3>Finding influential hotel reviewers</h3>
        
        <p><a data-type="indexterm" data-primary="Yelp dataset" data-secondary="finding influential hotel reviewers" id="ix_ch07-adoc6"></a>One way we can decide which reviews to feature is by ordering reviews based on the <em>influence of the reviewer</em> on Yelp. We’ll run the <a data-type="indexterm" data-primary="PageRank" data-secondary="with Yelp dataset" id="ix_ch07-adoc7"></a>PageRank algorithm over the projected graph of all users that have reviewed at least three hotels.
        Remember from earlier chapters that a projection can help filter out inessential information as well as add relationship data (sometimes inferred).
        We’ll use Yelp’s friend graph (introduced in <a data-type="xref" href="#yelp_social_network">“Yelp Social Network”</a>) as the relationships between users.
        The PageRank algorithm will uncover those reviewers with more sway over more users, even if they are not direct friends.</p>
        <div data-type="note" epub:type="note"><h6>Note</h6>
        <p>If two people are Yelp friends there are two <code>FRIENDS</code> relationships between them.
        For example, if A and B are friends there will be a <code>FRIENDS</code> relationship from A to B and another from B to A.</p>
        </div>
        
        <p>We need to write a query that projects a subgraph of users with more than three reviews and then executes the PageRank algorithm over that projected subgraph.</p>
        
        <p>It’s easier to understand how the subgraph projection works with a small example.
        <a data-type="xref" href="#friends_of_yelp">Figure&nbsp;7-6</a> shows a graph of three mutual friends—Mark, Arya, and Praveena.
        Mark and Praveena have both reviewed three hotels and will be part of the projected graph.
        Arya, on the other hand, has only reviewed one hotel and will therefore be excluded from the projection.</p>
        
        <figure><div id="friends_of_yelp" class="figure">
        <img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/gral_0706.png" alt="gral 0706" width="4545" height="2476">
        <h6><span class="label">Figure 7-6. </span>A sample Yelp graph</h6>
        </div></figure>
        
        <p>Our projected graph will only include Mark and Praveena, as shown in <a data-type="xref" href="#mark_praveena">Figure&nbsp;7-7</a>.</p>
        
        <figure><div id="mark_praveena" class="figure">
        <img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/gral_rr_0707.png" alt="gral rr 0707" width="1442" height="406">
        <h6><span class="label">Figure 7-7. </span>Our sample projected graph</h6>
        </div></figure>
        
        <p>Now that we’ve seen how graph projections work, let’s move forward. The following query executes the PageRank algorithm over our projected graph and stores the result in the <code>hotelPageRank</code> property on each node:</p>
        
        <pre data-type="programlisting" data-code-language="cypher"><code class="n">CALL gds.pageRank.write({</code>
        <code class="n">  nodeQuery: </code><code class="s1">'MATCH (u:User)-[:WROTE]-&gt;()-[:REVIEWS]-&gt;(b),</code>
        <code class="s1">                    (b)-[:IN_CATEGORY]-&gt;(:Category {name: $category})</code>
        <code class="s1">              WITH u, count(*) AS reviews</code>
        <code class="s1">              WHERE reviews &gt;= $cutOff</code>
        <code class="s1">              RETURN id(u) AS id'</code><code class="n">,</code>
        <code class="n">  relationshipQuery: </code><code class="s1">'MATCH (u1:User)-[:WROTE]-&gt;()-[:REVIEWS]-&gt;(b),</code>
        <code class="s1">                            (b)-[:IN_CATEGORY]-&gt;(:Category {name: $category})</code>
        <code class="s1">                      MATCH (u1)-[:FRIENDS]-&gt;(u2)</code>
        <code class="s1">                      RETURN id(u1) AS source, id(u2) AS target'</code><code class="n">,</code>
        <code class="n">  writeProperty: </code><code class="s2">"hotelPageRank"</code><code class="n">,</code>
        <code class="n">  validateRelationships: </code><code class="no">false</code><code class="n">,</code>
        <code class="n">  parameters: {category: </code><code class="s2">"Hotels"</code><code class="n">, cutOff: 3}</code>
        <code class="n">})</code>
        <code class="n">YIELD nodePropertiesWritten, createMillis, computeMillis,</code>
        <code class="n">      writeMillis, ranIterations</code>
        <code class="k">RETURN </code><code class="n">nodePropertiesWritten, createMillis, computeMillis,</code>
        <code class="n">       writeMillis, ranIterations;</code></pre>
        
        <p>You might have noticed that we didn’t set the damping factor or maximum iteration limit discussed in <a data-type="xref" href="ch05.html#centrality_algorithms">Chapter&nbsp;5</a>.
        If not explicitly set, Neo4j defaults to a <code>0.85</code> damping factor with <code>maxIterations</code> set to 20`.</p>
        
        <p>If we run this query, we’ll see the following output:</p>
        <table>
        
        <thead>
        <tr>
        <th>nodePropertiesWritten</th>
        <th>createMillis</th>
        <th>computeMillis</th>
        <th>writeMillis</th>
        <th>ranIterations</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><p>10195</p></td>
        <td><p>7507</p></td>
        <td><p>610</p></td>
        <td><p>168</p></td>
        <td><p>20</p></td>
        </tr>
        </tbody>
        </table>
        
        <p>The <code>hotelPageRank</code> has been added to just over 10,000 users.
        Now let’s look at the distribution of the PageRank values so we’ll know how to filter our data:</p>
        
        <pre data-type="programlisting" data-code-language="cypher"><code class="k">MATCH</code><code class="n"> (u:User)</code>
        <code class="k">WHERE </code><code class="n">exists(u.hotelPageRank)</code>
        <code class="k">RETURN </code><code class="nf">count</code><code class="n">(u.hotelPageRank) </code><code class="k">AS </code><code class="nf">count</code><code class="n">,</code>
        <code class="n">       </code><code class="nf">avg</code><code class="n">(u.hotelPageRank) </code><code class="k">AS </code><code class="n">ave,</code>
        <code class="n">       apoc.math.</code><code class="nf">round</code><code class="n">(percentileDisc(u.hotelPageRank, 0.5), 2) </code><code class="k">AS</code><code class="n"> `50%`,</code>
        <code class="n">       apoc.math.</code><code class="nf">round</code><code class="n">(percentileDisc(u.hotelPageRank, 0.75), 2) </code><code class="k">AS</code><code class="n"> `75%`,</code>
        <code class="n">       apoc.math.</code><code class="nf">round</code><code class="n">(percentileDisc(u.hotelPageRank, 0.90), 2) </code><code class="k">AS</code><code class="n"> `90%`,</code>
        <code class="n">       apoc.math.</code><code class="nf">round</code><code class="n">(percentileDisc(u.hotelPageRank, 0.95), 2) </code><code class="k">AS</code><code class="n"> `95%`,</code>
        <code class="n">       apoc.math.</code><code class="nf">round</code><code class="n">(percentileDisc(u.hotelPageRank, 0.99), 2) </code><code class="k">AS</code><code class="n"> `99%`,</code>
        <code class="n">       apoc.math.</code><code class="nf">round</code><code class="n">(percentileDisc(u.hotelPageRank, 0.999), 2) </code><code class="k">AS</code><code class="n"> `99.9%`,</code>
        <code class="n">       apoc.math.</code><code class="nf">round</code><code class="n">(percentileDisc(u.hotelPageRank, 0.9999), 2) </code><code class="k">AS</code><code class="n"> `99.99%`,</code>
        <code class="n">       apoc.math.</code><code class="nf">round</code><code class="n">(percentileDisc(u.hotelPageRank, 0.99999), 2) </code><code class="k">AS</code><code class="n"> `99.999%`,</code>
        <code class="n">       apoc.math.</code><code class="nf">round</code><code class="n">(percentileDisc(u.hotelPageRank, 1), 2) </code><code class="k">AS</code><code class="n"> `100%`;</code></pre>
        
        <p>If we run that query we’ll get this output:</p>
        <table>
        
        <thead>
        <tr>
        <th>count</th>
        <th>ave</th>
        <th>50%</th>
        <th>75%</th>
        <th>90%</th>
        <th>95%</th>
        <th>99%</th>
        <th>99.9%</th>
        <th>99.99%</th>
        <th>99.999%</th>
        <th>100%</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><p>10195</p></td>
        <td><p>0.7513906938612781</p></td>
        <td><p>0.27</p></td>
        <td><p>0.65</p></td>
        <td><p>1.67</p></td>
        <td><p>2.8</p></td>
        <td><p>7.71</p></td>
        <td><p>17.48</p></td>
        <td><p>25.1</p></td>
        <td><p>26.26</p></td>
        <td><p>26.26</p></td>
        </tr>
        </tbody>
        </table>
        
        <p>To interpret this percentile table, the 90% value of 1.67 means that 90% of users had a lower PageRank score.
        99.99% reflects the influence rank for the top 0.01% of reviewers and 100% is simply the highest PageRank score.</p>
        
        <p>It’s interesting that 50% of the users have a score of under 0.27, which is slightly lower than the overall average—and only marginally more than the 0.15 that they are initialized with by the PageRank algorithm.
        It seems like this data reflects a power-law distribution with a few very influential reviewers.</p>
        
        <p>Because we want to find only the most influential users, we’ll write a query based on the PageRank score of the top 1,000 users.
        The following query finds reviewers with a PageRank score <em>higher</em> than 1.67 (notice that’s the 99% group):</p>
        
        <pre data-type="programlisting" data-code-language="cypher"><code class="k">MATCH</code><code class="n"> </code><code class="n">(</code><code class="n">u</code><code class="n">:</code><code class="n">U</code><code class="n">s</code><code class="n">e</code><code class="n">r</code><code class="n">)</code><code class="n">
        </code><code class="k">WHERE </code><code class="n">u</code><code class="n">.</code><code class="n">h</code><code class="n">o</code><code class="n">t</code><code class="n">e</code><code class="n">l</code><code class="n">P</code><code class="n">a</code><code class="n">g</code><code class="n">e</code><code class="n">R</code><code class="n">a</code><code class="n">n</code><code class="n">k</code><code class="n"> </code><code class="n">&gt;</code><code class="n"> </code><code class="n"> </code><code class="n">1</code><code class="n">.</code><code class="n">6</code><code class="n">7</code><code class="n"> </code><a class="co" id="co_graph_algorithms_in_practice_CO2-1" href="#callout_graph_algorithms_in_practice_CO2-1"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/1.png" alt="1" width="12" height="12"></a><code class="n">
        </code><code class="n">
        </code><code class="k">WITH </code><code class="n">u</code><code class="n"> </code><code class="k">ORDER </code><code class="k">BY </code><code class="n">u</code><code class="n">.</code><code class="n">h</code><code class="n">o</code><code class="n">t</code><code class="n">e</code><code class="n">l</code><code class="n">P</code><code class="n">a</code><code class="n">g</code><code class="n">e</code><code class="n">R</code><code class="n">a</code><code class="n">n</code><code class="n">k</code><code class="n"> </code><code class="k">DESC </code><a class="co" id="co_graph_algorithms_in_practice_CO2-2" href="#callout_graph_algorithms_in_practice_CO2-2"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/2.png" alt="2" width="12" height="12"></a><code class="k">
        </code><code class="k">LIMIT </code><code class="n">1</code><code class="n">0</code><code class="n">
        </code><code class="n">
        </code><code class="k">RETURN </code><code class="n">u</code><code class="n">.</code><code class="n">n</code><code class="n">a</code><code class="n">m</code><code class="n">e</code><code class="n"> </code><code class="k">AS </code><code class="n">n</code><code class="n">a</code><code class="n">m</code><code class="n">e</code><code class="n">,</code><code class="n">
        </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n">u</code><code class="n">.</code><code class="n">h</code><code class="n">o</code><code class="n">t</code><code class="n">e</code><code class="n">l</code><code class="n">P</code><code class="n">a</code><code class="n">g</code><code class="n">e</code><code class="n">R</code><code class="n">a</code><code class="n">n</code><code class="n">k</code><code class="n"> </code><code class="k">AS </code><code class="n">p</code><code class="n">a</code><code class="n">g</code><code class="n">e</code><code class="n">R</code><code class="n">a</code><code class="n">n</code><code class="n">k</code><code class="n">,</code><code class="n">
        </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n">s</code><code class="n">i</code><code class="n">z</code><code class="n">e</code><code class="n">(</code><code class="n">(</code><code class="n">u</code><code class="n">)</code><code class="n">-</code><code class="n">[</code><code class="n">:</code><code class="n">W</code><code class="n">R</code><code class="n">O</code><code class="n">T</code><code class="n">E</code><code class="n">]</code><code class="n">-</code><code class="n">&gt;</code><code class="n">(</code><code class="n">)</code><code class="n">-</code><code class="n">[</code><code class="n">:</code><code class="n">R</code><code class="n">E</code><code class="n">V</code><code class="n">I</code><code class="n">E</code><code class="n">W</code><code class="n">S</code><code class="n">]</code><code class="n">-</code><code class="n">&gt;</code><code class="n">(</code><code class="n">)</code><code class="n">-</code><code class="n">[</code><code class="n">:</code><code class="n">I</code><code class="n">N</code><code class="n">_</code><code class="n">C</code><code class="n">A</code><code class="n">T</code><code class="n">E</code><code class="n">G</code><code class="n">O</code><code class="n">R</code><code class="n">Y</code><code class="n">]</code><code class="n">-</code><code class="n">&gt;</code><code class="n">
        </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n">(</code><code class="n">:</code><code class="n">C</code><code class="n">a</code><code class="n">t</code><code class="n">e</code><code class="n">g</code><code class="n">o</code><code class="n">r</code><code class="n">y</code><code class="n"> </code><code class="n">{</code><code class="n">n</code><code class="n">a</code><code class="n">m</code><code class="n">e</code><code class="n">:</code><code class="n"> </code><code class="s2">"Hotels"</code><code class="n">}</code><code class="n">)</code><code class="n">)</code><code class="n"> </code><code class="k">AS </code><code class="n">h</code><code class="n">o</code><code class="n">t</code><code class="n">e</code><code class="n">l</code><code class="n">R</code><code class="n">e</code><code class="n">v</code><code class="n">i</code><code class="n">e</code><code class="n">w</code><code class="n">s</code><code class="n">,</code><code class="n">
        </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n">s</code><code class="n">i</code><code class="n">z</code><code class="n">e</code><code class="n">(</code><code class="n">(</code><code class="n">u</code><code class="n">)</code><code class="n">-</code><code class="n">[</code><code class="n">:</code><code class="n">W</code><code class="n">R</code><code class="n">O</code><code class="n">T</code><code class="n">E</code><code class="n">]</code><code class="n">-</code><code class="n">&gt;</code><code class="n">(</code><code class="n">)</code><code class="n">)</code><code class="n"> </code><code class="k">AS </code><code class="n">t</code><code class="n">o</code><code class="n">t</code><code class="n">a</code><code class="n">l</code><code class="n">R</code><code class="n">e</code><code class="n">v</code><code class="n">i</code><code class="n">e</code><code class="n">w</code><code class="n">s</code><code class="n">,</code><code class="n">
        </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n">s</code><code class="n">i</code><code class="n">z</code><code class="n">e</code><code class="n">(</code><code class="n">(</code><code class="n">u</code><code class="n">)</code><code class="n">-</code><code class="n">[</code><code class="n">:</code><code class="n">F</code><code class="n">R</code><code class="n">I</code><code class="n">E</code><code class="n">N</code><code class="n">D</code><code class="n">S</code><code class="n">]</code><code class="n">-</code><code class="n">(</code><code class="n">)</code><code class="n">)</code><code class="n"> </code><code class="k">AS </code><code class="n">f</code><code class="n">r</code><code class="n">i</code><code class="n">e</code><code class="n">n</code><code class="n">d</code><code class="n">s</code><code class="n">;</code></pre>
        <dl class="calloutlist">
        <dt><a class="co" id="callout_graph_algorithms_in_practice_CO2-1" href="#co_graph_algorithms_in_practice_CO2-1"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/1.png" alt="1" width="12" height="12"></a></dt>
        <dd><p>Only find users that have a <code>hotelPageRank</code> score in the top 1,000 users.</p></dd>
        <dt><a class="co" id="callout_graph_algorithms_in_practice_CO2-2" href="#co_graph_algorithms_in_practice_CO2-2"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/2.png" alt="2" width="12" height="12"></a></dt>
        <dd><p>Find the top 10 of those users.</p></dd>
        </dl>
        
        <p>If we run that query we’ll get the results seen here:</p>
        <table class="less_space pagebreak-before">
        
        <thead>
        <tr>
        <th>name</th>
        <th>pageRank</th>
        <th>hotelReviews</th>
        <th>totalReviews</th>
        <th>friends</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><p>Phil</p></td>
        <td><p>26.258416866464536</p></td>
        <td><p>15</p></td>
        <td><p>134</p></td>
        <td><p>8154</p></td>
        </tr>
        <tr>
        <td><p>Philip</p></td>
        <td><p>25.095720199332572</p></td>
        <td><p>21</p></td>
        <td><p>620</p></td>
        <td><p>9634</p></td>
        </tr>
        <tr>
        <td><p>Cassandra</p></td>
        <td><p>19.118613678961992</p></td>
        <td><p>3</p></td>
        <td><p>23</p></td>
        <td><p>7148</p></td>
        </tr>
        <tr>
        <td><p>Carol</p></td>
        <td><p>18.455617765896026</p></td>
        <td><p>6</p></td>
        <td><p>119</p></td>
        <td><p>6218</p></td>
        </tr>
        <tr>
        <td><p>Abby</p></td>
        <td><p>18.014389160706198</p></td>
        <td><p>9</p></td>
        <td><p>82</p></td>
        <td><p>7922</p></td>
        </tr>
        <tr>
        <td><p>Joseph</p></td>
        <td><p>18.008178111561577</p></td>
        <td><p>5</p></td>
        <td><p>32</p></td>
        <td><p>6596</p></td>
        </tr>
        <tr>
        <td><p>Erica</p></td>
        <td><p>17.693355155712922</p></td>
        <td><p>6</p></td>
        <td><p>15</p></td>
        <td><p>7071</p></td>
        </tr>
        <tr>
        <td><p>J</p></td>
        <td><p>17.663379741786045</p></td>
        <td><p>103</p></td>
        <td><p>1322</p></td>
        <td><p>6498</p></td>
        </tr>
        <tr>
        <td><p>Misti</p></td>
        <td><p>17.638867230992766</p></td>
        <td><p>19</p></td>
        <td><p>730</p></td>
        <td><p>6230</p></td>
        </tr>
        <tr>
        <td><p>Randy</p></td>
        <td><p>17.519849820295345</p></td>
        <td><p>21</p></td>
        <td><p>125</p></td>
        <td><p>7846</p></td>
        </tr>
        </tbody>
        </table>
        
        <p>These results show us that Phil is the most credible reviewer, although he hasn’t reviewed many hotels.
        He’s likely connected to some very influential people, but if we wanted a stream of new reviews, his profile wouldn’t be the best selection.
        Philip has a slightly lower score, but has the most friends and has written five times more reviews than Phil.
        While J has written the most reviews of all and has a reasonable number of friends, J’s PageRank score isn’t the highest—but it’s still in the top 10.
        For our app we choose to highlight hotel reviews from Phil, Philip, and J to give us the right mix of influencers and number of reviews.</p>
        
        <p>Now that we’ve improved our in-app recommendations with relevant reviews, let’s turn to the other side of our business: consulting.<a data-type="indexterm" data-startref="ix_ch07-adoc7" id="idm46681363192200"></a></p>
        </div></section>
        
        
        
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Travel Business Consulting"><div class="sect2" id="idm46681363597000">
        <h2>Travel Business Consulting</h2>
        
        <p><a data-type="indexterm" data-primary="Yelp dataset" data-secondary="travel business consulting" id="ix_ch07-adoc8"></a>As part of our consulting service, hotels subscribe to be alerted when an influential visitor writes about their stay so they can take any necessary action. First, we’ll look at ratings of the Bellagio, sorted by the most influential reviewers:</p>
        
        <pre data-type="programlisting" data-code-language="python"><code class="n">query</code> <code class="o">=</code> <code class="s2">"""</code><code class="se">\</code>
        <code class="s2">MATCH (b:Business {name: $hotel})</code>
        <code class="s2">MATCH (b)&lt;-[:REVIEWS]-(review)&lt;-[:WROTE]-(user)</code>
        <code class="s2">WHERE exists(user.hotelPageRank)</code>
        <code class="s2">RETURN user.name AS name,</code>
        <code class="s2">       user.hotelPageRank AS pageRank,</code>
        <code class="s2">       review.stars AS stars</code>
        <code class="s2">"""</code>
        
        <code class="k">with</code> <code class="n">driver</code><code class="o">.</code><code class="n">session</code><code class="p">()</code> <code class="k">as</code> <code class="n">session</code><code class="p">:</code>
            <code class="n">params</code> <code class="o">=</code> <code class="p">{</code> <code class="s2">"hotel"</code><code class="p">:</code> <code class="s2">"Bellagio Hotel"</code> <code class="p">}</code>
            <code class="n">df</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">([</code><code class="nb">dict</code><code class="p">(</code><code class="n">record</code><code class="p">)</code> <code class="k">for</code> <code class="n">record</code> <code class="ow">in</code> <code class="n">session</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="n">query</code><code class="p">,</code> <code class="n">params</code><code class="p">)])</code>
            <code class="n">df</code> <code class="o">=</code> <code class="n">df</code><code class="o">.</code><code class="n">round</code><code class="p">(</code><code class="mi">2</code><code class="p">)</code>
            <code class="n">df</code> <code class="o">=</code> <code class="n">df</code><code class="p">[[</code><code class="s2">"name"</code><code class="p">,</code> <code class="s2">"pageRank"</code><code class="p">,</code> <code class="s2">"stars"</code><code class="p">]]</code>
        
        <code class="n">top_reviews</code> <code class="o">=</code> <code class="n">df</code><code class="o">.</code><code class="n">sort_values</code><code class="p">(</code><code class="n">by</code><code class="o">=</code><code class="p">[</code><code class="s2">"pageRank"</code><code class="p">],</code> <code class="n">ascending</code><code class="o">=</code><code class="bp">False</code><code class="p">)</code><code class="o">.</code><code class="n">head</code><code class="p">(</code><code class="mi">10</code><code class="p">)</code>
        <code class="k">print</code><code class="p">(</code><code class="n">tabulate</code><code class="p">(</code><code class="n">top_reviews</code><code class="p">,</code> <code class="n">headers</code><code class="o">=</code><code class="s1">'keys'</code><code class="p">,</code> <code class="n">tablefmt</code><code class="o">=</code><code class="s1">'psql'</code><code class="p">,</code> <code class="n">showindex</code><code class="o">=</code><code class="bp">False</code><code class="p">))</code></pre>
        
        <p>If we run that code we’ll get this output:</p>
        <table>
        
        <thead>
        <tr>
        <th>name</th>
        <th>pageRank</th>
        <th>stars</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><p>Erica</p></td>
        <td><p>17.69</p></td>
        <td><p>4</p></td>
        </tr>
        <tr>
        <td><p>J</p></td>
        <td><p>17.66</p></td>
        <td><p>5</p></td>
        </tr>
        <tr>
        <td><p>Misti</p></td>
        <td><p>17.64</p></td>
        <td><p>5</p></td>
        </tr>
        <tr>
        <td><p>Michael</p></td>
        <td><p>17.37</p></td>
        <td><p>4</p></td>
        </tr>
        <tr>
        <td><p>Christine</p></td>
        <td><p>15.84</p></td>
        <td><p>4</p></td>
        </tr>
        <tr>
        <td><p>Jeremy</p></td>
        <td><p>14.94</p></td>
        <td><p>5</p></td>
        </tr>
        <tr>
        <td><p>Connie</p></td>
        <td><p>14.6</p></td>
        <td><p>5</p></td>
        </tr>
        <tr>
        <td><p>Joyce</p></td>
        <td><p>11.76</p></td>
        <td><p>4</p></td>
        </tr>
        <tr>
        <td><p>Henry</p></td>
        <td><p>10.89</p></td>
        <td><p>5</p></td>
        </tr>
        <tr>
        <td><p>Flora</p></td>
        <td><p>10.34</p></td>
        <td><p>4</p></td>
        </tr>
        </tbody>
        </table>
        
        <p>Note that these results are different from our previous table of the best hotel reviewers. That’s because here we are only looking at reviewers that have rated the Bellagio.</p>
        
        <p>Things are looking good for the hotel customer service team at the Bellagio—the top 10 influencers all give their hotel good rankings.
        They may want to encourage these people to visit again and share their experiences.</p>
        
        <p>Are there any influential guests who haven’t had such a good experience?
        We can run the following code to find the guests with the highest PageRank that rated their experience with fewer than four stars:</p>
        
        <pre data-type="programlisting" data-code-language="python"><code class="n">query</code> <code class="o">=</code> <code class="s2">"""</code><code class="se">\</code>
        <code class="s2">MATCH (b:Business {name: $hotel})</code>
        <code class="s2">MATCH (b)&lt;-[:REVIEWS]-(review)&lt;-[:WROTE]-(user)</code>
        <code class="s2">WHERE exists(user.hotelPageRank) AND review.stars &lt; $goodRating</code>
        <code class="s2">RETURN user.name AS name,</code>
        <code class="s2">       user.hotelPageRank AS pageRank,</code>
        <code class="s2">       review.stars AS stars</code>
        <code class="s2">"""</code>
        
        <code class="k">with</code> <code class="n">driver</code><code class="o">.</code><code class="n">session</code><code class="p">()</code> <code class="k">as</code> <code class="n">session</code><code class="p">:</code>
            <code class="n">params</code> <code class="o">=</code> <code class="p">{</code> <code class="s2">"hotel"</code><code class="p">:</code> <code class="s2">"Bellagio Hotel"</code><code class="p">,</code> <code class="s2">"goodRating"</code><code class="p">:</code> <code class="mi">4</code> <code class="p">}</code>
            <code class="n">df</code> <code class="o">=</code> <code class="n">pd</code><code class="o">.</code><code class="n">DataFrame</code><code class="p">([</code><code class="nb">dict</code><code class="p">(</code><code class="n">record</code><code class="p">)</code> <code class="k">for</code> <code class="n">record</code> <code class="ow">in</code> <code class="n">session</code><code class="o">.</code><code class="n">run</code><code class="p">(</code><code class="n">query</code><code class="p">,</code> <code class="n">params</code><code class="p">)])</code>
            <code class="n">df</code> <code class="o">=</code> <code class="n">df</code><code class="o">.</code><code class="n">round</code><code class="p">(</code><code class="mi">2</code><code class="p">)</code>
            <code class="n">df</code> <code class="o">=</code> <code class="n">df</code><code class="p">[[</code><code class="s2">"name"</code><code class="p">,</code> <code class="s2">"pageRank"</code><code class="p">,</code> <code class="s2">"stars"</code><code class="p">]]</code>
        
        <code class="n">top_reviews</code> <code class="o">=</code> <code class="n">df</code><code class="o">.</code><code class="n">sort_values</code><code class="p">(</code><code class="n">by</code><code class="o">=</code><code class="p">[</code><code class="s2">"pageRank"</code><code class="p">],</code> <code class="n">ascending</code><code class="o">=</code><code class="bp">False</code><code class="p">)</code><code class="o">.</code><code class="n">head</code><code class="p">(</code><code class="mi">10</code><code class="p">)</code>
        <code class="k">print</code><code class="p">(</code><code class="n">tabulate</code><code class="p">(</code><code class="n">top_reviews</code><code class="p">,</code> <code class="n">headers</code><code class="o">=</code><code class="s1">'keys'</code><code class="p">,</code> <code class="n">tablefmt</code><code class="o">=</code><code class="s1">'psql'</code><code class="p">,</code> <code class="n">showindex</code><code class="o">=</code><code class="bp">False</code><code class="p">))</code></pre>
        
        <p>If we run that code we’ll get the following results:</p>
        <table>
        
        <thead>
        <tr>
        <th>name</th>
        <th>pageRank</th>
        <th>stars</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><p>Chris</p></td>
        <td><p>8.89</p></td>
        <td><p>3</p></td>
        </tr>
        <tr>
        <td><p>Lorrie</p></td>
        <td><p>7.46</p></td>
        <td><p>2</p></td>
        </tr>
        <tr>
        <td><p>Victor</p></td>
        <td><p>5.66</p></td>
        <td><p>3</p></td>
        </tr>
        <tr>
        <td><p>Dani</p></td>
        <td><p>5.54</p></td>
        <td><p>1</p></td>
        </tr>
        <tr>
        <td><p>Francine</p></td>
        <td><p>4.3</p></td>
        <td><p>3</p></td>
        </tr>
        <tr>
        <td><p>Rex</p></td>
        <td><p>3.96</p></td>
        <td><p>2</p></td>
        </tr>
        <tr>
        <td><p>Jon</p></td>
        <td><p>3.77</p></td>
        <td><p>3</p></td>
        </tr>
        <tr>
        <td><p>Stephen</p></td>
        <td><p>3.75</p></td>
        <td><p>2</p></td>
        </tr>
        <tr>
        <td><p>Pasquale</p></td>
        <td><p>3.6</p></td>
        <td><p>2</p></td>
        </tr>
        <tr>
        <td><p>Rachel</p></td>
        <td><p>3.58</p></td>
        <td><p>3</p></td>
        </tr>
        </tbody>
        </table>
        
        <p>Our highest-ranked users giving the Bellagio lower ratings, Chris and Lorrie, are amongst the top 1,000 most influential users (as per the results of our earlier query), so perhaps a personal outreach is warranted.<a data-type="indexterm" data-startref="ix_ch07-adoc8" id="idm46681362676520"></a>
        Also, because many reviewers write during their stay, real-time alerts about influencers may facilitate even more positive interactions<a data-type="indexterm" data-startref="ix_ch07-adoc6" id="idm46681362675528"></a>.<a data-type="indexterm" data-startref="ix_ch07-adoc5" id="idm46681362674728"></a><a data-type="indexterm" data-startref="ix_ch07-adoc4" id="idm46681362674024"></a></p>
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect3" data-pdf-bookmark="Bellagio cross-promotion"><div class="sect3" id="idm46681362673224">
        <h3>Bellagio cross-promotion</h3>
        
        <p><a data-type="indexterm" data-primary="Yelp dataset" data-secondary="Bellagio cross-promotion" id="ix_ch07-adoc9"></a>After we helped them find influential reviewers, the Bellagio has now asked us to help identify other businesses for cross-promotion with help from well-connected customers.
        In our scenario, we recommend that they increase their customer base by attracting new guests from different types of communities as a greenfield opportunity.
        <a data-type="indexterm" data-primary="Betweenness Centrality algorithm" data-secondary="with Yelp dataset" id="ix_ch07-adoc10"></a>We can use the Betweenness Centrality algorithm that we discussed earlier to work out which Bellagio reviewers are not only well connected across the whole Yelp network, but might also act as a bridge between different groups.</p>
        
        <p>We’re only interested in finding influencers in Las Vegas, so we’ll first tag those users:</p>
        
        <pre data-type="programlisting" data-code-language="cypher"><code class="k">MATCH</code><code class="n"> (u:User)</code>
        <code class="k">WHERE </code><code class="n">exists((u)-[:WROTE]-&gt;()-[:REVIEWS]-&gt;()-[:IN_CITY]-&gt;</code>
        <code class="n">                              (:City {name: </code><code class="s2">"Las Vegas"</code><code class="n">}))</code>
        <code class="k">SET </code><code class="n">u:LasVegas;</code></pre>
        
        <p><a data-type="indexterm" data-primary="Approximate Betweenness Centrality" id="idm46681362611064"></a>It would take a long time to run the Betweenness Centrality algorithm over our Las Vegas users, so instead we’ll use the the RA-Brandes variant.
        This algorithm calculates a betweenness score by sampling nodes and only exploring shortest paths to a certain depth.</p>
        
        <p>After some experimentation, we improved results with a few parameters set differently than the default values. We’ll use shortest paths of up to 4 hops (<code>maxDepth</code> of <code>4</code>) and sample 20% of the nodes (<code>probability</code> of <code>0.2</code>). Note that increasing the number of hops and nodes will generally increase the accuracy, but at the cost of more time to compute the results. For any particular problem, the optimal parameters typically require testing to identify the point of diminishing returns.</p>
        
        <p>The following query will execute the algorithm and store the result in the <code>between</code> property:</p>
        
        <pre data-type="programlisting" data-code-language="cypher"><code class="n">CALL gds.alpha.betweenness.sampled.write({</code>
        <code class="n">  nodeProjection: </code><code class="s2">"LasVegas"</code><code class="n">,</code>
        <code class="n">  relationshipProjection: </code><code class="s2">"FRIENDS"</code><code class="n">,</code>
        <code class="n">  maxDepth: 4,</code>
        <code class="n">  probability: 0.2,</code>
        <code class="n">  writeProperty: </code><code class="s2">"between"</code><code class="n"></code>
        <code class="n">})</code>
        <code class="n">YIELD </code><code class="nf">nodes</code><code class="n">, minCentrality, maxCentrality, sumCentrality</code>
        <code class="k">RETURN </code><code class="nf">nodes</code><code class="n">, minCentrality, maxCentrality, sumCentrality;</code></pre>
        
        <p>This query will take a while to run, but once it’s finished we’ll see the following output:</p>
        <table>
        
        <thead>
        <tr>
        <th>nodes</th>
        <th>minCentrality</th>
        <th>maxCentrality</th>
        <th>sumCentrality</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><p>506028</p></td>
        <td><p>0.0</p></td>
        <td><p>1980034772.4726186</p></td>
        <td><p>162296447142.80072</p></td>
        </tr>
        </tbody>
        </table>
        
        <p>Before we use these scores in our queries, let’s write a quick exploratory query to see how the scores are distributed:</p>
        
        <pre data-type="programlisting" data-code-language="cypher"><code class="k">MATCH</code><code class="n"> (u:User)</code>
        <code class="k">WHERE </code><code class="n">exists(u.between)</code>
        <code class="k">RETURN </code><code class="nf">count</code><code class="n">(u.between) </code><code class="k">AS </code><code class="nf">count</code><code class="n">,</code>
        <code class="n">       </code><code class="nf">avg</code><code class="n">(u.between) </code><code class="k">AS </code><code class="n">ave,</code>
        <code class="n">       toInteger(percentileDisc(u.between, 0.5)) </code><code class="k">AS</code><code class="n"> `50%`,</code>
        <code class="n">       toInteger(percentileDisc(u.between, 0.75)) </code><code class="k">AS</code><code class="n"> `75%`,</code>
        <code class="n">       toInteger(percentileDisc(u.between, 0.90)) </code><code class="k">AS</code><code class="n"> `90%`,</code>
        <code class="n">       toInteger(percentileDisc(u.between, 0.95)) </code><code class="k">AS</code><code class="n"> `95%`,</code>
        <code class="n">       toInteger(percentileDisc(u.between, 0.99)) </code><code class="k">AS</code><code class="n"> `99%`,</code>
        <code class="n">       toInteger(percentileDisc(u.between, 0.999)) </code><code class="k">AS</code><code class="n"> `99.9%`,</code>
        <code class="n">       toInteger(percentileDisc(u.between, 0.9999)) </code><code class="k">AS</code><code class="n"> `99.99%`,</code>
        <code class="n">       toInteger(percentileDisc(u.between, 1)) </code><code class="k">AS </code><code class="n">p100;</code></pre>
        
        <p>If we run that query we’ll see the following output:</p>
        <table>
        
        <thead>
        <tr>
        <th>count</th>
        <th>ave</th>
        <th>50%</th>
        <th>75%</th>
        <th>90%</th>
        <th>95%</th>
        <th>99%</th>
        <th>99.9%</th>
        <th>99.99%</th>
        <th>100%</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><p>506028</p></td>
        <td><p>320726.21898944734</p></td>
        <td><p>0</p></td>
        <td><p>9960</p></td>
        <td><p>316822</p></td>
        <td><p>1010165</p></td>
        <td><p>4418317</p></td>
        <td><p>35294323</p></td>
        <td><p>214059045</p></td>
        <td><p>1980034772</p></td>
        </tr>
        </tbody>
        </table>
        
        <p>Half of our users have a score of 0, meaning they are not well connected at all.
        The top 1 percentile (99% column) are on at least 4 million shortest paths between our set of 500,000 users.
        Considered together, we know that most of our users are poorly connected, but a few exert a lot of control over information; this is a classic behavior of small-world networks.</p>
        
        <p>We can find out who our superconnectors are by running the following query:</p>
        
        <pre data-type="programlisting" data-code-language="cypher"><code class="k">MATCH</code><code class="n"> (u:User)-[:WROTE]-&gt;()-[:REVIEWS]-&gt;(:Business {name:</code><code class="s2">"Bellagio Hotel"</code><code class="n">})</code>
        <code class="k">WHERE </code><code class="n">exists(u.between)</code>
        <code class="k">RETURN </code><code class="n">u.name </code><code class="k">AS </code><code class="n">user,</code>
        <code class="n">       toInteger(u.between) </code><code class="k">AS </code><code class="n">betweenness,</code>
        <code class="n">       u.hotelPageRank </code><code class="k">AS </code><code class="n">pageRank,</code>
        <code class="n">       size((u)-[:WROTE]-&gt;()-[:REVIEWS]-&gt;()-[:IN_CATEGORY]-&gt;</code>
        <code class="n">                             (:Category {name: </code><code class="s2">"Hotels"</code><code class="n">}))</code>
        <code class="n">       </code><code class="k">AS </code><code class="n">hotelReviews</code>
        <code class="k">ORDER BY </code><code class="n">u.between </code><code class="k">DESC</code>
        <code class="k">LIMIT </code><code class="n">10;</code></pre>
        
        <p>The output is as follows:</p>
        <table>
        
        <thead>
        <tr>
        <th>user</th>
        <th>betweenness</th>
        <th>pageRank</th>
        <th>hotelReviews</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><p>Misti</p></td>
        <td><p>840712928</p></td>
        <td><p>17.638867230992766</p></td>
        <td><p>19</p></td>
        </tr>
        <tr>
        <td><p>Christine</p></td>
        <td><p>241898939</p></td>
        <td><p>15.836424705456013</p></td>
        <td><p>16</p></td>
        </tr>
        <tr>
        <td><p>Erica</p></td>
        <td><p>235666410</p></td>
        <td><p>17.693355155712922</p></td>
        <td><p>6</p></td>
        </tr>
        <tr>
        <td><p>Mike</p></td>
        <td><p>215417753</p></td>
        <td><p>NULL</p></td>
        <td><p>2</p></td>
        </tr>
        <tr>
        <td><p>J</p></td>
        <td><p>189802203</p></td>
        <td><p>17.663379741786045</p></td>
        <td><p>103</p></td>
        </tr>
        <tr>
        <td><p>Michael</p></td>
        <td><p>162077742</p></td>
        <td><p>7.693667471793014</p></td>
        <td><p>31</p></td>
        </tr>
        <tr>
        <td><p>Jeremy</p></td>
        <td><p>159790780</p></td>
        <td><p>14.941242662875448</p></td>
        <td><p>6</p></td>
        </tr>
        <tr>
        <td><p>Michael</p></td>
        <td><p>143599018</p></td>
        <td><p>17.371501608518887</p></td>
        <td><p>13</p></td>
        </tr>
        <tr>
        <td><p>Chris</p></td>
        <td><p>138279165</p></td>
        <td><p>8.889553494018038</p></td>
        <td><p>5</p></td>
        </tr>
        <tr>
        <td><p>Connie</p></td>
        <td><p>132470615</p></td>
        <td><p>14.597890720120633</p></td>
        <td><p>7</p></td>
        </tr>
        </tbody>
        </table>
        
        <p>We see some of the same people here that we saw earlier in our PageRank query, with Mike being an interesting exception.
        He was excluded from that calculation because he hasn’t reviewed enough hotels (three was the cutoff), but it seems like he’s quite well connected in the world of Las Vegas Yelp users.</p>
        
        <p>In an effort to reach a wider variety of customers, we’ll look at other preferences these “connectors” display to see what we should promote.
        Many of these users have also reviewed restaurants, so we write the following query to find out which ones they like best:</p>
        
        <pre data-type="programlisting" data-code-language="cypher"><code class="k">MATCH</code><code class="n"> </code><code class="n">(</code><code class="n">u</code><code class="n">:</code><code class="n">U</code><code class="n">s</code><code class="n">e</code><code class="n">r</code><code class="n">)</code><code class="n">-</code><code class="n">[</code><code class="n">:</code><code class="n">W</code><code class="n">R</code><code class="n">O</code><code class="n">T</code><code class="n">E</code><code class="n">]</code><code class="n">-</code><code class="n">&gt;</code><code class="n">(</code><code class="n">)</code><code class="n">-</code><code class="n">[</code><code class="n">:</code><code class="n">R</code><code class="n">E</code><code class="n">V</code><code class="n">I</code><code class="n">E</code><code class="n">W</code><code class="n">S</code><code class="n">]</code><code class="n">-</code><code class="n">&gt;</code><code class="n">(</code><code class="n">:</code><code class="n">B</code><code class="n">u</code><code class="n">s</code><code class="n">i</code><code class="n">n</code><code class="n">e</code><code class="n">s</code><code class="n">s</code><code class="n"> </code><code class="n">{</code><code class="n">n</code><code class="n">a</code><code class="n">m</code><code class="n">e</code><code class="n">:</code><code class="s2">"Bellagio Hotel"</code><code class="n">}</code><code class="n">)</code><code class="n"> </code><a class="co" id="co_graph_algorithms_in_practice_CO3-1" href="#callout_graph_algorithms_in_practice_CO3-1"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/1.png" alt="1" width="12" height="12"></a><code class="n">
        </code><code class="k">WHERE </code><code class="n">u</code><code class="n">.</code><code class="n">b</code><code class="n">e</code><code class="n">t</code><code class="n">w</code><code class="n">e</code><code class="n">e</code><code class="n">n</code><code class="n"> </code><code class="n">&gt;</code><code class="n"> </code><code class="n">4</code><code class="n">4</code><code class="n">1</code><code class="n">8</code><code class="n">3</code><code class="n">1</code><code class="n">7</code><code class="n">
        </code><code class="k">WITH </code><code class="n">u</code><code class="n"> </code><code class="k">ORDER </code><code class="k">BY </code><code class="n">u</code><code class="n">.</code><code class="n">b</code><code class="n">e</code><code class="n">t</code><code class="n">w</code><code class="n">e</code><code class="n">e</code><code class="n">n</code><code class="n"> </code><code class="k">DESC </code><code class="k">LIMIT </code><code class="n">5</code><code class="n">0</code><code class="n">
        </code><code class="n">
        </code><code class="k">MATCH</code><code class="n"> </code><code class="n">(</code><code class="n">u</code><code class="n">)</code><code class="n">-</code><code class="n">[</code><code class="n">:</code><code class="n">W</code><code class="n">R</code><code class="n">O</code><code class="n">T</code><code class="n">E</code><code class="n">]</code><code class="n">-</code><code class="n">&gt;</code><code class="n">(</code><code class="n">r</code><code class="n">e</code><code class="n">v</code><code class="n">i</code><code class="n">e</code><code class="n">w</code><code class="n">)</code><code class="n">-</code><code class="n">[</code><code class="n">:</code><code class="n">R</code><code class="n">E</code><code class="n">V</code><code class="n">I</code><code class="n">E</code><code class="n">W</code><code class="n">S</code><code class="n">]</code><code class="n">-</code><code class="n">(</code><code class="n">b</code><code class="n">u</code><code class="n">s</code><code class="n">i</code><code class="n">n</code><code class="n">e</code><code class="n">s</code><code class="n">s</code><code class="n">)</code><code class="n"> </code><a class="co" id="co_graph_algorithms_in_practice_CO3-2" href="#callout_graph_algorithms_in_practice_CO3-2"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/2.png" alt="2" width="12" height="12"></a><code class="n">
        </code><code class="k">WHERE</code><code class="n"> </code><code class="n">(</code><code class="n">b</code><code class="n">u</code><code class="n">s</code><code class="n">i</code><code class="n">n</code><code class="n">e</code><code class="n">s</code><code class="n">s</code><code class="n">)</code><code class="n">-</code><code class="n">[</code><code class="n">:</code><code class="n">I</code><code class="n">N</code><code class="n">_</code><code class="n">C</code><code class="n">A</code><code class="n">T</code><code class="n">E</code><code class="n">G</code><code class="n">O</code><code class="n">R</code><code class="n">Y</code><code class="n">]</code><code class="n">-</code><code class="n">&gt;</code><code class="n">(</code><code class="n">:</code><code class="n">C</code><code class="n">a</code><code class="n">t</code><code class="n">e</code><code class="n">g</code><code class="n">o</code><code class="n">r</code><code class="n">y</code><code class="n"> </code><code class="n">{</code><code class="n">n</code><code class="n">a</code><code class="n">m</code><code class="n">e</code><code class="n">:</code><code class="n"> </code><code class="s2">"Restaurants"</code><code class="n">}</code><code class="n">)</code><code class="n">
        </code><code class="o">AND</code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n">(</code><code class="n">b</code><code class="n">u</code><code class="n">s</code><code class="n">i</code><code class="n">n</code><code class="n">e</code><code class="n">s</code><code class="n">s</code><code class="n">)</code><code class="n">-</code><code class="n">[</code><code class="n">:</code><code class="n">I</code><code class="n">N</code><code class="n">_</code><code class="n">C</code><code class="n">I</code><code class="n">T</code><code class="n">Y</code><code class="n">]</code><code class="n">-</code><code class="n">&gt;</code><code class="n">(</code><code class="n">:</code><code class="n">C</code><code class="n">i</code><code class="n">t</code><code class="n">y</code><code class="n"> </code><code class="n">{</code><code class="n">n</code><code class="n">a</code><code class="n">m</code><code class="n">e</code><code class="n">:</code><code class="n"> </code><code class="s2">"Las Vegas"</code><code class="n">}</code><code class="n">)</code><code class="n">
        </code><code class="n">
        </code><code class="k">WITH </code><code class="n">b</code><code class="n">u</code><code class="n">s</code><code class="n">i</code><code class="n">n</code><code class="n">e</code><code class="n">s</code><code class="n">s</code><code class="n">,</code><code class="n"> </code><code class="nf">avg</code><code class="n">(</code><code class="n">r</code><code class="n">e</code><code class="n">v</code><code class="n">i</code><code class="n">e</code><code class="n">w</code><code class="n">.</code><code class="n">s</code><code class="n">t</code><code class="n">a</code><code class="n">r</code><code class="n">s</code><code class="n">)</code><code class="n"> </code><code class="k">AS </code><code class="n">a</code><code class="n">v</code><code class="n">e</code><code class="n">r</code><code class="n">a</code><code class="n">g</code><code class="n">e</code><code class="n">R</code><code class="n">e</code><code class="n">v</code><code class="n">i</code><code class="n">e</code><code class="n">w</code><code class="n">,</code><code class="n"> </code><code class="nf">count</code><code class="n">(</code><code class="n">*</code><code class="n">)</code><code class="n"> </code><code class="k">AS </code><code class="n">n</code><code class="n">u</code><code class="n">m</code><code class="n">b</code><code class="n">e</code><code class="n">r</code><code class="n">O</code><code class="n">f</code><code class="n">R</code><code class="n">e</code><code class="n">v</code><code class="n">i</code><code class="n">e</code><code class="n">w</code><code class="n">s</code><code class="n"> </code><a class="co" id="co_graph_algorithms_in_practice_CO3-3" href="#callout_graph_algorithms_in_practice_CO3-3"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/3.png" alt="3" width="12" height="12"></a><code class="n">
        </code><code class="k">WHERE </code><code class="n">n</code><code class="n">u</code><code class="n">m</code><code class="n">b</code><code class="n">e</code><code class="n">r</code><code class="n">O</code><code class="n">f</code><code class="n">R</code><code class="n">e</code><code class="n">v</code><code class="n">i</code><code class="n">e</code><code class="n">w</code><code class="n">s</code><code class="n"> </code><code class="n">&gt;</code><code class="n">=</code><code class="n"> </code><code class="n">3</code><code class="n">
        </code><code class="n">
        </code><code class="k">RETURN </code><code class="n">b</code><code class="n">u</code><code class="n">s</code><code class="n">i</code><code class="n">n</code><code class="n">e</code><code class="n">s</code><code class="n">s</code><code class="n">.</code><code class="n">n</code><code class="n">a</code><code class="n">m</code><code class="n">e</code><code class="n"> </code><code class="k">AS </code><code class="n">b</code><code class="n">u</code><code class="n">s</code><code class="n">i</code><code class="n">n</code><code class="n">e</code><code class="n">s</code><code class="n">s</code><code class="n">,</code><code class="n"> </code><code class="n">a</code><code class="n">v</code><code class="n">e</code><code class="n">r</code><code class="n">a</code><code class="n">g</code><code class="n">e</code><code class="n">R</code><code class="n">e</code><code class="n">v</code><code class="n">i</code><code class="n">e</code><code class="n">w</code><code class="n">,</code><code class="n"> </code><code class="n">n</code><code class="n">u</code><code class="n">m</code><code class="n">b</code><code class="n">e</code><code class="n">r</code><code class="n">O</code><code class="n">f</code><code class="n">R</code><code class="n">e</code><code class="n">v</code><code class="n">i</code><code class="n">e</code><code class="n">w</code><code class="n">s</code><code class="n">
        </code><code class="k">ORDER </code><code class="k">BY </code><code class="n">a</code><code class="n">v</code><code class="n">e</code><code class="n">r</code><code class="n">a</code><code class="n">g</code><code class="n">e</code><code class="n">R</code><code class="n">e</code><code class="n">v</code><code class="n">i</code><code class="n">e</code><code class="n">w</code><code class="n"> </code><code class="k">DESC</code><code class="n">,</code><code class="n"> </code><code class="n">n</code><code class="n">u</code><code class="n">m</code><code class="n">b</code><code class="n">e</code><code class="n">r</code><code class="n">O</code><code class="n">f</code><code class="n">R</code><code class="n">e</code><code class="n">v</code><code class="n">i</code><code class="n">e</code><code class="n">w</code><code class="n">s</code><code class="n"> </code><code class="k">DESC
        </code><code class="k">LIMIT </code><code class="n">1</code><code class="n">0</code><code class="n">;</code></pre>
        <dl class="calloutlist">
        <dt><a class="co" id="callout_graph_algorithms_in_practice_CO3-1" href="#co_graph_algorithms_in_practice_CO3-1"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/1.png" alt="1" width="12" height="12"></a></dt>
        <dd><p>Find the top 50 users who have reviewed the Bellagio</p></dd>
        <dt><a class="co" id="callout_graph_algorithms_in_practice_CO3-2" href="#co_graph_algorithms_in_practice_CO3-2"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/2.png" alt="2" width="12" height="12"></a></dt>
        <dd><p>Find the restaurants those users have reviewed in Las Vegas</p></dd>
        <dt><a class="co" id="callout_graph_algorithms_in_practice_CO3-3" href="#co_graph_algorithms_in_practice_CO3-3"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/3.png" alt="3" width="12" height="12"></a></dt>
        <dd><p>Only include restaurants that have more than 3 reviews by these users</p></dd>
        </dl>
        
        <p>This query finds our top 50 influential connectors, and finds the top 10 Las Vegas restaurants where at least 3 of them have rated the restaurant.
        If we run it, we’ll see the output shown here:</p>
        <table>
        
        <thead>
        <tr>
        <th>business</th>
        <th>averageReview</th>
        <th>numberOfReviews</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><p>Jean Georges Steakhouse</p></td>
        <td><p>5.0</p></td>
        <td><p>6</p></td>
        </tr>
        <tr>
        <td><p>Sushi House Goyemon</p></td>
        <td><p>5.0</p></td>
        <td><p>6</p></td>
        </tr>
        <tr>
        <td><p>Parma By Chef Marc</p></td>
        <td><p>5.0</p></td>
        <td><p>4</p></td>
        </tr>
        <tr>
        <td><p>Kabuto</p></td>
        <td><p>5.0</p></td>
        <td><p>4</p></td>
        </tr>
        <tr>
        <td><p>é by José Andrés</p></td>
        <td><p>5.0</p></td>
        <td><p>4</p></td>
        </tr>
        <tr>
        <td><p>Yonaka Modern Japanese</p></td>
        <td><p>5.0</p></td>
        <td><p>4</p></td>
        </tr>
        <tr>
        <td><p>Art of Flavors</p></td>
        <td><p>5.0</p></td>
        <td><p>4</p></td>
        </tr>
        <tr>
        <td><p>Buffet of Buffets</p></td>
        <td><p>5.0</p></td>
        <td><p>3</p></td>
        </tr>
        <tr>
        <td><p>Rose. Rabbit. Lie</p></td>
        <td><p>5.0</p></td>
        <td><p>3</p></td>
        </tr>
        <tr>
        <td><p>Harvest by Roy Ellamar</p></td>
        <td><p>5.0</p></td>
        <td><p>3</p></td>
        </tr>
        </tbody>
        </table>
        
        <p>We can now recommend that the Bellagio run a joint promotion with these restaurants to attract new guests from groups they might not typically reach.
        Superconnectors who rate the Bellagio well become our proxy for estimating which restaurants might catch the eye of new types of target visitors.</p>
        
        <p>Now that we have helped the Bellagio reach new groups, we’re going to see how we can use community detection to further improve our app<a data-type="indexterm" data-startref="ix_ch07-adoc10" id="idm46681362220392"></a>.<a data-type="indexterm" data-startref="ix_ch07-adoc9" id="idm46681362219784"></a></p>
        </div></section>
        
        
        
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Finding Similar Categories"><div class="sect2" id="idm46681363191240">
        <h2>Finding Similar Categories</h2>
        
        <p><a data-type="indexterm" data-primary="Yelp dataset" data-secondary="finding similar categories" id="ix_ch07-adoc11"></a>While our end users are using the app to find hotels, we want to showcase other businesses they might be interested in.
        The Yelp dataset contains more than 1,000 categories, and it seems likely that some of those categories are similar to each other.
        We’ll use that similarity to make in-app recommendations for new businesses that our users will likely find interesting.</p>
        
        <p>Our graph model doesn’t have any relationships between categories, but we can use the ideas described in <a data-type="xref" href="ch02.html#ch2-projected-graphs">“Monopartite, Bipartite, and k-Partite Graphs”</a> to build a category similarity graph based on how businesses categorize themselves.</p>
        
        <p>For example, imagine that only one business categorizes itself under both Hotels and Historical Tours, as seen in <a data-type="xref" href="#projection1">Figure&nbsp;7-8</a>.</p>
        
        <figure><div id="projection1" class="figure">
        <img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/gral_rr_0708.png" alt="gral rr 0708" width="1441" height="1097">
        <h6><span class="label">Figure 7-8. </span>A business with two categories</h6>
        </div></figure>
        
        <p>This would result in a projected graph that has a link between Hotels and Historical Tours with a weight of 1, as seen in <a data-type="xref" href="#projection2">Figure&nbsp;7-9</a>.</p>
        
        <figure><div id="projection2" class="figure">
        <img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/gral_rr_0709.png" alt="gral rr 0709" width="1442" height="443">
        <h6><span class="label">Figure 7-9. </span>A projected categories graph</h6>
        </div></figure>
        
        <p>In this case, we don’t actually have to create the similarity graph—instead, we can run a community detection algorithm such as Label Propagation over a projected similarity graph.
        <a data-type="indexterm" data-primary="Label Propagation algorithm (LPA)" data-secondary="with Yelp dataset" id="ix_ch07-adoc12"></a>Using Label Propagation will effectively cluster businesses around the supercategory with which they have most in common:</p>
        
        <pre data-type="programlisting" data-code-language="cypher"><code class="n">CALL gds.labelPropagation.stream({</code>
        <code class="n">  nodeQuery: </code><code class="s1">'MATCH (c:Category) RETURN id(c) AS id'</code><code class="n">,</code>
        <code class="n">  relationshipQuery: </code><code class="s1">'MATCH (c1:Category)&lt;-[:IN_CATEGORY]-(b),</code>
        <code class="s1">                            (c2:Category)&lt;-[:IN_CATEGORY]-(b)</code>
        <code class="s1">                      WHERE id(c1) &lt; id(c2)</code>
        <code class="s1">                      RETURN id(c1) AS source,</code>
        <code class="s1">                             id(c2) AS target,</code>
        <code class="s1">                             count(*) AS weight'</code><code class="n"></code>
        <code class="n">})</code>
        <code class="n">YIELD nodeId, communityId</code>
        <code class="k">WITH </code><code class="n">gds.util.asNode(nodeId) </code><code class="k">AS node</code><code class="n">, communityId</code>
        <code class="n">MERGE (sc:SuperCategory {name: </code><code class="s2">"SuperCategory-"</code><code class="n"> + communityId})</code>
        <code class="n">MERGE (</code><code class="k">node</code><code class="n">)-[:IN_SUPER_CATEGORY]-&gt;(sc);</code></pre>
        
        <p>Let’s give those supercategories a friendlier name—the name of their largest category works well here:</p>
        
        <pre data-type="programlisting" data-code-language="cypher"><code class="k">MATCH</code><code class="n"> (sc:SuperCategory)&lt;-[:IN_SUPER_CATEGORY]-(category)</code>
        <code class="k">WITH </code><code class="n">sc, category, size((category)&lt;-[:IN_CATEGORY]-()) </code><code class="k">as </code><code class="n">size</code>
        <code class="k">ORDER BY </code><code class="n">size </code><code class="k">DESC</code>
        <code class="k">WITH </code><code class="n">sc, </code><code class="nf">collect</code><code class="n">(category.name)[0] </code><code class="k">as </code><code class="n">biggestCategory</code>
        <code class="k">SET </code><code class="n">sc.friendlyName = </code><code class="s2">"SuperCat "</code><code class="n"> + biggestCategory;</code></pre>
        
        <p>We can see a sample of categories and supercategories in <a data-type="xref" href="#cat_super_cat">Figure&nbsp;7-10</a>.</p>
        
        <figure><div id="cat_super_cat" class="figure">
        <img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/gral_rr_0710.png" alt="gral rr 0710" width="1439" height="1037">
        <h6><span class="label">Figure 7-10. </span>Categories and supercategories</h6>
        </div></figure>
        
        <p>The following query finds the most prevalent similar categories to Hotels in Las Vegas:</p>
        
        <pre data-type="programlisting" data-code-language="cypher"><code class="k">MATCH</code><code class="n"> (hotels:Category {name: </code><code class="s2">"Hotels"</code><code class="n">}),</code>
        <code class="n">      (lasVegas:City {name: </code><code class="s2">"Las Vegas"</code><code class="n">}),</code>
        <code class="n">      (hotels)-[:IN_SUPER_CATEGORY]-&gt;(superCat),</code>
        <code class="n">      (superCat)&lt;-[:IN_SUPER_CATEGORY]-(otherCategory)</code>
        <code class="k">RETURN </code><code class="n">otherCategory.name </code><code class="k">AS </code><code class="n">otherCategory,</code>
        <code class="n">       size((otherCategory)&lt;-[:IN_CATEGORY]-(:Business)-</code>
        <code class="n">                             [:IN_CITY]-&gt;(lasVegas)) </code><code class="k">AS </code><code class="n">businesses</code>
        <code class="k">ORDER BY </code><code class="n">businesses </code><code class="k">DESC</code>
        <code class="k">LIMIT </code><code class="n">10;</code></pre>
        
        <p>If we run that query we’ll see the following output:</p>
        <table>
        
        <thead>
        <tr>
        <th>otherCategory</th>
        <th>businesses</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><p>Tours</p></td>
        <td><p>189</p></td>
        </tr>
        <tr>
        <td><p>Car Rental</p></td>
        <td><p>160</p></td>
        </tr>
        <tr>
        <td><p>Limos</p></td>
        <td><p>84</p></td>
        </tr>
        <tr>
        <td><p>Resorts</p></td>
        <td><p>73</p></td>
        </tr>
        <tr>
        <td><p>Airport Shuttles</p></td>
        <td><p>52</p></td>
        </tr>
        <tr>
        <td><p>Taxis</p></td>
        <td><p>35</p></td>
        </tr>
        <tr>
        <td><p>Vacation Rentals</p></td>
        <td><p>29</p></td>
        </tr>
        <tr>
        <td><p>Airports</p></td>
        <td><p>25</p></td>
        </tr>
        <tr>
        <td><p>Airlines</p></td>
        <td><p>23</p></td>
        </tr>
        <tr>
        <td><p>Motorcycle Rental</p></td>
        <td><p>19</p></td>
        </tr>
        </tbody>
        </table>
        
        <p>Do these results seem odd?
        Obviously taxis and tours aren’t hotels, but remember that this is based on self-reported categorizations. What the Label Propagation algorithm is really showing us in this similarity group are adjacent businesses<a data-type="indexterm" data-startref="ix_ch07-adoc12" id="idm46681361696136"></a> and 
        <span class="keep-together">services.</span></p>
        
        <p>Now let’s find some businesses with an above-average rating in each of those 
        <span class="keep-together">categories:</span></p>
        
        <pre data-type="programlisting" data-code-language="cypher"><code class="k">MATCH</code><code class="n"> </code><code class="n">(</code><code class="n">h</code><code class="n">o</code><code class="n">t</code><code class="n">e</code><code class="n">l</code><code class="n">s</code><code class="n">:</code><code class="n">C</code><code class="n">a</code><code class="n">t</code><code class="n">e</code><code class="n">g</code><code class="n">o</code><code class="n">r</code><code class="n">y</code><code class="n"> </code><code class="n">{</code><code class="n">n</code><code class="n">a</code><code class="n">m</code><code class="n">e</code><code class="n">:</code><code class="n"> </code><code class="s2">"Hotels"</code><code class="n">}</code><code class="n">)</code><code class="n">,</code><code class="n"> </code><a class="co" id="co_graph_algorithms_in_practice_CO4-1" href="#callout_graph_algorithms_in_practice_CO4-1"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/1.png" alt="1" width="12" height="12"></a><code class="n">
        </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n">(</code><code class="n">h</code><code class="n">o</code><code class="n">t</code><code class="n">e</code><code class="n">l</code><code class="n">s</code><code class="n">)</code><code class="n">-</code><code class="n">[</code><code class="n">:</code><code class="n">I</code><code class="n">N</code><code class="n">_</code><code class="n">S</code><code class="n">U</code><code class="n">P</code><code class="n">E</code><code class="n">R</code><code class="n">_</code><code class="n">C</code><code class="n">A</code><code class="n">T</code><code class="n">E</code><code class="n">G</code><code class="n">O</code><code class="n">R</code><code class="n">Y</code><code class="n">]</code><code class="n">-</code><code class="n">&gt;</code><code class="n">(</code><code class="n">s</code><code class="n">u</code><code class="n">p</code><code class="n">e</code><code class="n">r</code><code class="n">C</code><code class="n">a</code><code class="n">t</code><code class="n">)</code><code class="n">,</code><code class="n">
        </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n">(</code><code class="n">o</code><code class="n">t</code><code class="n">h</code><code class="n">e</code><code class="n">r</code><code class="n">C</code><code class="n">a</code><code class="n">t</code><code class="n">e</code><code class="n">g</code><code class="n">o</code><code class="n">r</code><code class="n">y</code><code class="n">)</code><code class="n">-</code><code class="n">[</code><code class="n">:</code><code class="n">I</code><code class="n">N</code><code class="n">_</code><code class="n">S</code><code class="n">U</code><code class="n">P</code><code class="n">E</code><code class="n">R</code><code class="n">_</code><code class="n">C</code><code class="n">A</code><code class="n">T</code><code class="n">E</code><code class="n">G</code><code class="n">O</code><code class="n">R</code><code class="n">Y</code><code class="n">]</code><code class="n">-</code><code class="n">&gt;</code><code class="n">(</code><code class="n">s</code><code class="n">u</code><code class="n">p</code><code class="n">e</code><code class="n">r</code><code class="n">C</code><code class="n">a</code><code class="n">t</code><code class="n">)</code><code class="n">,</code><code class="n">
        </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n">(</code><code class="n">o</code><code class="n">t</code><code class="n">h</code><code class="n">e</code><code class="n">r</code><code class="n">C</code><code class="n">a</code><code class="n">t</code><code class="n">e</code><code class="n">g</code><code class="n">o</code><code class="n">r</code><code class="n">y</code><code class="n">)</code><code class="n">&lt;</code><code class="n">-</code><code class="n">[</code><code class="n">:</code><code class="n">I</code><code class="n">N</code><code class="n">_</code><code class="n">C</code><code class="n">A</code><code class="n">T</code><code class="n">E</code><code class="n">G</code><code class="n">O</code><code class="n">R</code><code class="n">Y</code><code class="n">]</code><code class="n">-</code><code class="n">(</code><code class="n">b</code><code class="n">u</code><code class="n">s</code><code class="n">i</code><code class="n">n</code><code class="n">e</code><code class="n">s</code><code class="n">s</code><code class="n">)</code><code class="n">
        </code><code class="k">WHERE</code><code class="n"> </code><code class="n">(</code><code class="n">b</code><code class="n">u</code><code class="n">s</code><code class="n">i</code><code class="n">n</code><code class="n">e</code><code class="n">s</code><code class="n">s</code><code class="n">)</code><code class="n">-</code><code class="n">[</code><code class="n">:</code><code class="n">I</code><code class="n">N</code><code class="n">_</code><code class="n">C</code><code class="n">I</code><code class="n">T</code><code class="n">Y</code><code class="n">]</code><code class="n">-</code><code class="n">&gt;</code><code class="n">(</code><code class="n">:</code><code class="n">C</code><code class="n">i</code><code class="n">t</code><code class="n">y</code><code class="n"> </code><code class="n">{</code><code class="n">n</code><code class="n">a</code><code class="n">m</code><code class="n">e</code><code class="n">:</code><code class="n"> </code><code class="s2">"Las Vegas"</code><code class="n">}</code><code class="n">)</code><code class="n">
        </code><code class="n">
        </code><code class="k">WITH </code><code class="n">o</code><code class="n">t</code><code class="n">h</code><code class="n">e</code><code class="n">r</code><code class="n">C</code><code class="n">a</code><code class="n">t</code><code class="n">e</code><code class="n">g</code><code class="n">o</code><code class="n">r</code><code class="n">y</code><code class="n">,</code><code class="n"> </code><code class="nf">count</code><code class="n">(</code><code class="n">*</code><code class="n">)</code><code class="n"> </code><code class="k">AS </code><code class="nf">count</code><code class="n">,</code><code class="n"> </code><a class="co" id="co_graph_algorithms_in_practice_CO4-2" href="#callout_graph_algorithms_in_practice_CO4-2"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/2.png" alt="2" width="12" height="12"></a><code class="n">
        </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="nf">collect</code><code class="n">(</code><code class="n">b</code><code class="n">u</code><code class="n">s</code><code class="n">i</code><code class="n">n</code><code class="n">e</code><code class="n">s</code><code class="n">s</code><code class="n">)</code><code class="n"> </code><code class="k">AS </code><code class="n">b</code><code class="n">u</code><code class="n">s</code><code class="n">i</code><code class="n">n</code><code class="n">e</code><code class="n">s</code><code class="n">s</code><code class="n">e</code><code class="n">s</code><code class="n">,</code><code class="n">
        </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n">p</code><code class="n">e</code><code class="n">r</code><code class="n">c</code><code class="n">e</code><code class="n">n</code><code class="n">t</code><code class="n">i</code><code class="n">l</code><code class="n">e</code><code class="n">D</code><code class="n">i</code><code class="n">s</code><code class="n">c</code><code class="n">(</code><code class="n">b</code><code class="n">u</code><code class="n">s</code><code class="n">i</code><code class="n">n</code><code class="n">e</code><code class="n">s</code><code class="n">s</code><code class="n">.</code><code class="n">a</code><code class="n">v</code><code class="n">e</code><code class="n">r</code><code class="n">a</code><code class="n">g</code><code class="n">e</code><code class="n">S</code><code class="n">t</code><code class="n">a</code><code class="n">r</code><code class="n">s</code><code class="n">,</code><code class="n"> </code><code class="n">0</code><code class="n">.</code><code class="n">9</code><code class="n">)</code><code class="n"> </code><code class="k">AS </code><code class="n">p</code><code class="n">9</code><code class="n">0</code><code class="n">S</code><code class="n">t</code><code class="n">a</code><code class="n">r</code><code class="n">s</code><code class="n">
        </code><code class="k">ORDER </code><code class="k">BY </code><code class="n">r</code><code class="n">a</code><code class="n">n</code><code class="n">d</code><code class="n">(</code><code class="n">)</code><code class="n"> </code><code class="k">DESC
        </code><code class="k">LIMIT </code><code class="n">1</code><code class="n">0</code><code class="n">
        </code><code class="n">
        </code><code class="k">WITH </code><code class="n">o</code><code class="n">t</code><code class="n">h</code><code class="n">e</code><code class="n">r</code><code class="n">C</code><code class="n">a</code><code class="n">t</code><code class="n">e</code><code class="n">g</code><code class="n">o</code><code class="n">r</code><code class="n">y</code><code class="n">,</code><code class="n">
        </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n">[</code><code class="n">b</code><code class="n"> </code><code class="k">in </code><code class="n">b</code><code class="n">u</code><code class="n">s</code><code class="n">i</code><code class="n">n</code><code class="n">e</code><code class="n">s</code><code class="n">s</code><code class="n">e</code><code class="n">s</code><code class="n"> </code><code class="k">where </code><code class="n">b</code><code class="n">.</code><code class="n">a</code><code class="n">v</code><code class="n">e</code><code class="n">r</code><code class="n">a</code><code class="n">g</code><code class="n">e</code><code class="n">S</code><code class="n">t</code><code class="n">a</code><code class="n">r</code><code class="n">s</code><code class="n"> </code><code class="n">&gt;</code><code class="n">=</code><code class="n"> </code><code class="n">p</code><code class="n">9</code><code class="n">0</code><code class="n">S</code><code class="n">t</code><code class="n">a</code><code class="n">r</code><code class="n">s</code><code class="n">]</code><code class="n"> </code><code class="k">AS </code><code class="n">b</code><code class="n">u</code><code class="n">s</code><code class="n">i</code><code class="n">n</code><code class="n">e</code><code class="n">s</code><code class="n">s</code><code class="n">e</code><code class="n">s</code><code class="n"> </code><a class="co" id="co_graph_algorithms_in_practice_CO4-3" href="#callout_graph_algorithms_in_practice_CO4-3"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/3.png" alt="3" width="12" height="12"></a><code class="n">
        </code><code class="n">
        </code><code class="k">WITH </code><code class="n">o</code><code class="n">t</code><code class="n">h</code><code class="n">e</code><code class="n">r</code><code class="n">C</code><code class="n">a</code><code class="n">t</code><code class="n">e</code><code class="n">g</code><code class="n">o</code><code class="n">r</code><code class="n">y</code><code class="n">,</code><code class="n">
        </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n">b</code><code class="n">u</code><code class="n">s</code><code class="n">i</code><code class="n">n</code><code class="n">e</code><code class="n">s</code><code class="n">s</code><code class="n">e</code><code class="n">s</code><code class="n">[</code><code class="n">t</code><code class="n">o</code><code class="n">I</code><code class="n">n</code><code class="n">t</code><code class="n">e</code><code class="n">g</code><code class="n">e</code><code class="n">r</code><code class="n">(</code><code class="n">r</code><code class="n">a</code><code class="n">n</code><code class="n">d</code><code class="n">(</code><code class="n">)</code><code class="n"> </code><code class="n">*</code><code class="n"> </code><code class="n">s</code><code class="n">i</code><code class="n">z</code><code class="n">e</code><code class="n">(</code><code class="n">b</code><code class="n">u</code><code class="n">s</code><code class="n">i</code><code class="n">n</code><code class="n">e</code><code class="n">s</code><code class="n">s</code><code class="n">e</code><code class="n">s</code><code class="n">)</code><code class="n">)</code><code class="n">]</code><code class="n"> </code><code class="k">AS </code><code class="n">b</code><code class="n">u</code><code class="n">s</code><code class="n">i</code><code class="n">n</code><code class="n">e</code><code class="n">s</code><code class="n">s</code><code class="n"> </code><a class="co" id="co_graph_algorithms_in_practice_CO4-4" href="#callout_graph_algorithms_in_practice_CO4-4"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/4.png" alt="4" width="12" height="12"></a><code class="n">
        </code><code class="n">
        </code><code class="k">RETURN </code><code class="n">o</code><code class="n">t</code><code class="n">h</code><code class="n">e</code><code class="n">r</code><code class="n">C</code><code class="n">a</code><code class="n">t</code><code class="n">e</code><code class="n">g</code><code class="n">o</code><code class="n">r</code><code class="n">y</code><code class="n">.</code><code class="n">n</code><code class="n">a</code><code class="n">m</code><code class="n">e</code><code class="n"> </code><code class="k">AS </code><code class="n">o</code><code class="n">t</code><code class="n">h</code><code class="n">e</code><code class="n">r</code><code class="n">C</code><code class="n">a</code><code class="n">t</code><code class="n">e</code><code class="n">g</code><code class="n">o</code><code class="n">r</code><code class="n">y</code><code class="n">,</code><code class="n">
        </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n">b</code><code class="n">u</code><code class="n">s</code><code class="n">i</code><code class="n">n</code><code class="n">e</code><code class="n">s</code><code class="n">s</code><code class="n">.</code><code class="n">n</code><code class="n">a</code><code class="n">m</code><code class="n">e</code><code class="n"> </code><code class="k">AS </code><code class="n">b</code><code class="n">u</code><code class="n">s</code><code class="n">i</code><code class="n">n</code><code class="n">e</code><code class="n">s</code><code class="n">s</code><code class="n">,</code><code class="n">
        </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n"> </code><code class="n">b</code><code class="n">u</code><code class="n">s</code><code class="n">i</code><code class="n">n</code><code class="n">e</code><code class="n">s</code><code class="n">s</code><code class="n">.</code><code class="n">a</code><code class="n">v</code><code class="n">e</code><code class="n">r</code><code class="n">a</code><code class="n">g</code><code class="n">e</code><code class="n">S</code><code class="n">t</code><code class="n">a</code><code class="n">r</code><code class="n">s</code><code class="n"> </code><code class="k">AS </code><code class="n">a</code><code class="n">v</code><code class="n">e</code><code class="n">r</code><code class="n">a</code><code class="n">g</code><code class="n">e</code><code class="n">S</code><code class="n">t</code><code class="n">a</code><code class="n">r</code><code class="n">s</code><code class="n">;</code></pre>
        <dl class="calloutlist">
        <dt><a class="co" id="callout_graph_algorithms_in_practice_CO4-1" href="#co_graph_algorithms_in_practice_CO4-1"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/1.png" alt="1" width="12" height="12"></a></dt>
        <dd><p>Find businesses in Las Vegas that have the same <code>SuperCategory</code> as Hotels.</p></dd>
        <dt><a class="co" id="callout_graph_algorithms_in_practice_CO4-2" href="#co_graph_algorithms_in_practice_CO4-2"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/2.png" alt="2" width="12" height="12"></a></dt>
        <dd><p>Select 10 random categories and calculate the 90th percentile star rating.</p></dd>
        <dt><a class="co" id="callout_graph_algorithms_in_practice_CO4-3" href="#co_graph_algorithms_in_practice_CO4-3"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/3.png" alt="3" width="12" height="12"></a></dt>
        <dd><p>Select businesses from each of those categories that have an average rating higher than the 90th percentile using a pattern comprehension.</p></dd>
        <dt><a class="co" id="callout_graph_algorithms_in_practice_CO4-4" href="#co_graph_algorithms_in_practice_CO4-4"><img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/4.png" alt="4" width="12" height="12"></a></dt>
        <dd><p>Select one business per category.</p></dd>
        </dl>
        
        <p>In this query we use <a href="https://bit.ly/2HRa1gr">pattern comprehension</a> for the first time. Pattern comprehension is a syntax construction for creating a list based on pattern matching. It finds a specified pattern using a <code>MATCH</code> clause with a <code>WHERE</code> clause for predicates and then yields a custom projection. <a data-type="indexterm" data-primary="Cypher" id="idm46681361045192"></a>This Cypher feature was added based on inspiration from <a href="https://graphql.org">GraphQL</a>, a query language for APIs.</p>
        
        <p>If we run that query we see the following result:</p>
        <table>
        
        <thead>
        <tr>
        <th>otherCategory</th>
        <th>business</th>
        <th>averageStars</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><p>Motorcycle Rental</p></td>
        <td><p>Adrenaline Rush Slingshot Rentals</p></td>
        <td><p>5.0</p></td>
        </tr>
        <tr>
        <td><p>Snorkeling</p></td>
        <td><p>Sin City Scuba</p></td>
        <td><p>5.0</p></td>
        </tr>
        <tr>
        <td><p>Guest Houses</p></td>
        <td><p>Hotel Del Kacvinsky</p></td>
        <td><p>5.0</p></td>
        </tr>
        <tr>
        <td><p>Car Rental</p></td>
        <td><p>The Lead Team</p></td>
        <td><p>5.0</p></td>
        </tr>
        <tr>
        <td><p>Food Tours</p></td>
        <td><p>Taste BUZZ Food Tours</p></td>
        <td><p>5.0</p></td>
        </tr>
        <tr>
        <td><p>Airports</p></td>
        <td><p>Signature Flight Support</p></td>
        <td><p>5.0</p></td>
        </tr>
        <tr>
        <td><p>Public Transportation</p></td>
        <td><p>JetSuiteX</p></td>
        <td><p>4.6875</p></td>
        </tr>
        <tr>
        <td><p>Ski Resorts</p></td>
        <td><p>Trikke Las Vegas</p></td>
        <td><p>4.833333333333332</p></td>
        </tr>
        <tr>
        <td><p>Town Car Service</p></td>
        <td><p>MW Travel Vegas</p></td>
        <td><p>4.866666666666665</p></td>
        </tr>
        <tr>
        <td><p>Campgrounds</p></td>
        <td><p>McWilliams Campground</p></td>
        <td><p>3.875</p></td>
        </tr>
        </tbody>
        </table>
        
        <p class="less_space pagebreak-before">We can then make real-time recommendations based on a user’s immediate app behavior.
        For example, while users are looking at Las Vegas hotels, we can now highlight a variety of adjacent Las Vegas businesses with good ratings. We can generalize these approaches to any business category, such as restaurants or theaters, in any location<a data-type="indexterm" data-startref="ix_ch07-adoc11" id="idm46681361026904"></a>.<a data-type="indexterm" data-startref="ix_ch07-adoc2" id="idm46681361015000"></a><a data-type="indexterm" data-startref="ix_ch07-adoc1" id="idm46681361014296"></a></p>
        <aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="reader-exercises1">
        <h5>Reader Exercises</h5>
        <ul>
        <li>
        <p>Can you plot how the reviews for a city’s hotels vary over time?</p>
        </li>
        <li>
        <p>What about for a particular hotel or other business?</p>
        </li>
        <li>
        <p>Are there any trends (seasonal or otherwise) in popularity?</p>
        </li>
        <li>
        <p>Do the most influential reviewers connect (out-link) to  only other influential reviewers?</p>
        </li>
        </ul>
        </div></aside>
        </div></section>
        
        
        
        
        
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect1" data-pdf-bookmark="Analyzing Airline Flight Data with Apache Spark"><div class="sect1" id="idm46681364674216">
        <h1>Analyzing Airline Flight Data with Apache Spark</h1>
        
        <p><a data-type="indexterm" data-primary="airline flight data" data-secondary="analyzing with Apache Spark" id="ix_ch07-adoc13"></a><a data-type="indexterm" data-primary="Apache Spark" data-secondary="analyzing airline flight data with" data-seealso="airline flight data" id="ix_ch07-adoc14"></a>In this section, we’ll use a different scenario to illustrate the analysis of US airport data with Spark.
        Imagine you’re a data scientist with a considerable travel schedule and would like to dig into information about airline flights and delays.
        We’ll first explore airport and flight information and then look deeper into delays at two specific airports. Community detection will be used to analyze routes and find the best use of our frequent flyer points.</p>
        
        <p>The US Bureau of Transportation Statistics makes available a <a href="https://bit.ly/2Fy0GHA">significant amount of transportation information</a>.
        For our analysis, we’ll use their May 2018 air travel on-time performance data, which includes flights originating and ending in the United States in that month.
        To add more detail about airports, such as location information, we’ll also load data from a separate source, <a href="https://bit.ly/2Frv8TO">OpenFlights</a>.</p>
        
        <p>Let’s load the data in Spark.
        As was the case in previous sections, our data is in CSV files that are available on the book’s <a href="https://bit.ly/2FPgGVV">Github repository</a>.</p>
        
        <pre data-type="programlisting" data-code-language="python"><code class="n">nodes</code> <code class="o">=</code> <code class="n">spark</code><code class="o">.</code><code class="n">read</code><code class="o">.</code><code class="n">csv</code><code class="p">(</code><code class="s2">"data/airports.csv"</code><code class="p">,</code> <code class="n">header</code><code class="o">=</code><code class="bp">False</code><code class="p">)</code>
        
        <code class="n">cleaned_nodes</code> <code class="o">=</code> <code class="p">(</code><code class="n">nodes</code><code class="o">.</code><code class="n">select</code><code class="p">(</code><code class="s2">"_c1"</code><code class="p">,</code> <code class="s2">"_c3"</code><code class="p">,</code> <code class="s2">"_c4"</code><code class="p">,</code> <code class="s2">"_c6"</code><code class="p">,</code> <code class="s2">"_c7"</code><code class="p">)</code>
                         <code class="o">.</code><code class="n">filter</code><code class="p">(</code><code class="s2">"_c3 = 'United States'"</code><code class="p">)</code>
                         <code class="o">.</code><code class="n">withColumnRenamed</code><code class="p">(</code><code class="s2">"_c1"</code><code class="p">,</code> <code class="s2">"name"</code><code class="p">)</code>
                         <code class="o">.</code><code class="n">withColumnRenamed</code><code class="p">(</code><code class="s2">"_c4"</code><code class="p">,</code> <code class="s2">"id"</code><code class="p">)</code>
                         <code class="o">.</code><code class="n">withColumnRenamed</code><code class="p">(</code><code class="s2">"_c6"</code><code class="p">,</code> <code class="s2">"latitude"</code><code class="p">)</code>
                         <code class="o">.</code><code class="n">withColumnRenamed</code><code class="p">(</code><code class="s2">"_c7"</code><code class="p">,</code> <code class="s2">"longitude"</code><code class="p">)</code>
                         <code class="o">.</code><code class="n">drop</code><code class="p">(</code><code class="s2">"_c3"</code><code class="p">))</code>
        <code class="n">cleaned_nodes</code> <code class="o">=</code> <code class="n">cleaned_nodes</code><code class="p">[</code><code class="n">cleaned_nodes</code><code class="p">[</code><code class="s2">"id"</code><code class="p">]</code> <code class="o">!=</code> <code class="s2">"</code><code class="se">\\</code><code class="s2">N"</code><code class="p">]</code>
        
        <code class="n">relationships</code> <code class="o">=</code> <code class="n">spark</code><code class="o">.</code><code class="n">read</code><code class="o">.</code><code class="n">csv</code><code class="p">(</code><code class="s2">"data/188591317_T_ONTIME.csv"</code><code class="p">,</code> <code class="n">header</code><code class="o">=</code><code class="bp">True</code><code class="p">)</code>
        
        <code class="n">cleaned_relationships</code> <code class="o">=</code> <code class="p">(</code><code class="n">relationships</code>
                                 <code class="o">.</code><code class="n">select</code><code class="p">(</code><code class="s2">"ORIGIN"</code><code class="p">,</code> <code class="s2">"DEST"</code><code class="p">,</code> <code class="s2">"FL_DATE"</code><code class="p">,</code> <code class="s2">"DEP_DELAY"</code><code class="p">,</code>
                                         <code class="s2">"ARR_DELAY"</code><code class="p">,</code> <code class="s2">"DISTANCE"</code><code class="p">,</code> <code class="s2">"TAIL_NUM"</code><code class="p">,</code> <code class="s2">"FL_NUM"</code><code class="p">,</code>
                                          <code class="s2">"CRS_DEP_TIME"</code><code class="p">,</code> <code class="s2">"CRS_ARR_TIME"</code><code class="p">,</code>
                                          <code class="s2">"UNIQUE_CARRIER"</code><code class="p">)</code>
                                 <code class="o">.</code><code class="n">withColumnRenamed</code><code class="p">(</code><code class="s2">"ORIGIN"</code><code class="p">,</code> <code class="s2">"src"</code><code class="p">)</code>
                                 <code class="o">.</code><code class="n">withColumnRenamed</code><code class="p">(</code><code class="s2">"DEST"</code><code class="p">,</code> <code class="s2">"dst"</code><code class="p">)</code>
                                 <code class="o">.</code><code class="n">withColumnRenamed</code><code class="p">(</code><code class="s2">"DEP_DELAY"</code><code class="p">,</code> <code class="s2">"deptDelay"</code><code class="p">)</code>
                                 <code class="o">.</code><code class="n">withColumnRenamed</code><code class="p">(</code><code class="s2">"ARR_DELAY"</code><code class="p">,</code> <code class="s2">"arrDelay"</code><code class="p">)</code>
                                 <code class="o">.</code><code class="n">withColumnRenamed</code><code class="p">(</code><code class="s2">"TAIL_NUM"</code><code class="p">,</code> <code class="s2">"tailNumber"</code><code class="p">)</code>
                                 <code class="o">.</code><code class="n">withColumnRenamed</code><code class="p">(</code><code class="s2">"FL_NUM"</code><code class="p">,</code> <code class="s2">"flightNumber"</code><code class="p">)</code>
                                 <code class="o">.</code><code class="n">withColumnRenamed</code><code class="p">(</code><code class="s2">"FL_DATE"</code><code class="p">,</code> <code class="s2">"date"</code><code class="p">)</code>
                                 <code class="o">.</code><code class="n">withColumnRenamed</code><code class="p">(</code><code class="s2">"CRS_DEP_TIME"</code><code class="p">,</code> <code class="s2">"time"</code><code class="p">)</code>
                                 <code class="o">.</code><code class="n">withColumnRenamed</code><code class="p">(</code><code class="s2">"CRS_ARR_TIME"</code><code class="p">,</code> <code class="s2">"arrivalTime"</code><code class="p">)</code>
                                 <code class="o">.</code><code class="n">withColumnRenamed</code><code class="p">(</code><code class="s2">"DISTANCE"</code><code class="p">,</code> <code class="s2">"distance"</code><code class="p">)</code>
                                 <code class="o">.</code><code class="n">withColumnRenamed</code><code class="p">(</code><code class="s2">"UNIQUE_CARRIER"</code><code class="p">,</code> <code class="s2">"airline"</code><code class="p">)</code>
                                 <code class="o">.</code><code class="n">withColumn</code><code class="p">(</code><code class="s2">"deptDelay"</code><code class="p">,</code>
                                      <code class="n">F</code><code class="o">.</code><code class="n">col</code><code class="p">(</code><code class="s2">"deptDelay"</code><code class="p">)</code><code class="o">.</code><code class="n">cast</code><code class="p">(</code><code class="n">FloatType</code><code class="p">()))</code>
                                 <code class="o">.</code><code class="n">withColumn</code><code class="p">(</code><code class="s2">"arrDelay"</code><code class="p">,</code>
                                      <code class="n">F</code><code class="o">.</code><code class="n">col</code><code class="p">(</code><code class="s2">"arrDelay"</code><code class="p">)</code><code class="o">.</code><code class="n">cast</code><code class="p">(</code><code class="n">FloatType</code><code class="p">()))</code>
                                 <code class="o">.</code><code class="n">withColumn</code><code class="p">(</code><code class="s2">"time"</code><code class="p">,</code> <code class="n">F</code><code class="o">.</code><code class="n">col</code><code class="p">(</code><code class="s2">"time"</code><code class="p">)</code><code class="o">.</code><code class="n">cast</code><code class="p">(</code><code class="n">IntegerType</code><code class="p">()))</code>
                                 <code class="o">.</code><code class="n">withColumn</code><code class="p">(</code><code class="s2">"arrivalTime"</code><code class="p">,</code>
                                      <code class="n">F</code><code class="o">.</code><code class="n">col</code><code class="p">(</code><code class="s2">"arrivalTime"</code><code class="p">)</code><code class="o">.</code><code class="n">cast</code><code class="p">(</code><code class="n">IntegerType</code><code class="p">()))</code>
                                 <code class="p">)</code>
        
        <code class="n">g</code> <code class="o">=</code> <code class="n">GraphFrame</code><code class="p">(</code><code class="n">cleaned_nodes</code><code class="p">,</code> <code class="n">cleaned_relationships</code><code class="p">)</code></pre>
        
        <p>We have to do some cleanup on the nodes because some airports don’t have valid airport codes.
        We’ll give the columns more descriptive names and convert some items into appropriate numeric types.
        We also need to make sure that we have columns named <code>id</code>, <code>dst</code>, and <code>src</code>, as this is expected by Spark’s GraphFrames library.</p>
        
        <p>We’ll also create a separate DataFrame that maps airline codes to airline names.
        We’ll use this later in this chapter:</p>
        
        <pre data-type="programlisting" data-code-language="python"><code class="n">airlines_reference</code> <code class="o">=</code> <code class="p">(</code><code class="n">spark</code><code class="o">.</code><code class="n">read</code><code class="o">.</code><code class="n">csv</code><code class="p">(</code><code class="s2">"data/airlines.csv"</code><code class="p">)</code>
              <code class="o">.</code><code class="n">select</code><code class="p">(</code><code class="s2">"_c1"</code><code class="p">,</code> <code class="s2">"_c3"</code><code class="p">)</code>
              <code class="o">.</code><code class="n">withColumnRenamed</code><code class="p">(</code><code class="s2">"_c1"</code><code class="p">,</code> <code class="s2">"name"</code><code class="p">)</code>
              <code class="o">.</code><code class="n">withColumnRenamed</code><code class="p">(</code><code class="s2">"_c3"</code><code class="p">,</code> <code class="s2">"code"</code><code class="p">))</code>
        
        <code class="n">airlines_reference</code> <code class="o">=</code> <code class="n">airlines_reference</code><code class="p">[</code><code class="n">airlines_reference</code><code class="p">[</code><code class="s2">"code"</code><code class="p">]</code> <code class="o">!=</code> <code class="s2">"null"</code><code class="p">]</code></pre>
        
        
        
        
        
        
        
        
        <section data-type="sect2" class="less_space pagebreak-before" data-pdf-bookmark="Exploratory Analysis"><div class="sect2" id="idm46681361467976">
        <h2>Exploratory Analysis</h2>
        
        <p><a data-type="indexterm" data-primary="airline flight data" data-secondary="exploratory analysis" id="idm46681361450936"></a>Let’s start with some exploratory analysis to see what the data looks like.</p>
        
        <p>First let’s see how many airports we have:</p>
        
        <pre data-type="programlisting" data-code-language="python"><code class="n">g</code><code class="o">.</code><code class="n">vertices</code><code class="o">.</code><code class="n">count</code><code class="p">()</code></pre>
        <pre>1435</pre>
        
        <p>And how many connections do we have between these airports?</p>
        
        <pre data-type="programlisting" data-code-language="python"><code class="n">g</code><code class="o">.</code><code class="n">edges</code><code class="o">.</code><code class="n">count</code><code class="p">()</code></pre>
        <pre>616529</pre>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Popular Airports"><div class="sect2" id="idm46681361442552">
        <h2>Popular Airports</h2>
        
        <p><a data-type="indexterm" data-primary="airline flight data" data-secondary="popular airports" id="ix_ch07-adoc15"></a><a data-type="indexterm" data-primary="Degree Centrality algorithm" data-secondary="with airport data" id="ix_ch07-adoc16"></a>Which airports have the most departing flights?
        We can work out the number of outgoing flights from an airport using the Degree Centrality algorithm:</p>
        
        <pre data-type="programlisting" data-code-language="python"><code class="n">airports_degree</code> <code class="o">=</code> <code class="n">g</code><code class="o">.</code><code class="n">outDegrees</code><code class="o">.</code><code class="n">withColumnRenamed</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="s2">"oId"</code><code class="p">)</code>
        
        <code class="n">full_airports_degree</code> <code class="o">=</code> <code class="p">(</code><code class="n">airports_degree</code>
                                <code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="n">g</code><code class="o">.</code><code class="n">vertices</code><code class="p">,</code> <code class="n">airports_degree</code><code class="o">.</code><code class="n">oId</code> <code class="o">==</code> <code class="n">g</code><code class="o">.</code><code class="n">vertices</code><code class="o">.</code><code class="n">id</code><code class="p">)</code>
                                <code class="o">.</code><code class="n">sort</code><code class="p">(</code><code class="s2">"outDegree"</code><code class="p">,</code> <code class="n">ascending</code><code class="o">=</code><code class="bp">False</code><code class="p">)</code>
                                <code class="o">.</code><code class="n">select</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="s2">"name"</code><code class="p">,</code> <code class="s2">"outDegree"</code><code class="p">))</code>
        
        <code class="n">full_airports_degree</code><code class="o">.</code><code class="n">show</code><code class="p">(</code><code class="n">n</code><code class="o">=</code><code class="mi">10</code><code class="p">,</code> <code class="n">truncate</code><code class="o">=</code><code class="bp">False</code><code class="p">)</code></pre>
        
        <p>If we run that code we’ll see the following output:</p>
        <table>
        
        <thead>
        <tr>
        <th>id</th>
        <th>name</th>
        <th>outDegree</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><p>ATL</p></td>
        <td><p>Hartsfield Jackson Atlanta International Airport</p></td>
        <td><p>33837</p></td>
        </tr>
        <tr>
        <td><p>ORD</p></td>
        <td><p>Chicago O’Hare International Airport</p></td>
        <td><p>28338</p></td>
        </tr>
        <tr>
        <td><p>DFW</p></td>
        <td><p>Dallas Fort Worth International Airport</p></td>
        <td><p>23765</p></td>
        </tr>
        <tr>
        <td><p>CLT</p></td>
        <td><p>Charlotte Douglas International Airport</p></td>
        <td><p>20251</p></td>
        </tr>
        <tr>
        <td><p>DEN</p></td>
        <td><p>Denver International Airport</p></td>
        <td><p>19836</p></td>
        </tr>
        <tr>
        <td><p>LAX</p></td>
        <td><p>Los Angeles International Airport</p></td>
        <td><p>19059</p></td>
        </tr>
        <tr>
        <td><p>PHX</p></td>
        <td><p>Phoenix Sky Harbor International Airport</p></td>
        <td><p>15103</p></td>
        </tr>
        <tr>
        <td><p>SFO</p></td>
        <td><p>San Francisco International Airport</p></td>
        <td><p>14934</p></td>
        </tr>
        <tr>
        <td><p>LGA</p></td>
        <td><p>La Guardia Airport</p></td>
        <td><p>14709</p></td>
        </tr>
        <tr>
        <td><p>IAH</p></td>
        <td><p>George Bush Intercontinental Houston Airport</p></td>
        <td><p>14407</p></td>
        </tr>
        </tbody>
        </table>
        
        <p class="less_space pagebreak-before">Most large US cities show up on this list—Chicago, Atlanta, Los Angeles, and New York all have popular airports.
        We can also create a visual representation of the outgoing flights using the following code:</p>
        
        <pre data-type="programlisting" data-code-language="python"><code class="n">plt</code><code class="o">.</code><code class="n">style</code><code class="o">.</code><code class="n">use</code><code class="p">(</code><code class="s1">'fivethirtyeight'</code><code class="p">)</code>
        
        <code class="n">ax</code> <code class="o">=</code> <code class="p">(</code><code class="n">full_airports_degree</code>
              <code class="o">.</code><code class="n">toPandas</code><code class="p">()</code>
              <code class="o">.</code><code class="n">head</code><code class="p">(</code><code class="mi">10</code><code class="p">)</code>
              <code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">kind</code><code class="o">=</code><code class="s1">'bar'</code><code class="p">,</code> <code class="n">x</code><code class="o">=</code><code class="s1">'id'</code><code class="p">,</code> <code class="n">y</code><code class="o">=</code><code class="s1">'outDegree'</code><code class="p">,</code> <code class="n">legend</code><code class="o">=</code><code class="bp">None</code><code class="p">))</code>
        
        <code class="n">ax</code><code class="o">.</code><code class="n">xaxis</code><code class="o">.</code><code class="n">set_label_text</code><code class="p">(</code><code class="s2">""</code><code class="p">)</code>
        <code class="n">plt</code><code class="o">.</code><code class="n">xticks</code><code class="p">(</code><code class="n">rotation</code><code class="o">=</code><code class="mi">45</code><code class="p">)</code>
        <code class="n">plt</code><code class="o">.</code><code class="n">tight_layout</code><code class="p">()</code>
        <code class="n">plt</code><code class="o">.</code><code class="n">show</code><code class="p">()</code></pre>
        
        <p>The resulting chart can be seen in <a data-type="xref" href="#airports-outgoing">Figure&nbsp;7-11</a>.</p>
        
        <p>It’s quite striking how suddenly the number of flights drops off.
        Denver International Airport (DEN), the fifth most popular airport, has just over half as many outgoing fights as Hartsfield Jackson Atlanta International Airport (ATL), in first place.<a data-type="indexterm" data-startref="ix_ch07-adoc16" id="idm46681360259848"></a><a data-type="indexterm" data-startref="ix_ch07-adoc15" id="idm46681360259208"></a></p>
        
        <figure class="width-75"><div id="airports-outgoing" class="figure">
        <img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/gral_rr_0711.png" alt="gral rr 0711" width="1342" height="979">
        <h6><span class="label">Figure 7-11. </span>Outgoing flights by airport</h6>
        </div></figure>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" class="less_space pagebreak-before" data-pdf-bookmark="Delays from ORD"><div class="sect2" id="idm46681361442056">
        <h2>Delays from ORD</h2>
        
        <p><a data-type="indexterm" data-primary="airline flight data" data-secondary="delays from ORD" id="ix_ch07-adoc17"></a><a data-type="indexterm" data-primary="Chicago O'Hare International Airport (ORD), data in delays from" id="ix_ch07-adoc18"></a>In our scenario, we frequently travel between the west and east coasts and want to see delays through a midpoint hub like Chicago O’Hare International Airport (ORD).
        This dataset contains flight delay data, so we can dive right in.</p>
        
        <p>The following code finds the average delay of flights departing from ORD grouped by the destination airport:</p>
        
        <pre data-type="programlisting" data-code-language="python"><code class="n">delayed_flights</code> <code class="o">=</code> <code class="p">(</code><code class="n">g</code><code class="o">.</code><code class="n">edges</code>
                           <code class="o">.</code><code class="n">filter</code><code class="p">(</code><code class="s2">"src = 'ORD' and deptDelay &gt; 0"</code><code class="p">)</code>
                           <code class="o">.</code><code class="n">groupBy</code><code class="p">(</code><code class="s2">"dst"</code><code class="p">)</code>
                           <code class="o">.</code><code class="n">agg</code><code class="p">(</code><code class="n">F</code><code class="o">.</code><code class="n">avg</code><code class="p">(</code><code class="s2">"deptDelay"</code><code class="p">),</code> <code class="n">F</code><code class="o">.</code><code class="n">count</code><code class="p">(</code><code class="s2">"deptDelay"</code><code class="p">))</code>
                           <code class="o">.</code><code class="n">withColumn</code><code class="p">(</code><code class="s2">"averageDelay"</code><code class="p">,</code>
                                       <code class="n">F</code><code class="o">.</code><code class="n">round</code><code class="p">(</code><code class="n">F</code><code class="o">.</code><code class="n">col</code><code class="p">(</code><code class="s2">"avg(deptDelay)"</code><code class="p">),</code> <code class="mi">2</code><code class="p">))</code>
                           <code class="o">.</code><code class="n">withColumn</code><code class="p">(</code><code class="s2">"numberOfDelays"</code><code class="p">,</code>
                                       <code class="n">F</code><code class="o">.</code><code class="n">col</code><code class="p">(</code><code class="s2">"count(deptDelay)"</code><code class="p">)))</code>
        
        <code class="p">(</code><code class="n">delayed_flights</code>
         <code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="n">g</code><code class="o">.</code><code class="n">vertices</code><code class="p">,</code> <code class="n">delayed_flights</code><code class="o">.</code><code class="n">dst</code> <code class="o">==</code> <code class="n">g</code><code class="o">.</code><code class="n">vertices</code><code class="o">.</code><code class="n">id</code><code class="p">)</code>
         <code class="o">.</code><code class="n">sort</code><code class="p">(</code><code class="n">F</code><code class="o">.</code><code class="n">desc</code><code class="p">(</code><code class="s2">"averageDelay"</code><code class="p">))</code>
         <code class="o">.</code><code class="n">select</code><code class="p">(</code><code class="s2">"dst"</code><code class="p">,</code> <code class="s2">"name"</code><code class="p">,</code> <code class="s2">"averageDelay"</code><code class="p">,</code> <code class="s2">"numberOfDelays"</code><code class="p">)</code>
         <code class="o">.</code><code class="n">show</code><code class="p">(</code><code class="n">n</code><code class="o">=</code><code class="mi">10</code><code class="p">,</code> <code class="n">truncate</code><code class="o">=</code><code class="bp">False</code><code class="p">))</code></pre>
        
        <p>Once we’ve calculated the average delay grouped by destination we join the resulting Spark DataFrame with a DataFrame containing all vertices, so that we can print the full name of the destination airport.</p>
        
        <p>Running this code returns the 10 destinations with the worst delays:</p>
        <table>
        
        <thead>
        <tr>
        <th>dst</th>
        <th>name</th>
        <th>averageDelay</th>
        <th>numberOfDelays</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><p>CKB</p></td>
        <td><p>North Central West Virginia Airport</p></td>
        <td><p>145.08</p></td>
        <td><p>12</p></td>
        </tr>
        <tr>
        <td><p>OGG</p></td>
        <td><p>Kahului Airport</p></td>
        <td><p>119.67</p></td>
        <td><p>9</p></td>
        </tr>
        <tr>
        <td><p>MQT</p></td>
        <td><p>Sawyer International Airport</p></td>
        <td><p>114.75</p></td>
        <td><p>12</p></td>
        </tr>
        <tr>
        <td><p>MOB</p></td>
        <td><p>Mobile Regional Airport</p></td>
        <td><p>102.2</p></td>
        <td><p>10</p></td>
        </tr>
        <tr>
        <td><p>TTN</p></td>
        <td><p>Trenton Mercer Airport</p></td>
        <td><p>101.18</p></td>
        <td><p>17</p></td>
        </tr>
        <tr>
        <td><p>AVL</p></td>
        <td><p>Asheville Regional Airport</p></td>
        <td><p>98.5</p></td>
        <td><p>28</p></td>
        </tr>
        <tr>
        <td><p>ISP</p></td>
        <td><p>Long Island Mac Arthur Airport</p></td>
        <td><p>94.08</p></td>
        <td><p>13</p></td>
        </tr>
        <tr>
        <td><p>ANC</p></td>
        <td><p>Ted Stevens Anchorage International Airport</p></td>
        <td><p>83.74</p></td>
        <td><p>23</p></td>
        </tr>
        <tr>
        <td><p>BTV</p></td>
        <td><p>Burlington International Airport</p></td>
        <td><p>83.2</p></td>
        <td><p>25</p></td>
        </tr>
        <tr>
        <td><p>CMX</p></td>
        <td><p>Houghton County Memorial Airport</p></td>
        <td><p>79.18</p></td>
        <td><p>17</p></td>
        </tr>
        </tbody>
        </table>
        
        <p>This is interesting, but one data point really stands out: 12 flights from ORD to CKB have been delayed by more than 2 hours on average!
        Let’s find the flights between those airports and see what’s going on:</p>
        
        <pre data-type="programlisting" data-code-language="python"><code class="n">from_expr</code> <code class="o">=</code> <code class="s1">'id = "ORD"'</code>
        <code class="n">to_expr</code> <code class="o">=</code> <code class="s1">'id = "CKB"'</code>
        <code class="n">ord_to_ckb</code> <code class="o">=</code> <code class="n">g</code><code class="o">.</code><code class="n">bfs</code><code class="p">(</code><code class="n">from_expr</code><code class="p">,</code> <code class="n">to_expr</code><code class="p">)</code>
        
        <code class="n">ord_to_ckb</code> <code class="o">=</code> <code class="n">ord_to_ckb</code><code class="o">.</code><code class="n">select</code><code class="p">(</code>
          <code class="n">F</code><code class="o">.</code><code class="n">col</code><code class="p">(</code><code class="s2">"e0.date"</code><code class="p">),</code>
          <code class="n">F</code><code class="o">.</code><code class="n">col</code><code class="p">(</code><code class="s2">"e0.time"</code><code class="p">),</code>
          <code class="n">F</code><code class="o">.</code><code class="n">col</code><code class="p">(</code><code class="s2">"e0.flightNumber"</code><code class="p">),</code>
          <code class="n">F</code><code class="o">.</code><code class="n">col</code><code class="p">(</code><code class="s2">"e0.deptDelay"</code><code class="p">))</code></pre>
        
        <p>We can then plot the flights with the following code:</p>
        
        <pre data-type="programlisting" data-code-language="python"><code class="n">ax</code> <code class="o">=</code> <code class="p">(</code><code class="n">ord_to_ckb</code>
              <code class="o">.</code><code class="n">sort</code><code class="p">(</code><code class="s2">"date"</code><code class="p">)</code>
              <code class="o">.</code><code class="n">toPandas</code><code class="p">()</code>
              <code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">kind</code><code class="o">=</code><code class="s1">'bar'</code><code class="p">,</code> <code class="n">x</code><code class="o">=</code><code class="s1">'date'</code><code class="p">,</code> <code class="n">y</code><code class="o">=</code><code class="s1">'deptDelay'</code><code class="p">,</code> <code class="n">legend</code><code class="o">=</code><code class="bp">None</code><code class="p">))</code>
        
        <code class="n">ax</code><code class="o">.</code><code class="n">xaxis</code><code class="o">.</code><code class="n">set_label_text</code><code class="p">(</code><code class="s2">""</code><code class="p">)</code>
        <code class="n">plt</code><code class="o">.</code><code class="n">tight_layout</code><code class="p">()</code>
        <code class="n">plt</code><code class="o">.</code><code class="n">show</code><code class="p">()</code></pre>
        
        <p>If we run that code we’ll get the chart in <a data-type="xref" href="#ord-ckb-flights">Figure&nbsp;7-12</a>.</p>
        
        <figure><div id="ord-ckb-flights" class="figure">
        <img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/gral_rr_0712.png" alt="gral rr 0712" width="1342" height="981">
        <h6><span class="label">Figure 7-12. </span>Flights from ORD to CKB</h6>
        </div></figure>
        
        <p>About half of the flights were delayed, but the delay of more than 14 hours on May 2, 2018, has massively skewed the average.</p>
        
        <p>What if we want to find delays coming into and going out of a coastal airport?
        Those airports are often affected by adverse weather conditions, so we might be able to find some interesting delays.<a data-type="indexterm" data-startref="ix_ch07-adoc18" id="idm46681359857448"></a><a data-type="indexterm" data-startref="ix_ch07-adoc17" id="idm46681359856744"></a></p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Bad Day at SFO"><div class="sect2" id="idm46681360255736">
        <h2>Bad Day at SFO</h2>
        
        <p><a data-type="indexterm" data-primary="airline flight data" data-secondary="fog-related delays from SFO" id="ix_ch07-adoc19"></a><a data-type="indexterm" data-primary="San Francisco International Airport (SFO), data in fog-related delays from" id="ix_ch07-adoc20"></a>Let’s consider delays at an airport known for fog-related “low ceiling” issues: San Francisco International Airport (SFO).
        One method for analysis would be to look at <em>motifs</em>, which are recurrent subgraphs or patterns.</p>
        <div data-type="note" epub:type="note"><h6>Note</h6>
        <p>The equivalent to motifs in Neo4j is graph patterns, which are found using the <code>MATCH</code> clause or with pattern expressions in Cypher.</p>
        </div>
        
        <p>GraphFrames lets us <a href="http://bit.ly/2TZQ89B">search for motifs</a>, so we can use the structure of flights as part of a query. Let’s use motifs to find the most-delayed flights going into and out of SFO on May 11, 2018.
        The following code will find these delays:</p>
        
        <pre data-type="programlisting" data-code-language="python"><code class="n">motifs</code> <code class="o">=</code> <code class="p">(</code><code class="n">g</code><code class="o">.</code><code class="n">find</code><code class="p">(</code><code class="s2">"(a)-[ab]-&gt;(b); (b)-[bc]-&gt;(c)"</code><code class="p">)</code>
                  <code class="o">.</code><code class="n">filter</code><code class="p">(</code><code class="s2">"""(b.id = 'SFO') and</code>
        <code class="s2">                  (ab.date = '2018-05-11' and bc.date = '2018-05-11') and</code>
        <code class="s2">                  (ab.arrDelay &gt; 30 or bc.deptDelay &gt; 30) and</code>
        <code class="s2">                  (ab.flightNumber = bc.flightNumber) and</code>
        <code class="s2">                  (ab.airline = bc.airline) and</code>
        <code class="s2">                  (ab.time &lt; bc.time)"""</code><code class="p">))</code></pre>
        
        <p>The motif <code>(a)-[ab]-&gt;(b); (b)-[bc]-&gt;(c)</code> finds flights coming into and out from the same airport.
        We then filter the resulting pattern to find flights with:</p>
        
        <ul>
        <li>
        <p>A sequence where the first flight arrives at SFO and the second flight departs from SFO</p>
        </li>
        <li>
        <p>Delays of over 30 minutes when arriving at <em>or</em> departing from SFO</p>
        </li>
        <li>
        <p>The same flight number and airline</p>
        </li>
        </ul>
        
        <p>We can then take the result and select the columns we’re interested in:</p>
        
        <pre data-type="programlisting" data-code-language="python"><code class="n">result</code> <code class="o">=</code> <code class="p">(</code><code class="n">motifs</code><code class="o">.</code><code class="n">withColumn</code><code class="p">(</code><code class="s2">"delta"</code><code class="p">,</code> <code class="n">motifs</code><code class="o">.</code><code class="n">bc</code><code class="o">.</code><code class="n">deptDelay</code> <code class="o">-</code> <code class="n">motifs</code><code class="o">.</code><code class="n">ab</code><code class="o">.</code><code class="n">arrDelay</code><code class="p">)</code>
                  <code class="o">.</code><code class="n">select</code><code class="p">(</code><code class="s2">"ab"</code><code class="p">,</code> <code class="s2">"bc"</code><code class="p">,</code> <code class="s2">"delta"</code><code class="p">)</code>
                  <code class="o">.</code><code class="n">sort</code><code class="p">(</code><code class="s2">"delta"</code><code class="p">,</code> <code class="n">ascending</code><code class="o">=</code><code class="bp">False</code><code class="p">))</code>
        
        <code class="n">result</code><code class="o">.</code><code class="n">select</code><code class="p">(</code>
            <code class="n">F</code><code class="o">.</code><code class="n">col</code><code class="p">(</code><code class="s2">"ab.src"</code><code class="p">)</code><code class="o">.</code><code class="n">alias</code><code class="p">(</code><code class="s2">"a1"</code><code class="p">),</code>
            <code class="n">F</code><code class="o">.</code><code class="n">col</code><code class="p">(</code><code class="s2">"ab.time"</code><code class="p">)</code><code class="o">.</code><code class="n">alias</code><code class="p">(</code><code class="s2">"a1DeptTime"</code><code class="p">),</code>
            <code class="n">F</code><code class="o">.</code><code class="n">col</code><code class="p">(</code><code class="s2">"ab.arrDelay"</code><code class="p">),</code>
            <code class="n">F</code><code class="o">.</code><code class="n">col</code><code class="p">(</code><code class="s2">"ab.dst"</code><code class="p">)</code><code class="o">.</code><code class="n">alias</code><code class="p">(</code><code class="s2">"a2"</code><code class="p">),</code>
            <code class="n">F</code><code class="o">.</code><code class="n">col</code><code class="p">(</code><code class="s2">"bc.time"</code><code class="p">)</code><code class="o">.</code><code class="n">alias</code><code class="p">(</code><code class="s2">"a2DeptTime"</code><code class="p">),</code>
            <code class="n">F</code><code class="o">.</code><code class="n">col</code><code class="p">(</code><code class="s2">"bc.deptDelay"</code><code class="p">),</code>
            <code class="n">F</code><code class="o">.</code><code class="n">col</code><code class="p">(</code><code class="s2">"bc.dst"</code><code class="p">)</code><code class="o">.</code><code class="n">alias</code><code class="p">(</code><code class="s2">"a3"</code><code class="p">),</code>
            <code class="n">F</code><code class="o">.</code><code class="n">col</code><code class="p">(</code><code class="s2">"ab.airline"</code><code class="p">),</code>
            <code class="n">F</code><code class="o">.</code><code class="n">col</code><code class="p">(</code><code class="s2">"ab.flightNumber"</code><code class="p">),</code>
            <code class="n">F</code><code class="o">.</code><code class="n">col</code><code class="p">(</code><code class="s2">"delta"</code><code class="p">)</code>
        <code class="p">)</code><code class="o">.</code><code class="n">show</code><code class="p">()</code></pre>
        
        <p>We’re also calculating the <em>delta</em> between the arriving and departing flights to see which delays we can truly attribute to SFO.</p>
        
        <p>If we execute this code we’ll get the following result:</p>
        <table>
        
        <thead>
        <tr>
        <th>airline</th>
        <th>flightNumber</th>
        <th>a1</th>
        <th>a1DeptTime</th>
        <th>arrDelay</th>
        <th>a2</th>
        <th>a2DeptTime</th>
        <th>deptDelay</th>
        <th>a3</th>
        <th>delta</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><p>WN</p></td>
        <td><p>1454</p></td>
        <td><p>PDX</p></td>
        <td><p>1130</p></td>
        <td><p>-18.0</p></td>
        <td><p>SFO</p></td>
        <td><p>1350</p></td>
        <td><p>178.0</p></td>
        <td><p>BUR</p></td>
        <td><p>196.0</p></td>
        </tr>
        <tr>
        <td><p>OO</p></td>
        <td><p>5700</p></td>
        <td><p>ACV</p></td>
        <td><p>1755</p></td>
        <td><p>-9.0</p></td>
        <td><p>SFO</p></td>
        <td><p>2235</p></td>
        <td><p>64.0</p></td>
        <td><p>RDM</p></td>
        <td><p>73.0</p></td>
        </tr>
        <tr>
        <td><p>UA</p></td>
        <td><p>753</p></td>
        <td><p>BWI</p></td>
        <td><p>700</p></td>
        <td><p>-3.0</p></td>
        <td><p>SFO</p></td>
        <td><p>1125</p></td>
        <td><p>49.0</p></td>
        <td><p>IAD</p></td>
        <td><p>52.0</p></td>
        </tr>
        <tr>
        <td><p>UA</p></td>
        <td><p>1900</p></td>
        <td><p>ATL</p></td>
        <td><p>740</p></td>
        <td><p>40.0</p></td>
        <td><p>SFO</p></td>
        <td><p>1110</p></td>
        <td><p>77.0</p></td>
        <td><p>SAN</p></td>
        <td><p>37.0</p></td>
        </tr>
        <tr>
        <td><p>WN</p></td>
        <td><p>157</p></td>
        <td><p>BUR</p></td>
        <td><p>1405</p></td>
        <td><p>25.0</p></td>
        <td><p>SFO</p></td>
        <td><p>1600</p></td>
        <td><p>39.0</p></td>
        <td><p>PDX</p></td>
        <td><p>14.0</p></td>
        </tr>
        <tr>
        <td><p>DL</p></td>
        <td><p>745</p></td>
        <td><p>DTW</p></td>
        <td><p>835</p></td>
        <td><p>34.0</p></td>
        <td><p>SFO</p></td>
        <td><p>1135</p></td>
        <td><p>44.0</p></td>
        <td><p>DTW</p></td>
        <td><p>10.0</p></td>
        </tr>
        <tr>
        <td><p>WN</p></td>
        <td><p>1783</p></td>
        <td><p>DEN</p></td>
        <td><p>1830</p></td>
        <td><p>25.0</p></td>
        <td><p>SFO</p></td>
        <td><p>2045</p></td>
        <td><p>33.0</p></td>
        <td><p>BUR</p></td>
        <td><p>8.0</p></td>
        </tr>
        <tr>
        <td><p>WN</p></td>
        <td><p>5789</p></td>
        <td><p>PDX</p></td>
        <td><p>1855</p></td>
        <td><p>119.0</p></td>
        <td><p>SFO</p></td>
        <td><p>2120</p></td>
        <td><p>117.0</p></td>
        <td><p>DEN</p></td>
        <td><p>-2.0</p></td>
        </tr>
        <tr>
        <td><p>WN</p></td>
        <td><p>1585</p></td>
        <td><p>BUR</p></td>
        <td><p>2025</p></td>
        <td><p>31.0</p></td>
        <td><p>SFO</p></td>
        <td><p>2230</p></td>
        <td><p>11.0</p></td>
        <td><p>PHX</p></td>
        <td><p>-20.0</p></td>
        </tr>
        </tbody>
        </table>
        
        <p>The worst offender, WN 1454, is shown in the top row; it arrived early but departed almost three hours late.
        We can also see that there are some negative values in the <code>arrDelay</code> column; this means that the flight into SFO was early.</p>
        
        <p>Also notice that some flights, such as WN 5789 and WN 1585, made up time while on the ground in SFO, as shown with a negative delta.<a data-type="indexterm" data-startref="ix_ch07-adoc20" id="idm46681359568264"></a><a data-type="indexterm" data-startref="ix_ch07-adoc19" id="idm46681359567560"></a></p>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" data-pdf-bookmark="Interconnected Airports by Airline"><div class="sect2" id="idm46681359855480">
        <h2>Interconnected Airports by Airline</h2>
        
        <p><a data-type="indexterm" data-primary="airline flight data" data-secondary="interconnected airports by airline" id="ix_ch07-adoc21"></a>Now let’s say we’ve traveled a lot, and those frequent flyer points we’re determined to use to see as many destinations as efficiently as possible are soon to expire.
        If we start from a specific US airport, how many different airports can we visit and come back to the starting airport using the same airline?</p>
        
        <p class="less_space pagebreak-before">Let’s first identify all the airlines and work out how many flights there are on each of them:</p>
        
        <pre data-type="programlisting" data-code-language="python"><code class="n">airlines</code> <code class="o">=</code> <code class="p">(</code><code class="n">g</code><code class="o">.</code><code class="n">edges</code>
         <code class="o">.</code><code class="n">groupBy</code><code class="p">(</code><code class="s2">"airline"</code><code class="p">)</code>
         <code class="o">.</code><code class="n">agg</code><code class="p">(</code><code class="n">F</code><code class="o">.</code><code class="n">count</code><code class="p">(</code><code class="s2">"airline"</code><code class="p">)</code><code class="o">.</code><code class="n">alias</code><code class="p">(</code><code class="s2">"flights"</code><code class="p">))</code>
         <code class="o">.</code><code class="n">sort</code><code class="p">(</code><code class="s2">"flights"</code><code class="p">,</code> <code class="n">ascending</code><code class="o">=</code><code class="bp">False</code><code class="p">))</code>
        
        <code class="n">full_name_airlines</code> <code class="o">=</code> <code class="p">(</code><code class="n">airlines_reference</code>
                              <code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="n">airlines</code><code class="p">,</code> <code class="n">airlines</code><code class="o">.</code><code class="n">airline</code>
                                    <code class="o">==</code> <code class="n">airlines_reference</code><code class="o">.</code><code class="n">code</code><code class="p">)</code>
                              <code class="o">.</code><code class="n">select</code><code class="p">(</code><code class="s2">"code"</code><code class="p">,</code> <code class="s2">"name"</code><code class="p">,</code> <code class="s2">"flights"</code><code class="p">))</code></pre>
        
        <p>And now let’s create a bar chart showing our airlines:</p>
        
        <pre data-type="programlisting" data-code-language="python"><code class="n">ax</code> <code class="o">=</code> <code class="p">(</code><code class="n">full_name_airlines</code><code class="o">.</code><code class="n">toPandas</code><code class="p">()</code>
              <code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">kind</code><code class="o">=</code><code class="s1">'bar'</code><code class="p">,</code> <code class="n">x</code><code class="o">=</code><code class="s1">'name'</code><code class="p">,</code> <code class="n">y</code><code class="o">=</code><code class="s1">'flights'</code><code class="p">,</code> <code class="n">legend</code><code class="o">=</code><code class="bp">None</code><code class="p">))</code>
        
        <code class="n">ax</code><code class="o">.</code><code class="n">xaxis</code><code class="o">.</code><code class="n">set_label_text</code><code class="p">(</code><code class="s2">""</code><code class="p">)</code>
        <code class="n">plt</code><code class="o">.</code><code class="n">tight_layout</code><code class="p">()</code>
        <code class="n">plt</code><code class="o">.</code><code class="n">show</code><code class="p">()</code></pre>
        
        <p>If we run that query we’ll get the output in <a data-type="xref" href="#airline-counts">Figure&nbsp;7-13</a>.</p>
        
        <figure><div id="airline-counts" class="figure">
        <img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/gral_rr_0713.png" alt="gral rr 0713" width="1341" height="982">
        <h6><span class="label">Figure 7-13. </span>The number of flights by airline</h6>
        </div></figure>
        
        <p><a data-type="indexterm" data-primary="Strongly Connected Components (SCC) algorithm" data-secondary="with airport data" id="ix_ch07-adoc22"></a>Now let’s write a function that uses the Strongly Connected Components algorithm to find airport groupings for each airline where all the airports have flights to and from all the other airports in that group:</p>
        
        <pre data-type="programlisting" data-code-language="python"><code class="k">def</code> <code class="nf">find_scc_components</code><code class="p">(</code><code class="n">g</code><code class="p">,</code> <code class="n">airline</code><code class="p">):</code>
            <code class="c1"># Create a subgraph containing only flights on the provided airline</code>
            <code class="n">airline_relationships</code> <code class="o">=</code> <code class="n">g</code><code class="o">.</code><code class="n">edges</code><code class="p">[</code><code class="n">g</code><code class="o">.</code><code class="n">edges</code><code class="o">.</code><code class="n">airline</code> <code class="o">==</code> <code class="n">airline</code><code class="p">]</code>
            <code class="n">airline_graph</code> <code class="o">=</code> <code class="n">GraphFrame</code><code class="p">(</code><code class="n">g</code><code class="o">.</code><code class="n">vertices</code><code class="p">,</code> <code class="n">airline_relationships</code><code class="p">)</code>
        
            <code class="c1"># Calculate the Strongly Connected Components</code>
            <code class="n">scc</code> <code class="o">=</code> <code class="n">airline_graph</code><code class="o">.</code><code class="n">stronglyConnectedComponents</code><code class="p">(</code><code class="n">maxIter</code><code class="o">=</code><code class="mi">10</code><code class="p">)</code>
        
            <code class="c1"># Find the size of the biggest component and return that</code>
            <code class="k">return</code> <code class="p">(</code><code class="n">scc</code>
                <code class="o">.</code><code class="n">groupBy</code><code class="p">(</code><code class="s2">"component"</code><code class="p">)</code>
                <code class="o">.</code><code class="n">agg</code><code class="p">(</code><code class="n">F</code><code class="o">.</code><code class="n">count</code><code class="p">(</code><code class="s2">"id"</code><code class="p">)</code><code class="o">.</code><code class="n">alias</code><code class="p">(</code><code class="s2">"size"</code><code class="p">))</code>
                <code class="o">.</code><code class="n">sort</code><code class="p">(</code><code class="s2">"size"</code><code class="p">,</code> <code class="n">ascending</code><code class="o">=</code><code class="bp">False</code><code class="p">)</code>
                <code class="o">.</code><code class="n">take</code><code class="p">(</code><code class="mi">1</code><code class="p">)[</code><code class="mi">0</code><code class="p">][</code><code class="s2">"size"</code><code class="p">])</code></pre>
        
        <p>We can write the following code to create a DataFrame containing each airline and the number of airports of its largest strongly connected component:</p>
        
        <pre data-type="programlisting" data-code-language="python"><code class="c1"># Calculate the largest strongly connected component for each airline</code>
        <code class="n">airline_scc</code> <code class="o">=</code> <code class="p">[(</code><code class="n">airline</code><code class="p">,</code> <code class="n">find_scc_components</code><code class="p">(</code><code class="n">g</code><code class="p">,</code> <code class="n">airline</code><code class="p">))</code>
                       <code class="k">for</code> <code class="n">airline</code> <code class="ow">in</code> <code class="n">airlines</code><code class="o">.</code><code class="n">toPandas</code><code class="p">()[</code><code class="s2">"airline"</code><code class="p">]</code><code class="o">.</code><code class="n">tolist</code><code class="p">()]</code>
        <code class="n">airline_scc_df</code> <code class="o">=</code> <code class="n">spark</code><code class="o">.</code><code class="n">createDataFrame</code><code class="p">(</code><code class="n">airline_scc</code><code class="p">,</code> <code class="p">[</code><code class="s1">'id'</code><code class="p">,</code> <code class="s1">'sccCount'</code><code class="p">])</code>
        
        <code class="c1"># Join the SCC DataFrame with the airlines DataFrame so that we can show</code>
        <code class="c1"># the number of flights an airline has alongside the number of</code>
        <code class="c1"># airports reachable in its biggest component</code>
        <code class="n">airline_reach</code> <code class="o">=</code> <code class="p">(</code><code class="n">airline_scc_df</code>
         <code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="n">full_name_airlines</code><code class="p">,</code> <code class="n">full_name_airlines</code><code class="o">.</code><code class="n">code</code> <code class="o">==</code> <code class="n">airline_scc_df</code><code class="o">.</code><code class="n">id</code><code class="p">)</code>
         <code class="o">.</code><code class="n">select</code><code class="p">(</code><code class="s2">"code"</code><code class="p">,</code> <code class="s2">"name"</code><code class="p">,</code> <code class="s2">"flights"</code><code class="p">,</code> <code class="s2">"sccCount"</code><code class="p">)</code>
         <code class="o">.</code><code class="n">sort</code><code class="p">(</code><code class="s2">"sccCount"</code><code class="p">,</code> <code class="n">ascending</code><code class="o">=</code><code class="bp">False</code><code class="p">))</code></pre>
        
        <p>And now let’s create a bar chart showing our airlines:</p>
        
        <pre data-type="programlisting" data-code-language="python"><code class="n">ax</code> <code class="o">=</code> <code class="p">(</code><code class="n">airline_reach</code><code class="o">.</code><code class="n">toPandas</code><code class="p">()</code>
              <code class="o">.</code><code class="n">plot</code><code class="p">(</code><code class="n">kind</code><code class="o">=</code><code class="s1">'bar'</code><code class="p">,</code> <code class="n">x</code><code class="o">=</code><code class="s1">'name'</code><code class="p">,</code> <code class="n">y</code><code class="o">=</code><code class="s1">'sccCount'</code><code class="p">,</code> <code class="n">legend</code><code class="o">=</code><code class="bp">None</code><code class="p">))</code>
        
        <code class="n">ax</code><code class="o">.</code><code class="n">xaxis</code><code class="o">.</code><code class="n">set_label_text</code><code class="p">(</code><code class="s2">""</code><code class="p">)</code>
        <code class="n">plt</code><code class="o">.</code><code class="n">tight_layout</code><code class="p">()</code>
        <code class="n">plt</code><code class="o">.</code><code class="n">show</code><code class="p">()</code></pre>
        
        <p>If we run that query we’ll get the output in <a data-type="xref" href="#airlines-scc-counts">Figure&nbsp;7-14</a>.</p>
        
        <figure><div id="airlines-scc-counts" class="figure">
        <img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/gral_rr_0714.png" alt="gral rr 0714" width="1341" height="982">
        <h6><span class="label">Figure 7-14. </span>The number of reachable airports by airline</h6>
        </div></figure>
        
        <p>SkyWest has the largest community, with over 200 strongly connected airports.
        This might partially reflect its business model as an affiliate airline which operates aircraft used on flights for partner airlines.
        Southwest, on the other hand, has the highest number of flights but only connects around 80 airports.</p>
        
        <p>Now let’s say most of the frequent flyer points we have are with Delta Airlines (DL). Can we find airports that form communities within the network for that particular airline carrier?</p>
        
        <pre data-type="programlisting" data-code-language="python"><code class="n">airline_relationships</code> <code class="o">=</code> <code class="n">g</code><code class="o">.</code><code class="n">edges</code><code class="o">.</code><code class="n">filter</code><code class="p">(</code><code class="s2">"airline = 'DL'"</code><code class="p">)</code>
        <code class="n">airline_graph</code> <code class="o">=</code> <code class="n">GraphFrame</code><code class="p">(</code><code class="n">g</code><code class="o">.</code><code class="n">vertices</code><code class="p">,</code> <code class="n">airline_relationships</code><code class="p">)</code>
        
        <code class="n">clusters</code> <code class="o">=</code> <code class="n">airline_graph</code><code class="o">.</code><code class="n">labelPropagation</code><code class="p">(</code><code class="n">maxIter</code><code class="o">=</code><code class="mi">10</code><code class="p">)</code>
        <code class="p">(</code><code class="n">clusters</code>
         <code class="o">.</code><code class="n">sort</code><code class="p">(</code><code class="s2">"label"</code><code class="p">)</code>
         <code class="o">.</code><code class="n">groupby</code><code class="p">(</code><code class="s2">"label"</code><code class="p">)</code>
         <code class="o">.</code><code class="n">agg</code><code class="p">(</code><code class="n">F</code><code class="o">.</code><code class="n">collect_list</code><code class="p">(</code><code class="s2">"id"</code><code class="p">)</code><code class="o">.</code><code class="n">alias</code><code class="p">(</code><code class="s2">"airports"</code><code class="p">),</code>
              <code class="n">F</code><code class="o">.</code><code class="n">count</code><code class="p">(</code><code class="s2">"id"</code><code class="p">)</code><code class="o">.</code><code class="n">alias</code><code class="p">(</code><code class="s2">"count"</code><code class="p">))</code>
         <code class="o">.</code><code class="n">sort</code><code class="p">(</code><code class="s2">"count"</code><code class="p">,</code> <code class="n">ascending</code><code class="o">=</code><code class="bp">False</code><code class="p">)</code>
         <code class="o">.</code><code class="n">show</code><code class="p">(</code><code class="n">truncate</code><code class="o">=</code><code class="mi">70</code><code class="p">,</code> <code class="n">n</code><code class="o">=</code><code class="mi">10</code><code class="p">))</code></pre>
        
        <p class="less_space pagebreak-before">If we run that query we’ll see the following output:</p>
        <table>
        
        <thead>
        <tr>
        <th>label</th>
        <th>airports</th>
        <th>count</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><p>1606317768706</p></td>
        <td><p>[IND, ORF, ATW, RIC, TRI, XNA, ECP, AVL, JAX, SYR, BHM, GSO, MEM, C…</p></td>
        <td><p>89</p></td>
        </tr>
        <tr>
        <td><p>1219770712067</p></td>
        <td><p>[GEG, SLC, DTW, LAS, SEA, BOS, MSN, SNA, JFK, TVC, LIH, JAC, FLL, M…</p></td>
        <td><p>53</p></td>
        </tr>
        <tr>
        <td><p>17179869187</p></td>
        <td><p>[RHV]</p></td>
        <td><p>1</p></td>
        </tr>
        <tr>
        <td><p>25769803777</p></td>
        <td><p>[CWT]</p></td>
        <td><p>1</p></td>
        </tr>
        <tr>
        <td><p>25769803776</p></td>
        <td><p>[CDW]</p></td>
        <td><p>1</p></td>
        </tr>
        <tr>
        <td><p>25769803782</p></td>
        <td><p>[KNW]</p></td>
        <td><p>1</p></td>
        </tr>
        <tr>
        <td><p>25769803778</p></td>
        <td><p>[DRT]</p></td>
        <td><p>1</p></td>
        </tr>
        <tr>
        <td><p>25769803779</p></td>
        <td><p>[FOK]</p></td>
        <td><p>1</p></td>
        </tr>
        <tr>
        <td><p>25769803781</p></td>
        <td><p>[HVR]</p></td>
        <td><p>1</p></td>
        </tr>
        <tr>
        <td><p>42949672962</p></td>
        <td><p>[GTF]</p></td>
        <td><p>1</p></td>
        </tr>
        </tbody>
        </table>
        
        <p>Most of the airports DL uses have clustered into two groups; let’s drill down into those. There are too many airports to show here, so we’ll just show the airports with the biggest degree (ingoing and outgoing flights).
        We can write the following code to calculate airport degree:</p>
        
        <pre data-type="programlisting" data-code-language="python"><code class="n">all_flights</code> <code class="o">=</code> <code class="n">g</code><code class="o">.</code><code class="n">degrees</code><code class="o">.</code><code class="n">withColumnRenamed</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="s2">"aId"</code><code class="p">)</code></pre>
        
        <p>We’ll then combine this with the airports that belong to the largest cluster:</p>
        
        <pre data-type="programlisting" data-code-language="python"><code class="p">(</code><code class="n">clusters</code>
         <code class="o">.</code><code class="n">filter</code><code class="p">(</code><code class="s2">"label=1606317768706"</code><code class="p">)</code>
         <code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="n">all_flights</code><code class="p">,</code> <code class="n">all_flights</code><code class="o">.</code><code class="n">aId</code> <code class="o">==</code> <code class="n">clusters</code><code class="o">.</code><code class="n">id</code><code class="p">)</code>
         <code class="o">.</code><code class="n">sort</code><code class="p">(</code><code class="s2">"degree"</code><code class="p">,</code> <code class="n">ascending</code><code class="o">=</code><code class="bp">False</code><code class="p">)</code>
         <code class="o">.</code><code class="n">select</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="s2">"name"</code><code class="p">,</code> <code class="s2">"degree"</code><code class="p">)</code>
         <code class="o">.</code><code class="n">show</code><code class="p">(</code><code class="n">truncate</code><code class="o">=</code><code class="bp">False</code><code class="p">))</code></pre>
        
        <p>If we run that query we’ll get this output:</p>
        <table>
        
        <thead>
        <tr>
        <th>id</th>
        <th>name</th>
        <th>degree</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><p>DFW</p></td>
        <td><p>Dallas Fort Worth International Airport</p></td>
        <td><p>47514</p></td>
        </tr>
        <tr>
        <td><p>CLT</p></td>
        <td><p>Charlotte Douglas International Airport</p></td>
        <td><p>40495</p></td>
        </tr>
        <tr>
        <td><p>IAH</p></td>
        <td><p>George Bush Intercontinental Houston Airport</p></td>
        <td><p>28814</p></td>
        </tr>
        <tr>
        <td><p>EWR</p></td>
        <td><p>Newark Liberty International Airport</p></td>
        <td><p>25131</p></td>
        </tr>
        <tr>
        <td><p>PHL</p></td>
        <td><p>Philadelphia International Airport</p></td>
        <td><p>20804</p></td>
        </tr>
        <tr>
        <td><p>BWI</p></td>
        <td><p>Baltimore/Washington International Thurgood Marshall Airport</p></td>
        <td><p>18989</p></td>
        </tr>
        <tr>
        <td><p>MDW</p></td>
        <td><p>Chicago Midway International Airport</p></td>
        <td><p>15178</p></td>
        </tr>
        <tr>
        <td><p>BNA</p></td>
        <td><p>Nashville International Airport</p></td>
        <td><p>12455</p></td>
        </tr>
        <tr>
        <td><p>DAL</p></td>
        <td><p>Dallas Love Field</p></td>
        <td><p>12084</p></td>
        </tr>
        <tr>
        <td><p>IAD</p></td>
        <td><p>Washington Dulles International Airport</p></td>
        <td><p>11566</p></td>
        </tr>
        <tr>
        <td><p>STL</p></td>
        <td><p>Lambert St Louis International Airport</p></td>
        <td><p>11439</p></td>
        </tr>
        <tr>
        <td><p>HOU</p></td>
        <td><p>William P Hobby Airport</p></td>
        <td><p>9742</p></td>
        </tr>
        <tr>
        <td><p>IND</p></td>
        <td><p>Indianapolis International Airport</p></td>
        <td><p>8543</p></td>
        </tr>
        <tr>
        <td><p>PIT</p></td>
        <td><p>Pittsburgh International Airport</p></td>
        <td><p>8410</p></td>
        </tr>
        <tr>
        <td><p>CLE</p></td>
        <td><p>Cleveland Hopkins International Airport</p></td>
        <td><p>8238</p></td>
        </tr>
        <tr>
        <td><p>CMH</p></td>
        <td><p>Port Columbus International Airport</p></td>
        <td><p>7640</p></td>
        </tr>
        <tr>
        <td><p>SAT</p></td>
        <td><p>San Antonio International Airport</p></td>
        <td><p>6532</p></td>
        </tr>
        <tr>
        <td><p>JAX</p></td>
        <td><p>Jacksonville International Airport</p></td>
        <td><p>5495</p></td>
        </tr>
        <tr>
        <td><p>BDL</p></td>
        <td><p>Bradley International Airport</p></td>
        <td><p>4866</p></td>
        </tr>
        <tr>
        <td><p>RSW</p></td>
        <td><p>Southwest Florida International Airport</p></td>
        <td><p>4569</p></td>
        </tr>
        </tbody>
        </table>
        
        <p>In <a data-type="xref" href="#cluster-1-airports">Figure&nbsp;7-15</a> we can see that this cluster is actually focused on the East Coast to the Midwest of the United States.</p>
        
        <figure><div id="cluster-1-airports" class="figure">
        <img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/gral_rr_0715.png" alt="gral rr 0715" width="990" height="607">
        <h6><span class="label">Figure 7-15. </span>Cluster 1606317768706 airports</h6>
        </div></figure>
        
        <p class="less_space pagebreak-before">And now let’s do the same thing with the second-largest cluster:</p>
        
        <pre data-type="programlisting" data-code-language="python"><code class="p">(</code><code class="n">clusters</code>
         <code class="o">.</code><code class="n">filter</code><code class="p">(</code><code class="s2">"label=1219770712067"</code><code class="p">)</code>
         <code class="o">.</code><code class="n">join</code><code class="p">(</code><code class="n">all_flights</code><code class="p">,</code> <code class="n">all_flights</code><code class="o">.</code><code class="n">aId</code> <code class="o">==</code> <code class="n">result</code><code class="o">.</code><code class="n">id</code><code class="p">)</code>
         <code class="o">.</code><code class="n">sort</code><code class="p">(</code><code class="s2">"degree"</code><code class="p">,</code> <code class="n">ascending</code><code class="o">=</code><code class="bp">False</code><code class="p">)</code>
         <code class="o">.</code><code class="n">select</code><code class="p">(</code><code class="s2">"id"</code><code class="p">,</code> <code class="s2">"name"</code><code class="p">,</code> <code class="s2">"degree"</code><code class="p">)</code>
         <code class="o">.</code><code class="n">show</code><code class="p">(</code><code class="n">truncate</code><code class="o">=</code><code class="bp">False</code><code class="p">))</code></pre>
        
        <p>If we run that query we get this output:</p>
        <table>
        
        <thead>
        <tr>
        <th>id</th>
        <th>name</th>
        <th>degree</th>
        </tr>
        </thead>
        <tbody>
        <tr>
        <td><p>ATL</p></td>
        <td><p>Hartsfield Jackson Atlanta International Airport</p></td>
        <td><p>67672</p></td>
        </tr>
        <tr>
        <td><p>ORD</p></td>
        <td><p>Chicago O’Hare International Airport</p></td>
        <td><p>56681</p></td>
        </tr>
        <tr>
        <td><p>DEN</p></td>
        <td><p>Denver International Airport</p></td>
        <td><p>39671</p></td>
        </tr>
        <tr>
        <td><p>LAX</p></td>
        <td><p>Los Angeles International Airport</p></td>
        <td><p>38116</p></td>
        </tr>
        <tr>
        <td><p>PHX</p></td>
        <td><p>Phoenix Sky Harbor International Airport</p></td>
        <td><p>30206</p></td>
        </tr>
        <tr>
        <td><p>SFO</p></td>
        <td><p>San Francisco International Airport</p></td>
        <td><p>29865</p></td>
        </tr>
        <tr>
        <td><p>LGA</p></td>
        <td><p>La Guardia Airport</p></td>
        <td><p>29416</p></td>
        </tr>
        <tr>
        <td><p>LAS</p></td>
        <td><p>McCarran International Airport</p></td>
        <td><p>27801</p></td>
        </tr>
        <tr>
        <td><p>DTW</p></td>
        <td><p>Detroit Metropolitan Wayne County Airport</p></td>
        <td><p>27477</p></td>
        </tr>
        <tr>
        <td><p>MSP</p></td>
        <td><p>Minneapolis-St Paul International/Wold-Chamberlain Airport</p></td>
        <td><p>27163</p></td>
        </tr>
        <tr>
        <td><p>BOS</p></td>
        <td><p>General Edward Lawrence Logan International Airport</p></td>
        <td><p>26214</p></td>
        </tr>
        <tr>
        <td><p>SEA</p></td>
        <td><p>Seattle Tacoma International Airport</p></td>
        <td><p>24098</p></td>
        </tr>
        <tr>
        <td><p>MCO</p></td>
        <td><p>Orlando International Airport</p></td>
        <td><p>23442</p></td>
        </tr>
        <tr>
        <td><p>JFK</p></td>
        <td><p>John F Kennedy International Airport</p></td>
        <td><p>22294</p></td>
        </tr>
        <tr>
        <td><p>DCA</p></td>
        <td><p>Ronald Reagan Washington National Airport</p></td>
        <td><p>22244</p></td>
        </tr>
        <tr>
        <td><p>SLC</p></td>
        <td><p>Salt Lake City International Airport</p></td>
        <td><p>18661</p></td>
        </tr>
        <tr>
        <td><p>FLL</p></td>
        <td><p>Fort Lauderdale Hollywood International Airport</p></td>
        <td><p>16364</p></td>
        </tr>
        <tr>
        <td><p>SAN</p></td>
        <td><p>San Diego International Airport</p></td>
        <td><p>15401</p></td>
        </tr>
        <tr>
        <td><p>MIA</p></td>
        <td><p>Miami International Airport</p></td>
        <td><p>14869</p></td>
        </tr>
        <tr>
        <td><p>TPA</p></td>
        <td><p>Tampa International Airport</p></td>
        <td><p>12509</p></td>
        </tr>
        </tbody>
        </table>
        
        <p class="less_space pagebreak-before">In <a data-type="xref" href="#cluster-2-airports">Figure&nbsp;7-16</a> we can see that this cluster is apparently more hub-focused, with some additional northwestern stops along the way.</p>
        
        <figure><div id="cluster-2-airports" class="figure">
        <img src="https://learning.oreilly.com/api/v2/epubs/urn:orm:book:9781492047674/files/assets/gral_rr_0716.png" alt="gral rr 0716" width="664" height="393">
        <h6><span class="label">Figure 7-16. </span>Cluster 1219770712067 airports</h6>
        </div></figure>
        
        <p>The code we used to generate these maps is available in the book’s <a href="https://bit.ly/2FPgGVV">GitHub repository</a>.<a data-type="indexterm" data-startref="ix_ch07-adoc22" id="idm46681358614632"></a></p>
        
        <p>When checking the DL website for frequent flyer programs, we notice a use-two-get-one-free promotion.
        If we use our points for two flights, we get another for free—but only if we fly within one of the two clusters!
        Perhaps it’s a better use of our time, and certainly our points, to stay in a cluster<a data-type="indexterm" data-startref="ix_ch07-adoc21" id="idm46681358613192"></a>.<a data-type="indexterm" data-startref="ix_ch07-adoc14" id="idm46681358612360"></a><a data-type="indexterm" data-startref="ix_ch07-adoc13" id="idm46681358611656"></a></p>
        <aside data-type="sidebar" epub:type="sidebar"><div class="sidebar" id="reader-exercises2">
        <h5>Reader Exercises</h5>
        <ul>
        <li>
        <p>Use a Shortest Path algorithm to evaluate the number of flights from your home to the Bozeman Yellowstone International Airport (BZN).</p>
        </li>
        <li>
        <p>Are there any differences if you use relationship weights?</p>
        </li>
        </ul>
        </div></aside>
        </div></section>
        
        
        
        
        
        
        
        
        
        
        
        
        
        <section data-type="sect2" class="less_space pagebreak-before" data-pdf-bookmark="Summary"><div class="sect2" id="idm46681359565976">
        <h2>Summary</h2>
        
        <p>In the last few chapters we’ve provided details on how key graph algorithms for pathfinding, centrality, and community detection work in Apache Spark and Neo4j.
        In this chapter we walked through workflows that included using several algorithms in context with other tasks and analysis.
        We used a travel business scenario to analyze Yelp data in Neo4j and a personal air travel scenario to evaluate US airline data in Spark.<a data-type="indexterm" data-startref="ix_ch07-adoc0" id="idm46681358605544"></a></p>
        
        <p>Next, we’ll look at a use for graph algorithms that’s becoming increasingly important: graph-enhanced machine learning.</p>
        </div></section>
        
        
        
        
        
        </div></section>
        
        
        
        
        
        
        
        </div></section></div></div><link rel="stylesheet" href="/files/public/epub-reader/override_v1.css" crossorigin="anonymous"><link rel="stylesheet" href="/api/v2/epubs/urn:orm:book:9781492047674/files/epub.css" crossorigin="anonymous"><script src="https://learning.oreilly.comhttps://cdn.jsdelivr.net/npm/mathjax@3/es5/mml-svg.js"></script></div></div></section>
</div>

https://learning.oreilly.com